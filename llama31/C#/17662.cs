using System.Diagnostics;\n\npublic class ImpersonationHelper\n{\n    public static void RunAs(string username, string password, string domain, Action methodToRun)\n    {\n        var process = new Process();\n        process.StartInfo.FileName = "dotnet";\n        process.StartInfo.Arguments = $"run -c \"{methodToRun.Method.Name}\"";\n        process.StartInfo.UserName = username;\n        process.StartInfo.Password = password.ToSecureString();\n        process.StartInfo.Domain = domain;\n        process.StartInfo.UseShellExecute = false;\n        process.StartInfo.RedirectStandardOutput = true;\n        process.StartInfo.RedirectStandardError = true;\n        process.Start();\n\n        process.WaitForExit();\n    }\n}