using System.Collections.Generic;\nusing System.Data.Entity;\nusing System.Data.SqlClient;\nusing System.Linq;\n\n// Assume you have a DbContext and a DbSet for your table\npublic class MyDbContext : DbContext\n{\n    public DbSet<MyEntity> MyEntities { get; set; }\n}\n\npublic class MyEntity\n{\n    public int Id { get; set; }\n    public string Name { get; set; }\n}\n\npublic void BulkInsertOrUpdate(List<MyEntity> entities)\n{\n    // Retrieve all existing keys\n    var existingKeys = MyDbContext.MyEntities.Select(e => e.Id).ToHashSet();\n\n    // Create a bulk insert/update statement\n    var sql = new StringBuilder();\n    sql.AppendLine("MERGE INTO MyEntities AS target");\n    sql.AppendLine("USING (");\n    sql.AppendLine("    SELECT Id, Name");\n    sql.AppendLine("    FROM (");\n    sql.AppendLine("        VALUES");\n\n    // Add values for each entity\n    foreach (var entity in entities)\n    {\n        sql.AppendLine($"            ({entity.Id}, '{entity.Name}'),");\n    }\n\n    sql.AppendLine("        ) AS source (Id, Name)");\n    sql.AppendLine("    ) AS source");\n    sql.AppendLine("ON target.Id = source.Id");\n    sql.AppendLine("WHEN MATCHED THEN");\n    sql.AppendLine("    UPDATE SET Name = source.Name");\n    sql.AppendLine("WHEN NOT MATCHED THEN");\n    sql.AppendLine("    INSERT (Id, Name)");\n    sql.AppendLine("    VALUES (source.Id, source.Name);");\n\n    // Execute the bulk insert/update statement\n    using (var connection = new SqlConnection(MyDbContext.Database.Connection.ConnectionString))\n    {\n        connection.Open();\n        using (var command = new SqlCommand(sql.ToString(), connection))\n        {\n            command.ExecuteNonQuery();\n        }\n    }\n}