using Dapper;\n\n// Define the query builder\nvar builder = new SqlBuilder();\n\n// Define the CTEs\nbuilder.AddCTE("OrderCTE", @"\n    SELECT *\n    FROM Orders\n    WHERE OrderDate BETWEEN '2008-05-05' AND '2008-12-31'\n");\n\nbuilder.AddCTE("CustomerCTE", @"\n    SELECT *\n    FROM Customers\n    WHERE CustomerID IN (SELECT CustomerID FROM OrderCTE)\n");\n\nbuilder.AddCTE("CustomerCategoryCTE", @"\n    SELECT *\n    FROM CustomerCategories\n    WHERE CustomerCategoryID IN (SELECT CustomerCategoryID FROM CustomerCTE)\n");\n\n// Define the main query\nbuilder.AddQuery(@"\n    SELECT *\n    FROM OrderCTE\n    INNER JOIN CustomerCTE ON OrderCTE.CustomerID = CustomerCTE.CustomerID\n    INNER JOIN CustomerCategoryCTE ON CustomerCTE.CustomerCategoryID = CustomerCategoryCTE.CustomerCategoryID\n    INNER JOIN OrderDetails ON OrderCTE.OrderID = OrderDetails.OrderID\n");\n\n// Execute the query\nvar results = connection.Query(builder.ToString());