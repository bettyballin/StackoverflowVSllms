public class MedianCalculator\n{\n    private readonly int _numBuckets;\n    private readonly double[] _buckets;\n    private int _count;\n\n    public MedianCalculator(int numBuckets = 100)\n    {\n        _numBuckets = numBuckets;\n        _buckets = new double[numBuckets];\n    }\n\n    public void Add(double value)\n    {\n        int bucketIndex = (int)((value - _buckets[0]) / (_buckets[_numBuckets - 1] - _buckets[0]) * (_numBuckets - 1));\n        if (bucketIndex < 0) bucketIndex = 0;\n        if (bucketIndex >= _numBuckets) bucketIndex = _numBuckets - 1;\n\n        _buckets[bucketIndex]++;\n        _count++;\n    }\n\n    public double Median\n    {\n        get\n        {\n            int medianIndex = _count / 2;\n            int bucketIndex = 0;\n            int cumulativeCount = 0;\n\n            while (cumulativeCount < medianIndex)\n            {\n                cumulativeCount += (int)_buckets[bucketIndex];\n                bucketIndex++;\n            }\n\n            return _buckets[bucketIndex] * (medianIndex - cumulativeCount + 1) / _buckets[bucketIndex] + _buckets[bucketIndex - 1] * (cumulativeCount - medianIndex) / _buckets[bucketIndex - 1];\n        }\n    }\n}