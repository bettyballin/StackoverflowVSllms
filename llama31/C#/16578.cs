using (SqlConnection connection = new SqlConnection(connectionString))\n{\n    connection.Open();\n\n    // Open the symmetric key\n    using (SqlCommand command = new SqlCommand("OPEN SYMMETRIC KEY MySymmetricKey DECRYPTION BY CERTIFICATE MyCertificate", connection))\n    {\n        command.ExecuteNonQuery();\n    }\n\n    // Start the transaction\n    using (SqlTransaction transaction = connection.BeginTransaction())\n    {\n        try\n        {\n            // Execute stored procedures\n            using (SqlCommand command = new SqlCommand("MyProcedure", connection, transaction))\n            {\n                command.ExecuteNonQuery();\n            }\n\n            // Commit the transaction\n            transaction.Commit();\n        }\n        catch (Exception ex)\n        {\n            // Roll back the transaction\n            transaction.Rollback();\n\n            // Close the symmetric key\n            using (SqlCommand command = new SqlCommand("CLOSE SYMMETRIC KEY MySymmetricKey", connection))\n            {\n                command.ExecuteNonQuery();\n            }\n\n            throw;\n        }\n        finally\n        {\n            // Close the symmetric key\n            using (SqlCommand command = new SqlCommand("CLOSE SYMMETRIC KEY MySymmetricKey", connection))\n            {\n                command.ExecuteNonQuery();\n            }\n        }\n    }\n}