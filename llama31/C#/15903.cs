var template = @"\n    DECLARE @t Table(ContactId int, ROWRANK int)\n    INSERT INTO @t(ContactId, ROWRANK)\n    SELECT ContactID, ROW_NUMBER() OVER (ORDER BY @sortExpression @sortDirection) as ROWRANK\n    FROM (\n        SELECT c.id AS ContactID\n        @coreFields\n        FROM @from\n        @where\n    ) T\n    @groupBy\n    @havingClause\n    ;\n    SELECT @@rowcount as rCount;\n    SELECT @fields, field1, field2\n    FROM @t t INNER JOIN contacts c on t.ContactID = c.id\n    WHERE ROWRANK BETWEEN @pageIndex * @pageSize + 1 AND (@pageIndex + 1) * @pageSize\n";\n\nvar sql = Razor.Parse(template, new\n{\n    sortExpression,\n    sortDirection,\n    coreFields,\n    from,\n    where,\n    groupBy,\n    havingClause,\n    fields,\n    pageIndex,\n    pageSize\n});\n\n// Execute the query