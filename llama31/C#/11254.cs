using (SqlConnection connection = new SqlConnection(connectionString))\n{\n    connection.Open();\n\n    using (SqlTransaction transaction = connection.BeginTransaction())\n    {\n        SqlCommand command = new SqlCommand("SELECT * FROM widgets WHERE widget_id = @widget_id FOR UPDATE", connection, transaction);\n        command.CommandType = CommandType.Text;\n        command.Parameters.AddWithValue("@widget_id", widgetId);\n\n        using (SqlDataReader reader = command.ExecuteReader())\n        {\n            if (!reader.HasRows)\n            {\n                // Insert new row\n                command = new SqlCommand("INSERT INTO widgets (widget_id, ...) VALUES (@widget_id, ...)", connection, transaction);\n                command.CommandType = CommandType.Text;\n                command.Parameters.AddWithValue("@widget_id", widgetId);\n                // ...\n                command.ExecuteNonQuery();\n            }\n        }\n\n        transaction.Commit();\n    }\n}