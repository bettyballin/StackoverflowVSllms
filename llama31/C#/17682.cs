using System.Security.Principal;\nusing System.Runtime.InteropServices;\n\npublic class ImpersonationHelper\n{\n    [DllImport("advapi32.dll", SetLastError = true)]\n    static extern bool LogonUser(string lpszUsername, string lpszDomain, string lpszPassword, int dwLogonType, int dwLogonProvider, out IntPtr phToken);\n\n    public static void RunAs(string username, string password, string domain, Action methodToRun)\n    {\n        IntPtr token;\n        if (LogonUser(username, domain, password, 3, 0, out token))\n        {\n            using (var identity = new WindowsIdentity(token))\n            {\n                using (var impersonationContext = identity.Impersonate())\n                {\n                    methodToRun();\n                }\n            }\n        }\n    }\n}