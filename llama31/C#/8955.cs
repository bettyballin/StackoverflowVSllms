SPSecurity.RunWithElevatedPrivileges(\n    delegate\n    {\n        using (SPSite elevatedSite = new SPSite(SPContext.Current.Site.Url))\n        using (SPWeb targetWeb = elevatedSite.OpenWeb(webUrl))\n        {\n            targetWeb.AllowUnsafeUpdates = true;\n            SPFile newFile = files.Add(filename, file);\n            SPListItem item = newFile.Item;\n\n            // Get the original user's token\n            SPUserToken originalUserToken = SPContext.Current.Web.CurrentUser.UserToken;\n\n            // Impersonate the original user\n            using (SPSite impersonatedSite = new SPSite(elevatedSite.Url, originalUserToken))\n            {\n                using (SPWeb impersonatedWeb = impersonatedSite.OpenWeb(webUrl))\n                {\n                    // Update the item under the impersonated user's context\n                    impersonatedWeb.AllowUnsafeUpdates = true;\n                    item["Modified By"] = impersonatedWeb.CurrentUser;\n                    item.SystemUpdate();\n                }\n            }\n        }\n    }\n);