using System;\nusing System.IO;\nusing System.Runtime.InteropServices;\nusing System.Security.Principal;\nusing System.Security.Permissions;\n\nclass ImpersonationHelper\n{\n    [DllImport("advapi32.dll", SetLastError = true)]\n    static extern bool LogonUser(string lpszUsername, string lpszDomain, string lpszPassword, int dwLogonType, int dwLogonProvider, ref IntPtr phToken);\n\n    [DllImport("advapi32.dll", SetLastError = true)]\n    static extern bool ImpersonateLoggedOnUser(IntPtr hToken);\n\n    [DllImport("advapi32.dll", SetLastError = true)]\n    static extern bool RevertToSelf();\n\n    [DllImport("kernel32.dll", SetLastError = true)]\n    static extern bool CloseHandle(IntPtr hObject);\n\n    public static void ImpersonateUser(string username, string domain, string password, Action action)\n    {\n        IntPtr tokenHandle = IntPtr.Zero;\n        try\n        {\n            if (LogonUser(username, domain, password, 9, 0, ref tokenHandle))\n            {\n                try\n                {\n                    if (ImpersonateLoggedOnUser(tokenHandle))\n                    {\n                        try\n                        {\n                            action();\n                        }\n                        finally\n                        {\n                            RevertToSelf();\n                        }\n                    }\n                    else\n                    {\n                        throw new Exception("ImpersonateLoggedOnUser failed");\n                    }\n                }\n                finally\n                {\n                    CloseHandle(tokenHandle);\n                }\n            }\n            else\n            {\n                throw new Exception("LogonUser failed");\n            }\n        }\n        catch (Exception ex)\n        {\n            Console.WriteLine(ex.Message);\n        }\n    }\n\n    public static void Main()\n    {\n        // Example usage\n        string user = "username";\n        string domain = "domain";\n        string password = "password";\n\n        ImpersonateUser(user, domain, password, () =>\n        {\n            string[] directories = Directory.GetDirectories("C:\\");\n            foreach (var dir in directories)\n            {\n                Console.WriteLine(dir);\n            }\n\n            string[] files = Directory.GetFiles("C:\\");\n            foreach (var file in files)\n            {\n                Console.WriteLine(file);\n            }\n        });\n    }\n}