using (SqlConnection connection = new SqlConnection(connectionString))\n{\n    connection.Open();\n\n    using (SqlTransaction transaction = connection.BeginTransaction())\n    {\n        try\n        {\n            // Retrieve the email message\n            string messageId = RetrieveMessageId();\n\n            // Acquire a lock on the message\n            using (SqlCommand command = new SqlCommand("INSERT INTO MessageLocks (MessageId) VALUES (@MessageId)", connection, transaction))\n            {\n                command.Parameters.AddWithValue("@MessageId", messageId);\n                command.ExecuteNonQuery();\n            }\n\n            // Process the message\n            ProcessMessage(messageId);\n\n            // Delete the message\n            DeleteMessage(messageId);\n\n            // Commit the transaction\n            transaction.Commit();\n        }\n        catch (Exception ex)\n        {\n            // Rollback the transaction\n            transaction.Rollback();\n            throw;\n        }\n    }\n}