using (SqlConnection conn = new SqlConnection(connectionString))\n{\n    conn.Open();\n\n    using (SqlTransaction tran = conn.BeginTransaction())\n    {\n        try\n        {\n            // dequeue message\n            SqlCommand cmd = new SqlCommand("DequeueMessage", conn, tran);\n            int dataId = (int)cmd.ExecuteScalar();\n\n            // process message\n            // ...\n\n            // mark message as completed\n            cmd = new SqlCommand("UPDATE MessageQueue SET Status = 'COMPLETED' WHERE Id = @Id", conn, tran);\n            cmd.Parameters.AddWithValue("@Id", dataId);\n            cmd.ExecuteNonQuery();\n\n            tran.Commit();\n        }\n        catch\n        {\n            tran.Rollback();\n            // handle failure\n        }\n    }\n}