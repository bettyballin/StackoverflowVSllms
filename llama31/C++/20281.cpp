#define SAFE_RELEASE(comObj) \\n    if (comObj != NULL) { (comObj)->Release(); comObj = NULL; }\n\nBOOL success = false;\n\nHRESULT res;\nIClassFactory* pFactory;\nIMMDevice* pDevice;\nIMMDeviceEnumerator* pEnumerator;\n\nSESSION_LISTENER = NULL;\nSESSION = NULL;\n\nres = CoInitializeEx(NULL, COINIT_MULTITHREADED);\nif (res != S_OK) return false;\n\nres = CoGetClassObject(CLSID_CustomAudioFactory, CLSCTX_ALL, NULL, __uuidof(IClassFactory), (void**)&pFactory);\nif (res != S_OK) goto Exit;\n\nres = pFactory->CreateInstance(NULL, CLSID_CustomAudioNotifications, (void**)&SESSION_LISTENER);\nif (res != S_OK) goto Exit;\n\nres = CoCreateInstance(__uuidof(MMDeviceEnumerator), NULL, CLSCTX_ALL, __uuidof(IMMDeviceEnumerator), (void**)&pEnumerator);\nif (res != S_OK) goto Exit;\n\nres = pEnumerator->GetDefaultAudioEndpoint(eRender, eMultimedia, &pDevice);\nif (res != S_OK) goto Exit;\n\nres = pDevice->Activate(__uuidof(IAudioSessionManager2), CLSCTX_ALL, NULL, (void**)&SESSION);\nif (res != S_OK) goto Exit;\n\nres = SESSION->RegisterSessionNotification(SESSION_LISTENER);\nif (res != S_OK) goto Exit;\n\nsuccess = true;\n\nExit:\nSAFE_RELEASE(pFactory);\nSAFE_RELEASE(pEnumerator);\nSAFE_RELEASE(pDevice);\nif (!success)\n{\n    SAFE_RELEASE(SESSION_LISTENER);\n    SAFE_RELEASE(SESSION);\n}