Imports System.Collections\nImports System.Threading\n\nModule Module1\n\n    Public Class RingBuffer\n\n        Private m_Capacity As Integer\n        Private m_Queue As Queue\n        Private m_CancellationTokenSource As CancellationTokenSource\n\n        Public Sub New(ByVal Capacity As Integer)\n            m_Capacity = Capacity\n            m_Queue = Queue.Synchronized(New Queue(Capacity))\n            m_CancellationTokenSource = New CancellationTokenSource()\n        End Sub\n\n        Public Sub Enqueue(ByVal value As Object)\n            SyncLock m_Queue.SyncRoot\n                If m_Queue.Count = m_Capacity Then\n                    Threading.Monitor.Wait(m_Queue.SyncRoot)\n                End If\n\n                m_Queue.Enqueue(value)\n\n                Threading.Monitor.PulseAll(m_Queue.SyncRoot)\n            End SyncLock\n        End Sub\n\n        Public Function Dequeue() As Object\n            Dim value As Object = Nothing\n\n            SyncLock m_Queue.SyncRoot\n                If m_Queue.Count = 0 Then\n                    Threading.Monitor.Wait(m_Queue.SyncRoot)\n                End If\n\n                value = m_Queue.Dequeue()\n\n                Console.WriteLine("Full Slots: {0} - Open Slots: {1}", m_Queue.Count, m_Capacity - m_Queue.Count)\n\n                Threading.Monitor.PulseAll(m_Queue.SyncRoot)\n            End SyncLock\n\n            Return value\n        End Function\n\n        Public Function GetCancellationToken() As CancellationToken\n            Return m_CancellationTokenSource.Token\n        End Function\n\n        Public Sub Cancel()\n            m_CancellationTokenSource.Cancel()\n        End Sub\n    End Class\n\n    Public Class Tile\n        Public buffer() As Byte\n\n        Public Sub New()\n            buffer = New Byte(1023) {}\n        End Sub\n    End Class\n\n    Public Sub Producer(ByVal rb As RingBuffer)\n        Dim enq As Integer = 0\n        Dim rng As New System.Security.Cryptography.RNGCryptoServiceProvider\n\n        For i As Integer = 0 To 1023\n            Dim t As New Tile\n            rng.GetNonZeroBytes(t.buffer)\n            rb.Enqueue(t)\n            enq += 1\n            Threading.Thread.Sleep(10)\n        Next i\n\n        rb.Enqueue(Nothing)\n\n        Console.WriteLine("Total items enqueued: " & enq.ToString())\n        Console.WriteLine("Done Producing!")\n    End Sub\n\n    Public Sub Consumer(ByVal rb As RingBuffer)\n        Dim deq As Integer = 0\n\n        Using fs As New IO.FileStream("c:\test.bin", IO.FileMode.Create)\n            While Not rb.GetCancellationToken().IsCancellationRequested\n                Dim t As Tile = rb.Dequeue()\n                If t Is Nothing Then Exit While\n\n                fs.Write(t.buffer, 0, t.buffer.Length)\n                deq += 1\n                Threading.Thread.Sleep(30)\n            End While\n        End Using\n\n        Console.WriteLine("Total items dequeued: " & deq.ToString())\n        Console.WriteLine("Done Consuming!")\n    End Sub\n\n    Sub Main()\n        Dim rb As New RingBuffer(1000)\n\n        Dim thrdProducer As New Threading.Thread(AddressOf Producer)\n        thrdProducer.SetApartmentState(Threading.ApartmentState.STA)\n        thrdProducer.Name = "Producer"\n        thrdProducer.IsBackground = True\n        thrdProducer.Start(rb)\n\n        Dim thrdConsumer As New Threading.Thread(AddressOf Consumer)\n        thrdConsumer.SetApartmentState(Threading.ApartmentState.STA)\n        thrdConsumer.Name = "Consumer"\n        thrdConsumer.IsBackground = True\n        thrdConsumer.Start(rb)\n\n        Console.ReadKey()\n        rb.Cancel()\n    End Sub\nEnd Module