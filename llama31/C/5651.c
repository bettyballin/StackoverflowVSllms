pam_handle_t *try_login(const char *service, int *retval)\n{\n    static char *username = NULL;\n    struct pam_conv pam_conversation = { conv, NULL };\n    pam_handle_t *pamh;\n\n    *retval = pam_start(service, username, &pam_conversation, &pamh);\n\n    if (*retval == PAM_SUCCESS) *retval = pam_authenticate(pamh, 0);\n    if (*retval == PAM_SUCCESS) *retval = pam_acct_mgmt   (pamh, 0);\n    if (*retval == PAM_SUCCESS) *retval = pam_open_session(pamh, 0);\n\n    if (username == NULL) {\n        if (pam_get_item(pamh, PAM_USER, (const void **) &username) == PAM_SUCCESS) {\n            username = strdup(username);\n        }\n    }\n\n    if (*retval != PAM_SUCCESS) {\n        fprintf(stderr, "%s: %s\n", service, pam_strerror(pamh, *retval));\n        pam_end(pamh, *retval);\n        pamh = NULL;\n    } else {\n        // Store the authentication token\n        char *authtok;\n        if (pam_get_item(pamh, PAM_AUTHTOK, (const void **) &authtok) == PAM_SUCCESS) {\n            pam_set_item(pamh, PAM_AUTHTOK, authtok);\n        }\n    }\n\n    return pamh;\n}\n\nint main(void)\n{\n    pam_handle_t *pamh = NULL;\n    int retval;\n    const char *service, *username;\n\n    if (!pamh) pamh = try_login("pamdemo-admin", &retval);\n    if (!pamh) {\n        // If the first login attempt failed, try to retrieve the stored authentication token\n        char *authtok;\n        if (pam_get_item(pamh, PAM_AUTHTOK, (const void **) &authtok) == PAM_SUCCESS) {\n            // Use the stored authentication token for the second login attempt\n            pam_set_item(pamh, PAM_AUTHTOK, authtok);\n        }\n        pamh = try_login("pamdemo", &retval);\n    }\n\n    if (!pamh) {\n        fprintf(stderr, "Access denied.\n");\n        return 1;\n    }\n\n    pam_get_item(pamh, PAM_SERVICE, (const void **) &service);\n    pam_get_item(pamh, PAM_USER,    (const void **) &username);\n\n    printf("Logged into %s as %s.\n", service, username);\n\n    pam_close_session(pamh, 0);\n    pam_end          (pamh, retval);\n\n    return 0;\n}