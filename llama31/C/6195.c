#include <stdio.h>\n#include <stdlib.h>\n#include "jpeglib.h"\n#include <setjmp.h>\n\nint main () {\n  // read data\n  FILE *input = fopen("input.jpg", "rb");\n  if (input == NULL) {\n    exit(1);\n  }\n\n  // initialise jpeg library\n  struct jpeg_decompress_struct cinfo;\n  struct jpeg_error_mgr jerr;\n  cinfo.err = jpeg_std_error(&jerr);\n  jpeg_create_decompress(&cinfo);\n\n  // read jpeg header\n  jpeg_stdio_src(&cinfo, input);\n  jpeg_read_header(&cinfo, TRUE);\n\n  // start decompressing\n  jpeg_start_decompress(&cinfo);\n\n  // allocate buffer for raw pixel data\n  JSAMPLE *image_buffer = (JSAMPLE*) malloc(sizeof(JSAMPLE) * cinfo.output_width * cinfo.output_height * cinfo.output_components);\n\n  // read raw pixel data\n  JSAMPROW row_pointer[1];\n  while (cinfo.output_scanline < cinfo.output_height) {\n    row_pointer[0] = &image_buffer[cinfo.output_scanline * cinfo.output_width * cinfo.output_components];\n    jpeg_read_scanlines(&cinfo, row_pointer, 1);\n  }\n\n  // stop decompressing\n  jpeg_finish_decompress(&cinfo);\n\n  // clean up\n  fclose(input);\n  jpeg_destroy_decompress(&cinfo);\n\n  // now you can use the raw pixel data in image_buffer\n  // ...\n\n  // initialise jpeg library for compression\n  struct jpeg_compress_struct cinfo2;\n  cinfo2.err = jpeg_std_error(&jerr);\n  jpeg_create_compress(&cinfo2);\n\n  // write to foo.jpg\n  FILE *outfile = fopen("foo.jpg", "wb");\n  if (outfile == NULL) {\n    exit(1);\n  }\n  jpeg_stdio_dest(&cinfo2, outfile);\n\n  // setup library\n  cinfo2.image_width = cinfo.output_width;\n  cinfo2.image_height = cinfo.output_height;\n  cinfo2.input_components = cinfo.output_components;\n  cinfo2.in_color_space = cinfo.output_color_space;\n  jpeg_set_defaults(&cinfo2);\n\n  // start compressing\n  jpeg_start_compress(&cinfo2, TRUE);\n\n  // write raw pixel data to jpeg file\n  while (cinfo2.next_scanline < cinfo2.image_height) {\n    row_pointer[0] = &image_buffer[cinfo2.next_scanline * cinfo2.image_width * cinfo2.input_components];\n    jpeg_write_scanlines(&cinfo2, row_pointer, 1);\n  }\n\n  // stop compressing\n  jpeg_finish_compress(&cinfo2);\n\n  // clean up\n  fclose(outfile);\n  jpeg_destroy_compress(&cinfo2);\n\n  return 0;\n}