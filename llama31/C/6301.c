while (queue.head == queue.tail) {\n    __sync_synchronize();\n}