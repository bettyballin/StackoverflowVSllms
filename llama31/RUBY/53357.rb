require 'rack/utils'\n\ndef test_uses_referrer_for_return_to\n  expected_return_to = 'http://test.com/foo'\n  @request.env['HTTP_REFERER'] = expected_return_to\n  get :fazbot\n  uri = URI.parse(@response.redirected_to)\n  query_params = Rack::Utils.parse_query(uri.query)\n  encoded_return_to = query_params['return_to']\n  assert_equal expected_return_to, URI.unescape(encoded_return_to)\nend