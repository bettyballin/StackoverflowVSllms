def payment\n  # Tokenize credit card information\n  token = create_token(params[:credit_card])\n\n  # Store token in session\n  session[:token] = token\nend\n\ndef summary\n  # Retrieve token from session\n  token = session[:token]\n\n  # Retrieve credit card information from token\n  credit_card = retrieve_credit_card(token)\n\n  # Process payment with secure gateway\n  process_payment(credit_card)\nend\n\ndef finish\n  # Retrieve token from session\n  token = session[:token]\n\n  # Retrieve credit card information from token\n  credit_card = retrieve_credit_card(token)\n\n  # Process payment with secure gateway\n  process_payment(credit_card)\nend\n\nprivate\n\ndef create_token(credit_card)\n  # Implement tokenization system here\n  # ...\nend\n\ndef retrieve_credit_card(token)\n  # Implement tokenization system here\n  # ...\nend\n\ndef process_payment(credit_card)\n  gateway = ActiveMerchant::Billing::PaypalGateway.new(\n    login: $PAYPAL_LOGIN,\n    password: $PAYPAL_PASSWORD,\n    ssl: true\n  )\n\n  # Process payment with secure gateway\n  res = gateway.authorize(@total, credit_card, :ip => request.remote_ip)\n\n  # ...\nend