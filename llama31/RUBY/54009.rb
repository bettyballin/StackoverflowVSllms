def find_user\n  session[:user_id] ||= create_new_anonymous_user.id\n  # Regenerate session ID when user creates a real account\n  session.regenerate if current_user && current_user.registered?\nend\n\ndef create_new_anonymous_user\n  # Create a new anonymous user with a secure token\n  user = User.create!(is_anonymous: true, token: SecureRandom.hex(16))\n  # Store the user's ID in the session\n  session[:user_id] = user.id\n  user\nend