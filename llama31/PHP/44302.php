use League\Csv\Writer;\n\n$departments = [...]; // your data here\n\n$csv = Writer::createFromString('');\n\n$csv->insertOne([\n    'Current Milestone',\n    'Total Hours',\n    'Milestone 1 Hours',\n    'Milestone 2 Hours',\n    'Milestone 3 Hours',\n]);\n\nforeach ($departments as $dept) {\n    $deptStartRow = $csv->getRowCount() + 1;\n    $csv->insertOne([$dept['name']]);\n\n    foreach ($dept['modules'] as $module) {\n        $csv->insertOne([\n            $module['name'],\n            $module['ms'],\n            '=SUM(D' . $csv->getRowCount() . ':F' . $csv->getRowCount() . ')',\n            $module['m1'],\n            $module['m2'],\n            $module['m3'],\n        ]);\n    }\n\n    $deptSSRange = 'C' . $deptStartRow . ':C' . $csv->getRowCount();\n    $totSSRange .= $deptSSRange . ',';\n    $sumStr = '=SUM(' . $deptSSRange . ')';\n    $csv->insertOne([\n        'Sum',\n        '',\n        $sumStr,\n        str_replace('C', 'D', $sumStr),\n        str_replace('C', 'E', $sumStr),\n        str_replace('C', 'F', $sumStr),\n    ]);\n\n    $csv->insertOne([]); // empty row\n}\n\n$totSumStr = '=SUM(' . rtrim($totSSRange, ',') . ')';\n$csv->insertOne([\n    'Total',\n    '',\n    $totSumStr,\n    str_replace('C', 'D', $totSumStr),\n    str_replace('C', 'E', $totSumStr),\n    str_replace('C', 'F', $totSumStr),\n]);\n\necho $csv->getContent();