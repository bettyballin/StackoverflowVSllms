if ($msgStruct->parts) {\n    foreach ($msgStruct->parts as $key => $part) {\n        switch (strtoupper($part->subtype)) {\n            case 'GIF': case 'JPEG': case 'PNG':\n                $data = imap_fetchbody($mbox, $message->msgno, $key+1, FT_PEEK);\n                $decoded_data = base64_decode($data);\n                file_put_contents('image_'.$message->msgno.'_'.$key.'.'.$part->subtype, $decoded_data);\n                break;\n        }\n    }\n}