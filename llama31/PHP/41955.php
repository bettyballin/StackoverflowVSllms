/**\n * Convert an IPv4 address to IPv6\n *\n * @param string IP Address in dot notation (192.168.1.100)\n * @return string IPv6 formatted address or false if invalid input\n */\nfunction IPv4To6($Ip) {\n    if (strpos($Ip, ':') !== false) {\n        // Already in IPv6 format, return original IP address\n        return $Ip;\n    }\n    \n    static $Mask = '::ffff:'; // This tells IPv6 it has an IPv4 address\n    $Ip = array_pad(explode('.', $Ip), 4, 0);\n    if (count($Ip) > 4) return false;\n    for ($i = 0; $i < 4; $i++) if ($Ip[$i] > 255) return false;\n\n    $Part7 = base_convert(($Ip[0] * 256) + $Ip[1], 10, 16);\n    $Part8 = base_convert(($Ip[2] * 256) + $Ip[3], 10, 16);\n    return $Mask.$Part7.':'.$Part8;\n}\n\n/**\n * Replace '::' with appropriate number of ':0'\n */\nfunction ExpandIPv6Notation($Ip) {\n    if (strpos($Ip, '::') !== false) {\n        $parts = explode('::', $Ip);\n        $newIp = $parts[0];\n        $missingParts = 8 - substr_count($Ip, ':');\n        for ($i = 0; $i < $missingParts; $i++) {\n            $newIp .= ':0';\n        }\n        if (!empty($parts[1])) {\n            $newIp .= ':' . $parts[1];\n        }\n        return $newIp;\n    }\n    return $Ip;\n}\n\n/**\n * Convert IPv6 address to an integer\n *\n * Optionally split in to two parts.\n *\n * @see https://stackoverflow.com/questions/420680/\n */\nfunction IPv6ToLong($Ip, $DatabaseParts = 2) {\n    $Ip = ExpandIPv6Notation($Ip);\n    $Parts = explode(':', $Ip);\n    $Ip = array('', '');\n    for ($i = 0; $i < 4; $i++) $Ip[0] .= str_pad(base_convert($Parts[$i], 16, 2), 16, 0, STR_PAD_LEFT);\n    for ($i = 4; $i < 8; $i++) $Ip[1] .= str_pad(base_convert($Parts[$i], 16, 2), 16, 0, STR_PAD_LEFT);\n\n    if ($DatabaseParts == 2) {\n        return array(base_convert($Ip[0], 2, 10), base_convert($Ip[1], 2, 10));\n    } else {\n        return base_convert($Ip[0], 2, 10) + base_convert($Ip[1], 2, 10);\n    }\n}\n\n/**\n * Attempt to find the client's IP Address\n *\n * @param bool Should the IP be converted using ip2long?\n * @return string|long The IP Address\n */\nfunction GetRealRemoteIp($ForDatabase = false, $DatabaseParts = 2) {\n    $Ip = '0.0.0.0';\n    if (isset($_SERVER['REMOTE_ADDR']) && $_SERVER['REMOTE_ADDR'] != '') {\n        $Ip = $_SERVER['REMOTE_ADDR'];\n    }\n    if (($CommaPos = strpos($Ip, ',')) > 0) {\n        $Ip = substr($Ip, 0, ($CommaPos - 1));\n    }\n\n    $Ip = IPv4To6($Ip);\n    return ($ForDatabase ? IPv6ToLong($Ip, $DatabaseParts) : $Ip);\n}