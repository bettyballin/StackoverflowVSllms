<?php\nuse Defuse\Crypto\Crypto;\nuse Defuse\Crypto\Key;\n\n// Assume $userPassword is the user's password\n// Assume $hsmKey is the encryption key stored in the HSM or KMS\n\n// Derive a key from the user's password\n$userKey = Key::createNewRandomKey()->deriveKey($userPassword, 'sha256', 100000);\n\n// Generate a random data encryption key\n$dataKey = Key::createNewRandomKey();\n\n// Encrypt the data with the data encryption key\n$encryptedData = Crypto::encrypt($data, $dataKey);\n\n// Encrypt the data encryption key with the user's derived key\n$encryptedDataKey = Crypto::encrypt($dataKey, $userKey);\n\n// Store the encrypted data and encrypted data key in the database\n$pdo->query("INSERT INTO user_data (encrypted_data, encrypted_data_key) VALUES (:encryptedData, :encryptedDataKey)");