$query = mysql_query("SELECT * FROM eventcal WHERE eventDate = '$date' ORDER BY region");\n\n$doc = new DomDocument("1.0");\n\n$root = $doc->createElement('root');\n$root = $doc->appendChild($root);\n\n$collection = $doc->createElement('collection');\n$collection = $root->appendChild($collection);\n\n$regions = array();\n\nif (@mysql_num_rows($query)) {\n    while ($row = @mysql_fetch_assoc($query)) {\n        $regionId = $row['region'];\n\n        if (!isset($regions[$regionId])) {\n            $region = $doc->createElement('region');\n            $region->setAttribute('ID', $regionId);\n            $regions[$regionId] = $region;\n            $collection->appendChild($region);\n        }\n\n        $primary = $doc->createElement('primary', $row['primary']);\n        $regions[$regionId]->appendChild($primary);\n    }\n}