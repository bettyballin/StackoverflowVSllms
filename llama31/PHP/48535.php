$newText = preg_replace('/(?<!<pre>.*?)(?:&gt|&lt)(?!.*?<\/pre>)/', \n                        function($match) {\n                            return $match[0] == '&gt' ? '>' : '<';\n                        }, \n                        $text);