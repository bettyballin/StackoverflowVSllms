$result = $site->query('SELECT 1 FROM `user_ips` WHERE `ip` = '.$this->ip.' AND `userid` = '.$this->id);\nif (mysql_num_rows($result) == 0) {\n    $site->query('INSERT INTO `user_ips` SET `userid` = '.$this->id.', `ip` = '.$this->ip.', `first_time` = UNIX_TIMESTAMP(), `last_time` = UNIX_TIMESTAMP(), `user_agent` = \''.$this->user_agent.'\'');\n} else {\n    $site->query('UPDATE `user_ips` SET `last_time` = UNIX_TIMESTAMP(), `user_agent` = \''.$this->user_agent.'\' WHERE `ip` = '.$this->ip.' AND `userid` = '.$this->id);\n}