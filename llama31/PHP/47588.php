$html = '<p>My paragraph text</p>\n<img src="image.jpg" alt="My caption" />\n<p>Another paragraph text <img src="another_image.jpg" alt="Another caption" /> with more text</p>\n<p>And so on</p>';\n\n$doc = new DOMDocument();\n$doc->loadHTML($html);\n$xpath = new DOMXPath($doc);\n\nforeach ($xpath->query('//img') as $img) {\n    $div = $doc->createElement('div');\n    $div->setAttribute('class', 'caption ' . $img->getAttribute('class'));\n    $img->parentNode->replaceChild($div, $img);\n    $div->appendChild($img);\n    $img->removeAttribute('class');\n    $img->removeAttribute('height');\n    $img->removeAttribute('width');\n    $p = $doc->createElement('p', $img->getAttribute('alt'));\n    $div->appendChild($p);\n    $img->setAttribute('src', '/system/tools/phpthumb/phpThumb.php?src=' . $img->getAttribute('src') . '&wl=200&hp=200&q=85&f=jpg');\n}\n\necho $doc->saveHTML();