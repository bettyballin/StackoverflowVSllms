$entityManager = // get the entity manager instance\n$conn = $entityManager->getConnection();\n\n$conn->beginTransaction();\ntry {\n    $conn->executeUpdate('INSERT IGNORE INTO table (critical_id, field) VALUES (:id, :value)', [\n        'id' => $id,\n        'value' => 'new_value',\n    ]);\n\n    if ($conn->getRowCount() === 0) {\n        $conn->executeUpdate('UPDATE table SET field = :value WHERE critical_id = :id', [\n            'id' => $id,\n            'value' => 'new_value',\n        ]);\n    }\n\n    $conn->commit();\n} catch (\Exception $e) {\n    $conn->rollBack();\n    throw $e;\n}