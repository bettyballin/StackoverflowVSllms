$dbh->beginTransaction();\n\n// Create a savepoint\n$dbh->exec('SAVEPOINT my_savepoint');\n\ntry {\n    // Perform the inserts and updates\n    $insert_order->execute(array('293', $rayOrder['id_customer'], $rayOrder['date'], $rayOrder['code']));\n    // ...\n\n    // If everything is successful, release the savepoint\n    $dbh->exec('RELEASE SAVEPOINT my_savepoint');\n} catch (PDOException $e) {\n    // If an error occurs, roll back to the savepoint\n    $dbh->exec('ROLLBACK TO SAVEPOINT my_savepoint');\n    // Re-throw the exception to handle it further\n    throw $e;\n}\n\n// If the transaction is still active, commit or roll back based on your flag\nif ($rollback) {\n    $dbh->rollBack();\n} else {\n    $dbh->commit();\n}