WITH Segments AS (\n  SELECT 'A' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 1\n  EXCEPT\n  SELECT 'A' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 2 OR key1 = 3\n\n  UNION ALL\n\n  SELECT 'B' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 2\n  EXCEPT\n  SELECT 'B' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 1 OR key1 = 3\n\n  UNION ALL\n\n  SELECT 'C' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 3\n  EXCEPT\n  SELECT 'C' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 1 OR key1 = 2\n\n  UNION ALL\n\n  SELECT 'A I B' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 1\n  INTERSECT\n  SELECT 'A I B' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 2\n\n  UNION ALL\n\n  SELECT 'A I C' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 1\n  INTERSECT\n  SELECT 'A I C' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 3\n\n  UNION ALL\n\n  SELECT 'B I C' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 2\n  INTERSECT\n  SELECT 'B I C' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 3\n\n  UNION ALL\n\n  SELECT 'A I B I C' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 1\n  INTERSECT\n  SELECT 'A I B I C' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 2\n  INTERSECT\n  SELECT 'A I B I C' AS Segment, key2\n  FROM #t1\n  WHERE key1 = 3\n)\nSELECT \n  CASE \n    WHEN Segment = 'A' THEN 1001\n    WHEN Segment = 'B' THEN 1004\n    WHEN Segment = 'C' THEN 1005\n    WHEN Segment = 'A I B' THEN 1002\n    WHEN Segment = 'A I C' THEN 1002\n    WHEN Segment = 'B I C' THEN 1005\n    WHEN Segment = 'A I B I C' THEN 1003\n  END AS RowID,\n  key2\nFROM Segments\nORDER BY RowID;