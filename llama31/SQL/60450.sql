WITH RankedPhoneNumbers AS (\n  SELECT StoreID, PhoneNumber = dbo.GetPhoneNumber10(StorePhone), Rank = 1\n  FROM dbo.Store_Info\n  WHERE ParentID = 0 AND dbo.IsAniNumber(dbo.GetPhoneNumber10(StorePhone)) = 1\n\n  UNION ALL\n\n  SELECT StoreID, PhoneNumber = dbo.GetPhoneNumber10(AltPhone), Rank = 2\n  FROM dbo.Store_Info\n  WHERE ParentID = 0 AND dbo.IsAniNumber(dbo.GetPhoneNumber10(AltPhone)) = 1\n\n  UNION ALL\n\n  SELECT StoreID, PhoneNumber = dbo.GetPhoneNumber10(StorePhone), Rank = 3\n  FROM dbo.Store_Info\n  WHERE ParentID <> 0 AND dbo.IsAniNumber(dbo.GetPhoneNumber10(StorePhone)) = 1\n\n  UNION ALL\n\n  SELECT StoreID, PhoneNumber = dbo.GetPhoneNumber10(AltPhone), Rank = 4\n  FROM dbo.Store_Info\n  WHERE ParentID <> 0 AND dbo.IsAniNumber(dbo.GetPhoneNumber10(AltPhone)) = 1\n\n  UNION ALL\n\n  SELECT sc.StoreID, PhoneNumber = dbo.GetPhoneNumber10(sc.Phone), Rank = 5\n  FROM Store_Contacts sc\n  INNER JOIN Store_Info si ON sc.StoreID = si.StoreID\n  WHERE si.ParentID = 0 AND dbo.IsAniNumber(dbo.GetPhoneNumber10(sc.Phone)) = 1\n\n  UNION ALL\n\n  SELECT sc.StoreID, PhoneNumber = dbo.GetPhoneNumber10(sc.Phone), Rank = 6\n  FROM Store_Contacts sc\n  INNER JOIN Store_Info si ON sc.StoreID = si.StoreID\n  WHERE si.ParentID <> 0 AND dbo.IsAniNumber(dbo.GetPhoneNumber10(sc.Phone)) = 1\n)\nINSERT INTO dbo.Store_PhoneNumbers (StoreID, PhoneNumber)\nSELECT StoreID, PhoneNumber\nFROM (\n  SELECT StoreID, PhoneNumber, Rank,\n    ROW_NUMBER() OVER (PARTITION BY PhoneNumber ORDER BY Rank) AS RowNum\n  FROM RankedPhoneNumbers\n) AS Subquery\nWHERE RowNum = 1\nAND NOT EXISTS (SELECT * FROM dbo.Store_PhoneNumbers WHERE PhoneNumber = Subquery.PhoneNumber);