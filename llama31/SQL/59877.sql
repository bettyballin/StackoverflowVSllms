WITH RecursiveCategories AS (\n  SELECT CategoryId, ParentCategoryId, 0 AS Level\n  FROM Categories\n  WHERE CategoryId = @SelectedCategoryId  -- anchor query\n\n  UNION ALL\n\n  SELECT c.CategoryId, c.ParentCategoryId, Level + 1\n  FROM Categories c\n  INNER JOIN RecursiveCategories p ON c.ParentCategoryId = p.CategoryId\n)\nSELECT p.*\nFROM Products p\nINNER JOIN RecursiveCategories rc ON p.CategoryId = rc.CategoryId;