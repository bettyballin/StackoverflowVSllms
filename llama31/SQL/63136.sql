WITH \n  AllTables(TableName) AS\n  (\n    SELECT OBJECT_SCHEMA_NAME(so.id) +'.'+ OBJECT_NAME(so.id) \n    FROM dbo.sysobjects so \n    INNER JOIN sys.all_columns ac ON \n      so.ID = ac.object_id\n    WHERE\n      so.type = 'U'\n    AND\n      ac.is_rowguidcol = 1\n  ),\n  \n  Relationships(ReferenceTableName, ReferenceColumnName, TableName, ColumnName)  AS\n  (\n    SELECT  \n      OBJECT_SCHEMA_NAME (fkey.referenced_object_id) + '.' +  \n      OBJECT_NAME (fkey.referenced_object_id) AS ReferenceTableName \n      ,COL_NAME(fcol.referenced_object_id, \n                fcol.referenced_column_id) AS ReferenceColumnName \n      ,OBJECT_SCHEMA_NAME (fkey.parent_object_id) + '.' +  \n      OBJECT_NAME(fkey.parent_object_id) AS TableName \n      ,COL_NAME(fcol.parent_object_id, fcol.parent_column_id) AS ColumnName \n    FROM sys.foreign_keys AS fkey \n      INNER JOIN sys.foreign_key_columns AS fcol ON \n             fkey.OBJECT_ID = fcol.constraint_object_id \n  ),\n  \n  NotReferencedOrReferencing(TableName) AS\n  (\n    SELECT TableName FROM AllTables\n    EXCEPT\n    SELECT TableName FROM Relationships\n    EXCEPT\n    SELECT ReferenceTableName FROM Relationships\n  ),\n  \n  OnlyReferenced(Tablename) AS\n  (\n    SELECT ReferenceTableName FROM Relationships\n    EXCEPT\n    SELECT TableName FROM Relationships\n  ),\n  \n  ReferencedAndReferencing(TableName, ReferenceTableName, Level) AS\n  (\n    SELECT r1.Tablename, r2.ReferenceTableName, 0 AS Level \n    FROM Relationships r1 \n    INNER JOIN Relationships r2\n    ON r1.TableName = r2.ReferenceTableName   \n    WHERE r1.TableName NOT IN (SELECT ReferenceTableName FROM Relationships)\n    UNION ALL\n    SELECT r.TableName, rr.ReferenceTableName, Level + 1\n    FROM ReferencedAndReferencing r\n    INNER JOIN Relationships rr\n    ON r.TableName = rr.ReferenceTableName\n  ),\n  \n  OnlyReferencing(TableName) AS\n  (\n    SELECT Tablename FROM Relationships\n    EXCEPT\n    SELECT ReferenceTablename FROM Relationships\n  )\n  \nSELECT TableName, 1000 AS Sorting FROM NotReferencedOrReferencing\nUNION\nSELECT TableName, 2000 AS Sorting FROM OnlyReferenced \nUNION\nSELECT TableName, 3000 + Level AS Sorting FROM ReferencedAndReferencing\nUNION\nSELECT TableName, 4000 AS Sorting FROM OnlyReferencing\nORDER BY Sorting