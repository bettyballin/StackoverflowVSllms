INSERT INTO #temp2 (StoreId, StoreDesc, CommittedQty)\nSELECT StoreId, StoreDesc, SUM(CommittedQty) AS CommittedQty\nFROM (\n  SELECT StoreId, StoreDesc,\n    CASE WHEN ReservedQty > QtyOnHand THEN\n      sum(QtyOnHand * AvgPrice)\n    ELSE\n      sum(ReservedQty * AvgPrice)\n    END AS CommittedQty\n  FROM #temp1\n  GROUP BY StoreId, StoreDesc, QtyOnHand, ReservedQty\n) AS subquery\nGROUP BY StoreId, StoreDesc