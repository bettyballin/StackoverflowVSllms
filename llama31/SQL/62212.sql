LEFT OUTER JOIN \n    (\n        SELECT \n            tr2.*,\n            ROW_NUMBER() OVER (PARTITION BY tr2.person_id ORDER BY tr2.date DESC) AS row_num\n        FROM \n            [transaction] tr2\n        LEFT OUTER JOIN \n            [d_vendor] ins2\n        ON \n            ins2.d_vendor_id = tr2.d_vendor_id\n        LEFT OUTER JOIN \n            [d_product_type] prodtype2\n        ON \n            prodtype2.d_product_type_id = tr2.d_product_type_id\n        LEFT OUTER JOIN \n            [d_commission_type] ctype2\n        ON \n            ctype2.d_commission_type_id = tr2.d_commission_type_id\n        WHERE\n            prodtype2.name <> 'Medicare Part D'\n            AND tr2.termdate IS NOT NULL\n    ) AS b_t\nON\n    b_t.person_id = p.person_id AND b_t.row_num = 1