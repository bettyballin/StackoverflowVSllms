CREATE GLOBAL TEMPORARY TABLE temp_ids (ID NUMBER) ON COMMIT DELETE ROWS;\n\nINSERT INTO TEST_B (ID, BATCH, WHO, AMT)\nSELECT TEST_B_SEQ.NEXTVAL, 42, WHO, AMT\nFROM (\n  SELECT SRC AS WHO, SUM(AMT) AMT\n  FROM TEST_P\n  WHERE B_ID_SRC IS NULL AND B_ID_DEST IS NULL\n  GROUP BY SRC\n  UNION ALL\n  SELECT DEST, -SUM(AMT)\n  FROM TEST_P\n  WHERE B_ID_SRC IS NULL AND B_ID_DEST IS NULL\n  GROUP BY DEST\n)\nRETURNING ID INTO temp_ids;\n\nUPDATE TEST_P\nSET B_ID_SRC = (SELECT ID FROM TEST_B WHERE BATCH = 42 AND TEST_P.SRC = WHO),\n    B_ID_DEST = (SELECT ID FROM TEST_B WHERE BATCH = 42 AND TEST_P.DEST = WHO)\nWHERE ID IN (SELECT ID FROM temp_ids);