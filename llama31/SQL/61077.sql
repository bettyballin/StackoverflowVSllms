WITH \n  -- Calculate the number of previous referrals for each type and referrer\n  prev_referrals AS (\n    SELECT \n      referrer, \n      type, \n      COUNT(*) AS prev_count\n    FROM \n      referrals\n    GROUP BY \n      referrer, \n      type\n  ),\n  \n  -- Calculate the commission level for each referral\n  commission_levels AS (\n    SELECT \n      r.referrer, \n      r.type, \n      r.date, \n      CASE \n        WHEN p.prev_count = 0 THEN \n          CASE \n            WHEN r.type = 'A' THEN ra.Comm_A1\n            WHEN r.type = 'B' THEN ra.Comm_B1\n          END\n        WHEN p.prev_count = 1 THEN \n          CASE \n            WHEN r.type = 'A' THEN ra.Comm_A2\n            WHEN r.type = 'B' THEN ra.Comm_B2\n          END\n        ELSE \n          CASE \n            WHEN r.type = 'A' THEN ra.Comm_A3\n            WHEN r.type = 'B' THEN ra.Comm_B3\n          END\n      END AS commission\n    FROM \n      referrals r\n      JOIN prev_referrals p ON r.referrer = p.referrer AND r.type = p.type\n      JOIN referrer_rates ra ON r.referrer = ra.Referrer\n  )\n\n-- Filter results by date range and calculate total commission for each referral type\nSELECT \n  referrer, \n  SUM(CASE WHEN type = 'A' THEN commission ELSE 0 END) AS Type_A_Comm, \n  SUM(CASE WHEN type = 'A' THEN 1 ELSE 0 END) AS Type_A_Ref, \n  SUM(CASE WHEN type = 'B' THEN commission ELSE 0 END) AS Type_B_Comm, \n  SUM(CASE WHEN type = 'B' THEN 1 ELSE 0 END) AS Type_B_Ref\nFROM \n  commission_levels\nWHERE \n  date BETWEEN '2008-12-01' AND '2009-02-28'\nGROUP BY \n  referrer