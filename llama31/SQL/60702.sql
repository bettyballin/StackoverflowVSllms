SELECT r.rangeId, d.aDate, \n       CASE WHEN d.doUse = 1 THEN dy.qty ELSE 0 END AS qty\nFROM Range r\nJOIN (\n  SELECT r.rangeId, d.aDate, d.doUse,\n         SUM(d.doUse) OVER (PARTITION BY r.rangeId ORDER BY d.aDate) AS day\n  FROM Range r\n  JOIN Dates d ON d.aDate >= r.startDate\n) d ON r.rangeId = d.rangeId\nJOIN Days dy ON dy.rangeId = r.rangeId AND dy.day = d.day\nORDER BY r.rangeId, d.aDate ASC;