CREATE PROCEDURE ApplyPayment\n    @CustomerId VARCHAR(8),\n    @Payment DECIMAL(9, 2)\nAS\nBEGIN\n    DECLARE @CurrentInvoiceId VARCHAR(8)\n    DECLARE @CurrentInvoiceBalance DECIMAL(9, 2)\n    DECLARE @DaysOpen SMALLINT\n    DECLARE @RemainingPayment DECIMAL(9, 2)\n\n    SET @RemainingPayment = @Payment\n\n    DECLARE cur CURSOR FOR\n        SELECT id, balance, daysOpen\n        FROM openitems\n        WHERE id = @CustomerId\n        ORDER BY daysOpen DESC\n\n    OPEN cur\n\n    FETCH NEXT FROM cur INTO @CurrentInvoiceId, @CurrentInvoiceBalance, @DaysOpen\n\n    WHILE @@FETCH_STATUS = 0 AND @RemainingPayment > 0\n    BEGIN\n        IF @RemainingPayment >= @CurrentInvoiceBalance\n        BEGIN\n            SET @RemainingPayment = @RemainingPayment - @CurrentInvoiceBalance\n            UPDATE openitems\n            SET balance = 0.00\n            WHERE id = @CurrentInvoiceId\n        END\n        ELSE\n        BEGIN\n            UPDATE openitems\n            SET balance = balance - @RemainingPayment\n            WHERE id = @CurrentInvoiceId\n            SET @RemainingPayment = 0\n        END\n\n        FETCH NEXT FROM cur INTO @CurrentInvoiceId, @CurrentInvoiceBalance, @DaysOpen\n    END\n\n    CLOSE cur\n    DEALLOCATE cur\nEND\nGO