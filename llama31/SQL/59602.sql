-- Create a numbers table\nCREATE TABLE Numbers (\n    Number int PRIMARY KEY\n)\n\n-- Populate the numbers table\nINSERT INTO Numbers (Number)\nSELECT TOP 1000 ROW_NUMBER() OVER (ORDER BY t1.object_id) \nFROM master.sys.all_columns t1 \nCROSS JOIN master.sys.all_columns t2\n\n-- Create a function to get the dates between two dates\nCREATE FUNCTION GetDates (@StartDate datetime, @EndDate datetime)\nRETURNS @Dates TABLE (Date datetime)\nAS\nBEGIN\n    INSERT INTO @Dates (Date)\n    SELECT DATEADD(day, Number - 1, @StartDate)\n    FROM Numbers\n    WHERE Number <= DATEDIFF(day, @StartDate, ISNULL(@EndDate, GETDATE())) + 1\n    RETURN\nEND\n\n-- Use the function to get the dates for each absence\nSELECT \n    StaffID,\n    YEAR(Date) AS Year,\n    MONTH(Date) AS Month,\n    COUNT(*) AS AbsenceDays\nFROM \n    Absence a\n    CROSS APPLY GetDates(a.StartDate, a.EndDate) d\nGROUP BY \n    StaffID, \n    YEAR(Date), \n    MONTH(Date)\nORDER BY \n    StaffID, \n    Year, \n    Month