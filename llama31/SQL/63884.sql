DECLARE @sql nvarchar(max) = '';\nDECLARE @pivotList nvarchar(max) = '';\n\nSELECT @pivotList += '[' + Btype + '],' \nFROM #tmp \nGROUP BY Btype;\n\nSET @pivotList = LEFT(@pivotList, LEN(@pivotList) - 1); -- remove trailing comma\n\nSET @sql = '\n    SELECT Atype, ' + @pivotList + '\n    FROM \n    (\n        SELECT Atype, Btype, COUNT(*) as Count\n        FROM #tmp\n        GROUP BY Atype, Btype\n    ) AS SourceTable\n    PIVOT \n    (\n        SUM(Count)\n        FOR Btype IN (' + @pivotList + ')\n    ) AS PivotTable\n';\n\nEXEC sp_executesql @sql;