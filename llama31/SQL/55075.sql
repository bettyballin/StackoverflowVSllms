SELECT \n  u.userid, \n  u.cnt, \n  COALESCE(w.winner_elo, l.loser_elo) as current_elo\nFROM \n  (\n    SELECT \n      userid, \n      COUNT(*) as cnt\n    FROM \n      (\n        SELECT \n          winner as userid\n        FROM \n          webl_games g\n        WHERE \n          g.reported_on > NOW() - INTERVAL 4 DAY\n        UNION ALL\n        SELECT \n          loser as userid\n        FROM \n          webl_games g\n        WHERE \n          g.reported_on > NOW() - INTERVAL 4 DAY\n      ) t\n    GROUP BY \n      userid\n    HAVING \n      COUNT(*) >= 3\n  ) u\n  LEFT JOIN \n  (\n    SELECT \n      winner, \n      winner_elo, \n      ROW_NUMBER() OVER (PARTITION BY winner ORDER BY reported_on DESC) as rn\n    FROM \n      webl_games\n  ) w ON u.userid = w.winner AND w.rn = 1\n  LEFT JOIN \n  (\n    SELECT \n      loser, \n      loser_elo, \n      ROW_NUMBER() OVER (PARTITION BY loser ORDER BY reported_on DESC) as rn\n    FROM \n      webl_games\n  ) l ON u.userid = l.loser AND l.rn = 1\nORDER BY \n  current_elo DESC;