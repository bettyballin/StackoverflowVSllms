CREATE TABLE Patrols (\n    PatrolID INT PRIMARY KEY,\n    GuardID INT,\n    Starts DATETIME,\n    Ends DATETIME\n);\n\nCREATE INDEX IX_Patrols_GuardID_Starts_Ends ON Patrols (GuardID, Starts, Ends);\n\nCREATE TRIGGER TR_Patrols_PreventOverlappingPatrols ON Patrols\nINSTEAD OF INSERT, UPDATE\nAS\nBEGIN\n    SET NOCOUNT ON;\n\n    IF EXISTS (\n        SELECT 1\n        FROM inserted i\n        JOIN Patrols p ON i.GuardID = p.GuardID\n        WHERE p.Starts < i.Ends AND p.Ends > i.Starts\n        AND p.PatrolID <> i.PatrolID\n    )\n    BEGIN\n        RAISERROR ('Overlapping patrols detected.', 16, 1);\n        ROLLBACK TRANSACTION;\n    END\nEND;