SELECT \n    r.system, \n    AVG(ActiveCalls) AS AverageConcurrentCalls\nFROM \n    (\n        SELECT \n            m.Minute, \n            r.system, \n            COUNT(*) AS ActiveCalls\n        FROM \n            #Minutes m\n        JOIN \n            Records r ON \n                r.date = CONVERT(VARCHAR(8), m.Minute, 112) AND \n                r.time = CONVERT(VARCHAR(4), m.Minute, 114) AND \n                m.Minute BETWEEN DATEADD(s, r.seconds, '1970-01-01') AND DATEADD(s, r.seconds + r.dur, '1970-01-01')\n        GROUP BY \n            m.Minute, \n            r.system\n    ) AS Subquery\nGROUP BY \n    r.system