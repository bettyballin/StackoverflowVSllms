SELECT i.*\nFROM items i\nLEFT JOIN (\n  SELECT it.item_id,\n         MAX(CASE WHEN t.name IN ('p1', 'p2', ..., 'pn') THEN 1 ELSE 0 END) AS has_required_tags,\n         MAX(CASE WHEN t.name IN ('n1', 'n2', ..., 'nk') THEN 1 ELSE 0 END) AS has_excluded_tags\n  FROM item_tags it\n  JOIN tags t ON it.tag_id = t.id\n  GROUP BY it.item_id\n) AS tag_conditionals ON i.id = tag_conditionals.item_id\nWHERE tag_conditionals.has_required_tags = 1 AND tag_conditionals.has_excluded_tags = 0;