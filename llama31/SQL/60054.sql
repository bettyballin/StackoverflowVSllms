CREATE TABLE #order (\n    orderId INT PRIMARY KEY CLUSTERED,\n    customerId INT NOT NULL,\n    orderDateTime DATETIME NOT NULL\n);\n\nINSERT INTO #order (orderId, customerId, orderDateTime)\nVALUES\n(1, 100, '2009-01-01'),\n(2, 101, '2009-01-02'),\n(3, 102, '2009-01-03'),\n(4, 103, '2009-01-04'),\n(5, 100, '2009-01-05'),\n(6, 101, '2009-01-06'),\n(7, 101, '2009-01-07'),\n(8, 103, '2009-01-08'),\n(9, 105, '2009-01-09'),\n(10, 100, '2009-01-10'),\n(11, 101, '2009-01-11'),\n(12, 102, '2009-01-12'),\n(13, 103, '2009-01-13'),\n(14, 100, '2009-01-14'),\n(15, 100, '2009-01-15'),\n(16, 101, '2009-01-16'),\n(17, 102, '2009-01-17'),\n(18, 101, '2009-01-18'),\n(19, 100, '2009-01-19'),\n(20, 101, '2009-01-20');\n\nCREATE NONCLUSTERED INDEX IX_order_customerId ON #order (customerId);\n\nSELECT orderId, CustomerId, orderDateTime\n    , ROW_NUMBER() OVER (PARTITION BY customerId ORDER BY orderDateTime) RN\nFROM #order;