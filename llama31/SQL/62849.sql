SELECT `first_name`, `last_name`, `email`, `guaranteed_postcode`\nFROM (\n  SELECT `users`.`first_name`, `users`.`last_name`, `users`.`email`,\n  SUBSTRING(`locations`.`raw`,-6,4) AS `guaranteed_postcode`\n  FROM `users` LEFT OUTER JOIN `locations`\n  ON `users`.`id` = `locations`.`user_id`\n) AS `subquery`\nWHERE `guaranteed_postcode` NOT IN (\n  SELECT `postcode` FROM `postcodes` WHERE `region` IN ('australia')\n)