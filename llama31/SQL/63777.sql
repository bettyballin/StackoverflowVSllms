CREATE TABLE calendar (\n  date DATE PRIMARY KEY,\n  is_off_day BOOLEAN\n);\n\nINSERT INTO calendar (date, is_off_day)\nSELECT date, date IN (SELECT off_day FROM off_days)\nFROM generate_series('2008-01-01', '2008-12-31', '1 day');\n\nWITH RECURSIVE dates AS (\n  SELECT order_date, lead_time, 0 AS day_count\n  FROM orders\n  JOIN lead_time ON orders.product_id = lead_time.product_id\n  UNION ALL\n  SELECT DATE_ADD(dates.order_date, INTERVAL 1 DAY), lead_time, day_count + 1\n  FROM dates\n  JOIN calendar ON dates.order_date = calendar.date\n  WHERE day_count < lead_time\n  AND NOT calendar.is_off_day\n)\nSELECT MAX(order_date) AS effective_date\nFROM dates\nWHERE day_count = lead_time;