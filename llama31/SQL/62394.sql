WITH RankedStudents AS (\n  SELECT \n    ProfessorID, \n    StudentID, \n    Mark, \n    ROW_NUMBER() OVER (PARTITION BY ProfessorID ORDER BY Mark DESC) AS Rank\n  FROM \n    YourTable\n)\nSELECT \n  ProfessorID, \n  StudentID, \n  Mark\nFROM \n  RankedStudents\nWHERE \n  Rank <= 2 AND ProfessorID IN (\n    SELECT \n      ProfessorID\n    FROM \n      YourTable\n    GROUP BY \n      ProfessorID\n    HAVING \n      COUNT(DISTINCT StudentID) >= 2\n  )\nORDER BY \n  ProfessorID, \n  Mark DESC;