SELECT \n  z1.zip, \n  COUNT(UNIQUE address_id) LOCATIONS\nFROM \n  records \n  INNER JOIN addresses a USING (address_id)\n  INNER JOIN zip_coords z1 USING (zip)\n  INNER JOIN (\n    SELECT \n      z2.zip, \n      distance(z2.latitude, z2.longitude, z1.latitude, z1.longitude) d\n    FROM \n      zip_coords z2\n    WHERE \n      z2.zip IN (SELECT zip FROM available_zips)\n  ) z2 ON z1.zip = z2.zip AND z2.d <= 50\nGROUP BY \n  z1.zip