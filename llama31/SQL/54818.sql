SELECT \n    td.transaction_id,\n    sum(\n        IF( \n            coalesce(ti.na, -1) = 0\n            AND coalesce(ti.special_info_type, -1) = 0\n            AND coalesce(ti.item_type, '') = 'P'\n            AND coalesce(ti.comp_id, 0) <= 0,\n            coalesce(disc_amt, 0),\n            0\n        )\n    ) as disc_sum,\n    sum(\n        IF( \n            coalesce(ti.na, -1) = 0\n            AND coalesce(ti.special_info_type, -1) = 0\n            AND coalesce(ti.item_type, '') = 'P'\n            AND coalesce(ti.comp_id, 0) > 0,\n            coalesce(comp_amt, 0),\n            0\n        )\n    ) as cSM,\n    sum(\n        IF( \n            coalesce(ti.na, -1) = 0\n            AND coalesce(ti.special_info_type, -1) = 0\n            AND coalesce(ti.item_type, '') = 'P'\n            AND coalesce(ti.comp_id, 0) > 0,\n            coalesce(comp_tax, 0),\n            0\n        )\n    ) as cTX,\n    (\n        SELECT  \n            count(x.id) as refCnt,\n            coalesce(sum(x.item_price + x.sub_price), 0) as refAmt,\n            coalesce(sum(x.efftax), 0) as refTax\n        from(\n            SELECT  \n                (tiP.item_price - tiP.comp_amt) as item_price,\n                coalesce(sum(tiA.item_price), 0) as sub_price,\n                (tiP.efftax - tiP.comp_tax) as efftax,\n                tiP.id\n            from transaction_items tiP\n            left outer join transaction_items tiA\n                on( \n                    tiP.id = tiA.ref_id\n                    and tiA.item_type = 'A'\n                    and tiA.na = 0\n                ) \n            where   \n                tiP.item_type = 'P'\n                and tiP.na = 0\n                and tiP.refund = 1\n                and tiP.transaction_id = td.transaction_id\n            group by tiP.id\n            order by tiP.transaction_id, tiP.order_id\n        ) as x\n    ) as refund_details\nFROM transaction_details td\nLEFT OUTER JOIN transaction_items ti\n    ON ti.transaction_id = td.transaction_id\nWHERE   \n    td.na = 0\n    AND td.entry_TS >= ?\n    AND td.entry_TS <  ?\nGROUP BY td.transaction_id;