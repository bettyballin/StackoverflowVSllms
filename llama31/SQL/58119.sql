WITH ranked_temps AS (\n  SELECT city, temperature,\n         ROW_NUMBER() OVER (PARTITION BY city ORDER BY temperature) AS rownum,\n         COUNT(*) OVER (PARTITION BY city) AS city_count\n  FROM weather_history\n),\nmedian_temps AS (\n  SELECT city, temperature\n  FROM ranked_temps\n  WHERE rownum IN (FLOOR((city_count + 1) / 2.0), CEILING((city_count + 1) / 2.0))\n)\nSELECT city, \n       AVG(temperature) AS mean_temp, \n       DECIMAL(AVG(temperature), 10, 2) AS median_temp\nFROM median_temps\nGROUP BY city;