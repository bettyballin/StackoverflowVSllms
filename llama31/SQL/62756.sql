BEGIN TRAN\n\nDECLARE @CONTACT_ID VARCHAR(15)\nDECLARE @TYPE VARCHAR(15)\nDECLARE @INDEX_NO  SMALLINT\nDECLARE @COUNTER SMALLINT\nDECLARE @OUTER_FETCH_STATUS INT \nDECLARE @INNER_FETCH_STATUS INT \n\nDECLARE OUTER_CURSOR CURSOR \nFOR \nSELECT CONTACT_ID, TYPE, INDEX_NO FROM CONTACTS\nWHERE  \nCONTACT_ID IN (SELECT CONTACT_ID FROM dbo.CONTACTS\nWHERE CONTACT_ID IN(...)\nGROUP BY CONTACT_ID, TYPE, INDEX_NO\nHAVING COUNT(*) > 1\n\nOPEN OUTER_CURSOR \n\nFETCH NEXT FROM OUTER_CURSOR INTO @CONTACT_ID,  @TYPE, @INDEX_NO\nSET @OUTER_FETCH_STATUS = @@FETCH_STATUS\nWHILE (@OUTER_FETCH_STATUS <> -1)\nBEGIN\n    IF (@OUTER_FETCH_STATUS <> -2)\n    BEGIN\n        SET @COUNTER = 1\n\n        DECLARE INNER_CURSOR CURSOR \n        FOR \n        SELECT * FROM CONTACTS\n        WHERE CONTACT_ID = @CONTACT_ID\n        AND TYPE = @TYPE \n        FOR UPDATE \n\n        OPEN INNER_CURSOR \n\n        FETCH NEXT FROM INNER_CURSOR \n        SET @INNER_FETCH_STATUS = @@FETCH_STATUS\n        WHILE (@INNER_FETCH_STATUS <> -1)\n        BEGIN\n            IF (@INNER_FETCH_STATUS <> -2)\n            BEGIN\n                UPDATE CONTACTS\n                SET INDEX_NO = @COUNTER\n                WHERE CURRENT OF INNER_CURSOR\n\n                SET @COUNTER = @COUNTER + 1\n            END\n\n            FETCH NEXT FROM INNER_CURSOR \n            SET @INNER_FETCH_STATUS = @@FETCH_STATUS\n        END\n        CLOSE INNER_CURSOR\n        DEALLOCATE INNER_CURSOR\n    END\n\n    FETCH NEXT FROM OUTER_CURSOR INTO @CONTACT_ID,  @TYPE, @INDEX_NO\n    SET @OUTER_FETCH_STATUS = @@FETCH_STATUS\nEND\nCLOSE OUTER_CURSOR\nDEALLOCATE OUTER_CURSOR\n\nCOMMIT TRAN