WITH RankedUpdates AS (\n  SELECT UpdateID,\n         ProductID,\n         UpdateDateTime,\n         QuantityOnHand,\n         ROW_NUMBER() OVER (PARTITION BY CONVERT(DATE, UpdateDateTime), ProductID\n                            ORDER BY UpdateDateTime DESC) AS RowNum\n  FROM InventoryHistory\n  WHERE UpdateDateTime < DATEADD(hour, 17, CONVERT(DATE, UpdateDateTime))  -- filter out updates after 5 PM\n    AND ProductID = 1\n    AND UpdateDateTime >= DATEADD(day, -30, GETDATE())  -- filter last 30 days\n)\nSELECT UpdateID, ProductID, UpdateDateTime, QuantityOnHand\nFROM RankedUpdates\nWHERE RowNum = 1;