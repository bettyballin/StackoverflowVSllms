CREATE PROC [dbo].[UpdateProductDetails]\nAS\nBEGIN\n    BEGIN TRANSACTION;\n\n    UPDATE PRODUCTDETAILS SET E_CIKAN = 0;\n\n    DECLARE @ID int,\n            @SK varchar(50),\n            @DP varchar(50),\n            @DEMAND float;\n\n    DECLARE SH CURSOR FAST_FORWARD FOR\n    SELECT [ID], PRODUCTID, QTY, EXITDEPOT\n    FROM PRODUCTDETAILS\n    WHERE (EXITDEPOT IS NOT NULL)\n    ORDER BY [DATE] ASC;\n\n    OPEN SH;\n\n    FETCH NEXT FROM SH INTO @ID, @SK, @DEMAND, @DP;\n\n    WHILE (@@FETCH_STATUS = 0)\n    BEGIN\n        DECLARE @SUBID int,\n                @SUBQTY float,\n                @SUBCK float,\n                @REMAINS float;\n\n        DECLARE SA CURSOR FAST_FORWARD FOR\n        SELECT [ID], QTY, E_CIKAN\n        FROM PRODUCTDETAILS\n        WHERE (QTY > E_CIKAN) AND (PRODUCTID = @SK) AND (ENTRYDEPOT = @DP)\n        ORDER BY [DATE] ASC;\n\n        OPEN SA;\n\n        FETCH NEXT FROM SA INTO @SUBID, @SUBQTY, @SUBCK;\n\n        WHILE (@@FETCH_STATUS = 0) AND (@DEMAND > 0)\n        BEGIN\n            SET @REMAINS = @SUBQTY - @SUBCK;\n\n            IF @DEMAND > @REMAINS\n            BEGIN\n                UPDATE PRODUCTDETAILS SET E_CIKAN = QTY WHERE ID = @SUBID;\n                SET @DEMAND = @DEMAND - @REMAINS;\n            END\n            ELSE\n            BEGIN\n                UPDATE PRODUCTDETAILS SET E_CIKAN = E_CIKAN + @DEMAND WHERE ID = @SUBID;\n                SET @DEMAND = 0;\n            END\n\n            FETCH NEXT FROM SA INTO @SUBID, @SUBQTY, @SUBCK;\n        END\n\n        CLOSE SA;\n        DEALLOCATE SA;\n\n        FETCH NEXT FROM SH INTO @ID, @SK, @DEMAND, @DP;\n    END\n\n    CLOSE SH;\n    DEALLOCATE SH;\n\n    COMMIT TRANSACTION;\nEND;