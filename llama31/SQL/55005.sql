WITH FilteredLog AS (\n  SELECT *\n  FROM t_log\n  WHERE Date BETWEEN '2007/11/1' AND '2007/11/30'\n  AND Log_Type = 'Critical'\n)\nSELECT lo4.*\nFROM (\n  SELECT CASE WHEN ln.log_id IS NULL THEN lo2.log_id ELSE ln.log_id END\n  AS log_id, ROW_NUMBER() OVER (PARTITION BY lo2.fb_id ORDER BY lo2.cdate) AS rn \n  FROM (\n    SELECT lo.*,\n      (SELECT TOP 1 log_id\n      FROM FilteredLog li WHERE li.fb_id = lo.fb_id AND li.cdate >= lo.cdate\n      AND li.log_id  lo.log_id AND li.log_name  lo.log_name\n      ORDER BY cdate, log_id)\n    AS next_id\n    FROM FilteredLog lo\n  ) lo2 LEFT OUTER JOIN FilteredLog ln ON ln.log_id = lo2.next_id\n) lo3, FilteredLog lo4\nWHERE lo3.rn = 1 AND lo4.log_id = lo3.log_id