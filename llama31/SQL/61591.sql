UPDATE S\nSET StatusCode = 1\nFROM Stock S\nINNER JOIN (\n  SELECT ProductCode, MAX(ListDate) AS MaxListDate\n  FROM Stock\n  INNER JOIN Listed ON Stock.SKU = Listed.SKU\n  WHERE Stock.StatusCode = 2\n  GROUP BY ProductCode\n) AS Subquery ON S.ProductCode = Subquery.ProductCode\nINNER JOIN Listed ON S.SKU = Listed.SKU AND Listed.ListDate = Subquery.MaxListDate\nWHERE S.StatusCode = 2;