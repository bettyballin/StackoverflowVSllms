DECLARE @ResultTable table \n(\n  StaffName nvarchar(100),\n  Stage1Count int,\n  Stage2Count int\n)\n\n-- Insert all staff members with default counts\nINSERT INTO @ResultTable (StaffName, Stage1Count, Stage2Count)\nSELECT DISTINCT StaffName, 0, 0\nFROM ViewJob\n\n-- Update counts for each stage\nUPDATE rt\nSET Stage1Count = ISNULL(vj.Stage1Count, 0)\nFROM @ResultTable rt\nLEFT JOIN (\n  SELECT StaffName, COUNT(*) AS Stage1Count\n  FROM ViewJob\n  WHERE DateStarted IS NOT NULL AND DateFinished IS NULL\n  GROUP BY StaffName\n) vj ON rt.StaffName = vj.StaffName\n\nUPDATE rt\nSET Stage2Count = ISNULL(vj.Stage2Count, 0)\nFROM @ResultTable rt\nLEFT JOIN (\n  SELECT StaffName, COUNT(*) AS Stage2Count\n  FROM ViewJob\n  WHERE InStage2 = 1\n  GROUP BY StaffName\n) vj ON rt.StaffName = vj.StaffName