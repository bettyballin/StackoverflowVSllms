WITH src_subq AS (\n  SELECT SRC AS WHO, SUM(AMT) AMT\n  FROM TEST_P\n  WHERE B_ID_SRC IS NULL AND B_ID_DEST IS NULL\n  GROUP BY SRC\n  FOR UPDATE\n),\ndest_subq AS (\n  SELECT DEST, -SUM(AMT)\n  FROM TEST_P\n  WHERE B_ID_SRC IS NULL AND B_ID_DEST IS NULL\n  GROUP BY DEST\n  FOR UPDATE\n)\nINSERT INTO TEST_B (ID, BATCH, WHO, AMT)\nSELECT TEST_B_SEQ.NEXTVAL, 42, WHO, AMT\nFROM src_subq\nUNION ALL\nSELECT TEST_B_SEQ.NEXTVAL, 42, WHO, AMT\nFROM dest_subq;