UPDATE Table1 t1\nSET t1.DATE = (\n  SELECT MAX(t2.DATE)\n  FROM (\n    SELECT t2.DATE, SUM(t2.AMOUNT1) OVER (ORDER BY t2.DATE DESC) AS CUM_SUM\n    FROM Table2 t2\n    WHERE t2.ID = t1.ID\n  ) t2\n  WHERE t2.CUM_SUM <= t1.AMOUNT\n)