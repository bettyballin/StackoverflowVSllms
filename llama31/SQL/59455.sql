WITH conditions AS (\n  SELECT \n    'AND' as operator,\n    array[1, 3, 4] as criteria_ids\n  UNION ALL\n  SELECT \n    'OR' as operator,\n    array[5, 6, 7] as criteria_ids\n  UNION ALL\n  SELECT \n    'OR' as operator,\n    array[8, 9] as criteria_ids\n)\nSELECT \n  p.PersonID\nFROM \n  Person p\n  JOIN (\n    SELECT \n      pc.PersonID,\n      c.operator,\n      c.criteria_ids\n    FROM \n      PersonCriteria pc\n      JOIN conditions c ON pc.CriteriaID = ANY(c.criteria_ids)\n  ) k ON p.PersonID = k.PersonID\nGROUP BY \n  p.PersonID\nHAVING \n  COUNT(DISTINCT k.operator) = (SELECT COUNT(*) FROM conditions)\n  AND COUNT(DISTINCT k.criteria_ids) = (SELECT COUNT(*) FROM conditions);