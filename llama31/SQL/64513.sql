SELECT \n  name,\n  state,\n  SUM(duration) AS duration\nFROM (\n  SELECT \n    name,\n    state,\n    (END_TIME - START_TIME) AS duration\n  FROM (\n    SELECT \n      name,\n      state,\n      MIN(time) AS START_TIME,\n      MAX(time) AS END_TIME\n    FROM \n      your_table\n    WHERE \n      time BETWEEN '10:00 AM' AND '10:15 AM'\n    GROUP BY \n      name, state\n  ) AS subquery\n  WHERE \n    state IN ('chatting', 'Idle')\n  AND END_TIME IS NOT NULL\n) AS durations\nGROUP BY \n  name, state\nORDER BY \n  name, state;