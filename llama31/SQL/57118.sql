CREATE TABLE QueryLog (\n    id INT IDENTITY PRIMARY KEY, \n    execution_count BIGINT, \n    total_logical_reads BIGINT, \n    total_logical_writes BIGINT, \n    total_worker_time BIGINT, \n    total_elapsed_time BIGINT, \n    total_clr_time BIGINT, \n    total_physical_reads BIGINT, \n    total_physical_writes BIGINT, \n    query_text NVARCHAR(MAX), \n    query_plan XML, \n    log_time DATETIME DEFAULT GETDATE()\n);\n\nCREATE PROCEDURE LogExpensiveQueries\nAS\nBEGIN\n    INSERT INTO QueryLog (\n        execution_count, \n        total_logical_reads, \n        total_logical_writes, \n        total_worker_time, \n        total_elapsed_time, \n        total_clr_time, \n        total_physical_reads, \n        total_physical_writes, \n        query_text, \n        query_plan\n    )\n    SELECT TOP 10 \n        qs.execution_count, \n        qs.total_logical_reads, \n        qs.total_logical_writes, \n        qs.total_worker_time, \n        qs.total_elapsed_time, \n        qs.total_clr_time, \n        qs.total_physical_reads, \n        qs.total_physical_writes, \n        st.text AS query_text, \n        qp.query_plan AS query_plan\n    FROM \n        sys.dm_exec_query_stats qs\n    CROSS APPLY \n        sys.dm_exec_sql_text(qs.sql_handle) st\n    CROSS APPLY \n        sys.dm_exec_query_plan(qs.plan_handle) qp\n    ORDER BY \n        qs.total_elapsed_time DESC;\nEND;\n\n-- Create a SQL Agent job to run this procedure at regular intervals