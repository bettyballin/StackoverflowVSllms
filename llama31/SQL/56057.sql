WITH CorrectedOrderItems AS (\n  SELECT OrderID, Qty, Price,\n         CASE WHEN Qty < 0 AND MarkedUpTotal > 0\n              THEN -1 * MarkedUpTotal\n              ELSE MarkedUpTotal\n         END AS CorrectedMarkedUpTotal\n  FROM OrderItems\n)\nSELECT OrderID, SUM(Qty) AS OrderTotalQty,\n       SUM(Qty * Price) AS InternalCost,\n       SUM(CorrectedMarkedUpTotal) AS ClientCost\nFROM CorrectedOrderItems\nGROUP BY OrderID