WITH team_wins AS (\n  SELECT \n    team_id,\n    COUNT(*) AS wins\n  FROM (\n    SELECT \n      home_team_id AS team_id,\n      CASE WHEN home_score > away_score THEN 1 ELSE 0 END AS win\n    FROM game\n    WHERE date < DATE_SUB(CURRENT_DATE, INTERVAL 1 DAY)\n    UNION ALL\n    SELECT \n      away_team_id AS team_id,\n      CASE WHEN away_score > home_score THEN 1 ELSE 0 END AS win\n    FROM game\n    WHERE date < DATE_SUB(CURRENT_DATE, INTERVAL 1 DAY)\n  ) AS team_wins_subquery\n  GROUP BY team_id\n)\nSELECT \n  t.id,\n  g.home_team_id AS Home,\n  g.away_team_id AS Away,\n  tw.wins AS home_team_wins\nFROM ticket t\nJOIN game g ON g.id = t.game_id\nJOIN team_wins tw ON tw.team_id = g.home_team_id AND tw.date < DATE_SUB(t.time_sold, INTERVAL 1 DAY)