WITH SalesData AS (\n  SELECT \n    Branch,\n    DateOfSale,\n    SalesAmount,\n    DATEPART(wk, DateOfSale) AS WeekNumber,\n    DATEPART(dw, DateOfSale) AS DayOfWeek\n  FROM Sales\n),\nDailySales AS (\n  SELECT \n    Branch,\n    SUM(CASE WHEN DateOfSale = DATEADD(dd, -1, '2009-07-16') THEN SalesAmount ELSE 0 END) AS DailySales\n  FROM SalesData\n  GROUP BY Branch\n),\nDailyLFL AS (\n  SELECT \n    s1.Branch,\n    COALESCE(s2.SalesAmount, 0) AS DailyLFL,\n    CASE WHEN s2.SalesAmount IS NULL THEN 0 ELSE 1 END AS LFL\n  FROM SalesData s1\n  LEFT JOIN SalesData s2 ON s1.Branch = s2.Branch AND s2.DateOfSale = DATEADD(yy, -1, s1.DateOfSale)\n  WHERE s1.DateOfSale = DATEADD(dd, -1, '2009-07-16')\n),\nWTD AS (\n  SELECT \n    Branch,\n    SUM(CASE WHEN DateOfSale BETWEEN '2009-07-13' AND '2009-07-15' THEN SalesAmount ELSE 0 END) AS WTD\n  FROM SalesData\n  GROUP BY Branch\n),\nWTD_LFL AS (\n  SELECT \n    s1.Branch,\n    COALESCE(s2.WTD, 0) AS WTD_LFL\n  FROM WTD s1\n  LEFT JOIN (\n    SELECT \n      Branch,\n      SUM(CASE WHEN DateOfSale BETWEEN '2008-07-14' AND '2008-07-16' THEN SalesAmount ELSE 0 END) AS WTD\n    FROM SalesData\n    GROUP BY Branch\n  ) s2 ON s1.Branch = s2.Branch\n)\nSELECT \n  ds.Branch,\n  ds.DailySales,\n  dl.DailyLFL,\n  wt.WTD,\n  wl.WTD_LFL,\n  dl.LFL\nFROM DailySales ds\nJOIN DailyLFL dl ON ds.Branch = dl.Branch\nJOIN WTD wt ON ds.Branch = wt.Branch\nJOIN WTD_LFL wl ON ds.Branch = wl.Branch