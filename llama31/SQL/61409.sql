MERGE INTO USER_ALLOCATION ua\nUSING (\n  WITH \n    MONTHS as (select FROM_DT + ((ROWNUM-1) / (24*2)) as DT from DUAL connect by ROWNUM <= ((TO_DT - FROM_DT) * 24*2) + 1), \n    TIMES as (select DT as START_TIME,(DT + 1/48) as STOP_TIME from MONTHS where TO_NUMBER(TO_CHAR(DT,'HH24')) between 8 and 15 and TO_NUMBER(TO_CHAR(DT,'D')) not in (1,7))\n  SELECT \n    TIMES.START_TIME,\n    sysur_key USER_ID,\n    T.TASK_ID\n  FROM \n    TIMES \n    LEFT OUTER JOIN (ALLOCATED_USER u INNER JOIN REQUIRED_RESOURCE r ON u.AU_ID = r.RR_ID INNER JOIN TASK t ON r.TASK_ID = t.TASK_ID)\n      ON u.USER_ID = sysur_key AND t.PLAN_TYPE = 3 AND TIMES.start_time >= TRUNC30(t.START_DATE) AND TIMES.start_time < TRUNC30(t.FINISH_DATE)\n  WHERE u.USER_ID IS NULL OR u.USER_ID = sysur_key\n) src\nON (ua.START_TIME = src.START_TIME AND ua.USER_ID = src.USER_ID)\nWHEN NOT MATCHED THEN\n  INSERT (ua.START_TIME, ua.USER_ID, ua.TASK_ID)\n  VALUES (src.START_TIME, src.USER_ID, src.TASK_ID);