WITH RECURSIVE dates AS (\n  SELECT order_date, lead_time, 0 AS day_count\n  FROM orders\n  JOIN lead_time ON orders.product_id = lead_time.product_id\n  UNION ALL\n  SELECT DATE_ADD(dates.order_date, INTERVAL 1 DAY), lead_time, day_count + 1\n  FROM dates\n  JOIN lead_time ON dates.product_id = lead_time.product_id\n  WHERE day_count < lead_time\n  AND DATE_ADD(dates.order_date, INTERVAL 1 DAY) NOT IN (SELECT off_day FROM off_days)\n)\nSELECT MAX(order_date) AS effective_date\nFROM dates\nWHERE day_count = lead_time;