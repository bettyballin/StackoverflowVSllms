WITH \n  -- Get all orderlines for the customer\n  customer_orderlines AS (\n    SELECT ol.*, o.order_date, p.product_name\n    FROM orderlines ol\n    JOIN orders o ON ol.order_id = o.id\n    JOIN products p ON ol.product_id = p.id\n    WHERE o.customer_id = <customer_id>\n  ),\n  \n  -- Get the first purchase year for each product\n  first_purchase AS (\n    SELECT product_id, MIN(order_date) AS first_purchase_date\n    FROM customer_orderlines\n    GROUP BY product_id\n  ),\n  \n  -- Get the last three purchase dates for each product\n  last_purchases AS (\n    SELECT product_id, order_date\n    FROM (\n      SELECT product_id, order_date,\n             ROW_NUMBER() OVER (PARTITION BY product_id ORDER BY order_date DESC) AS row_num\n      FROM customer_orderlines\n    ) AS subquery\n    WHERE row_num <= 3\n  ),\n  \n  -- Get the latest comment for each product\n  latest_comment AS (\n    SELECT product_id, comment\n    FROM (\n      SELECT product_id, comment,\n             ROW_NUMBER() OVER (PARTITION BY product_id ORDER BY order_date DESC) AS row_num\n      FROM customer_orderlines\n    ) AS subquery\n    WHERE row_num = 1\n  ),\n  \n  -- Calculate the total income for each product in the last 12 months\n  total_income AS (\n    SELECT product_id, SUM(ol.quantity * p.price) AS total_income\n    FROM customer_orderlines ol\n    JOIN products p ON ol.product_id = p.id\n    WHERE ol.order_date >= DATE_TRUNC('year', CURRENT_DATE) - INTERVAL '1 year'\n    GROUP BY product_id\n  )\n\nSELECT \n  p.product_name,\n  fp.first_purchase_date AS first_purchase_year,\n  lp.order_date AS last_purchase_date,\n  lc.comment AS latest_comment,\n  ti.total_income\nFROM products p\nJOIN first_purchase fp ON p.id = fp.product_id\nJOIN last_purchases lp ON p.id = lp.product_id\nJOIN latest_comment lc ON p.id = lc.product_id\nJOIN total_income ti ON p.id = ti.product_id