WITH RecursiveEDR AS (\n    SELECT TOP 1 Id, ExtId, StartDate, EndDate, ApplyDate, 0 AS Level\n    FROM #t_edr\n    WHERE ExtId = @ExtID AND ApplyDate <= @dtDate\n    ORDER BY ApplyDate DESC\n    UNION ALL\n    SELECT e.Id, e.ExtId, e.StartDate, e.EndDate, e.ApplyDate, Level + 1\n    FROM #t_edr e\n    INNER JOIN RecursiveEDR r ON e.ExtId = r.ExtId AND e.ApplyDate < r.ApplyDate\n    WHERE (e.StartDate IS NULL OR e.StartDate <= @dtDate)\n    AND (e.EndDate IS NULL OR e.EndDate >= @dtDate)\n)\nSELECT TOP 1 ApplyDate\nFROM RecursiveEDR\nORDER BY Level DESC;