CREATE PROCEDURE sp_EncryptDecrypt\n    @data VARBINARY(MAX),\n    @keyName SYSNAME,\n    @algorithm SYSNAME,\n    @encrypt BIT = 1\nAS\nBEGIN\n    BEGIN TRY\n        OPEN SYMMETRIC KEY @keyName\n        IF @encrypt = 1\n            SELECT ENCRYPTBYKEY(@keyName, @algorithm, @data)\n        ELSE\n            SELECT DECRYPTBYKEY(@keyName, @algorithm, @data)\n        CLOSE SYMMETRIC KEY @keyName\n    END TRY\n    BEGIN CATCH\n        -- Handle errors and exceptions\n        DECLARE @ErrorMessage NVARCHAR(4000)\n        SET @ErrorMessage = ERROR_MESSAGE()\n        RAISERROR (@ErrorMessage, 16, 1)\n    END CATCH\nEND