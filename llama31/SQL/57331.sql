SELECT SUM(activity_amount) \nFROM (\n  SELECT MIN(f.points_sum - 20, a.activity) AS activity_amount\n  FROM activities a\n  JOIN (\n    SELECT name_id, SUM(points) AS points_sum\n    FROM foods\n    WHERE name_id IN (SELECT pk FROM dates WHERE weekly = 1)\n    GROUP BY name_id\n  ) f ON a.activity_id = f.name_id\n  WHERE a.activity_id IN (SELECT name_id FROM foods GROUP BY name_id HAVING SUM(points) > 20)\n) AS subquery;