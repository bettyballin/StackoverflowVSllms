WITH totalSalesSub AS (\n  SELECT groupNum, SUM((t.priceEach - (t.priceEach * m.margin)) * t.quantity) AS total\n  FROM financeMasters AS m\n  INNER JOIN temp AS t\n  ON m.id = t.id\n  GROUP BY groupNum\n)\nSELECT \n  m.id, \n  t.priceEach,\n  (t.priceEach - (t.priceEach * m.margin)) AS estCost,\n  ((t.priceEach - (t.priceEach * m.margin)) * t.quantity) AS salesSub,\n  ((t.priceEach - (t.priceEach * m.margin)) * t.quantity) / ts.total AS salesPercent\nINTO output\nFROM financeMasters AS m\nINNER JOIN temp AS t\nON m.id = t.id\nINNER JOIN totalSalesSub AS ts\nON m.groupNum = ts.groupNum