WITH Data AS (\n    SELECT \n        a,\n        b,\n        SUM(a) OVER (PARTITION BY a) AS suma\n    FROM (\n        SELECT 1 a,1 b UNION ALL\n        SELECT 2,2 UNION ALL\n        SELECT 2,NULL UNION ALL\n        SELECT 3,3 UNION ALL\n        SELECT 3,NULL UNION ALL\n        SELECT 3,NULL\n    ) AS InnerQuery\n)\nSELECT \n    a,\n    COUNT(DISTINCT b) AS countdistinctb,\n    MAX(suma) AS suma\nFROM \n    Data\nWHERE \n    b IS NOT NULL\nGROUP BY \n    a;