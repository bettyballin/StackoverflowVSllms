WITH events AS (\n  SELECT \n    id,\n    date,\n    event,\n    LAG(date) OVER (PARTITION BY id ORDER BY date) AS prev_date,\n    LAG(event) OVER (PARTITION BY id ORDER BY date) AS prev_event\n  FROM \n    event_table\n)\nSELECT \n  id,\n  SUM(CASE \n        WHEN event = 'Service Fulfilled' AND prev_event = 'Service Asignation' \n        THEN DATEDIFF(SECOND, prev_date, date) \n        WHEN event = 'Service Reactivated' AND prev_event = 'Service Delayed' \n        THEN -DATEDIFF(SECOND, prev_date, date) \n        ELSE 0 \n      END) AS time_spent\nFROM \n  events\nGROUP BY \n  id