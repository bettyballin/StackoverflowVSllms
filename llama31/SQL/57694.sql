SELECT \n  u.id AS owner,\n  [currency1],\n  [currency2],\n  [currency3]\nFROM \n  (SELECT \n     a.user_id,\n     c.name AS currency_name,\n     a.amount\n   FROM \n     accounts a\n   JOIN \n     currency c ON a.currency_id = c.id) AS SourceTable\nPIVOT \n  (SUM(amount) FOR currency_name IN ([currency1], [currency2], [currency3])) AS PivotTable\nJOIN \n  users u ON PivotTable.user_id = u.id