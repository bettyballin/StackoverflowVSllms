SELECT \n    e.name, \n    STRING_AGG(p.email, ';') AS email_addresses\nFROM \n    PERSON p\nINNER JOIN \n    EMPLOYEE e\nON \n    p.agentofrecord_id = e.employee_id\nWHERE \n    dbo.GetPersonMember(p.person_id) = 1\n    AND (p.isactive = 1)\n    AND p.email <> ''\nGROUP BY \n    e.name\nORDER BY \n    e.name