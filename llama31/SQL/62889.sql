WITH RankedResults AS (\n  SELECT \n    VisitingCount,\n    [Time],\n    ROW_NUMBER() OVER (PARTITION BY [Time] ORDER BY VisitingCount DESC) AS RowNum\n  FROM (\n    SELECT \n      SUM(VisitingCount) AS VisitingCount, \n      [Time]\n    FROM #Temp \n    GROUP BY [Time]\n    UNION ALL\n    SELECT \n      COUNT(page) AS VisitingCount, \n      (DATEPART(hour, Date) * 60 + DATEPART(minute, Date)) / 30 AS [Time]\n    FROM scr_SecuristLog\n    WHERE Date BETWEEN '2009-05-04 10:30' AND '2009-05-04 12:30'\n    GROUP BY (DATEPART(hour, Date) * 60 + DATEPART(minute, Date)) / 30\n  ) AS CombinedResults\n)\nSELECT \n  VisitingCount,\n  [Time]\nFROM RankedResults\nWHERE RowNum = 1\nORDER BY [Time] ASC;