SELECT \n  cur.element_id,\n  cur.category,\n  cur.source_prefix,\n  cur.source_name,\n  cur.date_updated,\n  AVG(cur.value) AS avg_value,\n  SUM(cur.value * cur.weight) / SUM(cur.weight) AS rating\nFROM \n  bigbigtable cur\n  INNER JOIN (\n    SELECT \n      category,\n      element_id,\n      source_prefix,\n      source_name,\n      MAX(date_updated) AS maxdate\n    FROM \n      bigbigtable\n    WHERE \n      date_updated <= '2009-04-28'\n    GROUP BY \n      category, element_id, source_prefix, source_name\n  ) next \n  ON cur.category = next.category \n  AND cur.element_id = next.element_id \n  AND cur.source_prefix = next.source_prefix \n  AND cur.source_name = next.source_name \n  AND cur.date_updated = next.maxdate\nGROUP BY \n  cur.category, cur.element_id, cur.date_updated;