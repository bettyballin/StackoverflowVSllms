WITH LoginEvents AS (\n  SELECT \n    UserID, \n    DateOnly, \n    DateTimeStamp AS LoginTime\n  FROM \n    AuditData\n  WHERE \n    ActivityCode = 1\n),\nUserDataEvents AS (\n  SELECT \n    UserID, \n    DateOnly, \n    DateTimeStamp AS UserDataTime\n  FROM \n    AuditData\n  WHERE \n    ActivityCode = 2\n)\nSELECT \n  LE.UserID, \n  LE.DateOnly, \n  AVG(UE.UserDataTime - LE.LoginTime) AS AverageResponseTime\nFROM \n  LoginEvents LE\n  JOIN (\n    SELECT \n      UserID, \n      DateOnly, \n      MIN(DateTimeStamp) AS UserDataTime\n    FROM \n      UserDataEvents\n    GROUP BY \n      UserID, \n      DateOnly\n  ) UE ON LE.UserID = UE.UserID AND LE.DateOnly = UE.DateOnly\nGROUP BY \n  LE.UserID, \n  LE.DateOnly