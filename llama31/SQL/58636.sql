WITH job_status AS (\n  SELECT job_id,\n         MAX(CASE WHEN status = 3 THEN 1 ELSE 0 END) AS all_done,\n         MAX(CASE WHEN completed_date = TRUNC(SYSDATE) THEN 1 ELSE 0 END) AS done_today\n  FROM tasks\n  GROUP BY job_id\n)\nSELECT t.task_id,\n       t.job_id,\n       t.to_do_by_date,\n       t.task_name,\n       t.status,\n       t.completed_date\nFROM tasks t\nJOIN job_status js ON t.job_id = js.job_id\nWHERE (js.all_done = 0 OR js.done_today = 1)\nORDER BY MIN(t.to_do_by_date) OVER (PARTITION BY t.job_id),\n         t.job_id,\n         t.to_do_by_date;