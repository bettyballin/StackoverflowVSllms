SELECT \n  trn.WID_DATE, \n  trn.MINE_CODE, \n  trn.TRAIN_CONTROL_ID, \n  trn.NUM_CARS as HBD_Car_Count, \n  SUM(CASE WHEN vcon.WAGON_TYPE_CODE = 'MS' AND wag.ACI_TAG_NO IN (SELECT DISTINCT ACI_TAG_NO FROM widsys.wagon) THEN 1 ELSE 0 END) M_Series,\n  -- ... other columns ...\nFROM \n  widsys.consist con, \n  widsys.train trn, \n  widsys.wagon wag, \n  widsys.v_consist_ore_detail vcon\nWHERE \n  -- ... existing conditions ...\nGROUP BY \n  trn.WID_DATE, \n  trn.MINE_CODE, \n  trn.TRAIN_CONTROL_ID, \n  trn.NUM_CARS\nORDER BY \n  trn.WID_DATE DESC;