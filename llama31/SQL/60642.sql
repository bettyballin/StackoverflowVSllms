CREATE TEMPORARY TABLE derived_table AS\nSELECT \n  t.id, \n  shift_times.shift_id AS shift_id \nFROM tickets t\nJOIN shifts ON t.shop_id = shifts.shop_id \nJOIN shift_times ON (shifts.id = shift_times.shift_id\n  AND shift_times.dow = DAYOFWEEK(t.created)\n  AND TIME(t.created) BETWEEN shift_times.start AND shift_times.end);\n\nCREATE INDEX idx_shift_id ON derived_table (shift_id);\n\nINSERT INTO tickets_extra (ticket_id, manager_created)\nSELECT \n  dt.id, \n  su.user_id\nFROM derived_table dt\nLEFT JOIN shifts_users su ON dt.shift_id = su.shift_id\nLEFT JOIN shift_positions ON su.shift_position_id = shift_positions.id\nWHERE shift_positions.level = 1;