CREATE TABLE grid AS (\n  SELECT \n    ST_MakeEnvelope(\n      ST_XMin(extent) + (ST_XMax(extent) - ST_XMin(extent)) * (x / grid_size),\n      ST_YMin(extent) + (ST_YMax(extent) - ST_YMin(extent)) * (y / grid_size),\n      ST_XMin(extent) + (ST_XMax(extent) - ST_XMin(extent)) * ((x + 1) / grid_size),\n      ST_YMin(extent) + (ST_YMax(extent) - ST_YMin(extent)) * ((y + 1) / grid_size),\n      4326\n    ) AS geom,\n    COUNT(*) AS count\n  FROM \n    your_table,\n    generate_series(0, grid_size) AS x,\n    generate_series(0, grid_size) AS y\n  WHERE \n    ST_Intersects(\n      ST_MakeEnvelope(\n        ST_XMin(extent) + (ST_XMax(extent) - ST_XMin(extent)) * (x / grid_size),\n        ST_YMin(extent) + (ST_YMax(extent) - ST_YMin(extent)) * (y / grid_size),\n        ST_XMin(extent) + (ST_XMax(extent) - ST_XMin(extent)) * ((x + 1) / grid_size),\n        ST_YMin(extent) + (ST_YMax(extent) - ST_YMin(extent)) * ((y + 1) / grid_size),\n        4326\n      ),\n      your_table.geom\n    )\n  GROUP BY \n    x, y\n);