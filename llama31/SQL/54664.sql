WITH FilteredData AS (\n    SELECT a, b\n    FROM (\n        SELECT 1 a,1 b UNION ALL\n        SELECT 2,2 UNION ALL\n        SELECT 2,NULL UNION ALL\n        SELECT 3,3 UNION ALL\n        SELECT 3,NULL UNION ALL\n        SELECT 3,NULL\n    ) AS InnerQuery\n    WHERE b IS NOT NULL\n)\nSELECT \n    a,\n    COUNT(DISTINCT b) AS countdistinctb,\n    SUM(a) OVER (PARTITION BY a) AS suma\nFROM \n    FilteredData\nGROUP BY \n    a;