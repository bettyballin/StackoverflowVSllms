LEFT OUTER JOIN \n    (\n        SELECT \n            tr1.*,\n            ROW_NUMBER() OVER (PARTITION BY tr1.person_id ORDER BY tr1.date DESC) AS row_num\n        FROM \n            [transaction] tr1\n        LEFT OUTER JOIN \n            [d_vendor] ins1\n        ON \n            ins1.d_vendor_id = tr1.d_vendor_id\n        LEFT OUTER JOIN \n            [d_product_type] prodtype1\n        ON \n            prodtype1.d_product_type_id = tr1.d_product_type_id\n        LEFT OUTER JOIN \n            [d_commission_type] ctype1\n        ON \n            ctype1.d_commission_type_id = tr1.d_commission_type_id\n        WHERE\n            prodtype1.name <> 'Medicare Part D'\n            AND tr1.termdate IS NULL\n    ) AS a_t\nON\n    a_t.person_id = p.person_id AND a_t.row_num = 1