INSERT INTO new_table (index_id, record_id, data_field)\nSELECT \n  NULL,  -- index_id will be auto-incremented\n  ot.record_id,\n  ot.data_field\nFROM \n  old_table ot\n  LEFT JOIN new_table nt ON ot.record_id = nt.record_id\n  LEFT JOIN new_table_index nti ON ot.record_id = nti.record_id AND nti.date = (SELECT MAX(date) FROM new_table_index WHERE record_id = ot.record_id)\nWHERE \n  nt.record_id IS NULL OR (nt.record_id IS NOT NULL AND nt.data_field != ot.data_field);\n\nINSERT INTO new_table_index (index_id, date)\nSELECT \n  LAST_INSERT_ID(),  -- get the auto-incremented index_id\n  ot.date\nFROM \n  old_table ot;