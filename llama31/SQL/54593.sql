MERGE INTO Tag AS t\nUSING (SELECT @TagName AS TagName) AS s\nON t.TagName = s.TagName\nWHEN MATCHED THEN\n    INSERT INTO TaggedRecords (TagId, TaggedRecordId)\n    VALUES (t.TagId, @TaggedRecordId)\nWHEN NOT MATCHED THEN\n    INSERT INTO Tag (TagName)\n    VALUES (s.TagName)\n    OUTPUT inserted.TagId INTO @NewTagId\n    INSERT INTO TaggedRecords (TagId, TaggedRecordId)\n    VALUES (@NewTagId, @TaggedRecordId);