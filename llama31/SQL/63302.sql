WITH RecursiveMatches AS (\n  SELECT asid1, asid2, 1 AS group_id\n  FROM #matches\n  UNION ALL\n  SELECT m.asid1, m.asid2, rm.group_id\n  FROM #matches m\n  INNER JOIN RecursiveMatches rm ON m.asid1 = rm.asid2 OR m.asid2 = rm.asid1\n)\nSELECT group_id, asid\nFROM (\n  SELECT group_id, asid1 AS asid\n  FROM RecursiveMatches\n  UNION\n  SELECT group_id, asid2 AS asid\n  FROM RecursiveMatches\n) AS subquery\nORDER BY group_id, asid;