SELECT \n  u.userid,\n  u.update_type,\n  CASE \n    WHEN u.update_type = 2 THEN CONCAT('uploaded ', COUNT(*), ' new photos')\n    WHEN u.update_type = 1 THEN 'updated their profile'\n    WHEN u.update_type = 3 THEN CONCAT('updated their mood! (', m.mood_description, ')')\n  END AS update_text,\n  MAX(u.update_time) AS update_time\nFROM \n  update_log u\n  LEFT JOIN userphotos p ON u.pictureid = p.pictureid\n  LEFT JOIN mood_lookup m ON u.mood_a = m.mood_id\nWHERE \n  u.update_time > UNIX_TIMESTAMP() - (60 * 60 * $x)  -- $x is the number of hours\nGROUP BY \n  u.userid,\n  u.update_type,\n  -- Group photo updates within an hour of each other\n  CASE \n    WHEN u.update_type = 2 THEN UNIX_TIMESTAMP() - (60 * 60) * FLOOR((UNIX_TIMESTAMP() - u.update_time) / (60 * 60))\n    ELSE NULL\n  END\nORDER BY \n  update_time DESC;