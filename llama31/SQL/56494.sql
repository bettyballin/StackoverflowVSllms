WITH ranges AS (\n  SELECT Start, Finish, Priority,\n         ROW_NUMBER() OVER (ORDER BY Start, Priority DESC) AS row_num\n  FROM #ranges\n),\nmerged_ranges AS (\n  SELECT Start, Finish, Priority\n  FROM (\n    SELECT Start, Finish, Priority,\n           LAG(Finish) OVER (ORDER BY Start) AS prev_finish\n    FROM ranges\n  ) AS sub\n  WHERE Start > prev_finish OR prev_finish IS NULL\n  UNION ALL\n  SELECT r.Start, r.Finish, r.Priority\n  FROM ranges r\n  JOIN merged_ranges m ON r.Start >= m.Start AND r.Start <= m.Finish\n  WHERE r.Priority > m.Priority\n),\nsplit_ranges AS (\n  SELECT Start, Finish, Priority\n  FROM (\n    SELECT Start, Finish, Priority,\n           LAG(Finish) OVER (PARTITION BY Priority ORDER BY Start) AS prev_finish\n    FROM merged_ranges\n  ) AS sub\n  WHERE Start > prev_finish OR prev_finish IS NULL\n)\nSELECT Start, Finish, Priority\nFROM split_ranges\nORDER BY Start;