-- Create a table of possible movements\nCREATE TABLE matches (\n  offsetRow1 INT, \n  offsetCol1 INT, \n  offsetRow2 INT, \n  offsetCol2 INT, \n  directions VARCHAR(20)\n);\n\n-- ... insert movements into matches table ...\n\n-- Create a CTE to transform the bejeweled table\nWITH CTE AS (\n  SELECT \n    [Row] = CAST([#] AS INT), \n    [Col] = CAST([Col] AS INT), \n    [Value]\n  FROM bejeweled\n  UNPIVOT ([Value] FOR [Col] IN ([1],[2],[3],[4],[5],[6],[7],[8],[9])) unpvt\n)\n-- Join the CTE with itself twice to find matching gems\nSELECT DISTINCT \n  T.Row, \n  T.Col, \n  T.Value, \n  directions\nFROM CTE T\nJOIN CTE T1 ON T.Value = T1.Value\nJOIN CTE T2 ON T.Value = T2.Value\nJOIN matches ON \n  (T1.Row - T.Row) = offsetRow1 AND \n  (T1.Col - T.Col) = offsetCol1 AND \n  (T2.Row - T.Row) = offsetRow2 AND \n  (T2.Col - T.Col) = offsetCol2\nORDER BY T.Row, T.Col;