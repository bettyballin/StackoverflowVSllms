WITH RecursiveGroups AS (\n    SELECT k.KundeID, g.GruppeID, g.ParentGruppeID, 0 AS Level\n    FROM Kunde k\n    INNER JOIN Gruppe g ON k.GruppeID = g.GruppeID\n    WHERE g.ParentGruppeID IS NULL  -- anchor query: top-level groups\n\n    UNION ALL\n\n    SELECT k.KundeID, g.GruppeID, g.ParentGruppeID, Level + 1\n    FROM Kunde k\n    INNER JOIN Gruppe g ON k.GruppeID = g.GruppeID\n    INNER JOIN RecursiveGroups rg ON g.ParentGruppeID = rg.GruppeID\n)\nSELECT k.KundeID, rg.GruppeID AS MostParentGroupID\nFROM Kunde k\nINNER JOIN (\n    SELECT KundeID, MAX(Level) AS MaxLevel\n    FROM RecursiveGroups\n    GROUP BY KundeID\n) m ON k.KundeID = m.KundeID\nINNER JOIN RecursiveGroups rg ON k.KundeID = rg.KundeID AND m.MaxLevel = rg.Level;