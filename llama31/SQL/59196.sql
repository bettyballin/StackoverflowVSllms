CREATE PROCEDURE MergeCustomers\n    @idCustomer1 int,\n    @idCustomer2 int\nAS\nBEGIN\n    -- Merge customers\n    UPDATE c1\n    SET c1.Company = c2.Company,\n        c1.[etc] = c2.[etc]\n    FROM Customers c1\n    INNER JOIN Customers c2 ON c2.idCustomer = @idCustomer2\n    WHERE c1.idCustomer = @idCustomer1;\n\n    -- Get tables with foreign key relationships\n    DECLARE @tables TABLE (TableName sysname);\n    INSERT INTO @tables\n    SELECT TABLE_NAME\n    FROM INFORMATION_SCHEMA.FOREIGN_KEYS\n    WHERE REFERENCED_TABLE_NAME = 'Customers';\n\n    -- Update foreign key columns\n    DECLARE @tableName sysname;\n    DECLARE cur CURSOR FOR SELECT TableName FROM @tables;\n    OPEN cur;\n    FETCH NEXT FROM cur INTO @tableName;\n    WHILE @@FETCH_STATUS = 0\n    BEGIN\n        EXEC ('UPDATE ' + @tableName + ' SET idCustomer = ' + CONVERT(varchar(10), @idCustomer1) + ' WHERE idCustomer = ' + CONVERT(varchar(10), @idCustomer2));\n        FETCH NEXT FROM cur INTO @tableName;\n    END;\n    CLOSE cur;\n    DEALLOCATE cur;\nEND;