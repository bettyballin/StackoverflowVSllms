DECLARE @startDate DATETIME, @endDate DATETIME\nSET @startDate = '2009-04-16 19:00:00'\nSET @endDate = '2009-04-16 20:00:00'\n\nCREATE TABLE #Minutes (Minute DATETIME)\nWHILE @startDate < @endDate\nBEGIN\n    INSERT INTO #Minutes (Minute) VALUES (@startDate)\n    SET @startDate = DATEADD(mi, 1, @startDate)\nEND\n\nSELECT \n    m.Minute, \n    r.system, \n    COUNT(*) AS ActiveCalls\nFROM \n    #Minutes m\nJOIN \n    Records r ON \n        r.date = CONVERT(VARCHAR(8), m.Minute, 112) AND \n        r.time = CONVERT(VARCHAR(4), m.Minute, 114) AND \n        m.Minute BETWEEN DATEADD(s, r.seconds, '1970-01-01') AND DATEADD(s, r.seconds + r.dur, '1970-01-01')\nGROUP BY \n    m.Minute, \n    r.system\nORDER BY \n    m.Minute, \n    r.system\n\nDROP TABLE #Minutes