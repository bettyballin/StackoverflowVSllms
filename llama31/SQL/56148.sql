-- Enable CDC on the source table\nEXEC sys.sp_cdc_enable_table\n    @source_schema = 'dbo',\n    @source_name = 'mytable',\n    @role_name = 'myrole';\n\n-- Create a change table\nEXEC sys.sp_cdc_create_change_tables\n    @source_schema = 'dbo',\n    @source_name = 'mytable';\n\n-- Create a Service Broker queue and service\nCREATE QUEUE myqueue;\nCREATE SERVICE myservice ON QUEUE myqueue (\n    'http://schemas.microsoft.com/SQL/Notifications/PostQueryNotification'\n);\n\n-- Send changes from the change table to the destination database\nCREATE PROCEDURE sp_send_changes\nAS\nBEGIN\n    DECLARE @message_body VARBINARY(MAX);\n    DECLARE @message_type SYSNAME;\n\n    WHILE EXISTS (SELECT 1 FROM cdc.dbo_mytable_CT WHERE __$operation = 2)\n    BEGIN\n        SELECT TOP 1 @message_body = __$command_id, @message_type = 'mytable_changed'\n        FROM cdc.dbo_mytable_CT\n        WHERE __$operation = 2;\n\n        SEND ON CONVERSATION 'myconversation' MESSAGE TYPE @message_type (@message_body);\n        DELETE FROM cdc.dbo_mytable_CT WHERE __$command_id = @message_body;\n    END\nEND;