WITH RankedPurchases AS (\n    SELECT \n        CustomerID,\n        Date,\n        ROW_NUMBER() OVER (\n            PARTITION BY CustomerID, EOMONTH(Date)\n            ORDER BY ABS(DATEDIFF(day, Date, EOMONTH(Date)))\n        ) AS Rank\n    FROM \n        Purchases\n)\nSELECT \n    CustomerID,\n    Date\nFROM \n    RankedPurchases\nWHERE \n    Rank = 1\nORDER BY \n    CustomerID,\n    Date;