WITH \n  -- Group data by minute intervals\n  MinuteIntervals AS (\n    SELECT \n      DATE_TRUNC('minute', CreateDate) AS IntervalStart,\n      COUNT(*) AS MessageCount\n    FROM \n      Messages\n    GROUP BY \n      DATE_TRUNC('minute', CreateDate)\n  ),\n  \n  -- Identify peak load intervals (e.g., top 10% with highest message counts)\n  PeakIntervals AS (\n    SELECT \n      IntervalStart,\n      MessageCount\n    FROM \n      MinuteIntervals\n    ORDER BY \n      MessageCount DESC\n    LIMIT \n      (SELECT COUNT(*) * 0.1 FROM MinuteIntervals)\n  ),\n  \n  -- Calculate average messages per second for peak load intervals\n  PeakLoadStats AS (\n    SELECT \n      AVG(MessageCount / 60.0) AS AvgMessagesPerSecond\n    FROM \n      PeakIntervals\n  )\n  \nSELECT \n  AvgMessagesPerSecond\nFROM \n  PeakLoadStats;