WITH FilteredBar AS (\n  SELECT \n    BarId, \n    FooId, \n    BarName\n  FROM \n    Bar\n  WHERE \n    BarName = 'SomeBar'\n)\nSELECT \n  FooId,\n  FooName,\n  (\n    SELECT \n      BarId, \n      FooId, \n      BarName\n    FROM \n      FilteredBar\n    WHERE \n      FooId = Foo.FooId\n    FOR XML PATH('Bar'), TYPE\n  )\nFROM \n  Foo\nWHERE \n  FooName = 'SomeFoo'\n  AND FooId IN (SELECT FooId FROM FilteredBar)\nFOR XML PATH('Foo'), TYPE