from sklearn.cluster import AgglomerativeClustering\n\ndef max_cluster_size(cluster):\n    return len(cluster) <= M\n\nhclust = AgglomerativeClustering(n_clusters=None, distance_threshold=0, affinity='haversine', linkage='ward')\nclusters = hclust.fit_predict(coords_scaled)\n\n# Get the cluster labels and filter out clusters with more than M addresses\nlabels = hclust.labels_\ngroups = {}\nfor addr, label in zip(addresses, labels):\n    if label not in groups:\n        groups[label] = []\n    groups[label].append(addr)\n\n# Filter out clusters with more than M addresses\ngroups = {label: group for label, group in groups.items() if len(group) <= M}