import io\nimport sys\nimport datetime\n\nclass TeeWithTimestamp(io.TextIOWrapper):\n    def __init__(self, file1, file2):\n        self.file1 = file1\n        self.file2 = file2\n        self.at_start_of_line = True\n\n    def write(self, text):\n        if len(text):\n            if self.at_start_of_line:\n                now = datetime.datetime.now()\n                prefix = now.strftime('[%H:%M:%S] ')\n                if self.file1 == sys.stderr:\n                    prefix += '[STDERR] '\n                text = prefix + text\n\n            self.file1.write(text)\n            self.file2.write(text)\n\n            self.at_start_of_line = (text[-1] == '\n')\n\n# log_file has already been opened\nsys.stdout = TeeWithTimestamp(sys.stdout, log_file)