function add_fields(link, association, content) {\n  var new_id = new Date().getTime();\n  var regexp = new RegExp("new_" + association, "g");\n  $(link).parent().before(content.replace(regexp, new_id));\n}\n\nfunction link_to_add_fields(name, f, association) {\n  var new_object = f.object.class.reflect_on_association(association).klass.new;\n  var fields = f.fields_for(association, new_object, :child_index => "new_#{association}") do |builder|\n    render(association.to_s.singularize + "_fields", :f => builder)\n  end\n  link_to_function(name, "add_fields(this, '#{association}', '#{fields}')")\n}