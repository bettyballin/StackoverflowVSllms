function getSelectedText() {\n  var text;\n\n  // Check main document\n  if (document.getSelection) {\n    text = document.getSelection().toString();\n  } else if (document.selection) {\n    text = document.selection.createRange().text;\n  }\n\n  // Check frames and iframes\n  if (!text) {\n    var frames = document.getElementsByTagName('frame');\n    var iframes = document.getElementsByTagName('iframe');\n    var allFrames = frames.concat(iframes);\n\n    for (var i = 0; i < allFrames.length; i++) {\n      var frame = allFrames[i];\n      if (frame.contentWindow && frame.contentWindow.getSelection) {\n        text = frame.contentWindow.getSelection().toString();\n        if (text) break;\n      }\n    }\n  }\n\n  // Check textareas\n  if (!text) {\n    var areas = document.getElementsByTagName('textarea');\n    for (var i = 0; i < areas.length; i++) {\n      if (areas[i].selectionStart != undefined && areas[i].selectionStart != areas[i].selectionEnd) {\n        text = areas[i].value.substring(areas[i].selectionStart, areas[i].selectionEnd);\n        break;\n      }\n    }\n  }\n\n  return text;\n}