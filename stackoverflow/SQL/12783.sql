declare @columnlist nvarchar(4000)\nselect @columnlist = IsNull(@columnlist + ', ', '') + '[' + PositionName + ']'\nfrom #Position\n\ndeclare @query nvarchar(4000)\nselect @query = '\n    select *\n    from (\n        select CategoryId, CategoryName, PositionName, \n                IsNull(COrder,0) as COrder\n        from #Position p\n        cross join #Category c\n        left join #CategoryPosition cp \n                on cp.pid = p.PositionId \n                and cp.cid = c.CategoryId\n    ) pv\n    PIVOT (max(COrder) FOR PositionName in (' + @columnlist + ')) as Y\n    ORDER BY CategoryId, CategoryName\n'\n\nexec sp_executesql @query