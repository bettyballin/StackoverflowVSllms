/*\nCREATE TABLE [dbo].[stackoverflow_159456](\n    [ID] [int] NOT NULL,\n    [TYPE] [char](1) NOT NULL,\n    [SUBTYPE] [char](1) NOT NULL,\n    [COUNT] [int] NOT NULL,\n    [MONTH] [datetime] NOT NULL\n) ON [PRIMARY]\n*/\n\nDECLARE @sql AS varchar(max)\nDECLARE @pivot_list AS varchar(max) -- Leave NULL for COALESCE technique\nDECLARE @select_list AS varchar(max) -- Leave NULL for COALESCE technique\n\nSELECT @pivot_list = COALESCE(@pivot_list + ', ', '') + '[' + PIVOT_CODE + ']'\n        ,@select_list = COALESCE(@select_list + ', ', '') + 'ISNULL([' + PIVOT_CODE + '], 0) AS [' + PIVOT_CODE + ']'\nFROM (\n    SELECT DISTINCT [TYPE] + '_' + SUBTYPE AS PIVOT_CODE\n    FROM stackoverflow_159456\n) AS PIVOT_CODES\n\nSET @sql = '\n;WITH p AS (\n    SELECT ID, [MONTH], [TYPE] + ''_'' + SUBTYPE AS PIVOT_CODE, SUM([COUNT]) AS [COUNT]\n    FROM stackoverflow_159456\n    GROUP BY ID, [MONTH], [TYPE] + ''_'' + SUBTYPE\n)\nSELECT ID, [MONTH], ' + @select_list + '\nFROM p\nPIVOT (\n    SUM([COUNT])\n    FOR PIVOT_CODE IN (\n        ' + @pivot_list + '\n    )\n) AS pvt\n'\n\nEXEC (@sql)