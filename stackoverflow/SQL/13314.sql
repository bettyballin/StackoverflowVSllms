declare  @table table (ProfessorID nvarchar(2), StudentID nvarchar(2),Mark int)\n\ninsert into @table\nselect 'P1', 'S1', 9\nunion all\nselect 'P1', 'S2', 8\nunion all\nselect 'P1', 'S3', 10\nunion all\nselect 'P2', 'S1', 7\nunion all\nselect 'P2', 'S2', 2\nunion all\nselect 'P2', 'S3', 4\nunion all\nselect 'P3', 'S4', 5\nunion all\nselect 'P4', 'S1', 6\n\nselect *\nfrom @table o\nwhere o.StudentID IN (select top 2 s.StudentID from @table s where s.ProfessorId = o.ProfessorId order by Mark DESC)\nand o.ProfessorID IN (select p.ProfessorID from @table p group by p.ProfessorID having count(*) >= 2)