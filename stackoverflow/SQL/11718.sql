SELECT  rt.rangeId, aDate, CASE WHEN doUse = 1 THEN qty ELSE 0 END AS qty\nFROM    (\n    SELECT  *\n    FROM    (\n        SELECT  r.*, t.*, SUM(doUse) OVER (PARTITION BY rangeId ORDER BY aDate) AS span\n        FROM    (\n            SELECT  r.rangeId, startDate, MAX(day) AS dm\n            FROM    Range r, Days d\n            WHERE   d.rangeid = r.rangeid\n            GROUP BY\n                r.rangeId, startDate\n            ) r, Dates t\n        WHERE   t.adate >= startDate\n        ORDER BY\n            rangeId, t.adate\n        )\n    WHERE\n        span <= dm\n    ) rt, Days d\nWHERE   d.rangeId = rt.rangeID\n    AND d.day = GREATEST(rt.span, 1)