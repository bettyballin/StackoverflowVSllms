SELECT cur.source_prefix, \n       cur.source_name, \n       cur.category, \n       cur.element_id,\n       MAX(cur.date_updated) AS DateUpdated, \n       AVG(cur.value) AS AvgValue,\n       SUM(cur.value * cur.weight) / SUM(cur.weight) AS Rating\nFROM eev0 cur\nLEFT JOIN eev0 next\n    ON next.date_updated < '2009-05-01'\n    AND next.source_prefix = cur.source_prefix \n    AND next.source_name = cur.source_name\n    AND next.element_id = cur.element_id\n    AND next.date_updated > cur.date_updated\nWHERE cur.date_updated < '2009-05-01'\nAND next.category IS NULL\nGROUP BY cur.source_prefix, cur.source_name, \n    cur.category, cur.element_id