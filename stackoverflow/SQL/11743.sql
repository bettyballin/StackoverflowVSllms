DECLARE TABLE months (start DATETIME)\n-- Populate with all month start dates that may ever be needed\n-- And I would recommend indexing / primary keying by start\n\nSELECT\n    months.start,\n    data.id,\n    SUM(CASE WHEN data.start < months.start\n            THEN DATEDIFF(DAY, months.start, data.end)\n            ELSE DATEDIFF(DAY, data.start, DATEADD(month, 1, months.start))\n        END) AS days\nFROM\n    data\nINNER JOIN\n    months\n        ON data.start < DATEADD(month, 1, months.start)\n        AND data.end > months.start\nGROUP BY\n   months.start,\n   data.id