CREATE TABLE magic ENGINE=MEMORY\nSELECT\n  s.shop_id AS shop_id,\n  s.id AS shift_id,\n  st.dow AS dow,\n  st.start AS start,\n  st.end AS end,\n  su.user_id AS manager_id\nFROM shifts s\nJOIN shift_times st ON s.id = st.shift_id\nJOIN shifts_users su ON s.id = su.shift_id\nJOIN shift_positions sp ON su.shift_position_id = sp.id AND sp.level = 1\n\nALTER TABLE magic ADD INDEX (shop_id, dow);\n\nCREATE TABLE tickets_extra ENGINE=MyISAM\nSELECT \n  t.id AS ticket_id,\n  (\n    SELECT m.manager_id\n    FROM magic m\n    WHERE DAYOFWEEK(t.created) = m.dow\n    AND TIME(t.created) BETWEEN m.start AND m.end\n    AND m.shop_id = t.shop_id\n  ) AS manager_created,\n  (\n    SELECT m.manager_id\n    FROM magic m\n    WHERE DAYOFWEEK(t.resolved) = m.dow\n    AND TIME(t.resolved) BETWEEN m.start AND m.end\n    AND m.shop_id = t.shop_id\n  ) AS manager_resolved\nFROM tickets t;\nDROP TABLE magic;