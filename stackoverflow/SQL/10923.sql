WITH LASTVISIT AS (\n    SELECT VISITORIP, MAX(DATEENTERED) AS DATEENTERED\n    FROM STATS\n    WHERE DATEENTERED BETWEEN @STARTTIME AND @ENDTIME\n    GROUP BY VISITORIP\n)\nSELECT STATS.VISITORIP, STATS.HTTPADDRESS, STATS.DATEENTERED\nFROM STATS\nINNER JOIN LASTVISIT\n    ON LASTVISIT.VISITORIP = STATS.VISITORIP\n    AND LASTVISIT.DATEENTERED = STATS.DATEENTERED\nORDER BY STATS.DATEENTERED DESC