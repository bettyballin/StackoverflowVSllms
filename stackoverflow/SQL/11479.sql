WITH cte AS\n(\n    SELECT\n        intID,\n        ROW_NUMBER() OVER\n            (\n                PARTITION BY geoLat, geoLng\n                ORDER BY NEWID()\n            ) AS row_num,\n        COUNT(intID) OVER (PARTITION BY geoLat, geoLng) AS TotalCount\n    FROM\n        dbo.Documents\n)\nSELECT TOP (@maxcount)\n    intID, RAND(intID)\nFROM\n    cte\nWHERE\n    row_num = 1 + FLOOR(RAND() * TotalCount)