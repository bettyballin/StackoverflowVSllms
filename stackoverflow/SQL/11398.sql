WITH \n  TablesCTE(TableName, TableID, Ordinal) AS\n  (\n  SELECT \n    OBJECT_SCHEMA_NAME(so.id) +'.'+ OBJECT_NAME(so.id) AS TableName,\n    so.id AS TableID,\n    0 AS Ordinal\n  FROM dbo.sysobjects so INNER JOIN sys.all_columns ac ON so.ID = ac.object_id\n  WHERE\n    so.type = 'U'\n  AND\n    ac.is_rowguidcol = 1\n  UNION ALL\n  SELECT \n    OBJECT_SCHEMA_NAME(so.id) +'.'+ OBJECT_NAME(so.id) AS TableName,\n    so.id AS TableID,\n    tt.Ordinal + 1 AS Ordinal\n  FROM \n    dbo.sysobjects so \n    INNER JOIN sys.all_columns ac ON so.ID = ac.object_id\n    INNER JOIN sys.foreign_keys f \n      ON (f.parent_object_id = so.id AND f.parent_object_id != f.referenced_object_id)\n    INNER JOIN TablesCTE tt ON f.referenced_object_id = tt.TableID\n  WHERE\n    so.type = 'U'\n  AND\n    ac.is_rowguidcol = 1\n)  \nSELECT DISTINCT \n  t.Ordinal,\n  t.TableName\n  FROM TablesCTE t\n  INNER JOIN \n    (\n    SELECT \n      TableName as TableName,\n      Max (Ordinal) as Ordinal\n    FROM TablesCTE\n    GROUP BY TableName\n    ) tt ON (t.TableName = tt.TableName  AND t.Ordinal = tt.Ordinal)\nORDER BY t.Ordinal, t.TableName