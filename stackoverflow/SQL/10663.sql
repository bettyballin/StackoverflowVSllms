SELECT p_new.identifier, COALESCE(p_inprog.activity, p_new.activity) AS activity,\n  p_inprog.participant, COALESCE(p_inprog.closedate, p_new.closedate) AS closedate\nFROM performance p_new\n  LEFT OUTER JOIN performance p_inprog \n    ON (p_new.identifier = p_inprog.identifier AND p_inprog.activity = 2)\n  LEFT OUTER JOIN performance p_closed \n    ON (p_new.identifier = p_closed.identifier AND p_closed.activity = 4)\nWHERE p_new.activity = 1\n  AND p_closed.identifier IS NULL;