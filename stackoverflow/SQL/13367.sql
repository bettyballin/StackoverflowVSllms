DECLARE @MyTable TABLE\n(\n  DeviceName varchar(100),\n  EventTime DateTime,\n  OnOff int,\n  GoodForRead int\n)\n\nINSERT INTO @MyTable(DeviceName, OnOff, EventTime)\nSELECT 'F07331E4-26EC-41B6-BEC5-002AACA58337', 1, '2008-05-08 04:03:47.000' \nINSERT INTO @MyTable(DeviceName, OnOff, EventTime)\nSELECT 'F07331E4-26EC-41B6-BEC5-002AACA58337', 0, '2008-05-08 10:02:08.000' \nINSERT INTO @MyTable(DeviceName, OnOff, EventTime)\nSELECT 'F07331E4-26EC-41B6-BEC5-002AACA58337', 0, '2008-05-09 10:03:24.000'\nINSERT INTO @MyTable(DeviceName, OnOff, EventTime)\nSELECT 'F07331E4-26EC-41B6-BEC5-002AACA58337', 1, '2008-05-10 04:05:05.000' \n\nUPDATE mt\nSET GoodForRead = \nCASE\n  (SELECT top 1 OnOff\n   FROM @MyTable mt2\n   WHERE mt2.DeviceName = mt.DeviceName\n     and mt2.EventTime < mt.EventTime\n   ORDER BY mt2.EventTime desc\n  )\n  WHEN null THEN 1\n  WHEN mt.OnOff THEN 0\n  ELSE 1\nEND\nFROM @MyTable mt\n    -- Limit the update to recent data\n--WHERE EventTime >= DateAdd(dd, -1, GetDate())\n\nSELECT *\nFROM @MyTable