-- Table1 (ItemKey as PK, rest of the columns)\n-- Table2 (as you defined with Key as PK)\n-- Table3 (ItemKey  as FK referencing Table1(ItemKey), \n--         GroupKey as FK referencing Table2(Key))\n\nDeclare @Exclude int\nSet @Exclude = 2          \n;WITH Groups AS     -- returns keys of groups where key is not equal\n(                   -- to @Exclude or any of his descendants\n   SELECT t.Key\n     FROM table2 t\n    WHERE t.ParentKey IS NULL\n      and t.Key <> @Exclude\n   UNION ALL\n   SELECT th.Key,\n     FROM table2 th\n    INNER JOIN Groups g ON g.Key = th.ParentKey\n    Where th.Key <> @Exclude\n)\nSELECT t1.* \n  FROM Table1 t1\n WHERE t1.key in (Select t3.ItemKey \n                    From table3 t3 \n                   Inner Join Groups g2 \n                      on t3.GroupKey = g2.Key\n                 )