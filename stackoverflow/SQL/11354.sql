WITH MyCte AS (SELECT  *,\n                       RowNum = ROW_NUMBER() OVER (PARTITION BY CONVERT(CHAR(8), UpdateDateTime, 112) ORDER BY UpdateDateTime DESC ) \n               FROM    InventoryHistory\n               WHERE   UpdateDateTime >= convert(char(8), dateadd(yy, -30, getdate()), 112)\n                       AND DATEPART(hh, UpdateDateTime) < 17)\nSELECT   UpdateID, \n         ProductID, \n         UpdateDateTime, \n         QuantityOnHand \nFROM     MyCte\nWHERE    RowNum = 1\n\n\n/* Results \nUpdateID    ProductID   UpdateDateTime          QuantityOnHand\n----------- ----------- ----------------------- --------------\n2           1           2009-07-29 14:00:00.000 99\n4           1           2009-07-30 09:00:00.000 97\n\n(2 row(s) affected)\n*/