select c.companyid\n      ,yearendingdate + '/' + convert(varchar, datepart(yy, dateadd(yy,1,o.orderdate))) as yearending\n      ,sum(ordervalue) as numberoforders\n  from @orders o\n       join @companies c\n         on o.companyid = c.companyid\n where orderdate between case when (cast(yearendingdate + '/' + convert(varchar, datepart(yy, o.orderdate)) as datetime) >= o.orderdate)\n                         then yearendingdate + '/' + convert(varchar, datepart(yy, dateadd(yy,-1,o.orderdate)))\n                         else yearendingdate + '/' + convert(varchar, datepart(yy, o.orderdate))\n                          end\n                     and \n                         case when (cast(yearendingdate + '/' + convert(varchar, datepart(yy, o.orderdate)) as datetime) >= o.orderdate)\n                         then yearendingdate + '/' + convert(varchar, datepart(yy, o.orderdate))\n                         else yearendingdate + '/' + convert(varchar, datepart(yy, dateadd(yy,1,o.orderdate)))\n                          end\n group by c.companyid, o.orderdate, yearendingdate