SELECT zr, min_distance\n  FROM (SELECT zr, min_distance, cnt, \n               row_number() over(PARTITION BY zr ORDER BY min_distance) rnk\n           FROM (SELECT zr.zip zr, zipdistance(zr.zip, za.zip) min_distance,\n                         COUNT(za.locations) over(\n                             PARTITION BY zr.zip \n                             ORDER BY zipdistance(zr.zip, za.zip)\n                         ) cnt\n                    FROM zips_required zr\n                   CROSS JOIN zips_available za)\n          WHERE cnt >= :N)\n WHERE rnk = 1