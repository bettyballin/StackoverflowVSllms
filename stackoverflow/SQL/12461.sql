DECLARE @pivot_list AS VARCHAR(MAX)\n\n--\n;\nWITH    cols\n          AS ( SELECT DISTINCT\n                        'INCIDENT IN ' + LEFT(UPPER(CONVERT(VARCHAR, [date], 107)),\n                                              3) + ' '\n                        + SUBSTRING(UPPER(CONVERT(VARCHAR, [date], 107)), 9, 4) AS col\n               FROM     so926209_2\n             )\n    SELECT  @pivot_list = COALESCE(@pivot_list + ', ', '') + '[' + col + ']'\n    FROM    cols\n\n--\nDECLARE @template AS VARCHAR(MAX)\nSET @template = 'WITH incidents AS (\nSELECT  [user_id],\n        incident_code,\n        ''INCIDENT IN '' + LEFT(UPPER(CONVERT(VARCHAR, [date], 107)), 3)\n        + '' '' + SUBSTRING(UPPER(CONVERT(VARCHAR, [date], 107)), 9, 4) AS col\nFROM    so926209_2\n)\n,results AS (\nSELECT * FROM incidents PIVOT (MAX(incident_code) FOR col IN ({@pivot_list})) AS pvt\n)\nSELECT results.[user_id]\n    ,so926209_1.[name]\n    ,{@select_list}\nFROM results INNER JOIN so926209_1 ON so926209_1.[user_id] = results.[user_id]\n'\n\nDECLARE @sql AS VARCHAR(MAX)\nSET @sql = REPLACE(REPLACE(@template, '{@pivot_list}', @pivot_list), '{@select_list}', @pivot_list)\n\n--PRINT @sql\nEXEC (@sql)