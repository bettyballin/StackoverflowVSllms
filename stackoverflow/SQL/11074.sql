select Start, cast(null as int) as Finish, cast(null as int) as Priority \ninto #processed  \nfrom #ranges\nunion  \nselect Finish, NULL, NULL \nfrom #ranges\n\n\nupdate p \nset Finish = (\n    select min(p1.Start) \n    from #processed p1 \n    where p1.Start > p.Start\n)\nfrom #processed p \n\ncreate clustered index idxStart on #processed(Start, Finish, Priority) \ncreate index idxFinish on #processed(Finish, Start, Priority) \n\nupdate p\nset Priority = \n    (\n        select max(r.Priority) \n        from #ranges r\n        where \n        (\n            (r.Start <= p.Start and r.Finish > p.Start) or \n            (r.Start >= p.Start and r.Start < p.Finish)  \n        )\n    )\nfrom #processed p\n\ndelete from #processed\nwhere Priority is null \n\nselect * from #processed