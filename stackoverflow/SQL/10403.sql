WITH indexCTE AS\n(\n    SELECT DISTINCT \n        i.index_id, i.name, i.object_id\n    FROM \n        sys.indexes i \n    INNER JOIN\n        sys.index_columns ic \n           ON i.index_id = ic.index_id AND i.object_id = ic.object_id\n    WHERE \n        EXISTS (SELECT * FROM sys.columns c \n                 WHERE c.collation_name = 'Modern_Spanish_CI_AS' \n                 AND c.column_id = ic.column_id AND c.object_id = ic.object_id)\n), \nindexCTE2 AS\n(\n    SELECT \n        indexCTE.name 'IndexName', \n        OBJECT_NAME(indexCTE.object_ID) 'TableName',\n        CASE indexCTE.index_id \n          WHEN 1 THEN 'CLUSTERED'\n          ELSE 'NONCLUSTERED'\n        END AS 'IndexType', \n        (SELECT DISTINCT c.name + ','\n         FROM \n            sys.columns c \n         INNER JOIN\n            sys.index_columns ic \n               ON c.object_id = ic.object_id AND ic.column_id = c.column_id AND ic.Is_Included_Column = 0\n         WHERE\n            indexCTE.OBJECT_ID = ic.object_id \n            AND indexCTE.index_id = ic.index_id \n         FOR XML PATH('')\n        ) ixcols,\n        ISNULL(\n        (SELECT DISTINCT c.name + ','\n         FROM \n            sys.columns c \n         INNER JOIN\n            sys.index_columns ic \n               ON c.object_id = ic.object_id AND ic.column_id = c.column_id AND ic.Is_Included_Column = 1\n         WHERE\n            indexCTE.OBJECT_ID = ic.object_id \n            AND indexCTE.index_id = ic.index_id \n         FOR XML PATH('')\n        ), '') includedcols\n    FROM \n        indexCTE\n) \nSELECT \n    'CREATE ' + IndexType + ' INDEX ' + IndexName + ' ON ' + TableName + \n        '(' + SUBSTRING(ixcols, 1, LEN(ixcols)-1) + \n        CASE LEN(includedcols)\n          WHEN 0 THEN ')'\n          ELSE ') INCLUDE (' + SUBSTRING(includedcols, 1, LEN(includedcols)-1) + ')'\n        END\nFROM \n   indexCTE2\nORDER BY \n   TableName, IndexName