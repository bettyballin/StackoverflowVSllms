WITH result AS\n(\nSELECT \n    ROW_NUMBER() OVER (PARTITION BY SpouseID ORDER BY FromDate DESC) as rowNumber,\n    * \nFROM \n    SpousePreviousAddresses\n)\n    UPDATE SpousePreviousAddresses\n    SET\n        AddressTypeID = 2\n    FROM \n        SpousePreviousAddresses spa\n            INNER JOIN result r ON spa.SpouseId = r.SpouseId\n    WHERE r.rowNumber = 1\n            AND spa.PreviousAddressID = r.PreviousAddressID\n            AND spa.CountryID = 181