DECLARE @Master TABLE(\n        MasterRecordID VARCHAR(20)\n)\n\nINSERT INTO @Master (MasterRecordID) VALUES ('MASTER1') \nINSERT INTO @Master (MasterRecordID) VALUES ('MASTER2') \nINSERT INTO @Master (MasterRecordID) VALUES ('MASTER3') \nINSERT INTO @Master (MasterRecordID) VALUES ('MASTER4')\n\nDECLARE @MasterDetail TABLE(\n        MasterRecordID VARCHAR(20),\n        MasterDetailRecord VARCHAR(50)\n)\n\nINSERT INTO @MasterDetail (MasterRecordID,MasterDetailRecord) VALUES ('MASTER4','MASTERDETAIL10') \n\nINSERT INTO @MasterDetail (MasterRecordID,MasterDetailRecord) VALUES ('MASTER3','MASTERDETAIL09') \nINSERT INTO @MasterDetail (MasterRecordID,MasterDetailRecord) VALUES ('MASTER3','MASTERDETAIL08') \nINSERT INTO @MasterDetail (MasterRecordID,MasterDetailRecord) VALUES ('MASTER3','MASTERDETAIL07') \n\nINSERT INTO @MasterDetail (MasterRecordID,MasterDetailRecord) VALUES ('MASTER2','MASTERDETAIL06') \nINSERT INTO @MasterDetail (MasterRecordID,MasterDetailRecord) VALUES ('MASTER2','MASTERDETAIL05') \nINSERT INTO @MasterDetail (MasterRecordID,MasterDetailRecord) VALUES ('MASTER2','MASTERDETAIL04') \n\nINSERT INTO @MasterDetail (MasterRecordID,MasterDetailRecord) VALUES ('MASTER1','MASTERDETAIL03') \nINSERT INTO @MasterDetail (MasterRecordID,MasterDetailRecord) VALUES ('MASTER1','MASTERDETAIL02') \nINSERT INTO @MasterDetail (MasterRecordID,MasterDetailRecord) VALUES ('MASTER1','MASTERDETAIL01') \n\nDECLARE @MaxRecords INT\nSELECT  @MaxRecords = 2\n\nSELECT  md.MasterRecordID,\n        md.MasterDetailRecord\nFROM    @MasterDetail md INNER JOIN\n        --this section ensures that we only return master records with at least MaxRecords as specified (2 in your case)\n        --if you wish to display al master records, with 1, 2 or MaxRecords, romove this section or see below\n        (\n            SELECT  MasterRecordID\n            FROM    @MasterDetail\n            GROUP BY    MasterRecordID\n            HAVING COUNT(MasterRecordID) >= @MaxRecords\n        ) NumberOfRecords ON md.MasterRecordID = NumberOfRecords.MasterRecordID INNER JOIN\n        @MasterDetail mdSmaller ON md.MasterRecordID = mdSmaller.MasterRecordID\nWHERE   mdSmaller.MasterDetailRecord <= md.MasterDetailRecord\nGROUP BY    md.MasterRecordID,\n            md.MasterDetailRecord\nHAVING  COUNT(mdSmaller.MasterDetailRecord) <= @MaxRecords\nORDER BY    md.MasterRecordID,\n            md.MasterDetailRecord\n\n\n\nSELECT  md.MasterRecordID,\n        md.MasterDetailRecord\nFROM    @MasterDetail md INNER JOIN\n        --this will ensure that all master records will return with 1, 2 or MaxRecords\n        @MasterDetail mdSmaller ON md.MasterRecordID = mdSmaller.MasterRecordID\nWHERE   mdSmaller.MasterDetailRecord <= md.MasterDetailRecord\nGROUP BY    md.MasterRecordID,\n            md.MasterDetailRecord\nHAVING  COUNT(mdSmaller.MasterDetailRecord) <= @MaxRecords\nORDER BY    md.MasterRecordID,\n            md.MasterDetailRecord