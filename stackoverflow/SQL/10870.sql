with fiscal_part as (\n            select fiscal\n            from   SO\n            where  fiscal is not null)\n,    fiscal as (\n            select fb.fiscal         fiscal_begin\n            ,      min(fe.fiscal)    fiscal_end\n            from   fiscal_part fb right join \n                   fiscal_part fe\n                on fe.fiscal > fb.fiscal\n            group by fb.fiscal)\n,    main as (\n            select *\n            from   SO\n            where  fiscal is null)\nselect main.ID\n,      fiscal.fiscal_end\n,      sum(main.cHour)\n,      sum(main.weight)\nfrom   main\njoin   fiscal on main.cdate >= coalesce(fiscal.fiscal_begin, main.cdate)\n             and main.cdate <  fiscal.fiscal_end\ngroup by main.ID\n,      fiscal.fiscal_end\norder by fiscal.fiscal_end