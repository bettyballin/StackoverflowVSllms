-- convert the required end hour to 24 hour format\nDECLARE @EndHour INT\nSET @EndHour = CASE WHEN @TimeFrame = 'AM' THEN @Hour ELSE @Hour + 12 END\n\n-- set @DateEnd to the date-only portion of the current datetime\n-- ie, the time portion will be set to 00:00:00\nSET @DateEnd = DATEADD(day, 0, DATEDIFF(day, 0, GETDATE()))\n\n-- add the required end hour\nSET @DateEnd = DATEADD(hour, @EndHour, @DateEnd)\n\n-- if @DateEnd is in the future then subtract 24 hours from it\nIF @DateEnd > GETDATE()\n   SET @DateEnd = DATEADD(hour, -24, @DateEnd)\n\n-- set @DateStart by subtracting the required timespan from @DateEnd\nSET @DateStart = DATEADD(hour, -@TimeSpan, @DateEnd)