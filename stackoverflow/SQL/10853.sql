WITH    sets AS\n        (\n        SELECT  SiteID, SUBSTRING(CAST(PersonID AS VARCHAR(MAX)) + SPACE(8), 1, 8)AS result, 1 AS rn\n        FROM    @Person p\n        UNION ALL\n        SELECT  p2.SiteID, s.result + SUBSTRING(CAST(PersonID AS VARCHAR(MAX)) + SPACE(8), 1, 8), rn + 1\n        FROM    sets s\n        JOIN    @Person p2\n        ON      p2.siteid = s.siteid\n                AND PATINDEX('%' + SUBSTRING(CAST(PersonID AS VARCHAR(MAX)) + SPACE(8), 1, 8) + '%', s.result) = 0\n        ),\n        cal AS\n        (\n        SELECT  1 AS rn\n        UNION ALL\n        SELECT  rn + 1\n        FROM    cal\n        WHERE   rn < 99\n        ),\n        pairs AS\n        (\n        SELECT  SiteId, result, ROW_NUMBER() OVER (PARTITION BY siteid ORDER BY rn2 % 30) pn\n        FROM    (\n                SELECT  s.*,\n                        ROW_NUMBER() OVER (PARTITION BY siteid ORDER BY siteid) AS rn2\n                FROM    sets s\n                WHERE   rn = 6\n                ) q\n        WHERE   rn2 % 2 > 0\n                AND rn2 % 12 > 5\n                AND rn2 % 240 > 119\n        )\nSELECT  CAST('2009-01-01' AS DATETIME) + rn, siteid,\n        SUBSTRING(result, 1 + (rn % 3) * 16, 8) AS first,\n        SUBSTRING(result, 1 + (rn % 3) * 16 + 8, 8) AS second\nFROM    cal\nJOIN    pairs\nON      pn = (rn / 7 + 1)\n        AND DATEPART(weekday, CAST('2009-01-01' AS DATETIME) + rn) <> 1