WITH RoleHierarchy (RoleID, [Role], [Description], ParentID, Editable, HierarchyLevel, SortKey) AS\n(\n   -- Base\n   SELECT\n        RoleID,\n        [Role],\n        [Description],\n        ParentID,\n        Editable,\n        0 as HierarchyLevel,\n        CAST(RoleID AS VARBINARY(300))\n   FROM\n        dbo.Roles       \n   WHERE\n        RoleID = @ParentID\n\n   UNION ALL\n\n   -- Recursive\n   SELECT\n        e.RoleID,\n        e.[Role],\n        e.[Description],\n        e.ParentID,\n        e.Editable,\n        th.HierarchyLevel + 1 AS HierarchyLevel,\n        CAST (th.SortKey + CAST (e.[Role] AS VARBINARY(100)) + CAST (e.[RoleID] AS VARBINARY(100)) AS VARBINARY(300))\n   FROM\n        Roles e\n        INNER JOIN RoleHierarchy th ON e.ParentID = th.RoleID\n    WHERE\n        e.RoleID != 0\n)\n\nSELECT\n    RoleID,\n    ParentID,\n    [Role],\n    [Description],\n    Editable,\n    HierarchyLevel\nFROM\n    RoleHierarchy\nWHERE\n    RoleID != @ParentID\nORDER BY\n    SortKey