;WITH Firsts AS (\n    SELECT t1.dt\n        ,MIN(t2.dt) AS Prevdt\n    FROM t AS t1\n    INNER JOIN t AS t2\n        ON t1.dt < t2.dt\n        AND t2.cyclestate <> t1.cyclestate\n    GROUP BY t1.dt\n)\nSELECT MIN(t1.dt) AS dt_start\n    ,t2.dt AS dt_end\nFROM t AS t1\nINNER JOIN Firsts\n    ON t1.dt = Firsts.dt\nINNER JOIN t AS t2\n    ON t2.dt = Firsts.Prevdt\n    AND t1.cyclestate <> t2.cyclestate\nGROUP BY t2.dt\n    ,t2.cyclestate\nHAVING MIN(t1.cyclestate) = 0