CREATE OR REPLACE FUNCTION public.test()\nRETURNS integer AS\n$$\nDECLARE\ntempvar integer;\n\nBEGIN    \n     tempvar := 1;\n\n     INSERT INTO movements (from, to, import) VALUES ('mary', 'steve', 600);\n     UPDATE users SET credit = credit - 600 WHERE name = 'mary';\n     UPDATE users SET credit = credit + 600 WHERE name = 'steve';\n\n     --here comes the problem!\n     IF (SELECT credit FROM users WHERE name = 'mary') < 0 THEN\n        ROLLBACK;\n     END IF;\n\n     RETURN tempvar;\nEND\n$$\nLANGUAGE 'plpgsql'\nVOLATILE\nCALLED ON NULL INPUT\nSECURITY INVOKER;