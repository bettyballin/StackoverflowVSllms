create table TemperatureHistory \n    (City varchar(20)\n    , Temperature decimal(5, 2)\n    , DateTaken datetime)\n\ninsert into TemperatureHistory values ('Minneapolis', 61, '20090101')\ninsert into TemperatureHistory values ('Minneapolis', 59, '20090102')\n\ninsert into TemperatureHistory values ('Milwaukee', 65, '20090101')\ninsert into TemperatureHistory values ('Milwaukee', 65, '20090102')\ninsert into TemperatureHistory values ('Milwaukee', 100, '20090103')\n\ninsert into TemperatureHistory values ('Muskegon', 80, '20090101')\ninsert into TemperatureHistory values ('Muskegon', 70, '20090102')\ninsert into TemperatureHistory values ('Muskegon', 70, '20090103')\ninsert into TemperatureHistory values ('Muskegon', 20, '20090104')\n\n; with base_t as\n    (select city\n        , Temperature\n        , row_number() over (partition by city order by temperature) as RowNum\n        , (count(*) over (partition by city)) + 1 as CountPlusOne \n    from TemperatureHistory)\nselect City\n    , avg(Temperature) as MeanTemp\n    , avg(case \n        when RowNum in (FLOOR(CountPlusOne/2.0), CEILING(CountPlusOne/2.0)) \n            then Temperature\n            else null end) as MedianTemp\nfrom base_t \ngroup by City