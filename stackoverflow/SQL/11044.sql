create function dbo.udf_Haversine(@lat1 float, @long1 float, \n                   @lat2 float, @long2 float) returns float begin\n    declare @dlon float, @dlat float, @rlat1 float, \n                 @rlat2 float, @rlong1 float, @rlong2 float, \n                 @a float, @c float, @R float, @d float, @DtoR float\n    \n    select @DtoR = 0.017453293\n    select @R = 3959      -- Earth radius\n    \n    select \n        @rlat1 = @lat1 * @DtoR,\n        @rlong1 = @long1 * @DtoR,\n        @rlat2 = @lat2 * @DtoR,\n        @rlong2 = @long2 * @DtoR\n    \n    select \n        @dlon = @rlong1 - @rlong2,\n        @dlat = @rlat1 - @rlat2\n    \n    select @a = power(sin(@dlat/2), 2) + cos(@rlat1) * \n                     cos(@rlat2) * power(sin(@dlon/2), 2)\n    select @c = 2 * atn2(sqrt(@a), sqrt(1-@a))\n    select @d = @R * @c\n    \n    return @d \nend