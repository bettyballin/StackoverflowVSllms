SELECT log.*\nFROM\n(\n    SELECT lo4.*\n    FROM\n        (SELECT CASE WHEN ln.log_id IS NULL THEN lo2.log_id ELSE ln.log_id END\n        AS log_id, ROW_NUMBER() OVER (PARTITION BY lo2.fb_id ORDER BY lo2.cdate) AS rn \n        FROM \n        (SELECT lo.*,\n            (SELECT TOP 1 log_id\n            FROM t_log li WHERE li.fb_id = lo.fb_id AND li.cdate >= lo.cdate\n            AND li.log_id  lo.log_id AND li.log_name  lo.log_name\n            ORDER BY cdate, log_id)\n        AS next_id\n        FROM t_log lo)\n    lo2 LEFT OUTER JOIN t_log ln ON ln.log_id = lo2.next_id)\n    lo3, t_log lo4\n    WHERE lo3.rn = 1 AND lo4.log_id = lo3.log_id\n) AS log\nWHERE log.Date BETWEEN @start and @end