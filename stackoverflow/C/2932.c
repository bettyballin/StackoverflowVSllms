\nBOOL StopServiceCmd ( const char * szServiceName )\n{ \n    SC_HANDLE schService; \n    SC_HANDLE schSCManager; \n    SERVICE_STATUS ssStatus;       // current status of the service \n    BOOL bRet;\n    int iCont=0;\n\n    schSCManager = OpenSCManager( \n        NULL, // machine (NULL == local) \n        NULL, // database (NULL == default) \n        SC_MANAGER_ALL_ACCESS // access required \n        ); \n    if ( schSCManager ) \n    { \n        schService = OpenService(schSCManager, szServiceName, SERVICE_ALL_ACCESS); \n\n        if (schService) \n        { \n            // try to stop the service \n            if ( ControlService( schService, SERVICE_CONTROL_STOP, &ssStatus ) ) \n            { \n                Sleep( 1000 ); \n\n                while( QueryServiceStatus( schService, &ssStatus ) ) \n                { \n                    iCont++;\n                    if ( ssStatus.dwCurrentState == SERVICE_STOP_PENDING ) \n                    { \n                        Sleep( 1000 ); \n                        if ( iCont > 4 ) break;\n                    } \n                    else \n                        break; \n                } \n\n                if ( ssStatus.dwCurrentState == SERVICE_STOPPED ) \n                    bRet = TRUE; \n                else \n                    bRet = FALSE; \n            } \n\n            CloseServiceHandle(schService); \n        } \n        else \n            bRet = FALSE; \n\n        CloseServiceHandle(schSCManager); \n    } \n    else \n        bRet = FALSE;\n\n    return bRet;\n} 