#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <signal.h>\n#include <sys/types.h>\n#include <sys/ipc.h>\n#include <sys/shm.h>\n#include <unistd.h>\n#include <assert.h>\n\ntypedef void (*sighandler_t)(int); \n\n#define SHM_SIZE 8  /* size of shared memory: enough for two 32 bit integers */\n\nvolatile int cancontinue = 0;\n\nvoid halt(char *err) { perror(err); exit(1); }\nvoid handler(int signum) { assert(signum == SIGUSR1); cancontinue = 1; }\n\nint main(void)\n{\n  key_t key;\n  int id;\n  int *data;\n  pid_t otherpid;\n\n  printf("Hi, I am the %s process and my pid is %d\n", \n#ifdef PRODUCER_MODE\n  "writer"\n#else\n  "reader"\n#endif\n, getpid());\n  printf("Please give me the pid of the other process: ");\n  scanf("%d", &otherpid);\n\n  // get a pointer to the shared memory\n  if ((key = ftok("test_concur.c", 'R')) == -1) halt("ftok");\n  if ((id = shmget(key, SHM_SIZE, 0644 | IPC_CREAT)) == -1) halt("shmget");\n  if ((data = shmat(id, (void *)0, 0)) == (int *)(-1)) halt("shmat");\n\n  sighandler_t oldhandler = signal(SIGUSR1, handler);\n\n  while (1) {\n#ifdef PRODUCER_MODE\n    printf("Enter two integers: ");\n    scanf("%d %d", data, data + 1);\n\n    printf("Sending signal to consumer process\n");\n    kill(otherpid, SIGUSR1);\n\n    printf("Waiting for consumer to allow me to continue\n");\n    while (!cancontinue);\n    cancontinue = 0;\n\n    if (*data + *(data + 1) == 0) { printf("Sum was 0, exiting...\n"); break; }\n#else\n    printf("Waiting for producer to signal me to do my work\n");\n    while (!cancontinue);\n    cancontinue = 0;\n\n    printf("Received signal\n");\n    printf("Pretending to do a long calculation\n");\n    sleep(1);\n    int sum = *data + *(data + 1);\n    printf("The sum of the ints in the shared memory is %d\n", sum);\n\n    printf("Signaling producer I'm done\n");\n    kill(otherpid, SIGUSR1);\n\n    if (sum == 0) break;\n#endif\n  }\n\n  signal(SIGUSR1, oldhandler);\n\n  /* detach from the segment: */\n  if (shmdt(data) == -1) {\n    perror("shmdt");\n    exit(1);\n  }\n\n  // don't forget to remove the shared segment from the command line with\n\n  // #sudo ipcs\n  // ... and look for the key of the shared memory segment\n\n  // #ipcrm -m <key>\n\n  return 0;\n}