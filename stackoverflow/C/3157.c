void smartSplit(string const& text, char delim, char esc, vector<string>& tokens)\n{\n    enum State { NORMAL, IN_ESC };\n    State state = NORMAL;\n    string frag;\n\n    for (size_t i = 0; i<text.length(); ++i)\n    {\n        char c = text[i];\n        switch (state)\n        {\n        case NORMAL:\n            if (c == delim)\n            {\n                if (!frag.empty())\n                    tokens.push_back(frag);\n                frag.clear();\n            }\n            else if (c == esc)\n                state = IN_ESC;\n            else\n                frag.append(1, c);\n            break;\n        case IN_ESC:\n            frag.append(1, c);\n            state = NORMAL;\n            break;\n        }\n    }\n    if (!frag.empty())\n        tokens.push_back(frag);\n}