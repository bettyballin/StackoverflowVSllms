if (bWait)\n{\n  // In order to allow updates of the GUI to happen while we're\n  // waiting for the application to finish, we must run a message\n  // pump here to allow messages to go through and get processed.\n  LONG  nIdleCount = 0;\n  for (;;)\n  {\n    MSG msg;\n    if (::PeekMessage(&msg, NULL, 0, 0, PM_NOREMOVE))\n      PumpMessage();\n    else //if (!OnIdle(nIdleCount++))\n    {\n      nIdleCount = 0;\n      if (!PeekMessage(&msg, NULL, 0, 0, PM_NOREMOVE))\n      {\n        DWORD nRes = ::MsgWaitForMultipleObjects(1, &ProcessInfo.hProcess,\n                                                 FALSE, INFINITE, QS_ALLEVENTS);\n        if (nRes == WAIT_OBJECT_0)\n          break;\n      }\n    }\n  }\n}\n::GetExitCodeProcess(ProcessInfo.hProcess, &dwExitCode);