CString FindRecycleBinOnDrive(LPCWSTR path)\n{\n    CString search;\n    search.Format(L"%c:\\*", path[0]);\n    WIN32_FIND_DATA fd = {0};\n    HANDLE fHandle = FindFirstFile(search, &fd);\n    while(INVALID_HANDLE_VALUE != fHandle)\n    {\n        if(FILE_ATTRIBUTE_DIRECTORY == (fd.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY)) //only check directories\n        {\n            if(0 != (fd.dwFileAttributes & (FILE_ATTRIBUTE_SYSTEM | FILE_ATTRIBUTE_HIDDEN))) //only check hidden and/or system directories\n            {\n                //the recycle bin directory itself won't be marked, but a SID-specific child directory will, so now look at them\n                CString childSearch;\n                childSearch.Format(L"%c:\\%s\\*", path[0], fd.cFileName);\n                WIN32_FIND_DATA childFD = {0};\n                HANDLE childHandle = FindFirstFile(childSearch, &childFD);\n                while(INVALID_HANDLE_VALUE != childHandle)\n                {\n                    if((FILE_ATTRIBUTE_DIRECTORY == (childFD.dwFileAttributes & FILE_ATTRIBUTE_DIRECTORY)) && //only check directories\n                        (childFD.cFileName[0] != L'.')) //don't check . and .. dirs\n                    {\n                        CString fullPath;\n                        fullPath.Format(L"%c:\\%s\\%s", path[0], fd.cFileName, childFD.cFileName);\n                        CLSID id = {0};\n                        HRESULT hr = GetFolderCLSID(fullPath, id);\n                        if(SUCCEEDED(hr))\n                        {\n                            if(IsEqualGUID(CLSID_RecycleBin, id))\n                            {\n                                FindClose(childHandle);\n                                FindClose(fHandle);\n                                //return the parent (recycle bin) directory\n                                fullPath.Format(L"%c:\\%s", path[0], fd.cFileName);\n                                return fullPath;\n                            }\n                        }\n                        else\n                        {\n                            Log(logERROR, L"GetFolderCLSID returned %08X for %s", hr, fullPath);\n                        }\n                    }\n\n                    if(FALSE == FindNextFile(childHandle, &childFD))\n                    {\n                        FindClose(childHandle);\n                        childHandle = INVALID_HANDLE_VALUE;\n                    }\n                }\n            }\n        }\n        if(FALSE == FindNextFile(fHandle, &fd))\n        {\n            FindClose(fHandle);\n            fHandle = INVALID_HANDLE_VALUE;\n        }\n    }\n    _ASSERT(0);\n    return L"";\n}\n\n\n//Works on Windows 2000, and even as Local System account\nHRESULT GetFolderCLSID(LPCWSTR path, CLSID& pathCLSID)\n{\n    LPMALLOC pMalloc = NULL;\n    HRESULT hr = 0;\n    if (SUCCEEDED(hr = SHGetMalloc(&pMalloc))) \n    {\n        LPSHELLFOLDER pshfDesktop = NULL;\n        if (SUCCEEDED(hr = SHGetDesktopFolder(&pshfDesktop))) \n        {\n            LPITEMIDLIST pidl = NULL;\n            DWORD dwAttributes = SFGAO_FOLDER;\n            if (SUCCEEDED(hr = pshfDesktop->ParseDisplayName(NULL, NULL, (LPWSTR)path, NULL, &pidl, &dwAttributes))) \n            {\n                LPPERSIST pPersist = NULL;\n                if (SUCCEEDED(hr = pshfDesktop->BindToObject(pidl, NULL, IID_IPersist, (LPVOID *) &pPersist))) \n                {\n                    hr = pPersist->GetClassID(&pathCLSID); \n                    pPersist->Release();\n                } \n                pMalloc->Free(pidl);\n            } \n            pshfDesktop->Release();\n        } \n        pMalloc->Release();\n    }\n    return hr;\n}\n\n\n//Not supported on Windows 2000 since SHParseDisplayName wasn't implemented then\n//HRESULT GetFolderCLSID(LPCWSTR pszPath, CLSID& pathCLSID)\n//{\n//  SHDESCRIPTIONID did = {0};\n//  HRESULT hr = 0;\n//  LPITEMIDLIST pidl = NULL;\n//  if (SUCCEEDED(hr = SHParseDisplayName(pszPath, NULL, &pidl, 0, NULL))) //not supported by Windows 2000\n//  {\n//      IShellFolder *psf = NULL;\n//      LPCITEMIDLIST pidlChild = NULL;\n//      if (SUCCEEDED(hr = SHBindToParent(pidl, IID_IShellFolder, (void**)&psf, &pidlChild))) \n//      {\n//          hr = SHGetDataFromIDList(psf, pidlChild, SHGDFIL_DESCRIPTIONID, &did, sizeof(did));\n//          psf->Release();\n//          pathCLSID = did.clsid;\n//      }\n//      CoTaskMemFree(pidl);\n//  }\n//  return hr;\n//}