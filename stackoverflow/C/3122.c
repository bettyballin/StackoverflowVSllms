//\n// some data will be shared across all\n// instances of the DLL\n//\n#pragma comment(linker, "/SECTION:.SHARED,RWS")\n#pragma data_seg(".SHARED")\nint iKeyCount = 0;\nHHOOK hKeyboardHook = 0;\nHHOOK hMouseHook = 0;\n#pragma data_seg()\n\n//\n// instance specific data\n//\nHMODULE hInstance = 0;\n\n//\n// DLL load/unload entry point\n//\nBOOL APIENTRY DllMain(HANDLE hModule, \n                      DWORD  dwReason, \n                      LPVOID lpReserved)\n{\n   switch (dwReason)\n   {\n   case DLL_PROCESS_ATTACH :\n      hInstance = (HINSTANCE) hModule;\n      break;\n\n   case DLL_THREAD_ATTACH :\n      break;\n\n   case DLL_THREAD_DETACH :\n      break;\n\n   case DLL_PROCESS_DETACH :\n      break;\n   }\n   return TRUE;\n}\n\n//\n// keyboard hook\n//\nLRESULT CALLBACK KeyboardProc(int code,       // hook code\n                              WPARAM wParam,  // virtual-key code\n                              LPARAM lParam)  // keystroke-message information\n{\n   if ((lParam & 0x80000000) != 0)\n   {\n      ++iKeyCount;\n   }\n   return CallNextHookEx(hKeyboardHook, code, wParam, lParam);\n}\n\n//\n// mouse hook\n//\nLRESULT CALLBACK MouseProc(int code,       // hook code\n                           WPARAM wParam,  // message identifier\n                           LPARAM lParam)  // mouse coordinates\n{\n   switch (wParam)\n   {\n   case WM_LBUTTONDOWN :\n   case WM_MBUTTONDOWN :\n   case WM_RBUTTONDOWN :\n   case WM_LBUTTONDBLCLK :\n   case WM_MBUTTONDBLCLK :\n   case WM_RBUTTONDBLCLK :\n      ++iKeyCount;\n      break;\n   }\n   return CallNextHookEx(hMouseHook, code, wParam, lParam);\n}\n\n//\n// install keyboard/mouse hooks\n//\nvoid KBM_API InstallHooks(void)\n{\n   hKeyboardHook = SetWindowsHookEx(WH_KEYBOARD, KeyboardProc, hInstance, 0);\n   hMouseHook = SetWindowsHookEx(WH_MOUSE, MouseProc, hInstance, 0);\n}\n\n//\n// remove keyboard/mouse hooks\n//\nvoid KBM_API RemoveHooks(void)\n{\n   UnhookWindowsHookEx(hKeyboardHook);\n   UnhookWindowsHookEx(hMouseHook);\n   hKeyboardHook = hMouseHook = 0;\n}\n\n//\n// retrieve number of keystrokes\n//\nint KBM_API FetchKeyCount(bool bClear)\n{\n   int kc = iKeyCount;\n   if (bClear)\n      iKeyCount = 0;\n   return kc;\n}