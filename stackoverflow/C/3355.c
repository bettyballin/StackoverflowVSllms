int SaveJpeg(HBITMAP hBmp, LPCWSTR lpszFilename, ULONG uQuality)\n{\n    ULONG *pBitmap = NULL;\n    CLSID imageCLSID;\n    EncoderParameters encoderParams;\n    int iRes = 0;\n\n    typedef Status (WINAPI *pGdipCreateBitmapFromHBITMAP)(HBITMAP, HPALETTE, ULONG**);\n    pGdipCreateBitmapFromHBITMAP lGdipCreateBitmapFromHBITMAP;\n\n    typedef Status (WINAPI *pGdipSaveImageToFile)(ULONG *, const WCHAR*, const CLSID*, const EncoderParameters*);\n    pGdipSaveImageToFile lGdipSaveImageToFile;\n\n    // load GdipCreateBitmapFromHBITMAP\n    lGdipCreateBitmapFromHBITMAP = (pGdipCreateBitmapFromHBITMAP)GetProcAddress(hModuleThread, "GdipCreateBitmapFromHBITMAP");\n    if(lGdipCreateBitmapFromHBITMAP == NULL)\n    {\n        // error\n        return 0;\n    }\n\n    // load GdipSaveImageToFile\n    lGdipSaveImageToFile = (pGdipSaveImageToFile)GetProcAddress(hModuleThread, "GdipSaveImageToFile");\n    if(lGdipSaveImageToFile == NULL)\n    {\n        // error\n        return 0;\n    }\n\n        lGdipCreateBitmapFromHBITMAP(hBmp, NULL, &pBitmap);\n\n       iRes = GetEncoderClsid(L"image/jpeg", &imageCLSID);\n       if(iRes == -1)\n    {\n        // error\n        return 0;\n    }\n    encoderParams.Count = 1;\n    encoderParams.Parameter[0].NumberOfValues = 1;\n    encoderParams.Parameter[0].Guid  = EncoderQuality;\n    encoderParams.Parameter[0].Type  = EncoderParameterValueTypeLong;\n    encoderParams.Parameter[0].Value = &uQuality;\n\n    lGdipSaveImageToFile(pBitmap, lpszFilename, &imageCLSID, &encoderParams);\n\n\n    return 1;\n}