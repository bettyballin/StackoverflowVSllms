protected override void PrintDocument(XmlDocument document, string xsltFileName, string directory, string tempImageDirectory)\n{\n    StringUtils.EscapeQuotesInXmlNode(document);\nif (RemoveDiatrics)\n{\n    var docXml = StringUtils.RemoveDiatrics(document.OuterXml);\n    document = new XmlDocument();\n    document.LoadXml(docXml);\n}\n\nIOException ex = null;\nfor (var attempts = 0; attempts < 10; attempts++)\n{\n    ex = tryWriteToFile(document, directory, xsltFileName);\n    if (ex == null)\n        break;\n}\n\nif (ex != null)\n    throw new ApplicationException("Cannot write to file", ex);\n}\n\nprivate IOException tryWriteToFile(XmlDocument document, string directory, string xsltFileName)\n{\ntry\n{\n    using (var writer = new StreamWriter(new FileStream(string.Format("{0}{1}{2}", directory, "batch", FileExtension), FileMode.Append, FileAccess.Write, FileShare.Read), Encoding.ASCII))\n    {\n        Transform(document, xsltFileName, writer);\n    writer.Close();\n    }\n    return null;\n}\ncatch (IOException e)\n{\n    return e;\n}\n}