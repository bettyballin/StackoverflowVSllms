using System;\nusing System.Net;\nusing System.Collections.Generic;\nusing System.Text;\nusing System.Security.Cryptography;\n\nnamespace xxx\n{\nclass STUNPacket\n{\n    static RNGCryptoServiceProvider m_rand=new RNGCryptoServiceProvider();\n\n    private byte[] m_requestid=new byte[16];\n\n    public STUNPacket()\n    {\n        m_rand.GetBytes(m_requestid);\n    }\n\n    public byte[] CreateRequest()\n    {\n        byte[] packet=new byte[0x1c] {\n            //Header:\n            0x00,0x01,      //Art des STUN-Pakets: 0x0001=Binding Request\n            0x00,0x08,      //Länge des Pakets ohne Header\n            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,    //Transkations-ID\n            //Message-Attribute:\n            0x00,0x03,      //Typ: Change-Request\n            0x00,0x04,      //Länge: 4 Bytes\n            0x00,0x00,0x00,0x00 //Weder IP, noch Port ändern\n        };\n\n        for(int i=0;i<16;i++)\n            packet[i+4]=m_requestid[i];\n\n        return packet;\n    }\n\n    public IPEndPoint ParseResponse(byte[] paket)\n    {\n        if (paket.Length<20)\n            throw new Exception("STUN-Response zu kurz, um einen Header zu haben");\n        if (paket[0]!=1||paket[1]!=1)\n            throw new Exception("STUN-Reposne hat falschen Typ, muss Binding-Response sein");\n        for (int i=0;i<16;i++)\n            if (paket[i+4]!=m_requestid[i])\n                throw new Exception("STUN-Antwort hat falsche Transkations-ID");\n        int size=paket[2]*256+paket[3];\n        int pos=20;\n        for(;;)\n        {\n            if (size<4)\n                throw new Exception("Verbleibende Nachricht zu kurz für weiteren Attributheader, "+\n                    "Mapped-Adress-Attribut nicht gefunden");\n            int attrsize=paket[pos+2]*256+paket[pos+3];\n            if (pos+4+attrsize>paket.Length)\n                throw new Exception("Attributheader hat Länge, die nicht mehr ins Paket passt");\n            //Wenn kein Mapped-Adress-Attribut, dann überspringen\n            if (paket[pos]!=0||paket[pos+1]!=1)\n            {\n                pos+=attrsize;\n                continue;\n            }\n            if (attrsize<8)\n                throw new Exception("Mapped-Adress-Attribut ist zu kurz");\n            if (paket[pos+5]!=1)\n                throw new Exception("Adreßfamilie von Mapped-Adress ist nicht IPV4");\n            int port=paket[pos+6]*256+paket[pos+7];\n            IPAddress adress=new IPAddress(new byte[4] { paket[pos+8],paket[pos+9],paket[pos+10],paket[pos+11] });\n            return new IPEndPoint(adress,port);\n        }\n    }\n\n}