public static DataTable ToDataTable<T>(this IEnumerable<T> collection)\n    {\n        DataTable dt = new DataTable("DataTable");\n        Type t = typeof(T);\n        PropertyInfo[] pia = t.GetProperties();\n\n        //Inspect the properties and create the columns in the DataTable\n        foreach (PropertyInfo pi in pia)\n        {\n            Type ColumnType = pi.PropertyType;\n            if ((ColumnType.IsGenericType))\n            {\n                ColumnType = ColumnType.GetGenericArguments()[0];\n            }\n            dt.Columns.Add(pi.Name, ColumnType);\n        }\n\n        //Populate the data table\n        foreach (T item in collection)\n        {\n            DataRow dr = dt.NewRow();\n            dr.BeginEdit();\n            foreach (PropertyInfo pi in pia)\n            {\n                if (pi.GetValue(item, null) != null)\n                {\n                    dr[pi.Name] = pi.GetValue(item, null);\n                }\n            }\n            dr.EndEdit();\n            dt.Rows.Add(dr);\n        }\n        return dt;\n    }