void Application_PreRequestHandlerExecute(Object sender, EventArgs e)\n{\n string sPage = Request.ServerVariables["SCRIPT_NAME"];\n if (!sPage.EndsWith("Maintenance.aspx", StringComparison.OrdinalIgnoreCase))\n {\n  //test the database connection\n  //if it fails then redirect the user to Maintenance.aspx\n  string connStr = ConfigurationManager.ConnectionString["ConnectionString"].ConnectionString;\n  SqlConnection conn = new SqlConnection(connStr);\n  try\n  {\n   conn.Open();\n  }\n  catch(Exception ex)\n  {\n   Session["DBException"] = ex;\n   Response.Redirect("Maintenance.aspx");\n  }\n  finally\n  {\n   conn.Close();\n  }\n }\n}