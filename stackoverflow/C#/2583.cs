using System.DirectoryServices;\n    using System.IO;\n    /// <summary>\n    /// Creates the virtual directory.\n    /// </summary>\n    /// <param name="webSite">The web site.</param>\n    /// <param name="appName">Name of the app.</param>\n    /// <param name="path">The path.</param>\n    /// <returns></returns>\n    /// <exception cref="Exception"><c>Exception</c>.</exception>\n    public static bool CreateVirtualDirectory(string webSite, string appName, string path)\n    {\n        var schema = new DirectoryEntry("IIS://" + webSite + "/Schema/AppIsolated");\n        bool canCreate = !(schema.Properties["Syntax"].Value.ToString().ToUpper() == "BOOLEAN");\n        schema.Dispose();\n\n        if (canCreate)\n        {\n            bool pathCreated = false;\n            try\n            {\n                var admin = new DirectoryEntry("IIS://" + webSite + "/W3SVC/1/Root");\n\n                //make sure folder exists\n                if (!Directory.Exists(path))\n                {\n                    Directory.CreateDirectory(path);\n                    pathCreated = true;\n                }\n\n                //If the virtual directory already exists then delete it\n                IEnumerable<DirectoryEntry> matchingEntries = admin.Children.Cast<DirectoryEntry>().Where(v => v.Name == appName);\n                foreach (DirectoryEntry vd in matchingEntries)\n                {\n                    admin.Invoke("Delete", new[] { vd.SchemaClassName, appName }); \n                    admin.CommitChanges();\n                    break;\n                }\n\n                //Create and setup new virtual directory\n                DirectoryEntry vdir = admin.Children.Add(appName, "IIsWebVirtualDir");\n\n                vdir.Properties["Path"][0] = path;\n                vdir.Properties["AppFriendlyName"][0] = appName;\n                vdir.Properties["EnableDirBrowsing"][0] = false;\n                vdir.Properties["AccessRead"][0] = true;\n                vdir.Properties["AccessExecute"][0] = true;\n                vdir.Properties["AccessWrite"][0] = false;\n                vdir.Properties["AccessScript"][0] = true;\n                vdir.Properties["AuthNTLM"][0] = true;\n                vdir.Properties["EnableDefaultDoc"][0] = true;\n                vdir.Properties["DefaultDoc"][0] =\n                    "default.aspx,default.asp,default.htm";\n                vdir.Properties["AspEnableParentPaths"][0] = true;\n                vdir.CommitChanges();\n\n                //the following are acceptable params\n                //INPROC = 0, OUTPROC = 1, POOLED = 2\n                vdir.Invoke("AppCreate", 1);\n\n                return true;\n            }\n            catch (Exception)\n            {\n                if (pathCreated)\n                    Directory.Delete(path);\n                throw;\n            }\n        }\n        return false;\n    }