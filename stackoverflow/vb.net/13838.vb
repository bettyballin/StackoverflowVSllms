Dim query4 = From loc In dc.Locations _\n                 Let curNames = (From ons In dc.organization_names _\n                                Where ons.eff_date <= ssDate _\n                                Order By ons.eff_date Descending _\n                                Group ons By ons.organization_id Into gNames = Group _\n                                Select New With { _\n                                    Key .Key = organization_id, _\n                                    .Result = gNames.Take(1)}) _\n                                    .SelectMany(Function(a) (a.Result)) _\n                Let curLocs = (From oLocs In dc.organization_locations _\n                               Where oLocs.eff_date <= ssDate _\n                               Order By oLocs.eff_date Descending _\n                               Group oLocs By oLocs.organization_id Into gLocs = Group _\n                               Select New With { _\n                                Key .Key = organization_id, _\n                                .Result = gLocs.Take(1)}) _\n                                .SelectMany(Function(a) (a.Result)) _\n                Where loc.AltLat IsNot Nothing And loc.AltLong IsNot Nothing _\n                Select New AnnexA.Entities.AnnexALocation With { _\n                    .ID = loc.ID, .Name = loc.Location, .Y = loc.AltLat, .X = loc.AltLong, _\n                    .Units = From curLoc In curLocs _\n                             Where curLoc.location = loc.ID _\n                             From curName In curNames _\n                             Where curName.organization_id = curLoc.organization_id _\n                             Select New AnnexA.Entities.AnnexAMillitaryUnit With { _\n                                .ID = curLoc.organization_id, _\n                                .Name = curName.name, _\n                                .IconPath = curName.icon}}