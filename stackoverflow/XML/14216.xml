<xsl:template name="normalizeName">\n  <xsl:param name="name" />\n  <xsl:param name="isFirst" select="true()" />\n  <xsl:if test="$name != ''">\n    <xsl:variable name="first" select="substring($name, 1, 1)" />\n    <xsl:variable name="rest" select="substring($name, 2)" />\n    <xsl:choose>\n      <xsl:when test="contains('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ:_', $first) or\n                      (not($first) and contains('0123456789.-', $first))">\n        <xsl:value-of select="$first" />\n      </xsl:when>\n      <xsl:otherwise>\n        <xsl:text>_</xsl:text>\n      </xsl:otherwise>\n    </xsl:choose>\n    <xsl:call-template name="normalizeName">\n      <xsl:with-param name="name" select="$rest" />\n      <xsl:with-param name="isFirst" select="false()" />\n    </xsl:call-template>\n  </xsl:if>\n</xsl:template>