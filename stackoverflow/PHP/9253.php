<?php\n    class membership\n    {\n        var $permissions;\n        var $full_name;\n        var $username;\n        var $group_level;\n\n        function membership(){\n            session_start();\n        }\n\n        function login ($username, $password){\n            global $db, $layout;\n\n\n            $password = stripslashes($password);\n            $password = md5(md5($password));\n\n\n            $get_user = $db->get_row("SELECT * FROM aiki_users where username='".$username."' and password='".$password."' limit 1");\n\n            if($get_user->username == $username and $get_user->password == $password){\n\n                $host_name = $_SERVER['HTTP_HOST'];\n                $user_ip = $this->get_ip();\n\n\n                $usersession = $this->generate_session(100);\n                $_SESSION['aiki'] = $usersession;\n\n                $insert_session = $db->query("INSERT INTO aiki_users_sessions (`session_id`,`user_id`,`user_name`,`session_date`,`user_session`, `user_ip`) VALUES ('','$get_user->userid','$username',NOW(),'$usersession','$user_ip')");\n                $update_acces = $db->query("UPDATE `aiki_users` SET `last_login`= NOW(),`last_ip`='$user_ip', `logins_number`=`logins_number`+1 WHERE `userid`='$get_user->userid' LIMIT 1");\n\n            } else{\n            }\n\n        }\n\n        function isUserLogged ($userid){\n            global $db;\n            $user_session = $db->get_var("SELECT user_id FROM aiki_users_sessions where user_session='$_SESSION[aiki]'");\n            if ($user_session == $userid){\n                return true;\n            }else{\n                return false;\n            }\n        }\n\n        function getUserPermissions ($user){\n            global $db;\n            $user = mysql_escape_string($user);\n\n            $user = $db->get_row("SELECT userid, usergroup, full_name, username FROM aiki_users where username='$user'");\n            if ($user->userid and $this->isUserLogged($user->userid)){\n                $group_permissions = $db->get_row("SELECT group_permissions, group_level FROM aiki_users_groups where id='$user->usergroup'");\n\n                $this->full_name = $user->full_name;\n                $this->username = $user->username;\n                $this->group_level= $group_permissions->group_level;\n\n\n            }else{\n                $this->permissions = "";\n            }\n\n            $this->permissions = $group_permissions->group_permissions;\n        }\n\n        //function from Membership V1.0\n        //http://AwesomePHP.com/gpl.txt\n        function get_ip(){\n            $ipParts = explode(".", $_SERVER['REMOTE_ADDR']);\n            if ($ipParts[0] == "165" && $ipParts[1] == "21") {\n                if (getenv("HTTP_CLIENT_IP")) {\n                    $ip = getenv("HTTP_CLIENT_IP");\n                } elseif (getenv("HTTP_X_FORWARDED_FOR")) {\n                    $ip = getenv("HTTP_X_FORWARDED_FOR");\n                } elseif (getenv("REMOTE_ADDR")) {\n                    $ip = getenv("REMOTE_ADDR");\n                }\n            } else {\n                return $_SERVER['REMOTE_ADDR'];\n            }\n            return $ip;\n        }\n\n        //Generate session\n        function generate_session($strlen){\n            return substr(md5(uniqid(rand(),true)),1,$strlen);\n        }\n\n\n\n        function LogOut(){\n            global $db, $layout;\n            $domain = $_SERVER['HTTP_HOST'];\n            $path = $_SERVER['SCRIPT_NAME'];\n            $queryString = $_SERVER['QUERY_STRING'];\n            $thisurlnologout = "http://" . $domain . $path . "?" . $queryString;\n            $thisurlnologout = str_replace("&operators=logout", "", $thisurlnologout);\n\n            $make_offline = $db->query("UPDATE `aiki_guests` SET `is_online`='0' WHERE `guest_session`='$_SESSION[aiki]' LIMIT 1");\n            $delete_session_data = $db->query("DELETE FROM aiki_users_sessions where user_session='$_SESSION[aiki]'");\n            unset($_SESSION['aiki']);\n            session_destroy();\n            session_unset();\n            $layout->html_output .= '<META HTTP-EQUIV="refresh" content="1;URL=http://'.$domain.$path.'"><center><b>Logging out</b></center>';\n            //die();\n        }\n\n    }\n?>