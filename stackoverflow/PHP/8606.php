<?\n    define('CONST1', 'value'   );\ndefine   (CONST2, 'value2');\ndefine(   'CONST3', time());\n  define('define', 'define');\n    define("test", VALUE4);\ndefine('const5', //\n\n'weird declaration'\n)    ;\ndefine('CONST7', 3.14);\ndefine ( /* comment */ 'foo', 'bar');\n$defn = 'blah';\ndefine($defn, 'foo');\ndefine( 'CONST4', define('CONST5', 6));\n\nheader('Content-Type: text/plain');\n\n$defines = array();\n$state = 0;\n$key = '';\n$value = '';\n\n$file = file_get_contents('test.php');\n$tokens = token_get_all($file);\n$token = reset($tokens);\nwhile ($token) {\n//    dump($state, $token);\n    if (is_array($token)) {\n        if ($token[0] == T_WHITESPACE || $token[0] == T_COMMENT || $token[0] == T_DOC_COMMENT) {\n            // do nothing\n        } else if ($token[0] == T_STRING && strtolower($token[1]) == 'define') {\n            $state = 1;\n        } else if ($state == 2 && is_constant($token[0])) {\n            $key = $token[1];\n            $state = 3;\n        } else if ($state == 4 && is_constant($token[0])) {\n            $value = $token[1];\n            $state = 5;\n        }\n    } else {\n        $symbol = trim($token);\n        if ($symbol == '(' && $state == 1) {\n            $state = 2;\n        } else if ($symbol == ',' && $state == 3) {\n            $state = 4;\n        } else if ($symbol == ')' && $state == 5) {\n            $defines[strip($key)] = strip($value);\n            $state = 0;\n        }\n    }\n    $token = next($tokens);\n}\n\nforeach ($defines as $k => $v) {\n    echo "'$k' => '$v'\n";\n}\n\nfunction is_constant($token) {\n    return $token == T_CONSTANT_ENCAPSED_STRING || $token == T_STRING ||\n        $token == T_LNUMBER || $token == T_DNUMBER;\n}\n\nfunction dump($state, $token) {\n    if (is_array($token)) {\n        echo "$state: " . token_name($token[0]) . " [$token[1]] on line $token[2]\n";\n    } else {\n        echo "$state: Symbol '$token'\n";\n    }\n}\n\nfunction strip($value) {\n    return preg_replace('!^([\'"])(.*)\1$!', '$2', $value);\n}\n?>