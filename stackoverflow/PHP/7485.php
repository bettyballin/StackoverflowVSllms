<?php\nheader('Content-type: text/plain; charset=utf-8');\n\nfunction printTruncated($maxLength, $html, $isUtf8=true)\n{\n    $printedLength = 0;\n    $position = 0;\n    $tags = array();\n\n    // For UTF-8, we need to count multibyte sequences as one character.\n    $re = $isUtf8\n        ? '{</?([a-z]+)[^>]*>|&#?[a-zA-Z0-9]+;|[\x80-\xFF][\x80-\xBF]*}'\n        : '{</?([a-z]+)[^>]*>|&#?[a-zA-Z0-9]+;}';\n\n    while ($printedLength < $maxLength && preg_match($re, $html, $match, PREG_OFFSET_CAPTURE, $position))\n    {\n        list($tag, $tagPosition) = $match[0];\n\n        // Print text leading up to the tag.\n        $str = substr($html, $position, $tagPosition - $position);\n        if ($printedLength + strlen($str) > $maxLength)\n        {\n            print(substr($str, 0, $maxLength - $printedLength));\n            $printedLength = $maxLength;\n            break;\n        }\n\n        print($str);\n        $printedLength += strlen($str);\n        if ($printedLength >= $maxLength) break;\n\n        if ($tag[0] == '&' || ord($tag) >= 0x80)\n        {\n            // Pass the entity or UTF-8 multibyte sequence through unchanged.\n            print($tag);\n            $printedLength++;\n        }\n        else\n        {\n            // Handle the tag.\n            $tagName = $match[1][0];\n            if ($tag[1] == '/')\n            {\n                // This is a closing tag.\n\n                $openingTag = array_pop($tags);\n                assert($openingTag == $tagName); // check that tags are properly nested.\n\n                print($tag);\n            }\n            else if ($tag[strlen($tag) - 2] == '/')\n            {\n                // Self-closing tag.\n                print($tag);\n            }\n            else\n            {\n                // Opening tag.\n                print($tag);\n                $tags[] = $tagName;\n            }\n        }\n\n        // Continue after the tag.\n        $position = $tagPosition + strlen($tag);\n    }\n\n    // Print any remaining text.\n    if ($printedLength < $maxLength && $position < strlen($html))\n        print(substr($html, $position, $maxLength - $printedLength));\n\n    // Close any open tags.\n    while (!empty($tags))\n        printf('</%s>', array_pop($tags));\n}\n\n\nprintTruncated(10, '<b>&lt;Hello&gt;</b> <img src="world.png" alt="" /> world!'); print("\n");\n\nprintTruncated(10, '<table><tr><td>Heck, </td><td>throw</td></tr><tr><td>in a</td><td>table</td></tr></table>'); print("\n");\n\nprintTruncated(10, "<em><b>Hello</b>&#20;w\xC3\xB8rld!</em>"); print("\n");