function link_keywords($str, $keyword, $url) {\n    $keyword = preg_quote($keyword, '/');\n    $url = htmlspecialchars($url);\n\n    // Use split the string on all <a> tags, keeping the matched delimiters:\n    $split_str = preg_split('#(<a\s.*?</a>)#i', $str, -1, PREG_SPLIT_DELIM_CAPTURE);\n\n    // loop through the results and process the sections between <a> tags\n    $result = '';\n    foreach ($split_str as $sub_str) {\n        if (preg_match('#^<a\s.*?</a>$#i', $sub_str)) {\n            $result .= $sub_str;\n        } else {\n            // split on all remaining tags\n            $split_sub_str = preg_split('/(<.+?>)/', $sub_str, -1, PREG_SPLIT_DELIM_CAPTURE);\n            foreach ($split_sub_str as $sub_sub_str) {\n                if (preg_match('/^<.+>$/', $sub_sub_str)) {\n                    $result .= $sub_sub_str;\n                } else {\n                    $result .= preg_replace('/'.$keyword.'/', '<a href="'.$url.'">$0</a>', $sub_sub_str);\n                }\n            }\n        }\n    }\n    return $result;\n}