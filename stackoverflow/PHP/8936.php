<?php\n\n$query = mysql_query("SELECT * FROM eventcal WHERE eventDate = '$date' ORDER BY region");\n\n$doc = new DomDocument("1.0");\n\n$root = $doc->createElement('data');\n$root = $doc->appendChild($root);\n\n$currentRegionId = -1;\n$currentRegionNode = null;\n\nif (@mysql_num_rows($query)) {\n        while ($row=@mysql_fetch_assoc($query)) {\n\n        if ($row['region'] != $currentRegionId)\n        {\n            $currentRegionId = $row['region'];\n\n            $node = $doc->createElement('collection');\n            $node = $root->appendChild($node);\n\n            $currentRegionNode = $doc->createElement('region');\n            $currentRegionNode->setAttribute('id', $row['region']);\n            $node->appendChild($currentRegionNode);\n        }\n\n        foreach($row as $fieldname => $fieldvalue){\n            if ($fieldname != 'region')\n                $currentRegionNode->appendChild($doc->createElement($fieldname, $fieldvalue));\n        }\n    }\n}\n\n?>