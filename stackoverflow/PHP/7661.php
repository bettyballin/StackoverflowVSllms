<?php\n$string = '{body}';\n$documentSource = mb_substr($string,3,-4);\n\n$doc = new DOMDocument();\n$doc->loadHTML($documentSource);\n$xpath = new DOMXPath($doc);\nforeach ($xpath->query('//html/body/img') as $node) {\n    $node->removeAttribute('height');\n    $node->removeAttribute('width');\n    $source = $node->getAttribute('src');\n\n    $node->setAttribute('src', '/system/tools/phpthumb/phpThumb.php?src=' . $source . '&wl=200&hp=200&q=85&f=jpg');\n\n    $pElem = $doc->createElement('p', $node->getAttribute('alt'));\n\n    $divElem = $doc->createElement('div');\n    $divElem->setAttribute('class', 'caption '.$node->getAttribute('class'));\n    $node->removeAttribute('class');\n\n    $divElem->appendChild($node->cloneNode(true));\n    $divElem->appendChild($pElem);\n    $node->parentNode->replaceChild($divElem, $node);\n\n}\n?>