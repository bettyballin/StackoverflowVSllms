require 'uri'\n  require 'webrick/cgihttpserver'\n\n  class CgiHandler\n    def initialize(app)\n      @app = app\n    end\n\n    def call(env)\n      path = env['PATH_INFO']\n      return @app.call(env) unless path.end_with?('.rb')\n\n      script_path = File.join(Rails.root, 'public', path)\n\n      if File.exist?(script_path) && File.extname(path) == '.rb'\n        cgi = WEBrick::HTTPServlet::CGIHandler.new(script_path)\n        output = StringIO.new\n        server = OpenStruct.new(server_name: 'localhost', port: 3000, logger: Rails.logger)\n        request = WEBrick::HTTPRequest.new(Log: [], Socket: env['rack.input'])\n        request.parse\n        response = WEBrick::HTTPResponse.new(HTTPVersion: '1.0')\n        request.script_name = path\n        request.path_info = ''\n        cgi.setup(server, request, response)\n        cgi.run\n        body = response.body.split("\r\n").select { |line| !line.match(/^Content-Length:/) }.join("\r\n")\n        return [response.status, {'Content-Type' => response['content-type'], 'Content-Length' => body.length.to_s}, [body]]\n      else\n        @app.call(env)\n      end\n    end\n  end