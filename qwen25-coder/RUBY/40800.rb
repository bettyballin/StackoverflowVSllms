def test_uses_referrer_for_return_to\n  expected_return_to = 'http://test.com/foo'\n  @request.env['HTTP_REFERER'] = expected_return_to\n  get :fazbot\n\n  # Parse the query from the redirected URL\n  parsed_url = URI.parse(@response.redirected_to)\n  params = Rack::Utils.parse_nested_query(parsed_url.query)\n\n  # Extract and decode the return_to parameter\n  actual_return_to = params['return_to']\n\n  assert_equal expected_return_to, CGI.unescape(actual_return_to)\nend