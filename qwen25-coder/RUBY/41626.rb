def wrap_long_string_preserving_urls(txt, col = 50)\n  txt.gsub(/https?:\/\/[^\s]+|\S{#{col}}|\S+/) do |match|\n    if match =~ /https?:\/\//\n      match # Don't alter URLs\n    else\n      wrap_non_url(match, col)\n    end\n  end\nend\n\ndef wrap_non_url(txt, col)\n  txt.gsub(/(.{1,#{col - 1}})( +|$\n?)|(.{1,#{col - 1}})/, "\\1\\3\n")\nend\n\n# Usage in your view:\nauto_link(h(wrap_long_string_preserving_urls(post.text, 50))).gsub(/\n/,"<br />")