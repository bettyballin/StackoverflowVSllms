context "on POST to :my_action" do\n  setup do\n    @site = Site.new # Assuming Site is a model\n    controller.stubs(:current_site).returns(@site)\n    @owner = Owner.new\n    @site.expects(:owner).returns(@owner)\n  end\n\n  context "when @site is nil" do\n    setup { @site = nil }\n    should_redirect_to(root_url)\n  end\n\n  context "with empty parameters" do\n    setup { post :my_action, email: '', password: '' }\n    should_set_the_flash.to("You must fill in both the e-mail and password fields")\n    should_render_template(:my_action)\n  end\n\n  context "with incorrect password" do\n    setup do\n      @owner.expects(:authenticated?).with('test').returns(false)\n      post :my_action, email: 'foo@bar.com', password: 'test'\n    end\n    should_set_the_flash.to("Incorrect password")\n    should_render_template(:my_action)\n  end\n\n  context "with correct credentials" do\n    setup do\n      @owner.expects(:authenticated?).with('test').returns(true)\n      @owner.expects(:login=).with('foo@bar.com')\n      @owner.expects(:save!).once.returns(true)\n      @owner.expects(:do_some_method)\n      post :my_action, email: 'foo@bar.com', password: 'test'\n    end\n    should_set_the_flash.to("Success.")\n    should_render_template(:my_action)\n  end\n\n  context "with correct credentials and save failure" do\n    setup do\n      @owner.expects(:authenticated?).with('test').returns(true)\n      @owner.expects(:login=).with('foo@bar.com')\n      @owner.expects(:save!).raises(ActiveRecord::RecordNotSaved)\n      post :my_action, email: 'foo@bar.com', password: 'test'\n    end\n    should_set_the_flash.to("Success.")\n    should_render_template(:my_action)\n  end\nend