class User < ApplicationRecord\n  has_many :messages\n  \n  before_save :update_message_count\n\n  private\n\n  def update_message_count\n    self.total_messages = messages.count\n  end\nend\n\nclass Message < ApplicationRecord\n  belongs_to :user\n\n  after_create :increment_counter_cache\n  after_destroy :decrement_counter_cache\n\n  private\n\n  def increment_counter_cache\n    user.increment!(:total_messages) if user && user.respond_to?(:total_messages)\n  end\n\n  def decrement_counter_cache\n    user.decrement!(:total_messages) if user && user.respond_to?(:total_messages)\n  end\nend