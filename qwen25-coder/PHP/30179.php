function crypt_apr1_md5($plainpasswd) {\n    $salt = substr(str_shuffle("abcdefghijklmnopqrstuvwxyz0123456789"), 0, 8);\n    $len = strlen($plainpasswd);\n    $text = $plainpasswd . '$apr1$' . $salt;\n    $bin = pack('H*', md5_16($plainpasswd . $salt . $plainpasswd));\n\n    for ($i = $len; $i > 0; $i -= 16) {\n        $text .= substr($bin, 0, min(16, $i));\n    }\n    for ($i = $len; $i > 0; $i >>= 1) {\n        $text .= ($i & 1) ? chr(0) : $plainpasswd{0};\n    }\n\n    $bin = pack('H*', md5_16($text));\n\n    for ($i = 0; $i < 1000; $i++) {\n        $new = ($i & 1) ? $plainpasswd : $bin;\n        if ($i % 3) {\n            $new .= $salt;\n        }\n        if ($i % 7) {\n            $new .= $plainpasswd;\n        }\n        $new .= ($i & 1) ? $bin : $plainpasswd;\n\n        $bin = pack('H*', md5_16($new));\n    }\n\n    $tmp = '';\n    for ($i = 0; $i < 5; $i++) {\n        $k = $i + 6;\n        $j = $i + 12;\n        if ($j == 16) {\n            $j = 5;\n        }\n        $tmp .= $bin[$i] . $bin[$k] . $bin[$j];\n    }\n\n    $tmp = str_split(strtr(base64_encode($tmp), 'A-Za-z0-9+/', './0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz'), 4);\n    $tmp[4] = ($salt[8] ? $this->itoa64[$salt[8]] : '.') . $this->itoa64[$salt[9]];\n    return '$apr1$' . $salt . '$' . implode('', array_slice($tmp, 0, -1));\n}\n\nfunction md5_16($string) {\n    return substr(md5($string), 0, 16);\n}