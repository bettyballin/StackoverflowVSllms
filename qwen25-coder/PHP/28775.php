<?php\n\nfunction calculatePercentileRank($userId, $timeSpan = null) {\n    $ci =& get_instance();\n    $ci->load->database();\n\n    // Base query for calculating reputation totals\n    $query = "SELECT SUM(value) as total_reputation FROM reputation WHERE user_id = {$userId}";\n\n    if ($timeSpan !== null) {\n        // Adjust the query based on the time span\n        $dateRange = date('Y-m-d H:i:s', strtotime("-{$timeSpan}"));\n        $query .= " AND created_at >= '{$dateRange}'";\n    }\n\n    // Get user's reputation total for the given time span\n    $userRepResult = $ci->db->query($query);\n    $userTotalReputation = $userRepResult->row()->total_reputation;\n\n    // Query to get all users' reputation totals within the same conditions\n    $allUserRepsQuery = "SELECT SUM(value) as total_reputation FROM reputation GROUP BY user_id HAVING COUNT(user_id)";\n    \n    if ($timeSpan !== null) {\n        $dateRange = date('Y-m-d H:i:s', strtotime("-{$timeSpan}"));\n        $allUserRepsQuery .= " AND created_at >= '{$dateRange}'";\n    }\n\n    // Get all reputation totals\n    $allUsersRepResult = $ci->db->query($allUserRepsQuery);\n    $allUsersReputations = array_map(function($row) { return (int)$row->total_reputation; }, $allUsersRepResult->result());\n\n    sort($allUsersReputations);\n\n    // Find the rank of user's reputation total\n    $rank = 0;\n    foreach ($allUsersReputations as $rep) {\n        if ($userTotalReputation >= $rep) {\n            $rank++;\n        } else {\n            break;\n        }\n    }\n\n    // Calculate percentile rank\n    $percentileRank = ($rank / count($allUsersReputations)) * 100;\n\n    return number_format($percentileRank, 2);\n}\n\n// Example usage: calculatePercentileRank(1138, '7 days');\n?>