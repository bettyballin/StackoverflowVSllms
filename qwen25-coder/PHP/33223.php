<?php\n$servername = "localhost";\n$username = "username";\n$password = "password";\n$dbname = "database_name";\n\n$conn = new mysqli($servername, $username, $password, $dbname);\n\nif ($conn->connect_error) {\n    die("Connection failed: " . $conn->connect_error);\n}\n\n$itemID = $_POST['item_id'];\n$tags = json_decode($_POST['tags']);\n\n// Start Transaction\n$conn->begin_transaction();\n\ntry {\n    // Delete existing tags for the item\n    $stmtDelete = $conn->prepare("DELETE FROM ItemTag WHERE ItemID = ?");\n    $stmtDelete->bind_param("i", $itemID);\n    $stmtDelete->execute();\n    \n    foreach ($tags as $tagTitle) {\n        if (empty($tagTitle)) continue;\n\n        // Check if tag already exists\n        $stmtSelect = $conn->prepare("SELECT TagID FROM Tag WHERE Title = ?");\n        $stmtSelect->bind_param("s", $tagTitle);\n        $stmtSelect->execute();\n        $stmtSelect->store_result();\n\n        if ($stmtSelect->num_rows > 0) {\n            // Tag exists, get ID\n            $stmtSelect->bind_result($tagID);\n            $stmtSelect->fetch();\n        } else {\n            // Insert new tag and return the id\n            $stmtInsertTag = $conn->prepare("INSERT INTO Tag (Title) VALUES (?)");\n            $stmtInsertTag->bind_param("s", $tagTitle);\n            $stmtInsertTag->execute();\n\n            $tagID = $stmtInsertTag->insert_id;\n        }\n\n        // Insert relation between item and tag\n        $stmtInsertItemTag = $conn->prepare("INSERT INTO ItemTag (ItemID, TagID) VALUES (?, ?)");\n        $stmtInsertItemTag->bind_param("ii", $itemID, $tagID);\n        $stmtInsertItemTag->execute();\n    }\n\n    // Commit transaction\n    $conn->commit();\n\n} catch(Exception $e) {\n    // Rollback transaction in case an error occurs\n    $conn->rollback();\n    echo "Error: " . $e->getMessage();\n}\n\n$conn->close();\n?>