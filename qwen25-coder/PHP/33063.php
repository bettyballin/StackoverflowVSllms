<?php\n// Assume $userPreferences contains user-specific filters like metal color\n$userPreferences = $_SESSION['user_preferences'] ?? [];\n\nfunction generateQuery($preferences) {\n    // Generate a database query based on the preferences\n    // Example is simplified and might vary based on actual requirements\n    $query = "SELECT * FROM products";\n    if (!empty($preferences)) {\n        $conditions = [];\n        foreach ($preferences as $key => $value) {\n            $conditions[] = "$key = '$value'";\n        }\n        $query .= ' WHERE ' . implode(' AND ', $conditions);\n    }\n    return $query;\n}\n\nfunction executeQuery($query) {\n    // Execute the query and fetch results\n    global $mysqli;  // Assuming you have already established a database connection\n    $result = $mysqli->query($query);\n    if ($result === false) {\n        error_log("Error in query: " . $mysql->error);\n        return [];\n    }\n    return $result->fetch_all(MYSQLI_ASSOC);\n}\n\n$query = generateQuery($userPreferences);\n$results = executeQuery($query);\n\n// Check if any results were found\nif (empty($results)) {\n    // Clear the user preferences\n    $_SESSION['user_preferences'] = [];\n    // Regenerate the query without previous filters\n    $query = generateQuery($_SESSION['user_preferences']);\n    $results = executeQuery($query);\n}\n\n// Display products based on the final results set\nforeach ($results as $product) {\n    // Render each product in your HTML structure\n    echo "<div>{$product['name']}</div>\n";\n}\n?>