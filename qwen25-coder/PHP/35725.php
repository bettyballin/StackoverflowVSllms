$results = get_data_from_db();\n$fp = gzopen($file_name, 'w');\nif ($fp) {\n    // Start output buffering\n    ob_start();\n    \n    foreach ($results as $row) {\n        // Use fputcsv with output buffering to capture the CSV line\n        fputcsv(STDOUT, $row, "\t");  // Using STDOUT to capture output in buffer\n    }\n    \n    // Get cleaned up output from buffer and write it into gzip file\n    $csvData = ob_get_clean();\n    gzwrite($fp, $csvData);\n    \n    gzclose($fp);\n}