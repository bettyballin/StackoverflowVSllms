<?php\nfunction generateDepartmentCsv(&$rowOffset, array $department) {\n    $deptRowStart = $rowOffset + 1;\n    $sumRange = "C" . $deptRowStart;\n\n    echo $department['name'] . "\n";\n    foreach ($department['modules'] as $moduleIndex => $module) {\n        $cellRow = ++$rowOffset; // Increment row index for each module\n        if ($moduleIndex === 0) { // First row of the department\n            $sumRange .= $cellRow;\n        } else {\n            $sumRange .= ":C" . $cellRow;\n        }\n\n        echo implode(",", [\n                $module['name'],\n                $module['ms'],\n                "=SUM(D{$cellRow}:F{$cellRow})",\n                $module['m1'],\n                $module['m2'],\n                $module['m3']\n            ]) . "\n";\n    }\n\n    $sumMilestoneCols = function ($colOffset) use (&$rowOffset, &$sumRange) {\n        return "=SUM(" . chr(ord('D') + $colOffset) . substr($sumRange, 1) . ")";\n    };\n\n    echo "Sum,,,",\n         implode(",", array_map($sumMilestoneCols, range(0, 2))),\n         "\n\n";\n\n    return chr(ord('C') . ($deptRowStart - 2) . ':' . $rowOffset); // Return range for department total\n}\n\nfunction generateCsv(array $departments) {\n    echo "Department,Current Milestone,Total Hours,Milestone 1 Hours,Milestone 2 Hours,Milestone 3 Hours\n";\n    \n    $totalSumRange = '';\n    $currentRow = 2;\n    foreach ($departments as $departmentIndex => $dept) {\n        if ($departmentIndex > 0) { // Not the first department\n            $totalSumRange .= ",";\n        }\n\n        $totalSumRange .= generateDepartmentCsv($currentRow, $dept);\n        \n        // Skip 3 rows after each department's data for better readability\n        $currentRow += 3;\n    }\n\n    echo "Total,,,,",\n         implode(",", array_map(function ($colOffset) use (&$totalSumRange) {\n             return "=SUM(" . chr(ord('D') + $colOffset) . substr($totalSumRange, 1) . ")";\n         }, range(0, 2)));\n\n}\n\n// Example usage with sample data\n$data = [\n    ["name" => 'Dept A', "modules" => [["name" => "Module 1", "ms" => "", "m1" => '10', "m2" => '', "m3" => '5'],\n                                        ["name" => "Module 2", "ms" => "", "m1" => '7', "m2" => '', "m3" => '8']]],\n    ["name" => 'Dept B', "modules" => [["name" => "Module 3", "ms" => "", "m1" => '3', "m2" => '', "m3" => '4']]],\n];\n\ngenerateCsv($data);\n?>