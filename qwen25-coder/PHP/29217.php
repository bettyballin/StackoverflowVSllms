<?php\ndefined('_JEXEC') or die;\n\nuse Joomla\CMS\Factory;\nuse Joomla\CMS\Language\Text;\nuse Joomla\CMS\Plugin\CMSPlugin;\nuse Joomla\CMS\User\UserFactoryInterface;\n\nclass PlgAuthenticationUnifiedLogin extends CMSPlugin\n{\n    protected $autoloadLanguage = true;\n\n    public function onUserAuthenticate($credentials, $options, &$response)\n    {\n        $userFactory = Factory::getContainer()->get(UserFactoryInterface::class);\n\n        // Try to authenticate user first\n        $user = $userFactory->loadByUsername($credentials['username']);\n\n        if ($user && $this->comparePasswords($credentials['password'], $user->password))\n        {\n            $response->email = $user->email;\n            $response->fullname = $user->name;\n            $response->language = $user->getParam('language');\n            $response->status = JText::_('JSTATUS_SUCCESS');\n            $response->error_message = '';\n\n            return true;\n        }\n\n        // If not successful, try to authenticate admin\n        $adminUser = JFactory::getUser();\n        if ($adminUser->loadByUsername($credentials['username']) && $this->comparePasswords($credentials['password'], $adminUser->getPassword()))\n        {\n            $response->email = $adminUser->email;\n            $response->fullname = $adminUser->name;\n            $response->language = $adminUser->getParam('language');\n            $response->status = JText::_('JSTATUS_SUCCESS');\n            $response->error_message = '';\n\n            // Set the user to admin\n            Factory::getApplication()->setUser($adminUser);\n            return true;\n        }\n\n        $response->status = JText::_('JGLOBAL_AUTH_FAILED');\n        $response->error_message = 'Invalid username or password.';\n        return false;\n    }\n\n    private function comparePasswords($plainTextPassword, $hashedPassword)\n    {\n        if (empty($hashedPassword)) {\n            return false;\n        }\n        return Factory::getHasher()->verify(Factory::getApplication()->getHashedUserAgent() . $plainTextPassword, $hashedPassword);\n    }\n}