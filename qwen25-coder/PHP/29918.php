<?php\n\nfunction getUserPermissions($userId) {\n    // Assuming a database connection is established as $conn\n    $stmt = $conn->prepare("SELECT p.permission_key FROM permissions p\n                             JOIN user_permissions up ON p.id = up.permission_id\n                             WHERE up.user_id = ?");\n    $stmt->bind_param('i', $userId);\n    $stmt->execute();\n    $result = $stmt->get_result();\n\n    $permissions = [];\n    while ($row = $result->fetch_assoc()) {\n        $permissions[] = $row['permission_key'];\n    }\n\n    return $permissions;\n}\n\nfunction getCityIdFromUser($userId) {\n    // This function should determine the city ID based on user details\n    // For example, from a user_city table or similar association.\n    // Simplification for demonstration purpose:\n    return 1; // Assuming city ID is always 1 for this user\n}\n\nfunction buildQueryBasedOnRole($permissions) {\n    $query = "SELECT * FROM records";\n    if (in_array('view_city_data', $permissions)) {\n        $cityId = getCityIdFromUser($_SESSION['user_id']);\n        $query .= " WHERE city_id = ?";\n    }\n    return $query;\n}\n\n// Usage\n$userId = $_SESSION['user_id'];\n$userPermissions = getUserPermissions($userId);\n$query = buildQueryBasedOnRole($userPermissions);\n\n$stmt = $conn->prepare($query);\nif (in_array('view_city_data', $userPermissions)) {\n    $cityId = getCityIdFromUser($userId);\n    $stmt->bind_param('i', $cityId);\n}\n$stmt->execute();\n$result = $stmt->get_result();\n\nwhile ($row = $result->fetch_assoc()) {\n    // Process the row\n}