<?php\n// Assuming $date is defined and sanitized\n$query = mysql_query("SELECT * FROM eventcal WHERE eventDate = '$date' ORDER BY region");\n\n$doc = new DomDocument("1.0");\n$root = $doc->createElement('collection');\n$root = $doc->appendChild($root);\n\nif (@mysql_num_rows($query)) {\n    $currentRegionId = null;\n    $currentRegionNode = null;\n\n    while ($row = @mysql_fetch_assoc($query)) {\n        $regionId = (int)$row['region'];\n        $primaryName = $row['primary'];\n\n        if ($regionId !== $currentRegionId) {\n            // Create a new region node for the current region\n            if ($currentRegionNode !== null) {\n                // Append the previous region node to the root before starting a new one\n                $root->appendChild($currentRegionNode);\n            }\n\n            $currentRegionNode = $doc->createElement('region');\n            $attr = $doc->createAttribute('ID');\n            $attr->value = $regionId;\n            $currentRegionNode->appendChild($attr);\n\n            // Update the current region ID\n            $currentRegionId = $regionId;\n        }\n\n        // Append primary nodes to the current region node\n        $primaryNode = $doc->createElement('primary', $primaryName);\n        $currentRegionNode->appendChild($primaryNode);\n    }\n\n    // Append the last region node after the loop ends\n    if ($currentRegionNode !== null) {\n        $root->appendChild($currentRegionNode);\n    }\n}\n\nheader("Content-Type: text/xml");\necho $doc->saveXML();\n?>