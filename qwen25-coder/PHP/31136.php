// Read the post from PayPal system and add 'cmd'\n$req = 'cmd=_notify-validate';\n\nforeach ($_POST as $key => $value) {\n    $value = urlencode(stripslashes($value));\n    $req .= "&$key=$value";\n}\n\n// Post back to PayPal system to validate\n$header = "POST /cgi-bin/webscr HTTP/1.0\r\n";\n$header .= "Content-Type: application/x-www-form-urlencoded\r\n";\n$header .= "Content-Length: " . strlen($req) . "\r\n";\n$header .= "Connection: Close\r\n\r\n";\n\n$fp = fsockopen ('ssl://www.paypal.com', 443, $errno, $errstr, 30);\n\nif (!$fp) {\n    echo 'HTTP error! Couldn\'t connect to PayPal.';\n} else {\n    fputs ($fp, $header . $req);\n    while (!feof($fp)) {\n        $res = fgets ($fp, 1024);\n        if (strcmp ($res, "VERIFIED") == 0) {\n            // Check the payment_status is Completed\n            // Check that txn_id has not been previously processed\n            // Check that receiver_email is your PayPal email\n            // Check that payment_amount/payment_currency are correct\n            // Process payment\n\n            // Send license key to user\n        } else if (strcmp ($res, "INVALID") == 0) {\n            // Log for manual investigation\n        }\n    }\n    fclose ($fp);\n}