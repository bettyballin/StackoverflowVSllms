<?php\n\nfunction imap_idle($server, $username, $password) {\n    // Open a socket connection\n    $stream = fsockopen($server, 993, $errno, $errstr, 15);\n    if (!$stream) {\n        die("Could not connect: $errstr ($errno)\n");\n    }\n    \n    // Set SSL stream context for secure connection\n    stream_set_blocking($stream, true);\n    stream_socket_enable_crypto($stream, true, STREAM_CRYPTO_METHOD_TLS_CLIENT);\n\n    // Login to the IMAP server\n    $tag = 1;\n    fwrite($stream, "$tag LOGIN \"$username\" \"$password\"\r\n");\n    if (!check_response($stream, $tag)) {\n        die("Login Failed!");\n    }\n\n    // Select the INBOX\n    $tag++;\n    fwrite($stream, "$tag SELECT \"INBOX\"\r\n");\n    if (!check_response($stream, $tag)) {\n        die("Failed to select INBOX!");\n    }\n    \n    // Start IDLE mode\n    $idleTag = "a" . (++$tag);\n    fwrite($stream, "$idleTag IDLE\r\n");\n\n    echo "Now in IDLE state.\n";\n    while (true) {\n        $read = [$stream];\n        $write = null;\n        $except = null;\n        \n        // Wait for socket response\n        if (!stream_select($read, $write, $except, 30)) { // Timeout after 30 seconds\n            fwrite($stream, "DONE\r\n"); // Send DONE to refresh IDLE\n            fwrite($stream, "$idleTag IDLE\r\n");\n            echo "Refreshed IDLE state.\n";\n        } else {\n            if (in_array($stream, $read)) {\n                while ($line = fgets($stream)) {\n                    if (strpos($line,"EXISTS") !== false) {\n                        echo "New message arrived!\n";\n                        // Break out of loop or handle new message\n                    }\n                    echo "Received from server: $line\n"; // Debugging\n                }\n            }\n        }\n    }\n\n    // Logout and close the connection\n    $tag++;\n    fwrite($stream, "$tag LOGOUT\r\n");\n    fclose($stream);\n}\n\nfunction check_response($stream, $expectedTag) {\n    while ($line = fgets($stream)) {\n        if (strpos($line,"OK") !== false && strpos($line ,$expectedTag) === 0) {\n            return true;\n        }\n        echo "Received: $line"; // Optional: For debugging purposes\n    }\n    return false;\n}\n\n// Usage example\nimap_idle('imap.gmail.com', 'your-email@gmail.com', 'your-password');\n\n?>