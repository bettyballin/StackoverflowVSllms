function bbcode($text) {\n    $text = htmlspecialchars($text);\n    $text = nl2br($text);\n\n    // Define patterns for [b], [i], [url] and auto-links\n    $find = array(\n        "'\[b\](.*?)\[/b\]'is",\n        "'\[i\](.*?)\[/i\]'i",\n        "'\[url\](.*?)\[/url\]'i",\n        '/\b((?:https?|ftp):\/\/[^\s]+)/i', // Matches links starting with http or https or ftp\n        '/\b(www\.[^\s]+)/i' // Matches links starting with www\n    );\n\n    // Define replacements for each pattern\n    $replace = array(\n        '<strong>\\1</strong>',\n        '<em>\\1</em>',\n        '<a href="\\1">\\1</a>',\n        '<a href="\\1" target="_blank">\\1</a>', // Make http/https/ftp links clickable\n        '<a href="http://\\1" target="_blank">\\1</a>' // Prepend http:// to www links and make them clickable\n    );\n\n    $text = preg_replace($find, $replace, $text);\n\n    return $text;\n}