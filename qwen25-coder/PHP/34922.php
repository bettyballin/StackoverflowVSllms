<?php\n\nfunction smarty_block_discussion_thread($params, $content, &$smarty, &$repeat) {\n    static $level = 0;\n    static $items = [];\n    static $currentIndex = -1;\n\n    if ($repeat === false && is_null($content)) {\n        // We just came in here for the first time...\n        list($parentIndex, $level) = array_pop($smarty->_tag_stack);\n        $currentIndex--;\n\n        if ($currentIndex >= 0) {\n            $nextItem = &$items[$currentIndex];\n\n            if (!empty($nextItem['children'])) {\n                array_push($smarty->_tag_stack, [$currentIndex, $level]);\n                ++$currentIndex;\n                list($itemToDisplayNext, $itemLevel) = [&$items[$currentIndex], $level + 1];\n                $smarty->assign('thread_item', $itemToDisplayNext);\n                $repeat = true;\n\n            } else {\n                // We are done with this parent\n                if (count($smarty->_tag_stack)) {\n                    list($parentIndex, $level) = array_pop($smarty->_tag_stack);\n                    ++$currentIndex;\n                    list($nextParentItem, $itemLevel) = [$items[$parentIndex], $level];\n                    while (!empty($nextParentItem['children'][$currentIndex]['children'])) {\n                        // Find next parent with children\n                        array_push($smarty->_tag_stack, [$currentIndex, $itemLevel]);\n                        ++$currentIndex;\n                        list($nextParentItem, $itemLevel) = [$items[$parentIndex], $level];\n                    }\n                    if (isset($nextParentItem['children'][$currentIndex])) {\n                        // Setup next item to display\n                        array_push($smarty->_tag_stack, [$currentIndex, $itemLevel]);\n                        ++$currentIndex;\n                        list($itemToDisplayNext, $currentLevel) = [&$items[$currentIndex], $level];\n                        $smarty->assign('thread_item', $itemToDisplayNext);\n                        $repeat = true;\n                    }\n                } else {\n                    // We are done with all items\n                    $repeat = false;\n                    return '';\n                }\n            }\n        } else { // $currentIndex == -1  No more parents...\n            foreach ($items as &$item) unset($item['_children']);\n            if (count($smarty->_tag_stack)) list($parentIndex, $level) = array_pop($smarty->_tag_stack);\n            if (!is_null($currentIndex) && !empty($items[$currentIndex]['_children'])) {\n                // More items to display\n                array_push($smarty->_tag_stack, [$currentIndex, $level]);\n                ++$currentIndex;\n                list($itemToDisplayNext, $currentLevel) = [&$items[$currentIndex], $level];\n                $smarty->assign('thread_item', $itemToDisplayNext);\n                $repeat = true;\n            } else {\n                $repeat = false;\n                return '';\n            }\n        }\n    }\n\n    if (isset($params['from'])) {\n        // Get array data\n        $items = &$params['from'];\n        list($parentIndex, $level) = array_pop($smarty->_tag_stack);\n        ++$currentIndex;\n\n        list($itemToDisplayNext, $currentLevel) = [&$items[$currentIndex], $level];\n        $smarty->assign('thread_item', $itemToDisplayNext);\n\n        if (count($items)) {\n            // Set tag to repeat\n            array_push($smarty->_tag_stack, [$parentIndex, $level]);\n            $repeat = true;\n        }\n    }\n\n    return '';\n}