<?php\n// Use Sandbox or Live endpoint based on your requirement\n$paypalUrl = 'https://www.sandbox.paypal.com/cgi-bin/webscr';\n\n// Store the custom data received (order_data)\n$orderData = $_POST['custom'];\n\n// Check if PayPal IPN request originated from PayPal by sending back a post request.\n$req = 'cmd=_notify-validate';\nforeach ($_POST as $key => $value) {\n    $value = urlencode(stripslashes($value));\n    $req .= "&$key=$value";\n}\n\n// Post back to PayPal system to validate\n$header = "POST /cgi-bin/webscr HTTP/1.0\r\n";\n$header .= "Content-Type: application/x-www-form-urlencoded\r\n";\n$header .= "Content-Length: " . strlen($req) . "\r\n\r\n";\n\n$fp = fsockopen('ssl://' . parse_url($paypalUrl, PHP_URL_HOST), 443, $errno, $errstr, 30);\n\nif (!$fp) {\n    // HTTP ERROR\n} else {\n    fputs($fp, $header . $req);\n    while (!feof($fp)) {\n        $res = fgets($fp, 1024);\n        if (strcmp(trim($res), "VERIFIED") == 0) {\n\n            // Check the payment_status is Completed\n            if ($_POST['payment_status'] == 'Completed') {\n                // Insert the custom data into your MySQL database here\n                $mysqli = new mysqli("localhost", "my_user", "my_password", "my_db");\n\n                if ($mysqli->connect_error) die('Connect Error (' . $mysqli->connect_errno . ') '\n                    . $mysqli->connect_error);\n                else {\n                    // Prepare and execute the SQL statement\n                    $stmt = $mysqli->prepare("INSERT INTO payments (order_data) VALUES (?)");\n                    $stmt->bind_param("s", $orderData);\n\n                    // Execute the statement\n                    if (!$stmt->execute()) {\n                        echo "Execute failed: (" . $stmt->errno . ") " . $stmt->error;\n                    }\n                    $stmt->close();\n                }\n\n            } else {\n                // Log that payment status was not Completed\n            }\n        } elseif (strcmp(trim($res), "INVALID") == 0) {\n            // IPN invalid, log for manual investigation\n        }\n    }\n    fclose($fp);\n}\n?>