function getSelfReferentialURL() {\n    $protocol = (isset($_SERVER['HTTPS']) && $_SERVER['HTTPS'] === 'on' || \n                  (!empty($_SERVER['HTTP_X_FORWARDED_PROTO']) && $_SERVER['HTTP_X_FORWARDED_PROTO'] === 'https')) ? "https" : "http";\n    \n    // Handle load balancers or proxies\n    $host = $_SERVER['HTTP_HOST'];\n    if (isset($_SERVER['HTTP_X_FORWARDED_HOST']) && !empty($_SERVER['HTTP_X_FORWARDED_HOST'])) {\n        $host = $_SERVER['HTTP_X_FORWARDED_HOST'];\n    }\n    \n    // Handle port numbers\n    $port = "";\n    if (!in_array($protocol . '://' . $host, ['http://localhost', 'https://localhost'])\n        && substr_count($host, ':') === 1\n    ) {\n        list($host, $port) = explode(':', $host);\n        if (($protocol === "http" && $port !== "80") || ($protocol === "https" && $port !== "443")) {\n            $port = ':' . $port;\n        } else {\n            $port = '';\n        }\n    }\n    \n    // Base URL\n    return $protocol . '://' . $host . $port . $_SERVER['REQUEST_URI'];\n}\n\n$url = getSelfReferentialURL();\necho $url;