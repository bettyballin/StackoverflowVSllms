<?php\n\nfunction transformImages($html) {\n    $dom = new DOMDocument();\n    libxml_use_internal_errors(true); // Suppress warnings about malformed HTML\n    $dom->loadHTML($html);\n    libxml_clear_errors();\n\n    $images = $dom->getElementsByTagName('img');\n    $newElements = [];\n\n    // We need to iterate over a copy of the node list because modifying it as we go will cause issues\n    foreach ($images as $image) {\n        $src = $image->getAttribute('src');\n        $alt = $image->getAttribute('alt');\n        $classes = explode(' ', $image->getAttribute('class'));\n\n        // Create new div element\n        $div = $dom->createElement('div');\n        $captionClass = 'caption' . (!empty($classes) ? ' ' : '') . implode(' ', $classes);\n        $div->setAttribute('class', $captionClass);\n\n        // Clone the image node and modify it\n        $newImage = $image->cloneNode();\n        foreach (['width', 'height', 'class'] as $attr) {\n            $newImage->removeAttribute($attr);\n        }\n        $newSrc = '/system/tools/phpthumb/phpThumb.php?src=' . $src . '&wl=200&hp=200&q=85&f=jpg';\n        $newImage->setAttribute('src', $newSrc);\n\n        // Append the new image to the div\n        $div->appendChild($newImage);\n\n        // Create and append the alt text as a paragraph if it exists\n        if ($alt) {\n            $caption = $dom->createElement('p', $alt);\n            $div->appendChild($caption);\n        }\n\n        // Save the new element for later insertion\n        $newElements[$image] = $div;\n    }\n\n    // Replace old images with their new div-wrapped versions\n    foreach ($newElements as $old => $new) {\n        $old->parentNode->replaceChild($new, $old);\n    }\n\n    return $dom->saveHTML();\n}\n\n// Example usage\n$html = '<p>My paragraph text</p>\n<img src="image.jpg" alt="First image" />\n<p>Another paragraph text <img src="another_image.jpg" alt="Second image" /> with more text</p>\n<p>And so on</p>';\n\necho transformImages($html);\n\n?>