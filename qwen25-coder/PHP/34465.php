function authenticate($username, $password) {\n    $this->username = $username;\n    $this->password = $password;\n\n    // Ensure domain is set\n    if (!isset($this->domain)) {\n        throw new Exception("Domain not set");\n    }\n\n    // Create the authentication string and base64 encode it\n    $authString = implode("\0", [$username . '@' . $this->domain, $username, $password]);\n    $authBase64 = base64_encode(utf8_encode($authString));\n\n    // Send the auth XML stanza\n    $xml = '<auth mechanism="PLAIN" xmlns="urn:ietf:params:xml:ns:xmpp-sasl">' . htmlspecialchars($authBase64) . '</auth>';\n    if ($this->write($xml)) {\n        // Listen for response\n        if ($response = $this->listen(1, true)) {\n            if (preg_match('/<success/', $response)) {\n                // Send new stream after successful SASL auth\n                $this->authenticated = $this->_sendStream();\n            } elseif (preg_match('/<failure/', $response)) {\n                throw new Exception("Authentication failed: $response");\n            }\n        }\n    }\n\n    // Trigger event and return authentication status\n    $this->events->trigger('authenticate', $this->authenticated);\n    return $this->authenticated;\n}