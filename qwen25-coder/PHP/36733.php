function encodeOutsidePre($text) {\n    return preg_replace_callback(\n        '/<pre>(.*?)<\/pre>/is',\n        function ($matches) {\n            // Return the content inside <pre> tags as is\n            return $matches[0];\n        },\n        preg_replace_callback(\n            '/(.*?)(?=\<pre>|$)/is',\n            function ($matches) {\n                // Apply htmlentities to text outside of <pre> tags\n                return htmlentities($matches[1], ENT_QUOTES, 'UTF-8');\n            },\n            $text\n        )\n    );\n}\n\n$input = "<b>Hello world</b>\n<pre>This must not be converted to HTML entities</pre>";\n$output = encodeOutsidePre($input);\necho $output;