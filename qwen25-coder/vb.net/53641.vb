Imports System.Transactions\n\nPublic Function GetOrInsertTags(ByVal tags As List(Of String)) As Dictionary(Of String, Long)\n    Dim tagDictionary As New Dictionary(Of String, Long)()\n    \n    Using tx As New TransactionScope()\n        Using context As New YourDataContext()\n            \n            For Each tag In tags\n                ' Check if the tag already exists\n                Dim existingTag = (From t In context.Tags Where t.Tag = tag Select t).FirstOrDefault()\n                \n                If existingTag IsNot Nothing Then\n                    tagDictionary.Add(tag, existingTag.TagID)\n                Else\n                    ' Insert new tag and retrieve the TagID using OUTPUT clause or SCOPE_IDENTITY()\n                    Dim newTag As New Tag With {.Tag = tag}\n                    context.Tags.InsertOnSubmit(newTag)\n                    context.SubmitChanges() ' This will add a row to Tags and generate a TagID\n                    \n                    tagDictionary.Add(tag, newTag.TagID) ' Assuming TagID is set by the DB after insert\n                End If\n            Next\n            \n            tx.Complete()\n        End Using\n    End Using\n    \n    Return tagDictionary\nEnd Functio