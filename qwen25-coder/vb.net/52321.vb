Imports System.Data.SqlClient\nImports Microsoft.Office.Interop.Excel\n\nPublic Class DownloadReport\n    Inherits Page\n\n    Protected Sub GenerateAndDownload(sender As Object, e As EventArgs)\n        ' Database connection string\n        Dim connectionString As String = "YourConnectionStringHere"\n        Using connection As New SqlConnection(connectionString)\n            connection.Open()\n            Dim command As New SqlCommand("YourStoredProcedureOrQuery", connection)\n            command.CommandType = CommandType.StoredProcedure ' or CommandType.Text\n\n            ' Execute the query and fill data into a DataTable\n            Using reader As SqlDataReader = command.ExecuteReader()\n                Dim dataTable As New System.Data.DataTable\n                dataTable.Load(reader)\n\n                ' Create an Excel file in memory\n                Using excelApp As New Application\n                    Dim workbook As Workbook = excelApp.Workbooks.Add(Type.Missing)\n                    Dim worksheet As Worksheet = CType(workbook.Sheets(1), Worksheet)\n\n                    ' Populate the Excel sheet with data from DataTable\n                    For colIndex As Integer = 0 To dataTable.Columns.Count - 1\n                        worksheet.Cells(1, colIndex + 1) = dataTable.Columns(colIndex).ColumnName\n                    Next\n\n                    For rowIndex As Integer = 0 To dataTable.Rows.Count - 1\n                        For colIndex As Integer = 0 To dataTable.Columns.Count - 1\n                            worksheet.Cells(rowIndex + 2, colIndex + 1) = dataTable.Rows(rowIndex)(colIndex)\n                        Next\n                    Next\n\n                    ' Save the file to Memory Stream\n                    Using ms As New IO.MemoryStream()\n                        workbook.SaveAs(ms, XlFileFormat.xlOpenXMLWorkbook)\n                        Dim byteArray As Byte() = ms.ToArray()\n\n                        ' Send it back via HTTP response\n                        Response.Clear()\n                        Response.ContentType = "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"\n                        Response.AddHeader("Content-Disposition", "attachment; filename=Report.xlsx")\n                        Response.BinaryWrite(byteArray)\n                        Response.End()\n                    End Using\n\n                    workbook.Close(False, Type.Missing, Type.Missing)\n                End Using\n            End Using\n        End Using\n    End Sub\nEnd Class