using System;\nusing System.Globalization;\nusing System.Windows.Controls;\nusing Microsoft.Xaml.Behaviors;\n\npublic class RevertToLastValidValueBehavior : Behavior<TextBox>\n{\n    private string _lastValidValue = "";\n\n    protected override void OnAttached()\n    {\n        base.OnAttached();\n        AssociatedObject.TextChanged += OnTextChanged;\n        AssociatedObject.LostFocus += OnLostKeyboardFocus;\n    }\n\n    private void OnTextChanged(object sender, TextChangedEventArgs e)\n    {\n        var bindingExpression = BindingOperations.GetBindingExpression(AssociatedObject, TextBox.TextProperty);\n        if (bindingExpression != null && !bindingExpression.HasError)\n            _lastValidValue = AssociatedObject.Text;\n    }\n\n    private void OnLostKeyboardFocus(object sender, RoutedEventArgs e)\n    {\n        var bindingExpression = BindingOperations.GetBindingExpression(AssociatedObject, TextBox.TextProperty);\n        if (bindingExpression != null && bindingExpression.HasError)\n            AssociatedObject.Text = _lastValidValue;\n    }\n\n    protected override void OnDetaching()\n    {\n        base.OnDetaching();\n        AssociatedObject.TextChanged -= OnTextChanged;\n        AssociatedObject.LostFocus -= OnLostKeyboardFocus;\n    }\n}