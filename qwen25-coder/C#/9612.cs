public string GetUserIPAddress()\n{\n    var result = "";\n\n    // Try to get the IP from X-Forwarded-For header if present\n    if (Request.ServerVariables["HTTP_X_FORWARDED_FOR"] != null)\n    {\n        string[] forwardedIps = Request.ServerVariables["HTTP_X_FORWARDED_FOR"].Split(new char[] { ',' }, StringSplitOptions.RemoveEmptyEntries);\n        result = forwardedIps[0];\n    }\n\n    // Fallback to RemoteAddr if X-Forwarded-For is not present\n    if (string.IsNullOrEmpty(result))\n    {\n        result = Request.ServerVariables["REMOTE_ADDR"];\n    }\n\n    return result;\n}