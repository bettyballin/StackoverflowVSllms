public IHttpHandler GetHttpHandler(RequestContext requestContext)\n{\n    if (AllowedRoles != null)\n    {\n        bool allowed = false;\n\n        for (int i = 0; i < AllowedRoles.Length; i++)\n        {\n            if (requestContext.HttpContext.User.IsInRole(AllowedRoles[i]))\n            {\n                allowed = true;\n                break;\n            }\n        }\n\n        if (!allowed)\n        {\n            string returnUrl = requestContext.HttpContext.Request.Url.AbsolutePath;\n            string loginUrl = FormsAuthentication.LoginUrl + "?ReturnUrl=" + HttpUtility.UrlEncode(returnUrl);\n            requestContext.HttpContext.Response.Redirect(loginUrl, true /* endResponse */);\n        }\n    }\n\n    // If user is allowed or no roles are specified, proceed with the original functionality\n    return BuildPageFromVirtualPath(requestContext.RouteData.Values["virtualPath"] as string);\n}