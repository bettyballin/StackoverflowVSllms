internal static DependencyObject GetVisualRoot(DependencyObject d)\n{\n    DependencyObject root = d;\n    while (true) // This loop will find the topmost ancestor by continuously moving up\n    {\n        FrameworkElement element = root as FrameworkElement; \n        if (element == null || element.Parent == null) // Once there's no parent or it can't be cast to FrameworkElement, we've found the root\n        {\n            break;\n        }\n        root = element.Parent; // Move up one level in the visual tree\n    }\n    return root;\n}