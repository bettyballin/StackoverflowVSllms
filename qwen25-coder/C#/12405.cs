using System;\nusing Microsoft.SharePoint;\n\npublic class PriorityItemEventReceiver : SPItemEventReceiver\n{\n    public override void ItemAdded(SPItemEventProperties properties)\n    {\n        UpdatePriorityOrder(properties);\n    }\n\n    public override void ItemUpdated(SPItemEventProperties properties)\n    {\n        UpdatePriorityOrder(properties);\n    }\n\n    private void UpdatePriorityOrder(SPItemEventProperties properties)\n    {\n        using (SPWeb web = properties.OpenWeb())\n        {\n            SPList list = web.Lists[properties.ListId];\n            int newPriority = Convert.ToInt32(properties.AfterProperties["Priority"]);\n\n            // Get items with priority greater than or equal to the new item's priority\n            var query = new SPQuery();\n            query.Query = string.Format("<Where><Geq><FieldRef Name='Priority'/><Value Type='Integer'>{0}</Value></Geq></Where>", newPriority);\n            query.OrderBy = "<OrderBy><FieldRef Name='Priority' Ascending='TRUE' /></OrderBy>";\n            SPListItemCollection itemsToUpdate = list.GetItems(query);\n\n            bool itemUpdated = false;\n            foreach (SPListItem item in itemsToUpdate)\n            {\n                int currentPriority = Convert.ToInt32(item["Priority"]);\n                if (item.ID == properties.ListItemId && !itemUpdated)\n                {\n                    // Skip this loop iteration for the new or updated item itself\n                    itemUpdated = true;\n                    continue;\n                }\n                item["Priority"] = ++currentPriority;\n                item.Update();\n            }\n\n            web.AllowUnsafeUpdates = true;\n            SPListItem currentItem = list.GetItemById(properties.ListItemId);\n            currentItem["Priority"] = newPriority;\n            currentItem.Update();\n            web.AllowUnsafeUpdates = false;\n        }\n    }\n}