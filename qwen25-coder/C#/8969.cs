using System;\nusing System.Collections.Generic;\nusing System.IO;\n\npublic class DelimitedTextWriter<T>\n{\n    private readonly char _delimiter;\n    private readonly StreamWriter _writer;\n    private string[] _propertyNames;\n\n    public DelimitedTextWriter(Stream stream, char delimiter = ',')\n    {\n        _delimiter = delimiter;\n        _writer = new StreamWriter(stream);\n    }\n\n    public void WriteHeader(IEnumerable<string> headers)\n    {\n        _writer.WriteLine(string.Join(_delimiter.ToString(), headers));\n    }\n\n    public void WriteRecords(IEnumerable<T> records, Func<T, IEnumerable<object>> fieldsSelector)\n    {\n        foreach (var record in records)\n        {\n            var fields = fieldsSelector(record);\n            var values = new List<string>();\n            foreach (var field in fields)\n            {\n                var value = field?.ToString();\n                if (!string.IsNullOrEmpty(value) && (value.Contains(_delimiter) || value.Contains("\"") || value.Contains("\n")))\n                {\n                    value = $"\"{value.Replace("\"", "\"\"")}\"";\n                }\n                values.Add(value);\n            }\n            _writer.WriteLine(string.Join(_delimiter.ToString(), values));\n        }\n    }\n\n    public void Dispose()\n    {\n        _writer.Dispose();\n    }\n}