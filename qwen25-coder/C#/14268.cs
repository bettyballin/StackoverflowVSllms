public async Task HandleWebSocketAsync(HttpContext context)\n{\n    if (!context.WebSockets.IsWebSocketRequest)\n        return;\n\n    using (var webSocket = await context.WebSockets.AcceptWebSocketAsync())\n    {\n        var buffer = new byte[1024 * 4];\n        \n        while (webSocket.State == WebSocketState.Open)\n        {\n            // Read and handle messages\n            var result = await webSocket.ReceiveAsync(new ArraySegment<byte>(buffer), CancellationToken.None);\n            \n            if (result.MessageType == WebSocketMessageType.Close)\n                break;\n\n            // Echo back received data or process accordingly\n            await webSocket.SendAsync(\n                new ArraySegment<byte>(buffer, 0, result.Count),\n                WebSockets.WebSocketMessageType.Text, \n                true, \n                CancellationToken.None);\n        }\n    }\n}