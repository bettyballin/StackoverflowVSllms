using System.IO;\nusing iTextSharp.text.pdf;\n\npublic byte[] FillAndFlattenPdf(byte[] pdfBytes, IDictionary<string, string> fields)\n{\n    using (var ms = new MemoryStream())\n    {\n        PdfReader reader = new PdfReader(pdfBytes);\n        using (PdfStamper stamper = new PdfStamper(reader, ms))\n        {\n            var acroFields = stamper.AcroFields;\n\n            foreach (var field in fields)\n            {\n                acroFields.SetField(field.Key, field.Value);\n            }\n\n            // Ensure appearances are generated and fields are flattened\n            acroFields.GenerateAppearances = true;\n            stamper.FormFlattening = true;            \n        }\n\n        return ms.ToArray();\n    }\n}