using System;\nusing System.Runtime.InteropServices;\n\npublic class LayerEventHandler : IDisposable\n{\n    private ILayer _layer;\n    private ILayerEvents_Event _layerEvents;\n\n    public LayerEventHandler(ILayer layer)\n    {\n        _layer = (ILayer)Marshal.CreateWrapperOfType(layer, typeof(ILayer));\n        _layerEvents = (ILayerEvents_Event)_layer;\n        _layerEvents.VisibilityChanged += OnVisibilityChanged;\n    }\n\n    ~LayerEventHandler()\n    {\n        Dispose(false);\n    }\n\n    public void Dispose()\n    {\n        Dispose(true);\n        GC.SuppressFinalize(this);\n    }\n\n    protected virtual void Dispose(bool disposing)\n    {\n        if (disposing)\n        {\n            // Unsubscribe from the event\n            _layerEvents.VisibilityChanged -= OnVisibilityChanged;\n\n            // Release COM objects explicitly\n            Marshal.ReleaseComObject(_layerEvents);\n            Marshal.ReleaseComObject(_layer);\n        }\n        _layerEvents = null;\n        _layer = null;\n    }\n\n    private void OnVisibilityChanged(bool visible)\n    {\n        // Handle visibility change event\n        Console.WriteLine($"Layer visibility changed to {visible}");\n    }\n}\n\npublic class Program\n{\n    public static void Main()\n    {\n        // Assume layers is a collection of ILayer objects from ArcGIS\n        List<ILayer> layers = GetLayers();\n\n        List<LayerEventHandler> handlers = new List<LayerEventHandler>();\n\n        try\n        {\n            foreach (ILayer layer in layers)\n            {\n                handlers.Add(new LayerEventHandler(layer));\n            }\n\n            // Simulate application running\n            Console.WriteLine("Application is running...");\n            // ... some app logic here\n\n            // Simulate shutting down the application\n            Console.WriteLine("Shutting down...");\n        }\n        finally\n        {\n            foreach (var handler in handlers)\n            {\n                handler.Dispose();\n            }\n        }\n    }\n\n    private static List<ILayer> GetLayers()\n    {\n        // This should be replaced with actual logic to get layers from ArcGIS\n        return new List<ILayer>();\n    }\n}