using System;\nusing System.ServiceProcess;\nusing System.IO;\n\npublic void StopServiceAndDoSomething(string serviceName, string sqlFilePath)\n{\n    ServiceController serviceController = new ServiceController(serviceName);\n    serviceController.Stop();\n    serviceController.WaitForStatus(ServiceControllerStatus.Stopped);\n\n    // Check if the file is available and can be opened exclusively\n    bool isFileAvailable = false;\n    int retries = 10; // Number of retries\n    for (int i = 0; i < retries && !isFileAvailable; i++)\n    {\n        try\n        {\n            using (new FileStream(sqlFilePath, FileMode.Open, FileAccess.ReadWrite, FileShare.None)) {}\n            isFileAvailable = true;\n        }\n        catch (IOException)\n        {\n            // Wait a bit and retry if the file is still in use\n            System.Threading.Thread.Sleep(500); // Sleep for 500 milliseconds\n        }\n    }\n\n    if (!isFileAvailable)\n    {\n        throw new InvalidOperationException("Unable to access the database file. It may still be in use.");\n    }\n\n    DoSomething();\n}