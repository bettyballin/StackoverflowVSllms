using System;\nusing System.Data;\nusing System.Windows.Forms;\nusing System.Data.SqlClient;\n\nnamespace sqlAsyncTesting\n{\n    public partial class Form1 : Form\n    {\n        private SqlConnection conn;\n\n        public Form1()\n        {\n            InitializeComponent();\n        }\n\n        private void button1_Click(object sender, EventArgs e)\n        {\n            string connectionString = @"Data Source=bigapple;Initial Catalog=master;Integrated Security=SSPI;Asynchronous Processing=true;";\n            \n            conn = new SqlConnection(connectionString);\n            conn.Open();\n\n            SqlCommand cmd = new SqlCommand(@"WAITFOR DELAY '00:03'; Select top 3 * from sysobjects;", conn);\n            IAsyncResult result = cmd.BeginExecuteReader(new AsyncCallback(HandleCallback), cmd, CommandBehavior.CloseConnection);\n        }\n\n        private void HandleCallback(IAsyncResult result)\n        {\n            SqlDataReader dr;\n            SqlCommand _this = (SqlCommand)result.AsyncState;\n\n            if (result.IsCompleted)\n            {\n                try\n                {\n                    dr = _this.EndExecuteReader(result);\n                    DataTable dt = new DataTable();\n                    DataSet ds = new DataSet();\n\n                    dt.Load(dr);\n                    ds.Tables.Add(dt);\n                    Complete(ds);\n                }\n                catch (Exception ex)\n                {\n                    // Handle exception here\n                    MessageBox.Show("Error: " + ex.Message);\n                }\n                finally\n                {\n                    if (conn != null && conn.State == ConnectionState.Open)\n                    {\n                        conn.Close();\n                    }\n                }\n            }\n        }\n\n        private void Complete(DataSet ds)\n        {\n            string output = string.Empty;\n            foreach (DataColumn c in ds.Tables[0].Columns)\n            {\n                output += c.ColumnName + "\t";\n            }\n            output += "\r\n";\n\n            foreach (DataRow dr in ds.Tables[0].Rows)\n            {\n                foreach (object i in dr.ItemArray)\n                {\n                    output += i.ToString() + "\t";\n                }\n                output += "\r\n";\n            }\n\n            MessageBox.Show(output);\n        }\n    }\n}