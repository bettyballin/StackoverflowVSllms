var savedSelection = {\n    range: null,\n    focusNode: null,\n    focusOffset: 0,\n    anchorNode: null,\n    anchorOffset: 0\n};\n\nfunction saveSelection() {\n    var selection;\n    if (window.getSelection) {\n        selection = window.getSelection();\n        if (selection.rangeCount > 0) {\n            savedSelection.range = selection.getRangeAt(0);\n        }\n    } else if (document.selection && document.selection.type !== "Control") {\n        savedSelection.range = document.selection.createRange();\n    }\n}\n\nfunction restoreSelection() {\n    var selection;\n    if (window.getSelection) {\n        selection = window.getSelection();\n        if (savedSelection.range) {\n            try {\n                selection.removeAllRanges();\n                selection.addRange(savedSelection.range);\n            } catch (e) {\n                // Fallback for selections across text nodes\n                selection.setBaseAndExtent(\n                    savedSelection.anchorNode, savedSelection.anchorOffset,\n                    savedSelection.focusNode, savedSelection.focusOffset\n                );\n            }\n        }\n    } else if (document.selection && document.selection.type !== "Control") {\n        if (savedSelection.range) {\n            savedSelection.range.select();\n        }\n    }\n}\n\nfunction getSelectedText() {\n    var t;\n    if (window.getSelection) {\n        t = window.getSelection().toString();\n    } else if (document.selection) {\n        t = document.selection.createRange().text;\n    }\n    return t || '';\n}\n\n$("#dialog").dialog({\n    autoOpen: false,\n    bgiframe: false,\n    height: 60,\n    width: 80,\n    modal: false,\n    show: 'highlight',\n    title: 'wc',\n    open: function() {\n        restoreSelection();\n    }\n});\n\nsaveSelection(); // Save the selection before opening the dialog\n$("#dialog").dialog("open");\nalert(getSelectedText()); // Should have text selected here if possible