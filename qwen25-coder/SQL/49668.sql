SELECT t.date, t.expiration, t.days, t.callput, t.iv, t.delta\nFROM (\n    SELECT \n        date,\n        expiration,\n        DateDiff("d", [date], [expiration]) AS days,\n        callput,\n        iv,\n        delta,\n        Rank() OVER (PARTITION BY [date] ORDER BY IIF(delta > 0.5, delta - 0.5, 1), days) AS rank\n    FROM RAWDATA\n    WHERE callput = "C"\n      AND DateDiff("d", [date], [expiration]) BETWEEN 15 AND 50\n) t\nWHERE t.rank = 1;