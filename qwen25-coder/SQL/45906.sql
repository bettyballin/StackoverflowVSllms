WITH EventDurations AS (\n    SELECT \n        name,\n        state,\n        time,\n        CASE \n            WHEN LAG(state) OVER (PARTITION BY name ORDER BY time) = state THEN 0\n            ELSE DATETIME(TIME - LAG(time, 1, TIME) OVER (PARTITION BY name ORDER BY time), 'minutes')\n        END AS duration_minutes\n    FROM user_events\n    WHERE TIME BETWEEN "10:00 AM" AND "10:15 AM"\n)\nSELECT\n    name,\n    state,\n    SUM(duration_minutes) * 60 AS total_duration_seconds\nFROM EventDurations\nWHERE duration_minutes > 0\nGROUP BY name, state;