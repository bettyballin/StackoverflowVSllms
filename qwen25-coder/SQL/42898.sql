WITH RankedPatientStatus AS (\n    SELECT \n        ps.pkPatientStatusId,\n        ps.fkPatientId,\n        ps.StatusCode,\n        ps.StartDate,\n        ps.EndDate,\n        ROW_NUMBER() OVER (PARTITION BY ps.fkPatientId ORDER BY ps.StartDate) as rn\n    FROM PatientStatus ps\n)\nSELECT p.pkPatientId, p.FirstName, p.Surname, rps.StatusCode, rps.StartDate, rps.EndDate\nFROM Patient p\nJOIN RankedPatientStatus rps ON p.pkPatientId = rps.fkPatientId\nWHERE rps.rn <= 2\nAND EXISTS (\n    SELECT 1 \n    FROM PatientStatus ps2 \n    WHERE ps2.fkPatientId = rps.fkPatientId AND ps2.StartDate >= rps.StartDate\n    HAVING COUNT(*) > 1\n)\nORDER BY p.pkPatientId, rps.StartDate;