WITH RangeDates AS (\n    SELECT \n        r.rangeId,\n        d.aDate,\n        d.doUse,\n        RANK() OVER (PARTITION BY r.rangeId ORDER BY d.aDate) AS day_in_range\n    FROM \n        Dates d\n    JOIN \n        Ranges r ON d.aDate >= r.startDate\n)\nSELECT \n    rd.rangeId,\n    rd.aDate,\n    CASE WHEN rd.doUse = 1 THEN dy.qty ELSE 0 END AS qty\nFROM \n    RangeDates rd\nLEFT JOIN \n    Days dy ON rd.rangeId = dy.rangeId AND rd.day_in_range = dy.day\nORDER BY \n    rd.rangeId, rd.aDate;