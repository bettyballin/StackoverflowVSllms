WITH NumberedOrders AS (\n    SELECT \n        ROW_NUMBER() OVER (PARTITION BY customer_name ORDER BY order_date, price) AS pivot_id,\n        customer_name, \n        order_date,\n        price\n    FROM Sales AS x\n    WHERE (\n        SELECT COUNT(*) \n        FROM Sales \n        WHERE customer_name = x.customer_name \n        AND order_date >= x.order_date\n    ) <= 5\n)\nSELECT *\nFROM NumberedOrders;