WITH prioritized_phone_numbers AS (\n    SELECT \n        StoreID, dbo.GetPhoneNumber10(StorePhone) AS PhoneNumber,\n        1 AS Priority\n    FROM \n        dbo.Store_Info\n    WHERE \n        ParentID = 0 AND dbo.IsAniNumber(dbo.GetPhoneNumber10(StorePhone)) = 1\n\n    UNION ALL\n    \n    SELECT \n        StoreID, dbo.GetPhoneNumber10(AltPhone) AS PhoneNumber,\n        2 AS Priority\n    FROM \n        dbo.Store_Info\n    WHERE \n        ParentID = 0 AND dbo.IsAniNumber(dbo.GetPhoneNumber10(AltPhone)) = 1\n\n    UNION ALL\n    \n    SELECT \n        StoreID, dbo.GetPhoneNumber10(StorePhone) AS PhoneNumber,\n        3 AS Priority\n    FROM \n        dbo.Store_Info\n    WHERE \n        ParentID <> 0 AND dbo.IsAniNumber(dbo.GetPhoneNumber10(StorePhone)) = 1\n\n    UNION ALL\n    \n    SELECT \n        StoreID, dbo.GetPhoneNumber10(AltPhone) AS PhoneNumber,\n        4 AS Priority\n    FROM \n        dbo.Store_Info\n    WHERE \n        ParentID <> 0 AND dbo.IsAniNumber(dbo.GetPhoneNumber10(AltPhone)) = 1\n\n    UNION ALL\n    \n    SELECT \n        sc.StoreID, dbo.GetPhoneNumber10(sc.Phone) AS PhoneNumber,\n        5 AS Priority\n    FROM \n        Store_Contacts sc\n        INNER JOIN dbo.Store_Info si ON sc.StoreID = si.StoreID\n    WHERE \n        (si.ParentID = 0)\n        AND dbo.IsAniNumber(dbo.GetPhoneNumber10(sc.Phone)) = 1\n\n    UNION ALL\n    \n    SELECT \n        sc.StoreID, dbo.GetPhoneNumber10(sc.Phone) AS PhoneNumber,\n        6 AS Priority\n    FROM \n        Store_Contacts sc\n        INNER JOIN dbo.Store_Info si ON sc.StoreID = si.StoreID\n    WHERE \n        (si.ParentID <> 0)\n        AND dbo.IsAniNumber(dbo.GetPhoneNumber10(sc.Phone)) = 1\n),\nranked_numbers AS (\n    SELECT \n        StoreID, PhoneNumber,\n        ROW_NUMBER() OVER (PARTITION BY PhoneNumber ORDER BY Priority) AS rn\n    FROM \n        prioritized_phone_numbers\n)\nINSERT INTO dbo.Store_PhoneNumbers (StoreID, PhoneNumber)\nSELECT \n    StoreID, PhoneNumber\nFROM \n    ranked_numbers\nWHERE \n    rn = 1\nAND NOT EXISTS (\n    SELECT * \n    FROM dbo.Store_PhoneNumbers spn \n    WHERE spn.PhoneNumber = ranked_numbers.PhoneNumber\n);