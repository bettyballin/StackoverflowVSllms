DECLARE @BatchSize INT = 1000;\nDECLARE @Offset INT = 0;\n\nWHILE @Offset < (SELECT COUNT(*) FROM table t1 JOIN newtable t2 ON t1.email = t2.email)\nBEGIN\n    BEGIN TRANSACTION;\n\n    UPDATE TOP (@BatchSize) t1\n    SET t1.groupId = t2.groupId\n    FROM table t1\n    JOIN newtable t2 ON t1.email = t2.email\n    WHERE t1.groupId <> t2.groupId -- Ensure we only update rows that need to be changed\n    OFFSET @Offset ROWS FETCH NEXT @BatchSize ROWS ONLY;\n\n    COMMIT TRANSACTION;\n    \n    SET @Offset = @Offset + @BatchSize;\nEND;