WITH IndexCTE AS (\n    SELECT Table_Name, Column_Name, Collation_Name \n    FROM information_schema.columns \n    WHERE Collation_Name IS NOT NULL AND Collation_Name = 'Modern_Spanish_CI_AS'\n),\nIndexColumnsCTE AS (\n    SELECT i.name AS IndexName,\n           OBJECT_NAME(i.object_id) AS TableName,\n           ic.column_id, \n           c.name AS ColumnName,\n           CASE WHEN ic.is_descending_key = 1 THEN 'DESC' ELSE 'ASC' END AS SortOrder\n    FROM sys.indexes i \n    INNER JOIN sys.index_columns ic ON i.index_id = ic.index_id AND i.object_id = ic.object_id\n    INNER JOIN sys.columns c ON ic.column_id = c.column_id AND ic.object_id = c.OBJECT_ID\n    WHERE EXISTS (SELECT 1 FROM IndexCTE t1 WHERE t1.Table_Name = OBJECT_NAME(i.object_ID) AND t1.Column_Name = c.Name)\n),\nIndexData AS (\n    SELECT ic.IndexName, ic.TableName,\n           STRING_AGG(QUOTENAME(ic.ColumnName) + ' ' + ic.SortOrder, ', ') WITHIN GROUP (ORDER BY ic.column_id) AS Columns\n    FROM IndexColumnsCTE ic\n    GROUP BY ic.IndexName, ic.TableName\n)\nSELECT 'CREATE INDEX ' + QUOTENAME(i.IndexName) + ' ON ' + QUOTENAME(i.TableName) + '(' + i.Columns + ')' \nFROM IndexData i;