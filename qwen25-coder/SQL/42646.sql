select distinct p2c.product_id \nfrom '.TABLE_PRODUCT_TO_CATEGORY.' p2c\ninner join '.TABLE_PRODUCT.' p on p2c.product_id = p.id \nwhere p.status = 1\n  and exists (\n    select 1 from '.TABLE_PRODUCT_TAG.' pt1\n    inner join '.TABLE_TAG_TYPE.' tt on pt1.tag_type_id = tt.id\n    where pt1.product_id = p.id\n      and tt.id = '.PRODUCT_TAG_TYPE_FREE_TAG.'\n      and lower(pt1.value) = 'cats'\n  )\n  and exists (\n    select 1 from '.TABLE_PRODUCT_TAG.' pt2\n    inner join '.TABLE_TAG_TYPE.' tt on pt2.tag_type_id = tt.id\n    where pt2.product_id = p.id\n      and tt.id = '.PRODUCT_TAG_TYPE_FREE_TAG.'\n      and lower(pt2.value) in ('kittens', 'dogs')\n  )\n  and not exists (\n    select 1 from '.TABLE_PRODUCT_TAG.' pt3\n    inner join '.TABLE_TAG_TYPE.' tt on pt3.tag_type_id = tt.id\n    where pt3.product_id = p.id\n      and tt.id = '.PRODUCT_TAG_TYPE_FREE_TAG.'\n      and lower(pt3.value) = 'parrots'\n  );