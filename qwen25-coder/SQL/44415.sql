WITH LogRanked AS (\n    SELECT \n        Log_ID, FB_ID, Date, Log_Name, Log_Type,\n        ROW_NUMBER() OVER (PARTITION BY FB_ID ORDER BY Date) AS rn,\n        LAG(Log_Name) OVER (PARTITION BY FB_ID ORDER BY Date) AS prev_Log_Name\n    FROM t_log\n),\nSecondLogNameChange AS (\n    SELECT \n        *\n    FROM LogRanked\n    WHERE rn > 1 AND Log_Name <> ISNULL(prev_Log_Name, '')\n)\nSELECT *\nFROM SecondLogNameChange\nWHERE Log_Type = 'Critical' \n  AND Date BETWEEN '2007-11-01' AND '2007-11-30'\nORDER BY FB_ID;