DECLARE @DynamicColumnHeaders NVARCHAR(MAX),\n        @SQL NVARCHAR(MAX);\n\n-- Determine the distinct month/year combinations for dynamic columns\nSELECT @DynamicColumnHeaders = STUFF((\n    SELECT DISTINCT ', [' + DATENAME(MONTH, date) + ' ' + CAST(YEAR(date) AS VARCHAR(4)) + ']'\n    FROM Table2\n    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 2, '');\n\n-- Prepare the SQL query dynamically with those column headers\nSET @SQL = '\nSELECT \n    t1.user_id,\n    t1.name AS user_name,\n    ' + @DynamicColumnHeaders + '\nFROM (\n    SELECT \n        t1.user_id,\n        t1.name,\n        [MonthYear] = DATENAME(MONTH, t2.date) + '' '' + CAST(YEAR(t2.date) AS VARCHAR(4)),\n        t2.incident_code\n    FROM Table1 t1\n    JOIN Table2 t2 ON t1.user_id = t2.user_id\n) AS SourceTable\nPIVOT (\n    MAX(incident_code) FOR [MonthYear] IN (' + @DynamicColumnHeaders + ')\n) AS PivotTable;';\n\n-- Execute the dynamic SQL query\nEXEC sp_executesql @SQL;