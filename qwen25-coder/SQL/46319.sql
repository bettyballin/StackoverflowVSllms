WITH RankedValues AS (\n    SELECT \n        mainTable.custNbr AS PKCol,\n        MAX(CASE WHEN [lkup colA].usr_def_attr IS NOT NULL THEN [lkup colA].usr_def_attr END) OVER (PARTITION BY mainTable.custNbr) AS ColA,\n        MAX(CASE WHEN [lkup colB].usr_def_attr IS NOT NULL THEN [lkup colB].usr_def_attr END) OVER (PARTITION BY mainTable.custNbr) AS ColB,\n        MAX(CASE WHEN [lkup colC].usr_def_attr IS NOT NULL THEN [lkup colC].usr_def_attr END) OVER (PARTITION BY mainTable.custNbr) AS ColC,\n        MAX(CASE WHEN [lkup colD].usr_def_attr IS NOT NULL THEN [lkup colD].usr_def_attr END) OVER (PARTITION BY mainTable.custNbr) AS ColD,\n        MAX(CASE WHEN [lkup colE].usr_def_attr IS NOT NULL THEN [lkup colE].usr_def_attr END) OVER (PARTITION BY mainTable.custNbr) AS ColE,\n        ROW_NUMBER() OVER (PARTITION BY mainTable.custNbr ORDER BY \n            CASE WHEN [lkup colA].usr_def_attr IS NOT NULL THEN 1 ELSE 0 END DESC,\n            CASE WHEN [lkup colB].usr_def_attr IS NOT NULL THEN 1 ELSE 0 END DESC,\n            CASE WHEN [lkup colC].usr_def_attr IS NOT NULL THEN 1 ELSE 0 END DESC,\n            CASE WHEN [lkup colD].usr_def_attr IS NOT NULL THEN 1 ELSE 0 END DESC,\n            CASE WHEN [lkup colE].usr_def_attr IS NOT NULL THEN 1 ELSE 0 END DESC) AS rn\n    FROM db2.dbo.table2 AS mainTable\n    LEFT JOIN db1.dbo.lookup AS [lkup colA]\n        ON mainTable.lookupValue = [lkup colA].lkup_id\n        AND mainTable.cmply_typ_lkup_id = 166697\n    LEFT JOIN db1.dbo.lookup AS [lkup colB]\n        ON mainTable.lookupValue = [lkup colB].lkup_id\n        AND mainTable.cmply_typ_lkup_id = 166700\n    LEFT JOIN db1.dbo.lookup AS [lkup colC]\n        ON mainTable.lookupValue = [lkup colC].lkup_id\n        AND mainTable.cmply_typ_lkup_id = 166699\n    LEFT JOIN db1.dbo.lookup AS [lkup colD]\n        ON mainTable.lookupValue = [lkup colD].lkup_id\n        AND mainTable.cmply_typ_lkup_id = 166696\n    LEFT JOIN db1.dbo.lookup AS [lkup colE]\n        ON mainTable.lookupValue = [lkup colE].lkup_id\n        AND mainTable.cmply_typ_lkup_id = 166698\n)\nSELECT PKCol, ColA, ColB, ColC, ColD, ColE\nFROM RankedValues\nWHERE rn = 1;