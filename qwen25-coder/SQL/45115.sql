CREATE TRIGGER trg_EnsureUniqueNamePerParent ON MyTable\nAFTER INSERT, UPDATE AS\nBEGIN\n    SET NOCOUNT ON;\n    \n    IF EXISTS (\n        SELECT Name, ParentID\n        FROM (SELECT Name, ParentID \n              FROM MyTable WITH (UPDLOCK)\n              WHERE ParentID IN (SELECT DISTINCT COALESCE(ParentID, -1) FROM inserted UNION ALL SELECT DISTINCT COALESCE(ParentID, -1) FROM deleted)\n             ) AS T\n        GROUP BY Name, ParentID\n        HAVING COUNT(*) > 1\n    )\n    BEGIN\n        RAISERROR('Error: Duplicate name found within the same parent hierarchy.', 16, 1);\n        ROLLBACK TRANSACTION;\n        RETURN;\n    END\nEND;