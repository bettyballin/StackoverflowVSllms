CREATE PROCEDURE [dbo].[UpdateProductDetails]\nAS\nBEGIN\n    -- Ensure E_CIKAN is reset before processing\n    UPDATE PRODUCTDETAILS SET E_CIKAN = 0 WHERE EXITDEPOT IS NOT NULL;\n\n    -- Create a temporary table to hold the demand information.\n    CREATE TABLE #DemandToProcess (\n        ID INT,\n        PRODUCTID VARCHAR(50),\n        QTY FLOAT,\n        EXITDEPOT VARCHAR(50)\n    );\n\n    -- Insert relevant records into the temp table\n    INSERT INTO #DemandToProcess (ID, PRODUCTID, QTY, EXITDEPOT)\n    SELECT ID, PRODUCTID, QTY, EXITDEPOT \n    FROM PRODUCTDETAILS  \n    WHERE EXITDEPOT IS NOT NULL\n    ORDER BY [DATE] ASC;\n\n    -- Create a cursor from the temp table to reduce I/O operations.\n    DECLARE SH CURSOR FAST_FORWARD FOR\n    SELECT ID, PRODUCTID, QTY, EXITDEPOT FROM #DemandToProcess;\n\n    DECLARE @ID INT;\n    DECLARE @SKU VARCHAR(50);\n    DECLARE @DP VARCHAR(50);\n    DECLARE @DEMAND FLOAT;\n    DECLARE @SUBID INT;\n    DECLARE @SUBQTY FLOAT;\n    DECLARE @SUBCK FLOAT;\n    DECLARE @REMAINS FLOAT;\n\n    OPEN SH;\n    FETCH NEXT FROM SH INTO @ID, @SKU, @DEMAND, @DP;\n\n    WHILE (@@FETCH_STATUS = 0)\n    BEGIN\n        -- Find available quantities that can be allocated.\n        DECLARE SA CURSOR FAST_FORWARD FOR\n        SELECT [ID], QTY, E_CIKAN \n        FROM PRODUCTDETAILS  \n        WHERE (QTY > E_CIKAN) AND (PRODUCTID = @SKU) AND (ENTRYDEPOT = @DP)\n        ORDER BY [DATE] ASC;\n\n        OPEN SA;\n        FETCH NEXT FROM SA INTO @SUBID, @SUBQTY, @SUBCK;\n\n        WHILE (@@FETCH_STATUS = 0) AND (@DEMAND > 0)\n        BEGIN\n            SET @REMAINS = @SUBQTY - @SUBCK;\n            \n            IF @DEMAND > @REMAINS -- Current record isn't sufficient.\n            BEGIN\n                UPDATE PRODUCTDETAILS \n                SET E_CIKAN = QTY \n                WHERE ID = @SUBID;\n\n                SET @DEMAND = @DEMAND - @REMAINS;\n            END\n            ELSE\n            BEGIN\n                UPDATE PRODUCTDETAILS \n                SET E_CIKAN = E_CIKAN + @DEMAND \n                WHERE ID = @SUBID;\n\n                SET @DEMAND = 0;\n            END\n\n            FETCH NEXT FROM SA INTO @SUBID, @SUBQTY, @SUBCK;\n        END;\n\n        CLOSE SA;\n        DEALLOCATE SA;\n\n        FETCH NEXT FROM SH INTO @ID, @SKU, @DEMAND, @DP;\n    END;\n\n    CLOSE SH;\n    DEALLOCATE SH;\n\n    -- Cleanup\n    DROP TABLE #DemandToProcess;\nEND;