WITH FilteredUpdates AS (\n    SELECT \n        UpdateID,\n        ProductID,\n        UpdateDateTime,\n        QuantityOnHand,\n        ROW_NUMBER() OVER (PARTITION BY ProductID, CAST(UpdateDateTime AS DATE) ORDER BY UpdateDateTime DESC) as rn\n    FROM InventoryHistory\n    WHERE ProductID = 1 -- Specify your product ID here\n      AND UpdateDateTime < DATEADD(HOUR, 17, CAST(UpdateDateTime AS DATE)) -- Before 5PM of that day\n      AND UpdateDateTime >= DATEADD(DAY, -30, GETDATE()) -- Last 30 days\n)\nSELECT \n    UpdateID,\n    ProductID,\n    UpdateDateTime,\n    QuantityOnHand\nFROM FilteredUpdates\nWHERE rn = 1;