WITH production_weeks AS (\n  SELECT \n    wid_date,\n    CASE \n      WHEN EXTRACT(HOUR FROM wid_date) < 7 THEN wid_date - (EXTRACT(DOW FROM wid_date) + 6) % 7 * INTERVAL '1 day' - INTERVAL '17 hours'\n      ELSE wid_date - (EXTRACT(DOW FROM wid_date) + 5) % 7 * INTERVAL '1 day' + INTERVAL '7 hours'\n    END AS week_start\n  FROM production\n)\nSELECT \n  to_char(week_start, 'IYYY') AS year,\n  DATE_TRUNC('week', week_start)::date as week_number,\n  SUM(tonnes) AS total_tonnes\nFROM production_weeks\nWHERE to_char(week_start, 'IYYY') = '2009'\nGROUP BY \n  to_char(week_start, 'IYYY'),\n  DATE_TRUNC('week', week_start '::date\nORDER BY \n  year,\n  week_number;