USE [master]\nGO\n\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nALTER PROCEDURE [dbo].[spGrantExec] \n    @User sysname,\n    @DB varchar(50),\n    @Target varchar(50)\nAS \n/*---------------------------- SQL 2005 + -------------------------------*/\n\nBEGIN TRY\nSET NOCOUNT ON;\n\n-- Variable declarations\nDECLARE @SQL nvarchar(max);\nDECLARE @ErrorMessage nvarchar(4000);\n\n-- Construct dynamic SQL to create temp table and insert data\nSet @SQL = N'\nUSE [' + QUOTENAME(@DB, '[]') + N'];\n\nCREATE TABLE #StoredProcedures\n(\n    OID int IDENTITY (1,1),\n    StoredProcOwner sysname NOT NULL,\n    StoredProcName sysname NOT NULL\n);\n\nINSERT INTO #StoredProcedures (StoredProcOwner, StoredProcName)\nSELECT ROUTINE_SCHEMA, ROUTINE_NAME\nFROM ' + QUOTENAME(@DB, '[]') + N'.INFORMATION_SCHEMA.ROUTINES \nWHERE ROUTINE_NAME LIKE ''' + QUOTENAME(@Target, '''%''' ) + N'''\n  AND ROUTINE_TYPE = ''PROCEDURE'';\n\nDECLARE @MAXOID int;\nDECLARE @OwnerName sysname;\nDECLARE @ObjectName sysname;\n\n-- Capture the @MAXOID value\nSELECT @MAXOID = MAX(OID) FROM #StoredProcedures;\n\nWHILE @MAXOID > 0\nBEGIN \n    -- Initialize the variables\n    SELECT @OwnerName = StoredProcOwner,\n           @ObjectName = StoredProcName\n    FROM #StoredProcedures\n    WHERE OID = @MAXOID;\n\n    -- Execute GRANT statement dynamically\n    EXEC (''GRANT EXEC ON [' + QUOTENAME(@DB, '[]') + N'].['' + QUOTENAME(@OwnerName) + N'].['' + QUOTENAME(@ObjectName) + N'] TO ' + QUOTENAME(@User, '[') + ''');\n\n    -- Decrement @MAXOID\n    SET @MAXOID = @MAXOID - 1;\nEND\n\n-- Drop the temporary table\nDROP TABLE #StoredProcedures;';\n\nEXEC sp_executesql @SQL;\n\nSET NOCOUNT OFF;\nEND TRY\nBEGIN CATCH\n    SET @ErrorMessage = ERROR_MESSAGE();\n    RAISERROR (@ErrorMessage, 16, 1);\nEND CATCH