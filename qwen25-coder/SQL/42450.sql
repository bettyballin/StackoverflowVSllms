WITH LatestWorkplans AS (\n    SELECT w.*\n    FROM Workplan w\n    INNER JOIN (\n        SELECT UserID, MAX(CreatedDate) AS LatestCreatedDate\n        FROM Workplan\n        WHERE UserID IN (SELECT UserID FROM @UserIds)\n        GROUP BY UserID\n    ) latest ON w.UserID = latest.UserID AND w.CreatedDate = latest.LatestCreatedDate\n)\nSELECT p.*\nFROM Project p\nINNER JOIN LatestWorkplans lw ON p.WorkplanID = lw.WorkplanID;