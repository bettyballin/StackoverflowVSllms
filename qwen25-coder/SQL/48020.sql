CREATE PROCEDURE SP_GET_DEPENDENCIES\n    @obj_name NVARCHAR(300),\n    @max_level INT = 10\nAS\nBEGIN\n    WITH DependencyCTE AS (\n        -- Anchor member: start with the initial procedure\n        SELECT \n            OBJECT_NAME(id) AS ProcName,\n            OBJECT_NAME(depid) AS DependsOnProc,\n            '-- ' AS [Level],\n            1 as DepthLevel\n        FROM sysdepends\n        WHERE OBJECT_NAME(id) = @obj_name\n\n        UNION ALL\n\n        -- Recursive member: find child dependencies\n        SELECT \n            d2.name AS ProcName,\n            d1.depid AS DependsOnProc,\n            REPLICATE('--', p.DepthLevel + 1) + ' ' as [Level],\n            p.DepthLevel + 1 AS DepthLevel\n        FROM sysdepends d1\n        INNER JOIN DependencyCTE p ON OBJECT_NAME(d1.id) = p.DependsOnProc\n        LEFT JOIN sysobjects d2 ON d1.depid = d2.id\n        WHERE p.DepthLevel < @max_level\n    )\n    SELECT \n        [Level] + ProcName as DependencyHierarchy\n    FROM DependencyCTE\n    WHERE DepthLevel >= 1  -- Start displaying from level 1 to avoid self-reference\n    OPTION (MAXRECURSION 0);\nEND;