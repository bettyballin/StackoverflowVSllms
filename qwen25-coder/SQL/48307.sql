WITH RECURSIVE RankedUrls AS (\n    SELECT \n        url,\n        site,\n        ROW_NUMBER() OVER (PARTITION BY site ORDER BY url) as rank_within_site,\n        COUNT(*) OVER (PARTITION BY site) as count_per_site,\n        1 as iteration\n    FROM urls\n\n    UNION ALL\n\n    SELECT \n        u.url,\n        u.site,\n        ROW_NUMBER() OVER (PARTITION BY u.site ORDER BY u.url) as rank_within_site,\n        COUNT(*) OVER (PARTITION BY u.site) as count_per_site,\n        ru.iteration + 1\n    FROM RankedUrls ru\n    JOIN urls u ON ru.site <> u.site AND ru.iteration < (\n        SELECT MAX(count_per_site)\n        FROM RankedUrls\n    )\n    ORDER BY rank_within_site, u.site\n    LIMIT 1\n)\nSELECT url\nFROM RankedUrls\nORDER BY iteration, rank_within_site\nOPTION (MAXRECURSION 0);