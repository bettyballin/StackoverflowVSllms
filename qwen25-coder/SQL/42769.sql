-- Create temporary table and insert data\nCreate table #tmp\n(\n    Atype varchar(10),\n    Btype varchar(10)\n)\n\ninsert into #tmp values ('a','x')\ninsert into #tmp values ('b','x')\ninsert into #tmp values ('a','y')\ninsert into #tmp values ('a','y')\ninsert into #tmp values ('b','z')\ninsert into #tmp values ('b','y')\n\n-- Prepare dynamic SQL\nDECLARE @cols AS NVARCHAR(MAX),\n        @query  AS NVARCHAR(MAX)\n\nSELECT @cols = STUFF((SELECT DISTINCT ',' + QUOTENAME(Btype) \n                    FROM #tmp\n                    FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'),1,1,'')\n\nSET @query = 'SELECT Atype, ' + @cols + ' \n              FROM \n             (\n                SELECT Atype, Btype, COUNT(*) as cnt\n                FROM #tmp\n                GROUP BY Atype, Btype\n            ) x\n            PIVOT \n            (\n                MAX(cnt)\n                FOR Btype IN (' + @cols + ')\n            ) p'\n\n-- Execute the dynamic SQL query\nEXEC sp_executesql @query\n\n-- Clean up temp table\nDROP TABLE #tmp