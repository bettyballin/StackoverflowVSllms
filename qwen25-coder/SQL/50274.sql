DECLARE @sql NVARCHAR(MAX) = N'';\n\n-- Step 1: Gather column names for A and B type items\nSELECT \n    @sql += ', SUM(' + NAME + ') AS ' + SUBSTRING(NAME, 2, LEN(NAME)-1)\nFROM sys.columns\nWHERE object_id = OBJECT_ID(N'[dbo].[YourTableName]')\nAND (NAME LIKE 'A%' OR NAME LIKE 'B%');\n\n-- Step 2: Prepare a string with A and B columns dynamically\nSELECT \n    @sql = '\n        SELECT SUBSTRING(item, 2, LEN(item)-1) AS Index,\n               SUM(CASE WHEN item LIKE ''A%'' THEN val END) AS AValue,\n               SUM(CASE WHEN item LIKE ''B%'' THEN val END) AS BValue\n        FROM (\n            SELECT *\n            FROM YourTableName\n            WHERE timestamp > @minv AND timestamp < @maxv AND dbo.fn(timestamp) = @fnv\n        ) AS SourceTable\n        UNPIVOT (' + STUFF(@sql, 1, 2, '') + ' FOR item IN (A0001, A0002, A0003, B0001, B0002, B0003)) AS unpvt\n        GROUP BY SUBSTRING(item, 2, LEN(item)-1)';\n\n-- Execute dynamic SQL\nEXEC sp_executesql @sql, N'@minv DATETIME, @maxv DATETIME, @fnv INT', \n                     @minv = '2008-01-01',\n                     @maxv = '2008-01-31',\n                     @fnv = 1;