SELECT zip, COUNT(UNIQUE address_id) AS LOCATIONS\nFROM records \nINNER JOIN addresses a USING(address_id) \nINNER JOIN zip_coords z1 ON records.zip = z1.zip\nWHERE EXISTS (\n    SELECT 1 \n    FROM zip_coords z2\n    CROSS JOIN (SELECT z1.latitude AS lat1, z1.longitude AS lon1 FROM dual)\n    WHERE z2.zip IN (\n        SELECT zip FROM available_zips\n    )\n    AND distance(lat1, lon1, z2.latitude, z2.longitude) <= 50\n)\nGROUP BY ZIP;