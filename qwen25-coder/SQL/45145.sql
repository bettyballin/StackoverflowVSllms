CREATE TEMPORARY TABLE valuebycats (INDEX (category))\n        SELECT cur.element_id, \n               cur.category, \n               cur.source_prefix, \n               cur.source_name, \n               cur.date_updated, \n               AVG(cur.value) AS avg_value,\n               SUM(cur.value * cur.weight) / SUM(cur.weight) AS rating\n        FROM temp1 cur \n        INNER JOIN temp2 nxt ON cur.subcat_hash = nxt.subcat_hash AND cur.date_updated = nxt.maxdate\n        GROUP BY cur.cat_hash;