WITH RECURSIVE visitor_sessions AS (\n    SELECT \n        id,\n        visitor_id,\n        visit_time,\n        1 AS session_id\n    FROM \n        visiting\n    WHERE \n        id = (SELECT MIN(id) FROM visiting)\n    \n    UNION ALL\n    \n    SELECT \n        v.id,\n        v.visitor_id,\n        v.visit_time,\n        CASE \n            WHEN EXTRACT(EPOCH FROM (v.visit_time - vs.visit_time)) < 3600 THEN vs.session_id\n            ELSE vs.session_id + 1\n        END AS session_id\n    FROM \n        visiting v\n    JOIN \n        visitor_sessions vs ON v.visitor_id = vs.visitor_id AND v.id > vs.id\n)\nSELECT \n    visitor_id,\n    COUNT(*) AS count\nFROM \n    visitor_sessions\nGROUP BY \n    visitor_id, session_id\nORDER BY \n    visitor_id, MIN(visit_time);