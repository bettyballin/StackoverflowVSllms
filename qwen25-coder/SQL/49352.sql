WITH RankedActions AS (\n    SELECT \n        track.historyID,\n        ROW_NUMBER() OVER (PARTITION BY track.ticketID ORDER BY track.trackDateTime DESC) as rn\n    FROM RS_HistoryTracker track\n    WHERE track.action LIKE 'STATUS:%:DRAFT'\n      AND track.trackDateTime <= @endOfWeek\n)\nSELECT COUNT(DISTINCT his.historyID) AS theCount\nFROM RS_History his\nWHERE his.historyID IN (\n    SELECT ra.historyID\n    FROM RankedActions ra\n    WHERE ra.rn = 1\n);