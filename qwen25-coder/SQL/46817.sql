CREATE PROCEDURE ProcessOrder\n    @CustomerID INT,\n    @ProductID INT,\n    @Quantity INT\nAS\nBEGIN\n    BEGIN TRANSACTION;\n\n    BEGIN TRY\n        -- Insert Order Detail\n        INSERT INTO Orders (CustomerID, ProductID, Quantity)\n        VALUES (@CustomerID, @ProductID, @Quantity);\n\n        -- Update Product Stock\n        UPDATE Products\n        SET Stock = Stock - @Quantity\n        WHERE ProductID = @ProductID AND Stock >= @Quantity;\n\n        IF @@ROWCOUNT = 0\n            RAISERROR('Insufficient stock for the product.', 16, 1);\n\n        COMMIT TRANSACTION;\n    END TRY\n    BEGIN CATCH\n        ROLLBACK TRANSACTION;\n        DECLARE @ErrorMessage NVARCHAR(4000);\n        DECLARE @ErrorSeverity INT;\n        DECLARE @ErrorState INT;\n\n        SELECT \n            @ErrorMessage = ERROR_MESSAGE(),\n            @ErrorSeverity = ERROR_SEVERITY(),\n            @ErrorState = ERROR_STATE();\n\n        RAISERROR (@ErrorMessage, @ErrorSeverity, @ErrorState);\n    END CATCH\nEND