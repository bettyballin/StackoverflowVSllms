WITH DateSeries AS (\n    SELECT MIN(date) + (LEVEL-1)*5 AS ds_date\n    FROM balances\n    CONNECT BY MIN(date) + (LEVEL-1)*5 <= MAX(date)\n),\nRankedBalances AS (\n    SELECT\n        aid,\n        balance,\n        date,\n        ROW_NUMBER() OVER (PARTITION BY aid ORDER BY date DESC) as rnk\n    FROM balances\n)\nSELECT DISTINCT\n    ds.ds_date,\n    rb.aid,\n    FIRST_VALUE(rb.balance) IGNORE NULLS \n        OVER (PARTITION BY ds.aid ORDER BY CASE WHEN rb.date <= ds.ds_date THEN 0 ELSE ds.ds_date - rb.date END DESC) AS balance\nFROM DateSeries ds\nLEFT JOIN RankedBalances rb ON ds.aid = rb.aid AND ds.ds_date >= rb.date;