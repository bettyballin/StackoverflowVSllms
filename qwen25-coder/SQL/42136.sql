WITH RecursiveTree AS (\n    -- Anchor member: All visible nodes that are not children of hidden nodes\n    SELECT Id, ParentId, Visible\n    FROM MyTree\n    WHERE Visible = 1 AND ParentId IS NULL\n\n    UNION ALL\n\n    -- Recursive member: Get all children of the visible nodes found so far\n    SELECT m.Id, m.ParentId, m.Visible\n    FROM MyTree m\n    INNER JOIN RecursiveTree rt ON m.ParentId = rt.Id\n)\nSELECT *\nFROM RecursiveTree\nOPTION (MAXRECURSION 0);  -- Allows going deeper in recursion if needed