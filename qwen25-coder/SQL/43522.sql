SELECT r.Referrer,\n       SUM(CASE \n               WHEN ra.total_A = 1 THEN r.Comm_A1 \n               WHEN ra.total_A = 2 THEN r.Comm_A2 \n               ELSE r.Comm_A3 \n           END) * LEAST(3, COUNT(ra.ID)) AS Type_A_Comm,\n       COUNT(ra.ID) AS Type_A_Ref,\n       SUM(CASE \n               WHEN rb.total_B = 1 THEN r.Comm_B1 \n               WHEN rb.total_B = 2 THEN r.Comm_B2 \n               ELSE r.Comm_B3 \n           END) * LEAST(3, COUNT(rb.ID)) AS Type_B_Comm,\n       COUNT(rb.ID) AS Type_B_Ref\nFROM referrals ref\nJOIN (\n    SELECT Referrer, Type, COUNT(*) AS total_A\n    FROM referrals\n    WHERE Type = 'A'\n    GROUP BY Referrer\n) ra ON ref.Referrer = ra.Referrer AND ref.Type = 'A'\nJOIN (\n    SELECT Referrer, COUNT(*) AS total_B\n    FROM referrals\n    WHERE Type = 'B'\n    GROUP BY Referrer\n) rb ON ref.Referrer = rb.Referrer AND ref.Type = 'B'\nJOIN referrers r ON ref.Referrer = r.Referrer\nWHERE ref.Date BETWEEN '2008-12-01' AND '2009-02-28'\nGROUP BY r.Referrer;