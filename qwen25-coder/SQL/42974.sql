-- Creating a simple procedure to process data from the queue\nCREATE PROCEDURE usp_ProcessChangeData\nAS\nBEGIN\n    DECLARE @message_body XML,\n            @handle UNIQUEIDENTIFIER;\n\n    WHILE (1=1)\n    BEGIN\n        -- Receive message from service broker queue\n        BEGIN TRANSACTION;\n        WAITFOR (\n        RECEIVE TOP(1) \n                @message_body = [message_body],\n                @handle = [conversation_handle]\n          FROM ChangeQueue), TIMEOUT 5000;\n\n        IF @@ROWCOUNT = 0\n        BEGIN\n            ROLLBACK TRANSACTION;\n            BREAK; -- Exit if no more messages after waiting.\n        END\n\n        -- Process the message (e.g., insert into audit table)\n        INSERT INTO ChangeTrackingTable (OldValues, NewValues) \n        SELECT T.c.query('/ChangeData/OldValues'),\n               T.c.query('/ChangeData/NewValues')\n          FROM @message_body.nodes('Changes/Change') AS T(c);\n\n        END CONVERSATION @handle;\n        COMMIT TRANSACTION;\n\n    END\nEND