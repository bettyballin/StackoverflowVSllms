WITH SalesSummary AS (\n    SELECT \n        m.groupNum,\n        SUM(((t.priceEach - (t.priceEach * m.margin)) * t.quantity)) AS totalSalesSub\n    FROM financeMasters AS m\n    INNER JOIN temp AS t ON m.mod = t.mod\n    GROUP BY m.groupNum\n)\nSELECT \n    m.id, \n    m.groupNum,\n    t.priceEach,\n    (t.priceEach - (t.priceEach * m.margin)) AS estCost,\n    ((t.priceEach - (t.priceEach * m.margin)) * t.quantity) AS salesSub,\n    (((t.priceEach - (t.priceEach * m.margin)) * t.quantity) / ss.totalSalesSub) AS salesPercent\nINTO output\nFROM financeMasters AS m\nINNER JOIN temp AS t ON m.mod = t.mod\nJOIN SalesSummary AS ss ON m.groupNum = ss.groupNum;