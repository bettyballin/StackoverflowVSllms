WITH LoginData AS (\n    SELECT AuditRecordID, DateTimeStamp, UserID, DateOnly\n    FROM AuditData\n    WHERE ActivityCode = 1\n),\nDataReturnData AS (\n    SELECT AuditRecordID, DateTimeStamp, UserID, DateOnly,\n           ROW_NUMBER() OVER (PARTITION BY UserID, DateOnly ORDER BY DateTimeStamp) as rn\n    FROM AuditData\n    WHERE ActivityCode = 2\n)\nSELECT \n    Login.UserID, \n    Login.DateOnly,\n    AVG(DATEDIFF(SECOND, Login.DateTimeStamp, DataReturn.DateTimeStamp)) AS AvgTimeDiffSec\nFROM \n    LoginData Login\nJOIN \n    DataReturnData DataReturn ON Login.UserID = DataReturn.UserID AND Login.DateOnly = DataReturn.DateOnly\nWHERE \n    DataReturn.rn = 1\nGROUP BY \n    Login.UserID, Login.DateOnly\nORDER BY \n    Login.UserID, Login.DateOnly;