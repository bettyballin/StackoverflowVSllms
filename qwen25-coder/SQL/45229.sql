SELECT \n    p.person_id AS 'MIRID'\n    , p.firstname AS 'FIRST'\n    , p.lastname AS 'LAST'\n    , pg.name AS 'GROUP'\n    , e.name AS 'AOR'\n    , p.leaddate AS 'CONTACT DATE'\n    , [dbo].[GetPICampaignDisp](p.person_id, '2009') AS 'PI - 2009'\n    , [dbo].[GetPICampaignDisp](p.person_id, '2008') AS 'PI - 2008'\n    , [dbo].[GetPICampaignDisp](p.person_id, '2007') AS 'PI - 2007'\n    , a_disp.name AS 'CURR DISP'\n    , a_ins.name AS 'CURR INS'\n    , a_prodtype.name AS 'CURR INS TYPE'\n    , a_t.date AS 'CURR INS APP DATE'\n    , a_t.effdate AS 'CURR INS EFF DATE' \n    , b_disp.name AS 'PREV DISP'\n    , b_ins.name AS 'PREV INS'\n    , b_prodtype.name AS 'PREV INS TYPE'\n    , b_t.date AS 'PREV INS APP DATE'\n    , b_t.effdate AS 'PREV INS EFF DATE'\n    , b_t.termdate AS 'PREV INS TERM DATE'\nFROM \n    [person] p\nLEFT OUTER JOIN \n    [employee] e\nON \n    e.employee_id = p.agentofrecord_id\nINNER JOIN \n    [dbo].[person_physician] pp\nON \n    p.person_id = pp.person_id\nINNER JOIN \n    [dbo].[physician] ph\nON\n    ph.physician_id = pp.physician_id\nINNER JOIN\n    [dbo].[clinic] c\nON \n    c.clinic_id = ph.clinic_id\nINNER JOIN\n    [dbo].[d_Physgroup] pg\nON\n    pg.d_physgroup_id = c.physgroup_id\nLEFT OUTER JOIN \n    (\n        SELECT TOP 1 tr1.*\n        FROM \n            [transaction] tr1\n        LEFT OUTER JOIN \n            [d_vendor] ins1\n        ON \n            ins1.d_vendor_id = tr1.d_vendor_id\n        LEFT OUTER JOIN \n            [d_product_type] prodtype1\n        ON \n            prodtype1.d_product_type_id = tr1.d_product_type_id\n        LEFT OUTER JOIN \n            [d_commission_type] ctype1\n        ON \n            ctype1.d_commission_type_id = tr1.d_commission_type_id\n        WHERE\n            prodtype1.name <> 'Medicare Part D'\n            AND tr1.termdate IS NULL\n        ORDER BY tr1.effdate DESC -- Ensure the most recent record is selected\n    ) AS a_t\nON\n    a_t.person_id = p.person_id\nLEFT OUTER JOIN \n    [d_vendor] a_ins\nON \n    a_ins.d_vendor_id = a_t.d_vendor_id\nLEFT OUTER JOIN \n    [d_product_type] a_prodtype\nON \n    a_prodtype.d_product_type_id = a_t.d_product_type_id\nLEFT OUTER JOIN \n    [d_commission_type] a_ctype\nON \n    a_ctype.d_commission_type_id = a_t.d_commission_type_id\nLEFT OUTER JOIN\n    [d_disposition] a_disp\nON\n    a_disp.d_disposition_id = a_t.d_disposition_id\nLEFT OUTER JOIN \n    (\n        SELECT TOP 1 tr1.*\n        FROM \n            [transaction] tr1\n        LEFT OUTER JOIN \n            [d_vendor] ins1\n        ON \n            ins1.d_vendor_id = tr1.d_vendor_id\n        LEFT OUTER JOIN \n            [d_product_type] prodtype1\n        ON \n            prodtype1.d_product_type_id = tr1.d_product_type_id\n        LEFT OUTER JOIN \n            [d_commission_type] ctype1\n        ON \n            ctype1.d_commission_type_id = tr1.d_commission_type_id\n        WHERE\n            prodtype1.name <> 'Medicare Part D'\n            AND tr1.termdate IS NOT NULL\n        ORDER BY tr1.effdate DESC -- Ensure the most recent record is selected\n    ) AS b_t\nON\n    b_t.person_id = p.person_id\nLEFT OUTER JOIN \n    [d_vendor] b_ins\nON \n    b_ins.d_vendor_id = b_t.d_vendor_id\nLEFT OUTER JOIN \n    [d_product_type] b_prodtype\nON \n    b_prodtype.d_product_type_id = b_t.d_product_type_id\nLEFT OUTER JOIN \n    [d_commission_type] b_ctype\nON \n    b_ctype.d_commission_type_id = b_t.d_commission_type_id\nLEFT OUTER JOIN\n    [d_disposition] b_disp\nON\n    b_disp.d_disposition_id = b_t.d_disposition_id\nWHERE\n    pg.d_physgroup_id = @PhysGroupID;