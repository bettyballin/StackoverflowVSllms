USE [POBox]\nGO\n/****** Object:  StoredProcedure [dbo].[test]    Script Date: 07/06/2009 12:55:39 ******/\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\nALTER PROCEDURE [dbo].[test]\n(\n    @p_SortExpression NVARCHAR(100),\n    @p_StartIndex INT,\n    @p_MaxRows INT,\n    @p_SearchTerm NVARCHAR(100)\n)\nAS\nSET NOCOUNT ON;\n\nIF LEN(@p_SortExpression) = 0 \n    SET @p_SortExpression = 'DateTime DESC'\n\nDECLARE @Sql NVARCHAR(4000), @ParamList NVARCHAR(500);\n\n-- Construct the SQL statement with parameters\nSET @Sql = '\n    SELECT ID, DateTime, Subject, CreatedBy, ToReceipientID , ReceiverStatus\n    FROM (\n        SELECT ID, DateTime, Subject,CreatedBy, ToReceipientID, ReceiverStatus,\n               ROW_NUMBER() OVER(ORDER BY ' + QUOTENAME(@p_SortExpression) + ') AS Indexing\n        FROM ComposeMail\n        WHERE Subject LIKE @SearchTerm\n    ) AS NewDataTable\n    WHERE Indexing > @StartIndex AND Indexing <= (@StartIndex + @MaxRows)\n'\n\n-- Define parameter list for execution\nSET @ParamList = N'@StartIndex INT, @MaxRows INT, @SearchTerm NVARCHAR(100)';\n\n-- Execute the dynamic SQL with parameters\nEXEC sp_executesql \n    @sql,\n    @ParamList,\n    @p_StartIndex,\n    @p_MaxRows,\n    '%' + @p_SearchTerm + '%'