WITH LatestAddresses AS (\n    SELECT \n        CustomerID, \n        MAX(AddressID) AS MostRecentAddressID\n    FROM \n        Address\n    GROUP BY \n        CustomerID\n)\nSELECT \n    a.State, \n    COUNT(DISTINCT c.CustomerID) AS NumberOfCustomers\nFROM \n    Product p\nINNER JOIN \n    Customer c ON c.CustomerID = p.CustomerID\nLEFT JOIN \n    LatestAddresses la ON la.CustomerID = c.CustomerID\nLEFT JOIN \n    Address a ON a.AddressID = la.MostRecentAddressID\nGROUP BY \n    a.State;