CREATE PROCEDURE LogExpensiveQueries\nAS\nBEGIN\n    INSERT INTO ExpensiveQueriesLog (ExecutionTime, TextData, TotalLogicalReads, TotalPhysicalReads, TotalWorkerTime, SQLHandle)\n    SELECT GETDATE() AS ExecutionTime,\n           t.text AS QueryText,\n           s.total_logical_reads AS TotalLogicalReads,\n           s.total_physical_reads AS TotalPhysicalReads,\n           s.total_worker_time AS TotalWorkerTime,\n           p.sql_handle AS SQLHandle\n    FROM sys.dm_exec_query_stats AS s\n    CROSS APPLY sys.dm_exec_sql_text(s.sql_handle) AS t\n    CROSS APPLY sys.dm_exec_plan_attributes(s.plan_handle) AS p\n    WHERE p.attribute = 'dbid'\n      AND DB_NAME(p.value) = DB_NAME()\n    ORDER BY s.total_worker_time DESC;\nEND;