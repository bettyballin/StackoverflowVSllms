WITH access_details AS (\n    SELECT \n        t.id AS thing_id,\n        CASE\n            WHEN ta.type = 'thing' THEN ta.access\n            WHEN ta.type = 'group' AND ta_g.thing_id IS NULL THEN ta.access\n            ELSE NULL\n        END AS calculated_access\n    FROM \n        things t\n    LEFT JOIN \n        access ta ON ta.user_id = 1 AND (\n            (ta.type = 'group' AND ta.object_id = t.group_id)\n            OR (ta.type = 'thing' AND ta.object_id = t.id)\n        )\n    LEFT JOIN \n        access ta_g ON ta_g.user_id = 1 \n                   AND ta_g.type = 'group'\n                   AND ta_g.object_id = t.group_id\n    WHERE \n        ta.type = 'thing'\n        OR (ta.type = 'group' AND ta_g.thing_id IS NULL)\n)\n\nSELECT \n    thing_id,\n    MAX(calculated_access) AS access\nFROM (\n    SELECT \n        t.id AS thing_id,\n        COALESCE(\n            (SELECT ta.access\n             FROM access ta\n             WHERE user_id = 1 AND type = 'thing' AND object_id = t.id),\n            (SELECT ta.access\n             FROM access ta\n             WHERE user_id = 1 AND type = 'group' AND object_id = t.group_id)\n        ) AS calculated_access\n    FROM \n        things t\n) subquery\nGROUP BY \n    thing_id;