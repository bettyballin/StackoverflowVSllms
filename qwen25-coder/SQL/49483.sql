CREATE PROCEDURE ProcessEvents\nAS\nBEGIN\n    -- Insert only the latest change per device ID and value sequence into the EventLog table.\n    INSERT INTO EventLog (DeviceID, Value, Timestamp)\n        SELECT ds.DeviceID, ds.Value, ds.Timestamp\n        FROM (\n            SELECT DeviceID, \n                   Value, \n                   Timestamp,\n                   ROW_NUMBER() OVER (PARTITION BY DeviceID, Value ORDER BY Timestamp) as rn\n            FROM EventStaging es1\n            WHERE NOT EXISTS (\n                SELECT 1 \n                FROM EventStaging es2 \n                WHERE es1.DeviceID = es2.DeviceID \n                  AND es1.Timestamp > es2.Timestamp \n                  AND es1.Value = es2.Value\n            )\n        ) ds\n        LEFT JOIN EventLog el ON ds.DeviceID = el.DeviceID AND ds.Value = el.Value AND ds.Timestamp = el.Timestamp\n        WHERE el.DeviceID IS NULL;\n\n    -- Clear the staging table.\n    TRUNCATE TABLE EventStaging;\nEND;\nGO