WITH RankedStats AS (\n    SELECT \n        VISITORIP, \n        HTTPADDRESS, \n        DATEENTERED,\n        ROW_NUMBER() OVER (PARTITION BY VISITORIP ORDER BY DATEENTERED DESC) as rn\n    FROM \n        STATS\n    WHERE \n        DATEENTERED BETWEEN @OnlineTime AND GETDATE()\n)\nSELECT \n    VISITORIP, \n    HTTPADDRESS, \n    DATEENTERED\nFROM \n    RankedStats\nWHERE \n    rn = 1\nORDER BY \n    DATEENTERED DESC;