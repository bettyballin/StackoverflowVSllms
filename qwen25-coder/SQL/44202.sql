SELECT \n  p.p_pid, \n  p.p_name, \n  p.p_url \nFROM \n  products p\nJOIN (\n  SELECT a_pid, MAX(a_time) as max_a_time\n  FROM activity\n  WHERE a_uid = $uid_int AND a_pid > 0\n  GROUP BY a_pid\n) recent_activities ON p.p_pid = recent_activities.a_pid\nWHERE recent_activities.max_a_time >= (SELECT MIN(a_time) \n                                      FROM (\n                                        SELECT MAX(a_time) as max_a_time\n                                        FROM activity\n                                        WHERE a_uid = $uid_int AND a_pid > 0\n                                        GROUP BY a_pid\n                                        ORDER BY max_a_time DESC LIMIT 6\n                                      ) subquery)\nORDER BY recent_activities.max_a_time DESC\nLIMIT 6;