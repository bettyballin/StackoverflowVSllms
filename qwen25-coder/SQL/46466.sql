WITH RankedDetails AS (\n    SELECT \n        m.MasterRecord,\n        md.DetailRecord,\n        ROW_NUMBER() OVER (PARTITION BY m.MasterRecord ORDER BY md.DetailRecord) as rn\n    FROM \n        MasterTable m\n    JOIN \n        MasterDetailTable md ON m.MasterRecord = md.MasterRecord\n)\nSELECT \n    MasterRecord,\n    DetailRecord\nFROM \n    RankedDetails\nWHERE \n    rn <= 2;