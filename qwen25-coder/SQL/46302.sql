WITH RankedActions AS (\n    SELECT \n        ua.userid,\n        ua.action_date,\n        u.pay_date,\n        ROW_NUMBER() OVER (PARTITION BY ua.userid ORDER BY ua.action_date ASC) as rn\n    FROM \n        users u\n    LEFT JOIN \n        user_actions ua ON ua.userid = u.userid AND ua.action_date >= u.pay_date\n)\nSELECT \n    userid, action_date, pay_date\nFROM \n    RankedActions\nWHERE \n    rn = 1;