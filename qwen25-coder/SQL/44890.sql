CREATE PROCEDURE AddTagToRecord\n    @TagName VARCHAR(60),\n    @TaggedRecordId INT\nAS\nBEGIN\n    DECLARE @TempTag TABLE (TagId INT, TagName VARCHAR(60));\n\n    -- First step: Merge into Tag table to ensure the tag exists.\n    MERGE INTO Tag AS target\n    USING (SELECT @TagName AS TagName) AS source (TagName)\n    ON (target.TagName = source.TagName)\n    WHEN NOT MATCHED THEN\n        INSERT (TagName)\n        VALUES (@TagName)\n    OUTPUT inserted.TagId, inserted.TagName\n    INTO @TempTag;\n\n    -- Second step: Insert into TaggedRecords with the correct TagId.\n    INSERT INTO TaggedRecords (TagId, TaggedRecordId)\n    SELECT t.TagId, @TaggedRecordId\n    FROM @TempTag t;\nEND;