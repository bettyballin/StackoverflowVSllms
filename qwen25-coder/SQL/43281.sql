SELECT \n    COUNT(Page) AS VisitingCount,\n    dbo.fn_RoundTimeToHalfHour(CONVERT(TIME, [Date], 108)) AS [RoundedTime]\nFROM \n( \n    SELECT Page, [Date], [user],\n           CONVERT(TIME, [Date], 108) AS [Time]\n    FROM scr_SecuristLog\n) scr_SecuristLog\nWHERE\n    Date BETWEEN '2009-05-06' AND '2009-05-07'\nAND\n    [user] IN\n(       \n    SELECT USERNAME\n    FROM scr_CustomerAuthorities\n    WHERE customerID = 4 -- No need to convert numbers to varchar for comparison\n      AND ID = 43\n)\nGROUP BY \n    dbo.fn_RoundTimeToHalfHour(CONVERT(TIME, [Date], 108))\nORDER BY \n    dbo.fn_RoundTimeToHalfHour(CONVERT(TIME, [Date], 108)) ASC;