CREATE FUNCTION [dbo].[ZipsInRadius] (@zipCode varchar(15), \n    @radius int, @unit char(1))\nRETURNS @areaResults TABLE(\n    Zip    varchar    (30),\n    City   varchar    (255),\n    St     varchar (20),\n    Lat    decimal    (16,12),\n    Long   decimal (16,12))    \nBEGIN\n    DECLARE @iStartLat decimal(16, 12)\n    DECLARE @iStartLong decimal(16, 12)\n\n    SELECT TOP 1 \n        @iStartLat = CAST(Latitude AS decimal(16, 12)), \n        @iStartLong = CAST(Longitude AS decimal(16, 12)) \n    FROM zip\n    WHERE zipcode LIKE @zipCode + '%'\n\n    IF @@ROWCOUNT = 0\n    BEGIN\n        SELECT TOP 1 \n            @iStartLat = CAST(Latitude AS decimal(16, 12)), \n            @iStartLong = CAST(Longitude AS decimal(16, 12)) \n        FROM postalcode\n        WHERE postalcode LIKE @zipCode + '%'\n    END\n\n    DECLARE @latRange decimal(16, 12)\n    DECLARE @longRange decimal(16, 12)\n\n    IF (@unit = 'K')         --Get distance in kilometers\n    BEGIN\n        SET @LatRange = (CAST(@radius / ((6076.0 / 5280.0) * 60.0) AS decimal(16, 12))) * 0.621371\n        SET @LongRange = (@radius / (((cos(@iStartLat * pi() / 180.0) * 6076.0) / 5280.0) * 60)) * 0.621371\n    END\n    ELSE                     --Get distance in miles (the default)\n    BEGIN\n        SET @LatRange = CAST(@radius / ((6076.0 / 5280.0) * 60.0) AS decimal(16, 12))\n        SET @LongRange = @radius / (((cos(@iStartLat * pi() / 180.0) * 6076.0) / 5280.0) * 60)\n    END\n\n    DECLARE @lowLatitude decimal(16, 12)\n    DECLARE @highLatitude decimal(16, 12)\n    DECLARE @lowLongitude decimal (16, 12)\n    DECLARE @highLongitude decimal (16, 12)\n\n    SET @lowLatitude = @iStartLat - @latRange\n    SET @highLatitude = @iStartLat + @latRange\n    SET @lowLongitude = @iStartLong - @longRange\n    SET @highLongitude = @iStartLong + @longRange\n\n    INSERT INTO @areaResults (Zip, City, St, Lat, Long)\n    SELECT ZIPcode, CITY, STate, LATitude, LONGitude\n    FROM Zip Z\n    WHERE Z.Latitude BETWEEN @lowLatitude AND @highLatitude\n      AND Z.Longitude BETWEEN @lowLongitude AND @highLongitude\n    \n    UNION ALL\n\n    SELECT postalcode, CITY, province, LATitude, LONGitude\n    FROM postalcode z\n    WHERE Z.Latitude BETWEEN @lowLatitude AND @highLatitude\n      AND Z.Longitude BETWEEN @lowLongitude AND @highLongitude\n\n    RETURN\nEND