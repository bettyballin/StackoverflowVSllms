WITH RankedStock AS (\n    SELECT \n        s.SKU,\n        s.ProductCode,\n        s.StatusCode,\n        ROW_NUMBER() OVER (PARTITION BY s.ProductCode ORDER BY l.ListDate DESC) as rn\n    FROM \n        Stock s\n    INNER JOIN \n        Listed l ON l.SKU = s.SKU\n    WHERE \n        s.StatusCode = 2\n)\nUPDATE Stock\nSET StatusCode = 1\nWHERE SKU IN (\n    SELECT SKU\n    FROM RankedStock\n    WHERE rn = 1 AND StatusCode = 2\n);