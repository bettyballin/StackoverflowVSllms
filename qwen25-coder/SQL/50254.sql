UPDATE clusterNodes cn\nSET isMaster = CASE \n                 WHEN (SELECT COUNT(nodeID) FROM clusterNodes WHERE isMaster = 1) = 0 \n                   OR ((SELECT MAX(lastTimestamp) FROM clusterNodes WHERE isMaster = 1) < NOW() - INTERVAL '2*X' SECOND)\n                 THEN TRUE\n                 ELSE FALSE\n               END,\n    lastTimestamp = CASE WHEN cn.nodeID = (\n                       SELECT nodeID \n                       FROM (  \n                         SELECT nodeID, ROW_NUMBER() OVER () as row_num\n                         FROM clusterNodes \n                         WHERE isMaster = 1 AND lastTimestamp < NOW() - INTERVAL '2*X' SECOND\n                           OR NOT EXISTS(SELECT 1 FROM clusterNodes WHERE isMaster = 1)\n                         ORDER BY CASE WHEN isMaster = 0 THEN 1 ELSE 2 END, lastTimestamp ASC\n                       ) a\n                       WHERE row_num = 1\n                     )\n                 AND (SELECT COUNT(nodeID) FROM clusterNodes WHERE isMaster = 1) = 0 \n                   OR ((SELECT MAX(lastTimestamp) FROM clusterNodes WHERE isMaster = 1) < NOW() - INTERVAL '2*X' SECOND)\n                 THEN NOW()\n                 ELSE lastTimestamp \n             END\nWHERE cn.nodeID IN (\n  SELECT nodeID\n  FROM (\n    SELECT nodeID, ROW_NUMBER() OVER () as row_num\n    FROM clusterNodes\n    ORDER BY CASE WHEN isMaster = 0 THEN 1 ELSE 2 END, lastTimestamp ASC\n  ) a\n  WHERE row_num = 1\n);