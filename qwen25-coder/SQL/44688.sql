SELECT \n    TO_CHAR(td.datetime_act_comp_dump, 'IYYY') AS dump_year,\n    TO_CHAR(td.datetime_act_comp_dump - 7/24, 'IW') AS dump_week,\n    SUBSTR(trn.train_control_id, 1, 2) AS Mine,\n    vcon.product_type_code AS Product,\n    COUNT(DISTINCT trn.train_control_id) AS Trains,\n    COUNT(1) AS Wagons,\n    MIN(trn.wid_date) AS Min_WID_Hrs,\n    MAX(trn.wid_date) AS Max_WID_Hrs,\n    MIN(td.datetime_act_comp_dump) AS Min_Fin_Dump,\n    MAX(td.datetime_act_comp_dump) AS Max_Fin_Dump,        \n    ROUND(SUM(con.weight_total - con.empty_weight_total), 0) AS Tot_Tonnes,       \n    ROUND(AVG(con.weight_total - con.empty_weight_total), 2) AS Avg_Tonnes,\n    ROUND(MIN(con.weight_total - con.empty_weight_total), 2) AS Minimum,\n    ROUND(PERCENTILE_DISC(0.99) WITHIN GROUP (ORDER BY (con.weight_total - con.empty_weight_total) DESC), 2) AS "1st"\nFROM  \n    widsys.consist con\nINNER JOIN \n    widsys.train trn ON con.train_record_id = trn.train_record_id\nINNER JOIN \n    tpps.train_details td ON trn.train_tpps_id = td.train_id AND trn.mine_code = td.mine_code\nINNER JOIN \n    widsys.v_consist_ore_detail vcon ON con.consist_id = vcon.consist_id\nWHERE \n    trn.direction = 'N'\n    AND TO_CHAR(td.datetime_act_comp_dump, 'IYYY') = '2009'\n    AND TO_CHAR(td.datetime_act_comp_dump - INTERVAL '7' HOUR, 'IW') = '25'\nGROUP BY \n    TO_CHAR(td.datetime_act_comp_dump, 'IYYY'),\n    TO_CHAR(td.datetime_act_comp_dump - INTERVAL '7' HOUR, 'IW'),\n    SUBSTR(trn.train_control_id, 1, 2),\n    vcon.product_type_code\nORDER BY \n    TO_CHAR(td.datetime_act_comp_dump - INTERVAL '7' HOUR, 'IW') DESC;