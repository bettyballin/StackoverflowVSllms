-- Enable Service Broker on your database\nALTER DATABASE YourDatabaseName SET ENABLE_BROKER;\n\n-- Create Message Type, Contract, Queue, and Service \nCREATE MESSAGE TYPE NotificationMessage AUTHORIZATION dbo VALIDATION = WELL_FORMED_XML;\nGO\n\nCREATE CONTRACT NotifyContract AUTHORIZATION dbo (NotificationMessage SENT BY INITIATOR);\nGO\n\nCREATE QUEUE NotificationsQueue WITH STATUS=ON, RETENTION=OFF; \nGO\n\nCREATE SERVICE NotificationsService ON QUEUE NotificationsQueue(NotificationContract); \nGO\n\n-- Create an Activation Procedure\nCREATE PROCEDURE proc_NotificationHandler\nAS\nWHILE(1 = 1)\nBEGIN\n    BEGIN TRANSACTION;\n\n    DECLARE @message_body XML;\n    DECLARE @DlgHandle UNIQUEIDENTIFIER; \n        \n    WAITFOR (\n      RECEIVE TOP(1) -- just handle one conversation at a time\n              @message_body = CAST(message_body AS XML),\n              @DlgHandle = conversation_handle\n        FROM NotificationsQueue), TIMEOUT 5000;\n\n    IF (@@ROWCOUNT = 0)\n    BEGIN\n       COMMIT TRANSACTION;\n       BREAK;        \n    END\n\n    -- Process the message here\n    DECLARE @NewValue VARCHAR(1024);\n    SET @NewValue = @message_body.value('(/root/row/value)[1]', 'VARCHAR(1024)');\n\n    PRINT @NewValue;\n\n    -- You can call a CLR or any other procedure to handle further logic\n\n    END CONVERSATION @DlgHandle;\n\n    COMMIT TRANSACTION;\nEND\nGO\n\n-- Set the queue to activate and call the stored procedure when messages arrive\nALTER QUEUE NotificationsQueue \nWITH  \n   STATUS = ON, \n   ACTIVATION (STATUS = ON, \n               PROCEDURE_NAME=proc_NotificationHandler,\n               EXECUTE AS N'dbo',\n               MAX_QUEUE_READERS=10,\n               MAX_RECEIVE_COUNT=25);\nGO\n\n-- Create a trigger to send message on insert\nCREATE TRIGGER trg_InsertNotify \nON YourTableName\nAFTER INSERT\nAS\nBEGIN\n    -- Send XML format rows to Service Broker Queue\n    DECLARE @message_body XML; \n    SET @message_body =\n        (SELECT value AS [@value] FROM inserted FOR XML PATH('row'), ROOT);\n\n    DECLARE @DlgHandle UNIQUEIDENTIFIER;\n    BEGIN DIALOG CONVERSATION @DlgHandle\n         FROM SERVICE NotificationsService\n         TO SERVICE 'NotificationsService'\n         ON CONTRACT NotifyContract\n         MESSAGE TYPE NotificationMessage (@message_body);\nEND;\nGO