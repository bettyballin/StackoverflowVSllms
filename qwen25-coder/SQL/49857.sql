select Part.Id as PartId, Location.Id as LocationId\n  FROM Part\n  INNER JOIN PartEvent AS PartEventOuter ON PartEventOuter.PartId = Part.Id\n  INNER JOIN District ON Part.DistrictId = District.Id\n  INNER JOIN Location ON PartEventOuter.AddressId = Location.AddressId\n  WHERE \n      PartEventOuter.EventType = '600'\n      AND Part.PartTypeId = 15   \n      AND District.SubRegionId = 11  \n      AND PartEventOuter.EventDateTime <= '2009-04-28T16:30:00'  \n      AND NOT EXISTS (\n            SELECT 1\n            FROM PartEvent AS PartEventInner\n            WHERE PartEventInner.PartId = PartEventOuter.PartId\n                AND PartEventInner.EventDateTime > PartEventOuter.EventDateTime \n                AND PartEventInner.EventDateTime <= '2009-04-30T16:00:00'\n      )\n  OPTION (RECOMPILE);