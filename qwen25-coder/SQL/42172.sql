-- Step 1: Create indexes to speed up operations (if not already indexed)\nCREATE INDEX idx_record_id ON old_table(record_id);\nCREATE INDEX idx_new_table_record_id ON new_table(record_id);\n\n-- Step 2: Insert distinct records into new_table and get index_ids\nINSERT INTO new_table (record_id, data_field)\nSELECT DISTINCT record_id, data_field \nFROM (\n    SELECT record_id, data_field\n    FROM old_table ot1\n    WHERE NOT EXISTS (\n        SELECT 1 \n        FROM new_table nt \n        WHERE nt.record_id = ot1.record_id AND nt.data_field = ot1.data_field\n    )\n) AS distinct_records;\n\n-- Step 3: Insert into new_table_index with index_ids for all records from old_table\nINSERT INTO new_table_index (date, index_id)\nSELECT ot.date, COALESCE(nt.index_id, (\n    SELECT MAX(nt2.index_id)\n    FROM new_table nt2\n    WHERE nt2.record_id = ot.record_id AND nt2.data_field = ot.data_field\n)) AS index_id\nFROM old_table ot\nLEFT JOIN new_table nt ON ot.record_id = nt.record_id AND ot.data_field = nt.data_field;