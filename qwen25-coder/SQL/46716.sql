WITH LastOrders AS (\n    SELECT o.customer_id, ol.product_id, ol.comment_memo,\n           ROW_NUMBER() OVER (PARTITION BY ol.product_id ORDER BY o.order_date DESC) as rn,\n           MAX(o.order_date) OVER (PARTITION BY ol.product_id) as last_order_date\n    FROM orderlines ol\n    JOIN orders o ON ol.order_id = o.id\n),\nCustomerOrders AS (\n    SELECT o.customer_id, p.name as product_name,\n           DATE_EXTRACT(year FROM MIN(o.order_date)) as first_purchase_year,\n           GROUP_CONCAT(DISTINCT DATE_FORMAT(o.order_date, '%Y-%m-%d') ORDER BY o.order_date DESC SEPARATOR ', ') as last_three_dates\n    FROM orderlines ol\n    JOIN orders o ON ol.order_id = o.id\n    JOIN products p ON ol.product_id = p.id\n    WHERE o.customer_id = :customer_id\n    GROUP BY p.name, ol.product_id\n),\nRecentIncome AS (\n    SELECT ol.product_id,\n           SUM(ol.quantity * ol.price) as total_income_last_12_months\n    FROM orderlines ol\n    JOIN orders o ON ol.order_id = o.id\n    WHERE o.customer_id = :customer_id AND o.order_date >= DATE_SUB(CURRENT_DATE, INTERVAL 12 MONTH)\n    GROUP BY ol.product_id\n)\nSELECT co.product_name, co.first_purchase_year, co.last_three_dates, lo.comment_memo ri.total_income_last_12_months\nFROM CustomerOrders co\nLEFT JOIN LastOrders lo ON co.customer_id = lo.customer_id AND co.product_id = lo.product_id AND lo.rn = 1\nLEFT JOIN RecentIncome ri ON co.product_id = ri.product_id;