WITH TeamWins AS (\n    SELECT \n        home_team_id AS team_id,\n        DATE(date) as contest_date,\n        SUM(CASE WHEN home_score > away_score THEN 1 ELSE 0 END) OVER (PARTITION BY home_team_id ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING) as wins_at_home\n    FROM \n        game\n    \n    UNION ALL\n\n    SELECT \n        away_team_id AS team_id,\n        DATE(date) as contest_date,\n        SUM(CASE WHEN away_score > home_score THEN 1 ELSE 0 END) OVER (PARTITION BY away_team_id ORDER BY date ROWS BETWEEN UNBOUNDED PRECEDING AND 1 PRECEDING) as wins_at_away\n    FROM \n        game\n)\nSELECT \n    ticket.id, \n    game.home_team_id AS Home, \n    game.away_team_id AS Away,\n    IFNULL((SELECT MAX(w.wins_at_home + w.wins_at_away) \n            FROM TeamWins w \n            WHERE (w.team_id = game.home_team_id OR w.team_id = game.away_team_id)\n              AND w.contest_date < DATE_SUB(ticket.time_sold, INTERVAL 1 DAY)), 0) as home_team_wins_up_to_ticket_sale\nFROM \n    ticket\nJOIN \n    game ON game.id = ticket.game_id;