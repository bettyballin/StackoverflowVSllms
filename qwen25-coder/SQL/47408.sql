WITH ranked_mats AS (\n    SELECT material_id,\n           content_id,\n           file_location,\n           ROW_NUMBER() OVER (PARTITION BY content_id ORDER BY resolution DESC) as rn\n      FROM mat\n)\nSELECT m.material_id,\n       rm.file_location as special_mat_file_location\n  FROM mat m\n  JOIN ranked_mats rm ON m.content_id = rm.content_id AND rm.rn = 1\n WHERE m.material_id IN (\n     SELECT material_id\n       FROM mat\n       JOIN con ON con.content_id = mat.content_id\n       JOIN con_groups ON con_groups.content_id = con.content_id\n      WHERE con_groups.content_group_id = 10\n );