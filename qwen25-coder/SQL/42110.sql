WITH CommittedQtyCalc AS (\n    SELECT \n        StoreId,  \n        StoreDesc,\n        CASE \n            WHEN ReservedQty > QtyOnHand THEN QtyOnHand * AvgPrice \n            ELSE ReservedQty * AvgPrice \n        END AS CommittedQty\n    FROM #temp1\n)\nINSERT INTO #temp2 (StoreId, StoreDesc, CommittedQty)\nSELECT \n    StoreId,  \n    StoreDesc,\n    SUM(CommittedQty) AS CommittedQty\nFROM CommittedQtyCalc\nGROUP BY StoreId, StoreDesc;