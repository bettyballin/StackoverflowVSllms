WITH NumberedRefs AS (\n    SELECT \n        id,\n        ref,\n        ROW_NUMBER() OVER (PARTITION BY id ORDER BY ref) AS rn\n    FROM tableA\n),\nCommonPrefix AS (\n    SELECT \n        id,\n        MIN(ref) AS min_ref_starting,\n        MAX(ref) AS max_ref_ending\n    FROM NumberedRefs\n    GROUP BY id\n),\nLongestCommonPrefix AS (\n    SELECT \n        cp.id,\n        (SELECT TOP 1 SUBSTRING(cp.min_ref_starting, 1, n)\n         FROM Numbers\n         WHERE n <= LEN(cp.min_ref_starting) AND n <= LEN(cp.max_ref_ending)\n           AND LEFT(cp.min_ref_starting, n) = LEFT(cp.max_ref_ending, n)\n         ORDER BY n DESC) AS common_prefix_length\n    FROM CommonPrefix cp\n),\nProcessedRefs AS (\n    SELECT \n        nr.id,\n        CASE \n            WHEN nr.rn = 1 THEN SUBSTRING(nr.ref, lcp.common_prefix_length + 1, LEN(nr.ref)) \n            ELSE SUBSTRING(nr.ref, lcp.common_prefix_length + 1, LEN(nr.ref))\n        END AS processed_ref\n    FROM NumberedRefs nr\n    JOIN LongestCommonPrefix lcp ON nr.id = lcp.id\n),\nFullTextConcat AS (\n    SELECT \n        pr.id,\n        STUFF((SELECT '/' + processed_ref\n               FROM ProcessedRefs pr_int\n               WHERE pr_int.id = pr.id\n               FOR XML PATH(''), TYPE).value('.', 'NVARCHAR(MAX)'), 1, 1, '') AS concatenated_ref\n    FROM ProcessedRefs pr\n    GROUP BY pr.id\n)\nSELECT \n    id,\n    CONCAT(MIN(ref), '/', concatenated_ref) AS final_result\nFROM NumberedRefs nr\nJOIN FullTextConcat ftc ON nr.id = ftc.id\nGROUP BY id, concatenated_ref;