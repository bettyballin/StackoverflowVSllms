DELIMITER |\n\nDROP FUNCTION IF EXISTS get_idiscussion_ask|\n\nCREATE FUNCTION get_idiscussion_ask(iask_id INT UNSIGNED) RETURNS TEXT DETERMINISTIC\nBEGIN\n  DECLARE done INT DEFAULT 0;\n  DECLARE body varchar(600);\n  DECLARE created DATETIME;\n  DECLARE anonymous TINYINT(1);\n  DECLARE screen_name varchar(64);\n  DECLARE result TEXT;\n  DECLARE cur1 CURSOR FOR SELECT body,created,anonymous,screen_name from idiscussion left join users on idiscussion.uid=users.id where idiscussion.iask_id=iask_id;\n  DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET done = 1;\n\n  SET result = '';\n  OPEN cur1;\n  REPEAT\n    FETCH cur1 INTO body, created, anonymous, screen_name;\n    SET result = CONCAT(result,'<comment><body><![CDATA[',IFNULL(body,''),']]></body>','<replier>', IF(screen_name IS NOT NULL AND !anonymous,screen_name,''),'</replier>','<created>',IFNULL(created,''),'</created></comment>');\n  UNTIL done END REPEAT;\n  CLOSE cur1;\n\n  RETURN result;\nEND |\n\nDELIMITER ;