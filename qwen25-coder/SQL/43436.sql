WITH CategoryHierarchy AS (\n    SELECT \n        c.CategoryId,\n        p.ProductId\n    FROM \n        Category c\n    JOIN \n        ProductCategory p ON c.CategoryId = p.CategoryId\n\n    UNION ALL\n\n    SELECT \n        ch.CategoryId,\n        h.ProductId\n    FROM \n        CategoryHierarchy ch\n    INNER JOIN \n        Category h ON ch.CategoryId = h.ParentCategoryId\n)\n, FinalResult AS (\n    SELECT DISTINCT \n        ProductId, \n        CategoryId\n    FROM \n        CategoryHierarchy\n    \n    UNION ALL \n\n    SELECT DISTINCT \n        fc.ProductId, \n        0 AS CategoryId\n    FROM \n        FinalResult fc\n)\nSELECT *\nFROM FinalResult\nORDER BY ProductId, CategoryId;