WITH ProductsNotOwned AS (\n    SELECT \n        c.CustomerID,\n        p.ProductID,\n        ROW_NUMBER() OVER (PARTITION BY p.ProductID ORDER BY c.CustomerID) as RowNum\n    FROM \n        Customers c\n    CROSS JOIN \n        Products p\n    LEFT JOIN \n        CustomerProducts cp ON c.CustomerID = cp.CustomerID AND p.ProductID = cp.ProductID\n    WHERE \n        cp.CustomerID IS NULL  -- This means the customer does not own this product\n),\nFirstProductForCustomer AS (\n    SELECT \n        CustomerID,\n        ProductID\n    FROM \n        ProductsNotOwned\n    WHERE \n        RowNum = 1  -- Select only the first row for each product\n)\nUPDATE Customers\nSET UnownedProduct = fp.ProductID\nFROM Customers c\nJOIN FirstProductForCustomer fp ON c.CustomerID = fp.CustomerID;