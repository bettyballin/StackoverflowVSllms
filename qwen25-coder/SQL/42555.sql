WITH RankedStudents AS (\n    SELECT \n        ProfessorID,\n        StudentID,\n        Mark,\n        ROW_NUMBER() OVER (PARTITION BY ProfessorID ORDER BY Mark DESC) as Rank\n    FROM \n        ProfessorStudentMarks\n)\n\nSELECT \n    ProfessorID,\n    StudentID,\n    Mark\nFROM \n    RankedStudents\nWHERE \n    Rank <= 2\nAND \n    ProfessorID IN (\n        SELECT \n            ProfessorID\n        FROM \n            ProfessorStudentMarks\n        GROUP BY \n            ProfessorID\n        HAVING \n            COUNT(DISTINCT StudentID) >= 2\n    )\nORDER BY \n    ProfessorID, Mark DESC;