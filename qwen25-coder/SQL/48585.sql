SELECT \n    v.video_id, \n    v.video_name,\n    COUNT(vt2.tag_id) AS tag_similarity_count,\n    SUM(CASE WHEN tv1.word_id = tv2.word_id THEN 1 ELSE 0 END) AS title_similarity_count,\n    vv.view_count,\n    vr.avg_rating\nFROM \n    videos v\nJOIN \n    videotags vt1 ON v.video_id = vt1.video_id\nJOIN \n    videotags vt2 ON vt1.tag_id = vt2.tag_id AND vt1.video_id != vt2.video_id\nJOIN \n    (\n        SELECT video_id, COUNT(DISTINCT TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(video_name, ' ', numbers.n), ' ', -1))) AS word_id\n        FROM videos v, (SELECT a.N + b.N * 10 + 1 n FROM (SELECT 0 AS N UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) a\n        CROSS JOIN (SELECT 0 AS N UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) b\n    ) tv1 ON v.video_id = tv1.video_id\nJOIN \n    (\n        SELECT video_id, COUNT(DISTINCT TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(video_name, ' ', numbers.n), ' ', -1))) AS word_id\n        FROM videos v, (SELECT a.N + b.N * 10 + 1 n FROM (SELECT 0 AS N UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) a\n        CROSS JOIN (SELECT 0 AS N UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9) b\n    ) tv2 ON vt2.video_id = tv2.video_id\nLEFT JOIN \n    (SELECT video_id, COUNT(*) AS view_count FROM videoviews GROUP BY video_id) vv ON vv.video_id = v.video_id\nLEFT JOIN \n    (SELECT video_id, AVG(rating) AS avg_rating FROM videoratings GROUP BY video_id HAVING avg_rating > 0) vr ON vr.video_id = v.video_id\nWHERE \n    vt1.video_id = :current_video_id AND vt2.video_id != :current_video_id\nGROUP BY \n    v.video_id\nORDER BY \n    tag_similarity_count DESC, title_similarity_count DESC, vv.view_count DESC, vr.avg_rating DESC\nLIMIT 5;