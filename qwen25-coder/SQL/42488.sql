WITH LatestSalesPersonData AS (\n    SELECT \n        sp.salesPersonId,\n        d.companyId,\n        spd.order_id,\n        spd.timestamp,\n        spd.called_inbound,\n        spd.called_outbound,\n        spd.orders_issued,\n        spd.revenue_total,\n        ROW_NUMBER() OVER (PARTITION BY DATE(spd.timestamp), sp.salesPersonId ORDER BY spd.timestamp DESC) as rn\n    FROM \n        salesPerformanceData spd\n    JOIN \n        salesPerson sp ON spd.salesPersonId = sp.salesPersonId\n    JOIN \n        division d ON sp.divisionId = d.divisionId\n    WHERE \n        spd.timestamp >= '2009-05-01' AND spd.timestamp < '2009-05-07'\n),\nCompanyAggregatedData AS (\n    SELECT \n        c.companyId,\n        c.name as companyName,\n        SUM(spd.called_inbound) as total_called_inbound,\n        SUM(spd.called_outbound) as total_called_outbound,\n        SUM(spd.orders_issued) as total_orders_issued,\n        SUM(spd.revenue_total) as total_revenue\n    FROM \n        LatestSalesPersonData spd\n    JOIN \n        company c ON spd.companyId = c.companyId\n    WHERE \n        spd.rn = 1\n    GROUP BY \n        c.companyId, c.name\n)\nSELECT \n    *\nFROM \n    CompanyAggregatedData\nORDER BY \n    total_revenue DESC -- or any other column for sorting\nLIMIT \n    10 OFFSET 0; -- for paginatio