DECLARE @GivenDate DATE = '2023-10-05'; -- Replace with your desired date\n\n;WITH ProcessStatus AS (\n    SELECT \n        Message, \n        ROW_NUMBER() OVER (ORDER BY Timestamp) AS rn,\n        COUNT(CASE WHEN Message = 'Started' THEN 1 END) OVER () AS StartedCount,\n        COUNT(CASE WHEN Message = 'Finished' THEN 1 END) OVER () AS FinishedCount\n    FROM YourTableName -- Replace with your actual table name\n    WHERE CAST(Timestamp AS DATE) = @GivenDate AND Message IN ('Started', 'Finished')\n)\nSELECT \n    CASE \n        WHEN MAX(StartedCount) = 0 THEN 0\n        WHEN MAX(FinishedCount) < MAX(StartedCount) THEN 1\n        WHEN MAX(FinishedCount) >= MAX(StartedCount) THEN 2\n    END AS ProcessStatus,\n    CASE \n        WHEN MAX(StartedCount) > 1 OR (MAX(FinishedCount) > 0 AND MAX(FinishedCount) != MAX(StartedCount)) THEN 1\n        ELSE 0\n    END AS InvalidDataFlag\nINTO #TempProcessResult\nFROM ProcessStatus;\n\nDECLARE @Status INT, @InvalidDataFlag INT;\nSELECT @Status = ProcessStatus, @InvalidDataFlag = InvalidDataFlag FROM #TempProcessResult;\n\nIF @InvalidDataFlag = 1\n    RAISERROR ('Invalid data found: multiple "Started" messages or unmatched "Finished".', 16, 1);\n\nSELECT @Status AS Status;\n\nDROP TABLE #TempProcessResult;