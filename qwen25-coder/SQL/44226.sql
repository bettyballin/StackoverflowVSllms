-- Ensure appropriate indexes exist:\n-- CREATE NONCLUSTERED INDEX idx_POP10500_POPOPRCTRCPT ON dw.POP10500 (PONUMBER, POPRCTNM, RCPTLNNM);\n-- CREATE NONCLUSTERED INDEX idx_POP30310_POPOPRCTRCPT ON dw.POP30310 (PONUMBER, POPRCTNM, RCPTLNNM);\n\n; WITH Requested AS (\n    SELECT DISTINCT -- Consider if necessary, might be able to avoid this step\n        PONUMBER as PONumber, \n        MIN(REQSTDBY) as RequestedBy\n    FROM dw.POP10110\n    WHERE REQSTDBY <> ''\n    GROUP BY PONUMBER\n),\nPreFilter AS (\n    SELECT a.PONUMBER, a.POPRCTNM, a.RCPTLNNM, a.VENDORID, a.POPTYPE, a.QTYSHPPD, a.QTYINVCD,\n           b.ITEMNMBR, b.ITEMDESC, b.UOFM, b.UNITCOST, b.EXTDCOST, b.LOCNCODE, b.ProjNum,\n           coalesce(e.GLPOSTDT, f.GLPOSTDT, '') as GLPostDate,\n           coalesce(e.VENDNAME, f.VENDNAME, '') as VendorName\n    FROM dw.POP10500 a\n    INNER JOIN dw.POP30310 b ON a.PONUMBER = b.PONUMBER AND a.POPRCTNM = b.POPRCTNM AND a.RCPTLNNM = b.RCPTLNNM\n    LEFT OUTER JOIN @gl00100 c ON b.INVINDX = c.ActID\n    LEFT OUTER JOIN dw.POP30300 e ON b.POPRCTNM = e.POPRCTNM\n    LEFT OUTER JOIN dw.POP10300 f ON b.POPRCTNM = f.POPRCTNM\n)\n\nINSERT INTO @tblTableA (PONumber, ReceiptNumber, ReceiptLineNumber, VendorID, POType, QuantityShipped, QuantityInvoiced,\n                       ItemNumber, ItemDescription, UofM, UnitCost, ExtendedCost, SiteID, ProjectNumber, AccountID, RequestedBy,\n                       GLPostDate, VendorName, CostCategoryID)\nSELECT pf.PONUMBER, pf.POPRCTNM, pf.RCPTLNNM, pf.VENDORID, pf.POPTYPE, pf.QTYSHPPD, pf.QTYINVCD,\n       pf.ITEMNMBR, pf.ITEMDESC, pf.UOFM, pf.UNITCOST, pf.EXTDCOST, pf.LOCNCODE, pf.ProjNum,\n       CASE i.CostCategoryID \n            WHEN 'MISC' THEN isnull(i.AccountID,'N/A')\n            ELSE COALESCE(j.AccountID, c.PurchaseAccount) END AS AccountID,\n       Requested.RequestedBy,\n       pf.GLPostDate,\n       pf.VendorName,\n       CASE i.CostCategoryID \n            WHEN 'MISC' THEN i.CreateCategoryID\n            ELSE COALESCE(i.CreateCategoryID, j.CostCategoryID) END AS CostCategoryID\nFROM PreFilter pf\nLEFT OUTER JOIN Requested ON pf.PONUMBER = Requested.PONumber\nLEFT OUTER JOIN @pop31310 g ON pf.POPRCTNM = g.ReceiptNumber\nLEFT OUTER JOIN @pop11310 h ON pf.POPRCTNM = h.ReceiptNumber\nLEFT OUTER JOIN @pop30390 i ON pf.POPRCTNM = i.ReceiptNumber\nLEFT OUTER JOIN @pop10390 j ON pf.POPRCTNM = j.ReceiptNumber;