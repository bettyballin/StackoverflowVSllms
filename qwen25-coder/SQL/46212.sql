UPDATE Table1 t1\nSET DATE = (\n    SELECT MAX(t2.DATE)\n    FROM (\n        SELECT t2.DATE,\n               SUM(t2.AMOUNT1) OVER (ORDER BY t2.DATE DESC) AS cumulative_amount\n        FROM Table2 t2\n        WHERE t2.ID = t1.ID\n    ) t2\n    WHERE t2.cumulative_amount >= t1.AMOUNT\n)\nWHERE EXISTS (\n    SELECT 1\n    FROM Table2 t2\n    WHERE t2.ID = t1.ID AND SUM(t2.AMOUNT1) >= t1.AMOUNT\n);