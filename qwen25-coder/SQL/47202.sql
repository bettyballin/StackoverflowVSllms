DELIMITER //\n\n   CREATE PROCEDURE update_totals()\n   BEGIN\n       DECLARE done INT DEFAULT FALSE;\n       DECLARE current_node INT;\n       \n       DECLARE cur CURSOR FOR SELECT num FROM update_queue;\n       DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;\n\n       OPEN cur;\n\n       read_loop: LOOP\n           FETCH cur INTO current_node;\n           IF done THEN \n               LEAVE read_loop; \n           END IF;\n           \n           -- Update the total for the current node.\n           UPDATE items AS a\n           SET a.tot = (SELECT SUM(b.tot) FROM tree JOIN items AS b ON tree.term = b.num WHERE tree.orig = a.num)\n           WHERE a.num = current_node;\n\n           -- Remove the processed item from the queue.\n           DELETE FROM update_queue WHERE num = current_node;\n       END LOOP;\n\n       CLOSE cur;\n   END;//\n\n   DELIMITER ;