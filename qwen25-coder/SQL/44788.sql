WITH RecentWaypoints AS (\n    SELECT \n        WP_VTDID,\n        MAX(WP_ODOMETER) - MIN(WP_ODOMETER) AS ODOMETER_CHANGE,\n        DATEDIFF(DAY, MIN(WP_DATETIME), MAX(WP_DATETIME)) AS DAY_DIFF,\n        MAX(WP_ODOMETER) AS MAX_ODOMETER\n    FROM \n        WAYPOINTS\n    WHERE \n        WP_DATETIME BETWEEN DATEADD(DAY,-14,GETDATE()) AND GETDATE()\n    GROUP BY \n        WP_VTDID\n)\nSELECT \n    L_VTDID,\n    ODOMETER_CHANGE / NULLIF(DAY_DIFF, 0) AS MAXD,\n    MAX_ODOMETER AS MD\nFROM \n    LOCOMOTIVES\nLEFT JOIN\n    RecentWaypoints ON LOCOMOTIVES.L_VTDID = RecentWaypoints.WP_VTDID;