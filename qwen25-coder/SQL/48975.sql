DECLARE @columns NVARCHAR(MAX) = ''\nDECLARE @query   NVARCHAR(MAX)\n\n-- Step 1: Dynamically create column list from Flag table\nSELECT \n    @columns += '[' + Name + '] AS [' + Name + '], '\nFROM Flag\n\nSET @columns = LEFT(@columns, LEN(@columns) - 1) -- Trim the last comma and space\n\n-- Step 2: Construct and execute dynamic SQL\nSET @query = '\nSELECT f.Id AS FileId, \n       f.Name AS FileName,\n       ' + @columns + '\nFROM File f\nLEFT JOIN (\n    SELECT ff.FileId, fl.Name, CASE WHEN ff.FlagId IS NOT NULL THEN CAST(1 AS BIT) ELSE CAST(0 AS BIT) END AS FlagValue\n    FROM Flag fl\n    LEFT JOIN FileFlags ff ON fl.Id = ff.FlagId\n) flags ON f.Id = flags.FileId\nPIVOT (\n    MAX(FlagValue)\n    FOR [Name] IN (' + @columns + ')\n) as Pvt'\n\nEXEC sp_executesql @query