WITH RankedSlots AS (\n    SELECT \n        pss.slotnumber,\n        pss.fileid,\n        s.rank,\n        ROW_NUMBER() OVER (PARTITION BY pss.slotnumber ORDER BY s.rank DESC) as rn\n    FROM \n        PlaylistSlots pss\n    JOIN \n        Playlists pl ON pss.playlistid = pl.id\n    JOIN \n        Schedules s ON pl.id = s.playlistid\n)\nSELECT \n    slotnumber,\n    fileid,\n    rank\nFROM \n    RankedSlots\nWHERE \n    rn = 1;