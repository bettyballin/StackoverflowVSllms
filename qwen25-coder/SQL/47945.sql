WITH CoalescedDates AS (\n    SELECT \n        tbl1.gid,\n        [snip],\n        COALESCE(t1_end_dt, t6_actl_end_dt, t6_calc_end_dt) AS perd_end_dt,\n        t1_end_dt\n    FROM    tbl1\n    .....\n    LEFT JOIN tbl4 tbl4_a ON (tbl4_a.t4_pk = chkw_wkt_id)\n    .....\n)\n\nSELECT \n    gid,\n    [snip],\n    perd_end_dt,\n    t1_end_dt\nFROM CoalescedDates\nWHERE perd_end_dt BETWEEN t2_strt_dt AND t2_end_dt -- Assuming t2_* is accessible here or join condition needs to be moved inside CTE\nAND   perd_end_dt BETWEEN t3_strt_dt AND t3_end_dt  -- Similarly, ensure t3_* is accessible or adjust logic accordingly\nGROUP BY ged,\n         perd_end_dt,\n         COALESCE(tbl4_b.t4_or_id, tbl4_a.t4_or_id, t7_or_id),\n         t1_end_dt\nORDER BY perd_end_dt;