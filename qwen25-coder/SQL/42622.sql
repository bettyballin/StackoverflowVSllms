WITH FilteredRecords AS (\n    SELECT \n        Id, ExtId, StartExclusionDate, EndExclusionDate, ApplyDate,\n        ROW_NUMBER() OVER (PARTITION BY ExtId ORDER BY ApplyDate DESC) as rn\n    FROM \n        Exclusions\n    WHERE \n        ExtId = @ExtId AND ApplyDate <= @dtDate\n        AND (@dtDate BETWEEN StartExclusionDate AND EndExclusionDate OR StartExclusionDate IS NULL)\n),\nContinuousRecords AS (\n    SELECT \n        Id, ExtId, StartExclusionDate, EndExclusionDate, ApplyDate,\n        rn,\n        ROW_NUMBER() OVER (ORDER BY ApplyDate DESC) as continuous_rn\n    FROM \n        FilteredRecords\n    WHERE\n        rn = 1 OR (\n            EXISTS(\n                SELECT 1\n                FROM FilteredRecords fr2\n                WHERE fr2.rn = FilteredRecords.rn - 1\n                AND (\n                    (FilteredRecords.StartExclusionDate IS NULL OR FilteredRecords.StartExclusionDate <= fr2.EndExclusionDate)\n                    AND (FilteredRecords.EndExclusionDate IS NULL OR FilteredRecords.EndExclusionDate >= fr2.StartExclusionDate)\n                )\n            )\n        )\n)\nSELECT TOP 1\n    *\nFROM \n    ContinuousRecords\nWHERE \n    continuous_rn = 1;