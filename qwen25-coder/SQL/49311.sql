CREATE PROCEDURE web.getRandomCharities ( @tmp_ID bigint --members ID )\nAS \nBEGIN\n    DECLARE @FaveKey int;\n    \n    -- Get the user's favorite charity key\n    SELECT @FaveKey = members_Favourite FROM TBL_MEMBERS WHERE members_Id = @tmp_ID;\n\n    -- Get 5 random charities excluding cha_Key = 1 and the favorite charity\n    WITH RandomCharities AS (\n        SELECT TOP 5 *\n        FROM TBL_CHARITIES\n        WHERE   cha_Active = 'TRUE'\n                AND cha_Key != @FaveKey\n                AND cha_Key != 1\n        ORDER BY NEWID()\n    ),\n    AdditionalCharity AS (\n        -- Include cha_Key = 1 if not already selected and the user's favorite\n        SELECT TOP (5 - (SELECT COUNT(*) FROM RandomCharities)) *\n        FROM TBL_CHARITIES\n        WHERE   cha_Active = 'TRUE'\n                AND cha_Key != @FaveKey\n                AND (cha_Key = 1 OR cha_Key NOT IN (SELECT cha_Key FROM RandomCharities))\n        ORDER BY NEWID()\n    )\n    -- Combine results\n    SELECT * FROM RandomCharities\n    UNION ALL\n    SELECT * FROM AdditionalCharity;\n    \n    -- Finally, get the favorite charity if cha_Active is still true\n    SELECT * \n    FROM TBL_CHARITIES \n    WHERE cha_Key = @FaveKey AND cha_Active = 'TRUE';\nEND