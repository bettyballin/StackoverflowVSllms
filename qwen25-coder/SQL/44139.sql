BEGIN TRAN\n\n-- Declare Variables\nDECLARE @CONTACT_ID VARCHAR(15)\nDECLARE @TYPE VARCHAR(15)\nDECLARE @CURRENT_INDEX_NO SMALLINT\nDECLARE @COUNTER SMALLINT\nDECLARE @OUTER_STATUS INT \nDECLARE @INNER_STATUS INT \n\n-- Outer Cursor Declaration\nDECLARE OUTER_CURSOR CURSOR FOR \nSELECT CONTACT_ID, TYPE, INDEX_NO \nFROM CONTACTS\nWHERE CONTACT_ID IN (SELECT CONTACT_ID FROM dbo.CONTACTS\n                     GROUP BY CONTACT_ID, TYPE, INDEX_NO\n                     HAVING COUNT(*) > 1)\n\nOPEN OUTER_CURSOR \n\nFETCH NEXT FROM OUTER_CURSOR INTO @CONTACT_ID, @TYPE, @CURRENT_INDEX_NO\nSET @OUTER_STATUS = @@FETCH_STATUS\n\nWHILE (@OUTER_STATUS = 0)\nBEGIN\n    SET @COUNTER = 1\n\n    -- Inner Cursor Declaration\n    DECLARE INNER_CURSOR CURSOR FOR \n    SELECT * \n    FROM CONTACTS\n    WHERE CONTACT_ID = @CONTACT_ID AND TYPE = @TYPE \n    ORDER BY INDEX_NO -- or another column for consistent ordering\n    FOR UPDATE \n    \n    OPEN INNER_CURSOR \n\n    FETCH NEXT FROM INNER_CURSOR\n    SET @INNER_STATUS = @@FETCH_STATUS\n\n    WHILE (@INNER_STATUS = 0)\n    BEGIN\n        UPDATE CONTACTS\n        SET INDEX_NO = @COUNTER\n        WHERE CURRENT OF INNER_CURSOR\n\n        SET @COUNTER = @COUNTER + 1\n\n        FETCH NEXT FROM INNER_CURSOR \n        SET @INNER_STATUS = @@FETCH_STATUS\n    END\n\n    CLOSE INNER_CURSOR\n    DEALLOCATE INNER_CURSOR\n\n    FETCH NEXT FROM OUTER_CURSOR INTO @CONTACT_ID, @TYPE, @CURRENT_INDEX_NO\n    SET @OUTER_STATUS = @@FETCH_STATUS\nEND\n\nCLOSE OUTER_CURSOR\nDEALLOCATE OUTER_CURSOR\n\nCOMMIT TRAN