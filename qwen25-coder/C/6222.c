#include <stdio.h>\n#include <stdlib.h>\n#include <poll.h>\n#include <unistd.h>\n#include <sys/socket.h>\n#include <netinet/in.h>\n#include <arpa/inet.h>\n#include <string.h>\n\n#define PORT 8888\n#define MAX_CONN 10\n#define SECOND 1000\n#define TIMEOUT (30 * SECOND)\n\nstatic int listen_socket();\n\nint main(int argc, char **argv)\n{\n    struct pollfd my_fds[MAX_CONN];\n    int num_fds = 1;\n    int i, j;\n    char buff[256], buff2[512];\n\n    my_fds[0].fd = listen_socket();\n    my_fds[0].events = POLLIN;\n\n    while (1) {\n        if (poll(my_fds, num_fds, TIMEOUT) < 0) {\n            perror("poll()");\n            break;\n        }\n\n        if (my_fds[0].revents & POLLIN) { // new connection\n            struct sockaddr_in their_addr;\n            socklen_t sin_size = sizeof(their_addr);\n            int new_fd = accept(my_fds[0].fd, (struct sockaddr *)&their_addr, &sin_size);\n            if (new_fd < 0)\n                perror("accept()");\n            else {\n                printf("Connection from %s\n", inet_ntoa(their_addr.sin_addr));\n                sprintf(buff2, "Your connection on fd %d\n", new_fd);\n                send(new_fd, buff2, strlen(buff2), 0);\n\n                if (num_fds < MAX_CONN) {\n                    my_fds[num_fds].fd = new_fd;\n                    my_fds[num_fds++].events = POLLIN;\n                }\n            }\n        }\n\n        for (i = 1; i < num_fds; i++) {\n            if (my_fds[i].revents & POLLIN) { // data received\n                int n = recv(my_fds[i].fd, buff, sizeof(buff) - 1, 0);\n                if (n <= 0) { // handle disconnection or error\n                    printf("Connection %d closed\n", my_fds[i].fd);\n                    close(my_fds[i].fd);\n                    for (j = i; j < num_fds - 1; j++)\n                        my_fds[j] = my_fds[j + 1];\n                    num_fds--;\n                } else {\n                    buff[n] = '\0';\n                    printf("Received: %s", buff);\n\n                    // send the message to everyone else\n                    for (j = 1; j < num_fds; j++) {\n                        if (my_fds[j].fd != my_fds[i].fd) {\n                            sprintf(buff2, "FD %d sent: %s", my_fds[i].fd, buff);\n                            send(my_fds[j].fd, buff2, strlen(buff2), 0);\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    printf("App Ended\n");\n    return 0;\n}\n\nstatic int listen_socket()\n{\n    struct sockaddr_in a;\n    int s;\n    int yes = 1;\n\n    if ((s = socket(AF_INET, SOCK_STREAM, 0)) < 0) {\n        perror("socket");\n        exit(1);\n    }\n    if (setsockopt(s, SOL_SOCKET, SO_REUSEADDR, &yes, sizeof(yes)) < 0) {\n        perror("setsockopt");\n        close(s);\n        exit(1);\n    }\n    memset(&a, 0, sizeof(a));\n    a.sin_port = htons(PORT);\n    a.sin_family = AF_INET;\n    if (bind(s, (struct sockaddr *)&a, sizeof(a)) < 0) {\n        perror("bind");\n        close(s);\n        exit(1);\n    }\n    printf("Accepting connections on port %d\n", PORT);\n    listen(s, 10);\n    return s;\n}