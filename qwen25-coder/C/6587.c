#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <zlib.h>\n\n#define CHUNK 16384\n\nint compress_data(const unsigned char *data, size_t datalen, unsigned char **outbuf, size_t *outlen) {\n    z_stream strm;\n    int ret;\n    unsigned have;\n\n    /* allocate deflate state */\n    strm.zalloc = Z_NULL;\n    strm.zfree  = Z_NULL;\n    strm.opaque = Z_NULL;\n    \n    // Initialize state\n    ret = deflateInit(&strm, -1);\n    if (ret != Z_OK)\n        return ret;\n\n    // Allocate input and output buffers\n    strm.avail_in = datalen;\n    strm.next_in = data;\n\n    *outbuf = malloc(8 + zlibCompileFlags()); // Initial buffer size\n    int size_increase = 2;\n    unsigned char *pos = *outbuf + 8;\n    *outlen = 0;\n\n    // Deflate loop\n    do {\n        if (strm.avail_out == 0) {         \n            *outlen += CHUNK;\n            *outbuf = realloc(*outbuf, *outlen * size_increase);\n            pos = (*outbuf + *outlen - CHUNK);\n            strm.avail_out = CHUNK; \n            strm.next_out = pos;             \n        }\n\n        ret = deflate(&strm, Z_FINISH);   \n        have = CHUNK - strm.avail_out;\n        \n    } while (ret == Z_BUF_ERROR);\n\n    if (ret != Z_STREAM_END) {\n        deflateEnd(&strm);\n        free(*outbuf);\n        return ret == Z_MEM_ERROR ? Z_MEM_ERROR : Z_DATA_ERROR;\n     }\n\n   *outlen -= strm.avail_out;\n    deflateEnd(&strm);\n    return Z_OK;\n}\n\nint main() {\n    unsigned char *in = (unsigned char *)"this is a test\n";\n    size_t out_len;\n    unsigned char *out;\n\n    if (compress_data(in, strlen((char*) in), &out, &out_len) != Z_OK) {\n        printf("Compression failed!");\n        return 1;\n    }\n\n    // Output the compressed data to stdout or network\n    fwrite(out + 8, out_len - 8, 1, stdout); \n    free(out);\n    return 0;\n}