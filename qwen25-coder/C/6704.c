static size_t token_bucket_consume(token_buffer *tbf, size_t bytes)\n{\n    // Update the tokens\n    uint64_t now = time_now();\n    size_t delta = (size_t)(tbf->rate * (now - tbf->timestamp));\n    tbf->tokens = (tbf->capacity < tbf->tokens + delta) ? tbf->capacity : tbf->tokens + delta;\n    tbf->timestamp = now;\n\n    printf("TOKENS %zu  bytes: %zu\n", tbf->tokens, bytes);\n\n    // If the request is larger than the capacity, we can either drop it or permit sending it but account for future token consumption.\n    if (bytes > tbf->capacity) {\n        // Option A: Drop the message\n        // return -1;\n\n        // Option B: Send the large packet now and account for its tokens over time\n        printf("Large packet detected. Sending immediately but adjusting future token availability.\n");\n        tbf->tokens = 0; // Ensure no other packets can be sent instantly after this large one\n    } else if (bytes <= tbf->tokens) {\n        tbf->tokens -= bytes;\n    } else {\n        return -1;\n    }\n\n    return 0;\n}