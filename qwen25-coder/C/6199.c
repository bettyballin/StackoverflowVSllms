#include <stdio.h>\n#include <stdlib.h>\n#include "jpeglib.h"\n#include <setjmp.h>\n\nint main() {\n    // Decompress input.jpg\n    struct jpeg_decompress_struct cinfo;\n    struct jpeg_error_mgr jerr;\n\n    FILE *input = fopen("input.jpg", "rb");\n    if (input == NULL)\n        exit(1);\n\n    cinfo.err = jpeg_std_error(&jerr);\n    jpeg_create_decompress(&cinfo);\n    jpeg_stdio_src(&cinfo, input);\n    jpeg_read_header(&cinfo, TRUE);\n    jpeg_start_decompress(&cinfo);\n\n    JSAMPLE *image_buffer;\n    int row_stride = cinfo.output_width * cinfo.output_components;\n    image_buffer = (JSAMPLE *)malloc(row_stride * cinfo.output_height);\n\n    while (cinfo.output_scanline < cinfo.output_height) {\n        unsigned char *buffer_array[1];\n        buffer_array[0] = image_buffer + (row_stride * cinfo.output_scanline);\n        jpeg_read_scanlines(&cinfo, buffer_array, 1);\n    }\n\n    jpeg_finish_decompress(&cinfo);\n    fclose(input);\n    jpeg_destroy_decompress(&cinfo);\n\n    // Compress to foo.jpg\n    struct jpeg_compress_struct cinfo2;\n    cinfo2.err = jpeg_std_error(&jerr);\n    jpeg_create_compress(&cinfo2);\n    FILE *outfile = fopen("foo.jpg", "wb");\n    if (outfile == NULL)\n        exit(1);\n    jpeg_stdio_dest(&cinfo2, outfile);\n\n    cinfo2.image_width = cinfo.output_width;\n    cinfo2.image_height = cinfo.output_height;\n    cinfo2.input_components = cinfo.output_components;\n    cinfo2.in_color_space = cinfo.out_color_space == JCS_GRAYSCALE ? JCS_GRAYSCALE : JCS_RGB;\n\n    jpeg_set_defaults(&cinfo2);\n    jpeg_start_compress(&cinfo2, TRUE);\n\n    JSAMPROW row_pointer[1];\n    while (cinfo2.next_scanline < cinfo2.image_height) {\n        row_pointer[0] = &image_buffer[cinfo2.next_scanline * row_stride];\n        jpeg_write_scanlines(&cinfo2, row_pointer, 1);\n    }\n\n    jpeg_finish_compress(&cinfo2);\n    fclose(outfile);\n    jpeg_destroy_compress(&cinfo2);\n\n    free(image_buffer);\n}