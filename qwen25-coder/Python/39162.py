from sqlalchemy import desc\n\ndef add_category(session, name, parent_id=None):\n    # Get the right value of the parent or the tree root if no parent is specified\n    subq = (\n        session.query(Category.rgt)\n        .filter_by(id=parent_id) if parent_id else \n        session.query(func.max(Category.rgt))\n    ).scalar()\n    \n    rgt = subq + 1\n    \n    # Shift all greater numbers to the right (make room for the new node)\n    session.execute(\n        Category.update().where(Category.lft >= rgt).values(lft=Category.lft+2)\n    )\n    session.execute(\n        Category.update().where(Category.rgt >= rgt).values(rgt=Category.rgt+2)\n    )\n    \n    # Create the new node\n    new_category = Category(name=name, lft=rgt, rgt=rgt+1)\n    session.add(new_category)\n\n# Usage:\n# add_category(session, 'New Subcategory', parent_id=5)