from .models import Favorite\nfrom django.shortcuts import get_object_or_404\n\ndef add_favorite(request, product_id):\n    product = get_object_or_404(Product, pk=product_id)\n    session_key = request.session.session_key\n    if request.user.is_authenticated:\n        favorite, created = Favorite.objects.get_or_create(user=request.user, product=product)\n    else:\n        if not session_key:\n            request.session.save()  # Ensure we have a session key\n            session_key = request.session.session_key\n        favorite, created = Favorite.objects.get_or_create(session_key=session_key, product=product)\n\ndef get_favorites(request):\n    if request.user.is_authenticated:\n        return Favorite.objects.filter(user=request.user)\n    else:\n        session_key = request.session.session_key\n        return Favorite.objects.filter(session_key=session_key) or []