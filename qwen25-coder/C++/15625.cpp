#include <windows.h>\n#include <wincodec.h>\n\n#pragma comment(lib, "windowscodecs.lib")\n\nHRESULT SaveHBITMAPToJPEG(HBITMAP hBitmap, LPCWSTR filePath) {\n    IWICImagingFactory* pIWICFactory = NULL;\n    IWICBitmap* pWicBitmap = NULL;\n    IWICStream* pIWICStream = NULL;\n    IWICBitmapEncoder* pEncoder = NULL;\n    IWICBitmapFrameEncode* pFrameEncode = NULL;\n\n    HRESULT hr = CoInitializeEx(NULL, COINIT_MULTITHREADED);\n    if (FAILED(hr)) return hr;\n\n    hr = CoCreateInstance(\n        CLSID_WICImagingFactory1,\n        NULL,\n        CLSCTX_INPROC_SERVER,\n        IID_PPV_ARGS(&pIWICFactory)\n    );\n    if (FAILED(hr)) goto Cleanup;\n\n    hr = pIWICFactory->CreateBitmapFromHBITMAP(hBitmap, NULL, WICBitmapIgnoreAlpha, &pWicBitmap);\n    if (FAILED(hr)) goto Cleanup;\n\n    hr = pIWICFactory->CreateStream(&pIWICStream);\n    if (FAILED(hr)) goto Cleanup;\n\n    hr = pIWICStream->InitializeFromFilename(filePath, GENERIC_WRITE);\n    if (FAILED(hr)) goto Cleanup;\n\n    hr = pIWICFactory->CreateEncoder(GUID_ContainerFormatJpeg, NULL, &pEncoder);\n    if (FAILED(hr)) goto Cleanup;\n\n    hr = pEncoder->Initialize(pIWICStream, WICBitmapEncoderNoCache);\n    if (FAILED(hr)) goto Cleanup;\n\n    hr = pEncoder->CreateNewFrame(&pFrameEncode, NULL);\n    if (FAILED(hr)) goto Cleanup;\n\n    hr = pFrameEncode->Initialize(NULL);\n    if (FAILED(hr)) goto Cleanup;\n\n    hr = pFrameEncode->WriteSource(pWicBitmap, NULL);\n    if (FAILED(hr)) goto Cleanup;\n\n    hr = pFrameEncode->Commit();\n    if (FAILED(hr)) goto Cleanup;\n\n    hr = pEncoder->Commit();\n\nCleanup:\n    if (pIWICStream) pIWICStream->Release();\n    if (pEncoder) pEncoder->Release();\n    if (pFrameEncode) pFrameEncode->Release();\n    if (pWicBitmap) pWicBitmap->Release();\n    if (pIWICFactory) pIWICFactory->Release();\n    CoUninitialize();\n\n    return hr;\n}