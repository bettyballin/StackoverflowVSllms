<?php\n// Sample HTML content\n$html = '<p>My paragraph text</p>\n<img class="right" src="blah.jpg" alt="My caption" width="100" height="200" />\n<p>Another paragraph text <img src="another_image.jpg" alt="Another caption" /> with more text</p>\n<p>And so on</p>';\n\n// Load the HTML into a DOMDocument\n$dom = new DOMDocument();\nlibxml_use_internal_errors(true); // Suppress warnings due to malformed HTML\n$dom->loadHTML($html, LIBXML_HTML_NOIMPLIED | LIBXML_HTML_NODEFDTD);\nlibxml_clear_errors();\n\n// Get all <img> tags\n$images = $dom->getElementsByTagName('img');\n\nforeach ($images as $img) {\n    // Create a new <div> element with class "caption"\n    $div = $dom->createElement('div');\n    $div->setAttribute('class', 'caption ' . $img->getAttribute('class'));\n\n    // Remove class, height, and width attributes from the <img> element\n    $img->removeAttribute('class');\n    $img->removeAttribute('height');\n    $img->removeAttribute('width');\n\n    // Modify the src attribute to use phpthumb\n    $src = $img->getAttribute('src');\n    $img->setAttribute('src', '/system/tools/phpthumb/phpThumb.php?src=' . $src . '&wl=200&hp=200&q=85&f=jpg');\n\n    // Create a new <p> element for the caption\n    $caption = $dom->createElement('p', $img->getAttribute('alt'));\n\n    // Wrap the <img> and <p> elements inside the <div>\n    $img->parentNode->replaceChild($div, $img);\n    $div->appendChild($img);\n    $div->appendChild($caption);\n}\n\n// Save the modified HTML\necho $dom->saveHTML();\n?>