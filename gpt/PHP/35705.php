<?php\n\n// Read POST data\n$raw_post_data = file_get_contents('php://input');\n$raw_post_array = explode('&', $raw_post_data);\n$myPost = array();\nforeach ($raw_post_array as $keyval) {\n  $keyval = explode('=', $keyval);\n  if (count($keyval) == 2) {\n    $myPost[$keyval[0]] = urldecode($keyval[1]);\n  }\n}\n\n// Read the IPN message sent from PayPal and prepend 'cmd=_notify-validate'\n$req = 'cmd=_notify-validate';\nforeach ($myPost as $key => $value) {\n  $value = urlencode($value);\n  $req .= "&$key=$value";\n}\n\n// Post IPN data back to PayPal to validate the IPN data is genuine\n$ch = curl_init('https://ipnpb.paypal.com/cgi-bin/webscr');\ncurl_setopt($ch, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_1);\ncurl_setopt($ch, CURLOPT_POST, 1);\ncurl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\ncurl_setopt($ch, CURLOPT_POSTFIELDS, $req);\ncurl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1);\ncurl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);\ncurl_setopt($ch, CURLOPT_FORBID_REUSE, 1);\ncurl_setopt($ch, CURLOPT_HTTPHEADER, array('Connection: Close'));\n$res = curl_exec($ch);\ncurl_close($ch);\n\n// Inspect IPN validation result and act accordingly\nif (strcmp($res, "VERIFIED") == 0) {\n  // The IPN is verified, process it\n  $payment_status = $_POST['payment_status'];\n  $custom_data = $_POST['custom'];\n  \n  if ($payment_status == "Completed") {\n    // Connect to your MySQL database\n    $mysqli = new mysqli("localhost", "username", "password", "database");\n\n    if ($mysqli->connect_error) {\n      die("Connection failed: " . $mysqli->connect_error);\n    }\n\n    // Insert the data into your database\n    $stmt = $mysqli->prepare("INSERT INTO your_table (custom_data) VALUES (?)");\n    $stmt->bind_param("s", $custom_data);\n    $stmt->execute();\n    $stmt->close();\n    $mysqli->close();\n  }\n} else if (strcmp($res, "INVALID") == 0) {\n  // The IPN is invalid, log for manual investigation\n  error_log("Invalid IPN: " . $req);\n}\n?>