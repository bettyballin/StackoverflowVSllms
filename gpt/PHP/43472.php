$results = get_data_from_db();\n$file_name = 'output.gz';\n$fp = gzopen($file_name, 'w');\nif ($fp) {\n    foreach ($results as $row) {\n        ob_start(); // Start output buffering\n        $out = fopen('php://output', 'w');\n        fputcsv($out, $row); // Write CSV to the buffer\n        fclose($out);\n        $csv_line = ob_get_clean(); // Get the CSV line from the buffer\n        gzwrite($fp, $csv_line); // Write the CSV line to the gzipped file\n    }\n    gzclose($fp);\n}