<?php\n\nfunction outputHeader() {\n    echo ",Current Milestone,Total Hours,Milestone 1 Hours,Milestone 2 Hours,Milestone 3 Hours\n";\n}\n\nfunction outputDepartment($dept, &$row) {\n    $deptStartRow = $row + 1;\n    echo $dept['name'] . "\n";\n    foreach ($dept['modules'] as $module) {\n        $row++;\n        echo generateModuleRow($module, $row);\n    }\n    $deptSSRange = "C" . $deptStartRow . ":C" . $row;\n    return $deptSSRange;\n}\n\nfunction generateModuleRow($module, $row) {\n    $sumFormula = "=SUM(D$row:F$row)";\n    return $module['name'] . ',' . $module['ms'] . ',' . $sumFormula . ',' . $module['m1'] . ',' . $module['m2'] . ',' . $module['m3'] . "\n";\n}\n\nfunction outputSumRow($deptSSRange) {\n    $sumStr = "=SUM($deptSSRange)";\n    echo 'Sum,,'.$sumStr.','.str_replace("C","D",$sumStr).','.str_replace("C","E",$sumStr).','.str_replace("C","F",$sumStr)."\n\n";\n}\n\nfunction outputTotalRow($totSSRange) {\n    $totSumStr = "\"=SUM($totSSRange)\"";\n    echo 'Total,,'.$totSumStr.','.str_replace("C","D",$totSumStr).','.str_replace("C","E",$totSumStr).','.str_replace("C","F",$totSumStr);\n}\n\n// Main code\n$row = 2;\n$totSSRange = "";\noutputHeader();\n\nforeach ($departments as $dept) {\n    $deptSSRange = outputDepartment($dept, $row);\n    $totSSRange .= $deptSSRange . ",";\n    outputSumRow($deptSSRange);\n    $row += 3;\n}\n\noutputTotalRow($totSSRange);\n?>