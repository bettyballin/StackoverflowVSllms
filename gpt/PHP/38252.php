<?php\n// Connect to MySQL and check if the repository exists, and if the user has access\n$mysqli = new mysqli("hostname", "username", "password", "database");\nif ($mysqli->connect_error) {\n    die("Connection failed: " . $mysqli->connect_error);\n}\n\n$repoName = $mysqli->real_escape_string($_POST['repo_name']);\n$userId = $mysqli->real_escape_string($_SESSION['user_id']);\n\n$query = "SELECT * FROM repositories WHERE name='$repoName' AND user_id='$userId'";\n$result = $mysqli->query($query);\n\nif ($result->num_rows > 0) {\n    // Fetch the repository path\n    $row = $result->fetch_assoc();\n    $repoPath = $row['path'];\n\n    // Prepare the CGI script content\n    $cgiScript = <<<CGI\n#!/usr/bin/env python3\nimport sys\nfrom mercurial import hgweb\n\nrepo_path = "$repoPath"\napplication = hgweb.hgweb(repo_path)\n\nif __name__ == "__main__":\n    from wsgiref.simple_server import make_server\n    httpd = make_server('', 8000, application)\n    print("Serving on port 8000...")\n    httpd.serve_forever()\nCGI;\n\n    // Execute the CGI script using proc_open\n    $descriptorspec = [\n        0 => ["pipe", "r"],  // stdin\n        1 => ["pipe", "w"],  // stdout\n        2 => ["pipe", "w"],  // stderr\n    ];\n\n    $process = proc_open('/usr/bin/env python3', $descriptorspec, $pipes);\n\n    if (is_resource($process)) {\n        fwrite($pipes[0], $cgiScript);\n        fclose($pipes[0]);\n\n        $output = stream_get_contents($pipes[1]);\n        fclose($pipes[1]);\n\n        $errors = stream_get_contents($pipes[2]);\n        fclose($pipes[2]);\n\n        $return_value = proc_close($process);\n\n        if ($return_value == 0) {\n            echo "CGI script executed successfully:\n";\n            echo $output;\n        } else {\n            echo "CGI script execution failed:\n";\n            echo $errors;\n        }\n    } else {\n        echo "Failed to execute CGI script.";\n    }\n} else {\n    echo "Repository not found or access denied.";\n}\n\n$mysqli->close();\n?>