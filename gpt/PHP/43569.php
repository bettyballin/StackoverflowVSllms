class MakeItLink {\n    protected function _link_www( $matches ) {\n        $url = $matches[2];\n        $url = MakeItLink::cleanURL( $url );\n        if( empty( $url ) ) {\n            return $matches[0];\n        }\n        return "{$matches[1]}<a href='{$url}'>{$url}</a>";\n    }\n\n    protected function _link_at_replies( $matches ) {\n        $username = $matches[1];\n        return "<a href='http://twitter.com/{$username}'>@{$username}</a>";\n    }\n\n    protected function _link_hashtags( $matches ) {\n        $hashtag = $matches[1];\n        return "<a href='http://search.twitter.com/search?q=%23{$hashtag}'>#{$hashtag}</a>";\n    }\n\n    public function cleanURL( $url ) {\n        if( $url == '' ) {\n            return $url;\n        }\n\n        $url = preg_replace( "|[^a-z0-9-~+_.?#=!&;,/:%@$*'()x80-xff]|i", '', $url );\n        $url = str_replace( array( "%0d", "%0a" ), '', $url );\n        $url = str_replace( ";//", "://", $url );\n\n        if(\n            strpos( $url, ":" ) === false\n            && substr( $url, 0, 1 ) != "/"\n            && !preg_match( "|^[a-z0-9-]+?.php|i", $url )\n        ) {\n            $url = "http://{$url}";\n        }\n\n        $url = preg_replace( "|&([^#])(?![a-z]{2,8};)|", "&#038;$1", $url );\n        $url = str_replace( "'", "&#039;", $url );\n\n        return $url;\n    }\n\n    public function transform( $text ) {\n        $text = " {$text}";\n\n        $text = preg_replace_callback(\n            '#(?<=[\s>])(\()?([\w]+?://(?:[\w\\x80-\\xff\#$%&~/\-=?@\[\](+]|[.,;:](?![\s<])|(?(1)\)(?![\s<])|\)))*)#is',\n            array( 'MakeItLink', '_link_www' ),\n            $text\n        );\n\n        $text = preg_replace_callback(\n            '/@(\w+)/',\n            array( 'MakeItLink', '_link_at_replies' ),\n            $text\n        );\n\n        $text = preg_replace_callback(\n            '/#(\w+)/',\n            array( 'MakeItLink', '_link_hashtags' ),\n            $text\n        );\n\n        $text = preg_replace( '#(<a( [^>]+?>|>))<a [^>]+?>([^>]+?)</a></a>#i', "$1$3</a>", $text );\n        $text = trim( $text );\n\n        return $text;\n    }\n}\n\n// Example usage\n$makeItLink = new MakeItLink();\n$tweet = "Check out http://example.com @user and #hashtag";\necho $makeItLink->transform($tweet);