<?php\n\nfunction processImage($imagePath, $crop = null, $size = null)\n{\n    // Load the image from file\n    $imageContent = file_get_contents($imagePath);\n    if ($imageContent === false) {\n        throw new Exception("Unable to load image.");\n    }\n    $image = ImageCreateFromString($imageContent);\n    if ($image === false) {\n        throw new Exception("Invalid image content.");\n    }\n\n    $origWidth = imagesx($image);\n    $origHeight = imagesy($image);\n\n    // Sanitize and validate crop input\n    if ($crop !== null) {\n        $crop = array_filter(explode(':', $crop));\n        if (count($crop) !== 2 || !is_numeric($crop[0]) || !is_numeric($crop[1])) {\n            throw new InvalidArgumentException("Invalid crop ratio.");\n        }\n    } else {\n        $crop = [$origWidth, $origHeight];\n    }\n\n    $cropRatio = $crop[0] / $crop[1];\n    $origRatio = $origWidth / $origHeight;\n\n    // Calculate cropping dimensions\n    if ($origRatio > $cropRatio) {\n        $newHeight = $origHeight;\n        $newWidth = $newHeight * $cropRatio;\n        $x = ($origWidth - $newWidth) / 2;\n        $y = 0;\n    } else {\n        $newWidth = $origWidth;\n        $newHeight = $newWidth / $cropRatio;\n        $x = 0;\n        $y = ($origHeight - $newHeight) / 2;\n    }\n\n    // Sanitize and validate size input\n    if ($size !== null) {\n        $size = array_filter(explode('x', $size));\n        if (count($size) !== 2 || !is_numeric($size[0]) || !is_numeric($size[1])) {\n            throw new InvalidArgumentException("Invalid size.");\n        }\n        $resizeWidth = (int)$size[0];\n        $resizeHeight = (int)$size[1];\n    } else {\n        $resizeWidth = $newWidth;\n        $resizeHeight = $newHeight;\n    }\n\n    // Create the destination image\n    $result = ImageCreateTrueColor($resizeWidth, $resizeHeight);\n    if ($result === false) {\n        throw new Exception("Unable to create destination image.");\n    }\n\n    // Preserve transparency for PNG and GIF images\n    if (imageistruecolor($image)) {\n        ImageSaveAlpha($result, true);\n        ImageAlphaBlending($result, false);\n        ImageFill($result, 0, 0, ImageColorAllocateAlpha($result, 255, 255, 255, 127));\n    } else {\n        imagecolortransparent($result, imagecolorallocate($result, 0, 0, 0));\n    }\n\n    // Perform the cropping and resizing in a single step\n    ImageCopyResampled($result, $image, 0, 0, $x, $y, $resizeWidth, $resizeHeight, $newWidth, $newHeight);\n\n    // Output the image as JPEG\n    header('Content-Type: image/jpeg');\n    ImageJPEG($result);\n\n    // Clean up\n    ImageDestroy($image);\n    ImageDestroy($result);\n}\n\n$imagePath = 'path/to/your/image.jpg';\n$crop = '4:3'; // Example crop ratio\n$size = '800x600'; // Example size\nprocessImage($imagePath, $crop, $size);\n?>