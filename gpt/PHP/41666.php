// Moodle: sso_login.php\nrequire_once('config.php');\n\n$token = $_GET['token'] ?? '';\nif ($token) {\n    $db = new mysqli($DB_HOST, $DB_USER, $DB_PASS, $DB_NAME);\n\n    // Clean up expired tokens\n    $db->query("DELETE FROM mdl_sso_tokens WHERE expiration < UNIX_TIMESTAMP()");\n\n    // Validate token\n    $stmt = $db->prepare("SELECT user_id FROM mdl_sso_tokens WHERE token = ? AND expiration >= UNIX_TIMESTAMP()");\n    $stmt->bind_param('s', $token);\n    $stmt->execute();\n    $stmt->bind_result($userId);\n    \n    if ($stmt->fetch()) {\n        // Log the user in\n        $USER = get_complete_user_data('id', $userId);\n        complete_user_login($USER);\n\n        // Redirect to Moodle dashboard\n        header('Location: 'index.php');\n        exit();\n    } else {\n        // Invalid or expired token\n        echo "Invalid or expired token.";\n    }\n    $stmt->close();\n    $db->close();\n} else {\n    echo "No token provided.";\n}