<?php\nclass User {\n    public function ValidReg() {\n        if (!empty($_POST['username']) && !empty($_POST['password']) && !empty($_POST['email']) && !empty($_POST['state'])) {\n            //valid ?\n            $valid = true;\n\n            $username = mysql_real_escape_string($_POST['username']);\n            $password = md5(mysql_real_escape_string($_POST['password']));\n            $email = mysql_real_escape_string($_POST['email']);\n            $firstname = mysql_real_escape_string($_POST['firstname']);\n            $lastname = mysql_real_escape_string($_POST['lastname']);\n            $state = mysql_real_escape_string($_POST['state']);\n\n            $checkusername = mysql_query("SELECT * FROM users WHERE Username = '".$username."'");\n\n            if (mysql_num_rows($checkusername) == 1) {\n                echo "<div id='shopperlogin1'><p>Sorry, that username is taken.<br /> Please go back and try again.</p></div>";\n            } else {\n                //test\n                $confirm_code = mysql_real_escape_string(md5(uniqid(rand())));\n\n                $sql = "INSERT INTO temp_users (\n                          confirm_code, Username, Password, \n                          EmailAddress, FirstName, LastName, State) \n                        VALUES (\n                          '$confirm_code', '$username', '$password', \n                          '$email', '$firstname', '$lastname', '$state')";\n                $result = mysql_query($sql) \n                    or die ("Query failed: " . mysql_error() . " Actual query: " . $sql);\n\n                // if successfully inserted data into database, send confirmation link to email\n                if ($result) {\n                    // send e-mail to ...\n                    $to = $email;\n\n                    // Your subject\n                    $subject = "Your confirmation link here";\n\n                    // From\n                    $header = "From: blahblah@blahbalh.com";\n\n                    // Your message\n                    $message = "Your Confirmation link \r\n";\n                    $message .= "Click on this link to activate your account \r\n";\n                    $message .= "http://www.employeediscounted.com/secret/login.php?passkey=$confirm_code";\n\n                    // send email\n                    $sentmail = mail($to, $subject, $message, $header);\n                }\n\n                // if your email successfully sent\n                if ($sentmail) {\n                    echo "<div id='emailmsg'>Your Confirmation link Has Been Sent To Your Email Address.</div>";\n                } else {\n                    echo "<div id='emailmsg'>Cannot send Confirmation link to your e-mail address.</div>";\n                }\n            }\n        } else {\n            $valid = false;\n        }\n        return $valid;\n    }\n}\n\n// Ensure only a single call to ValidReg\n$User = new User();\n$valid = $User->ValidReg();\nif ($valid === false) {\n    // Handle the error case\n}\n?>