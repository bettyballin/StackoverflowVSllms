<?php\nfunction idle($imap_stream) {\n    // Send the IDLE command\n    fwrite($imap_stream, "a001 IDLE\r\n");\n\n    // Read the server response\n    $response = fread($imap_stream, 8192);\n    if (strpos($response, '+ idling') === false) {\n        throw new Exception("Server did not respond with '+ idling'");\n    }\n\n    // Wait for a new message notification or timeout\n    $timeout = 60 * 5;  // 5 minutes timeout\n    $start_time = time();\n    stream_set_blocking($imap_stream, false);\n    while (time() - $start_time < $timeout) {\n        $read = [$imap_stream];\n        $write = $except = null;\n        if (stream_select($read, $write, $except, $timeout)) {\n            $response = fread($imap_stream, 8192);\n            if (strpos($response, "EXISTS") !== false) {\n                // New message detected\n                break;\n            }\n        } else {\n            // Timeout, exit IDLE mode\n            break;\n        }\n    }\n\n    // Exit IDLE mode\n    fwrite($imap_stream, "DONE\r\n");\n    fread($imap_stream, 8192);  // Read the server response\n}\n\n$hostname = '{imap.gmail.com:993/imap/ssl}INBOX';\n$username = 'your-email@gmail.com';\n$password = 'your-password';\n\n// Connect to the IMAP server\n$imap_stream = @imap_open($hostname, $username, $password);\nif (!$imap_stream) {\n    die('Failed to connect to IMAP server: ' . imap_last_error());\n}\n\n// Get the underlying stream\n$imap_socket = imap_socket($imap_stream);\n\n// Enter IDLE mode and wait for new messages\ntry {\n    while (true) {\n        idle($imap_socket);\n        echo "New message arrived!\n";\n    }\n} catch (Exception $e) {\n    echo 'Error: ' . $e->getMessage();\n}\n\n// Close the IMAP connection\nimap_close($imap_stream);\n?>