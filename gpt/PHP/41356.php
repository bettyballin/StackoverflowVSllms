class Booze_Plugin_AclPlugin extends Zend_Controller_Plugin_Abstract {\n\n    public function preDispatch(Zend_Controller_Request_Abstract $request) {\n        $auth = Booze_Permissions_Auth::getInstance();\n        $acl = Zend_Registry::get('acl');\n\n        if (!$auth->hasIdentity()) {\n            $role = Booze_Permissions_Roles::GUEST;\n        } else {\n            $role = $auth->getUser()->role;\n        }\n\n        $resource = $request->getControllerName();\n        $privilege = $request->getActionName();\n\n        if (!$acl->isAllowed($role, $resource, $privilege)) {\n            Booze_Log::log("ACLPlugin: Sent to login");\n\n            if ($request->isXmlHttpRequest()) {\n                $response = $this->getResponse();\n                $response->setHttpResponseCode(403); // Forbidden\n                $response->setBody(json_encode(array('error' => 'unauthorized', 'redirect' => '/login')));\n                $response->sendResponse();\n                exit;\n            } else {\n                $request->setControllerName('login');\n                $request->setActionName('index');\n                $request->setDispatched(false);\n            }\n        }\n    }\n}