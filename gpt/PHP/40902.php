<?php\n\nfunction remove_comments($code) {\n    // Remove single line comments (// and #)\n    $code = preg_replace('/\/\/.*|#.*|\/\*[^*]*\*+(?:[^/*][^*]*\*+)*\//', '', $code);\n    // Remove multi-line comments (/* ... */)\n    $code = preg_replace('/\/\*[\s\S]*?\*\//', '', $code);\n    // Remove empty lines\n    $code = preg_replace('/^\s*[\r\n]/m', '', $code);\n    return $code;\n}\n\n$php_code = <<<'CODE'\n<?PHP\n// something\nif ($whatsit) {\n    do_something(); # we do something here\n    echo '<html>Some embedded HTML</html>';\n}\n/* another long\ncomment\n*/\nsome_more_code();\n?>\nCODE;\n\n$clean_code = remove_comments($php_code);\necho $clean_code;\n?>