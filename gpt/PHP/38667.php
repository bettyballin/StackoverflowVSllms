// Define the bounding box\n$lat = $user->latitude;\n$lon = $user->longitude;\n$radius = $radius; // in miles\n\n// Radius of the Earth in miles\n$earth_radius = 3960.0;\n\n// Latitude boundaries\n$max_lat = $lat + rad2deg($radius / $earth_radius);\n$min_lat = $lat - rad2deg($radius / $earth_radius);\n\n// Longitude boundaries\n$max_lon = $lon + rad2deg($radius / $earth_radius / cos(deg2rad($lat)));\n$min_lon = $lon - rad2deg($radius / $earth_radius / cos(deg2rad($lat)));\n\n$query = "\nSELECT\n    name, city,\n    (3959 * acos(cos(radians($lat)) * cos(radians(latitude)) * cos(radians(longitude) - radians($lon)) + sin(radians($lat)) * sin(radians(latitude)))) AS distance\nFROM\n    users\nWHERE\n    latitude BETWEEN $min_lat AND $max_lat\n    AND longitude BETWEEN $min_lon AND $max_lon\nHAVING\n    distance < $radius\nORDER BY\n    distance ASC\n";\n\n$result = mysql_query($query);