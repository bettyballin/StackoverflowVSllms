function bbcode($text) {\n    $text = htmlspecialchars($text);\n    $text = nl2br($text);\n\n    $find = array(\n        "'\[b\](.*?)\[/b\]'is",\n        "'\[i\](.*?)\[/i\]'i",\n        "'\[url\](.*?)\[/url\]'i",\n        "'\b(http:\/\/|https:\/\/|www\.)[^\s<]+[^\s<\.)]'i"\n    );\n\n    $replace = array(\n        "<b>\\1</b>",\n        "<i>\\1</i>",\n        "<a href='\\1'>\\1</a>",\n        "<a href='http://\\0'>\\0</a>"\n    );\n\n    // Adjust the last replace pattern to handle http/https correctly\n    $text = preg_replace_callback("'\\b(http:\/\/|https:\/\/|www\.)[^\s<]+[^\s<\.)]'i", function($matches) {\n        $url = $matches[0];\n        $prefix = (stripos($url, 'http') === 0) ? '' : 'http://';\n        return "<a href='{$prefix}{$url}'>{$url}</a>";\n    }, $text);\n\n    $text = preg_replace($find, $replace, $text);\n\n    return $text;\n}