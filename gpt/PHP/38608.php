function getResizedBackgroundImageURL($afb = "", $params = "") {\n    // Remove webroot\n    $filename = C_Settings::getFileRoot() . str_replace(C_Settings::getWebRoot(), "", $afb);\n    $i = strrpos($filename, ".");\n    if ($i !== FALSE) {\n        $ext = substr($filename, $i);\n        $basefilename = substr($filename, 0, $i);\n\n        // Parse width/height params\n        parse_str($params, $paramsArray);\n        $w = isset($paramsArray['w']) && is_numeric($paramsArray['w']) ? $paramsArray['w'] : die("Missing param w for getResizedBackgroundImageURL");\n        $h = isset($paramsArray['h']) && is_numeric($paramsArray['h']) ? $paramsArray['h'] : die("Missing param h for getResizedBackgroundImageURL");\n\n        // Compose new filename\n        $newFilename = $basefilename . "_w" . $w . "_h" . $h . $ext;\n\n        // See if the resized image exists\n        if (!file_exists($newFilename)) {\n            if (is_file($filename)) {\n                switch ($ext) {\n                    case ".jpg":\n                    case ".jpeg":\n                        $image_org = imagecreatefromjpeg($filename);\n                        break;\n                    case ".gif":\n                        $image_org = @imagecreatefromgif($filename);\n                        break;\n                    default:\n                        $image_org = false;\n                }\n\n                if ($image_org) {\n                    list($wp, $hp) = getimagesize($filename);\n                    $hfactor = $hp / $h;\n                    $wfactor = $wp / $w;\n                    $factor = max($hfactor, $wfactor);\n\n                    $image_w = $wp / $factor;\n                    $image_h = $hp / $factor;\n\n                    // Create true color image\n                    $img_copy = imagecreatetruecolor($image_w, $image_h);\n                    imagecopyresampled($img_copy, $image_org, 0, 0, 0, 0, $image_w, $image_h, $wp, $hp);\n\n                    if (@imagejpeg($img_copy, $newFilename, 80)) {\n                        chmod($newFilename, 0777);\n                    } else {\n                        echo("<b>Error: </b>Unable to create image $newFilename. Check directory permissions.");\n                    }\n\n                    // Free memory\n                    imagedestroy($image_org);\n                    imagedestroy($img_copy);\n                }\n            }\n        }\n        $newURL = C_Settings::getWebRoot() . str_replace(C_Settings::getFileRoot(), "", $newFilename);\n        return $newURL;\n    }\n}