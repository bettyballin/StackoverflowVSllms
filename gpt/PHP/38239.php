<?php\n// Read POST data\n$raw_post_data = file_get_contents('php://input');\n$raw_post_array = explode('&', $raw_post_data);\n$myPost = [];\nforeach ($raw_post_array as $keyval) {\n    $keyval = explode('=', $keyval);\n    if (count($keyval) == 2) {\n        $myPost[$keyval[0]] = urldecode($keyval[1]);\n    }\n}\n\n// Build the request string\n$req = 'cmd=_notify-validate';\nforeach ($myPost as $key => $value) {\n    $value = urlencode($value);\n    $req .= "&$key=$value";\n}\n\n// Post IPN data back to PayPal to validate\n$ch = curl_init('https://ipnpb.paypal.com/cgi-bin/webscr');\ncurl_setopt($ch, CURLOPT_HTTP_VERSION, CURL_HTTP_VERSION_1_1);\ncurl_setopt($ch, CURLOPT_POST, 1);\ncurl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\ncurl_setopt($ch, CURLOPT_POSTFIELDS, $req);\ncurl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 1);\ncurl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);\ncurl_setopt($ch, CURLOPT_FORBID_REUSE, 1);\ncurl_setopt($ch, CURLOPT_HTTPHEADER, ['Connection: Close']);\n\n$res = curl_exec($ch);\nif (!$res) {\n    // HTTP error\n    error_log("Got " . curl_error($ch) . " when validating IPN data");\n    curl_close($ch);\n    exit;\n}\n\ncurl_close($ch);\n\nif (strcmp($res, "VERIFIED") == 0) {\n    // The IPN is verified, process it\n    // Your code to process the IPN data\n} else if (strcmp($res, "INVALID") == 0) {\n    // IPN invalid, log for manual investigation\n    error_log("Invalid IPN: $req");\n}\n?>