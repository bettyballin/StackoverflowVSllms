<?php\n// Ensure this runs within the loop\nif (have_posts()) : while (have_posts()) : the_post(); ?>\n\n    <!-- Your current post content here -->\n\n    <h3>Related Posts</h3>\n    <ul>\n    <?php\n    $current_post_id = get_the_ID();\n    $categories = get_the_category();\n    if ($categories) {\n        $category_ids = array();\n        foreach ($categories as $category) {\n            $category_ids[] = $category->term_id;\n        }\n\n        $related_posts_query = new WP_Query(array(\n            'category__in' => $category_ids,\n            'post__not_in' => array($current_post_id),\n            'posts_per_page' => 5,\n            'ignore_sticky_posts' => 1\n        ));\n\n        if ($related_posts_query->have_posts()) {\n            while ($related_posts_query->have_posts()) {\n                $related_posts_query->the_post();\n                ?>\n                <li><a href="<?php the_permalink(); ?>"><?php the_title(); ?></a></li>\n                <?php\n            }\n        } else {\n            echo '<li>No related posts found</li>';\n        }\n        wp_reset_postdata();\n    }\n    ?>\n    </ul>\n\n<?php endwhile; endif; ?>