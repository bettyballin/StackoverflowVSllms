// src/Controller/ReferralsController.php\nnamespace App\Controller;\n\nuse App\Controller\AppController;\n\nclass ReferralsController extends AppController\n{\n    public function add()\n    {\n        $referral = $this->Referrals->newEmptyEntity();\n\n        if ($this->request->is('post')) {\n            $data = $this->request->getData();\n            $friendsData = [];\n\n            // Extract friends data\n            for ($i = 1; $i <= 10; $i++) {\n                if (!empty($data["friendName-$i"]) && !empty($data["friendEmail-$i"])) {\n                    $friendsData[] = [\n                        'friendName' => $data["friendName-$i"],\n                        'friendEmail' => $data["friendEmail-$i"]\n                    ];\n                }\n            }\n\n            $data['friends'] = $friendsData;\n            $referral = $this->Referrals->patchEntity($referral, $data, ['associated' => ['Friends']]);\n\n            if ($this->Referrals->save($referral)) {\n                $this->Flash->success(__('Referral and friends have been saved.'));\n\n                return $this->redirect(['action' => 'index']);\n            }\n            $this->Flash->error(__('Unable to save the referral.'));\n        }\n\n        $this->set(compact('referral'));\n    }\n}