<?php\n\nset_time_limit(120);\nini_set('max_input_time', 120);\n\n$allowed = ['jpg', 'jpeg', 'png', 'gif']; // Define allowed extensions\n$uploadDir = 'uploads/'; // Define your upload directory\n$lastInsert = 1; // Example value, replace with actual value\n\nfunction reSizePic($image) {\n    try {\n        $resource = NewMagickWand(); \n        if (!MagickReadImage($resource, $image)) {\n            throw new Exception('Failed to read image');\n        }\n        MagickSetImageCompressionQuality($resource, 100);\n        $resource = MagickTransformImage($resource, '0x0', '660x500');\n        if (!MagickWriteImage($resource, $image)) {\n            throw new Exception('Failed to write image');\n        }\n        DestroyMagickWand($resource);\n    } catch (Exception $e) {\n        error_log('Error in reSizePic: ' . $e->getMessage());\n    }\n}\n\n$numberImages = count($_FILES['galFile']['name']) - 1;\n\nfor ($i = 1; $i <= $numberImages; $i++) {\n    $imageName = $_FILES['galFile']['name'][$i];\n    $imageType = $_FILES['galFile']['type'][$i];\n    $imageSize = $_FILES['galFile']['size'][$i];\n    $imageTemp = $_FILES['galFile']['tmp_name'][$i];\n    $imageError = $_FILES['galFile']['error'][$i];\n\n    // Make sure it is an image\n    $ext = pathinfo($imageName, PATHINFO_EXTENSION);\n    if (in_array($ext, $allowed)) {\n        // Where to upload image to\n        $uploadFile = $uploadDir . $imageName;\n        if (file_exists($uploadFile)) {\n            // What to do if file already exists\n            // Append random number to the end\n            $front = explode(".", $imageName);\n            $randomNum = rand(1, 100);\n            $front[0] = $front[0] . $randomNum;\n            $imageName = implode(".", $front);\n            $uploadFile = $uploadDir . $imageName;\n        }\n        if (move_uploaded_file($imageTemp, $uploadFile)) {\n            // Add $imageName to DB\n            $query = "INSERT INTO galleryImages VALUES (0, '$lastInsert', '$imageName', '$i')";\n            if (!mysql_query($query)) {\n                error_log('Error inserting into database: ' . mysql_error());\n            } else {\n                reSizePic($uploadFile);\n            }\n        } else {\n            error_log('Failed to move uploaded file: ' . $imageTemp);\n        }\n    } else {\n        error_log('Invalid file type: ' . $imageName);\n    }\n}\n\n?>