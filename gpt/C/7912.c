#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <pthread.h>\n#include <unistd.h>\n\n#define BUFFER_SIZE 1024\n\ntypedef struct {\n    char data[BUFFER_SIZE];\n    int start;\n    int end;\n    pthread_mutex_t mutex;\n    pthread_cond_t cond;\n} circular_buffer;\n\ncircular_buffer stdout_buffer;\nint stdout_pipe[2];\n\nvoid init_buffer(circular_buffer *buffer) {\n    buffer->start = 0;\n    buffer->end = 0;\n    pthread_mutex_init(&buffer->mutex, NULL);\n    pthread_cond_init(&buffer->cond, NULL);\n}\n\nvoid write_buffer(circular_buffer *buffer, const char *data, size_t len) {\n    pthread_mutex_lock(&buffer->mutex);\n    for (size_t i = 0; i < len; ++i) {\n        buffer->data[buffer->end] = data[i];\n        buffer->end = (buffer->end + 1) % BUFFER_SIZE;\n        if (buffer->end == buffer->start) {\n            buffer->start = (buffer->start + 1) % BUFFER_SIZE;  // Overwrite oldest data\n        }\n    }\n    pthread_cond_signal(&buffer->cond);\n    pthread_mutex_unlock(&buffer->mutex);\n}\n\nvoid *writer_thread(void *arg) {\n    char buffer[BUFFER_SIZE];\n    while (1) {\n        pthread_mutex_lock(&stdout_buffer.mutex);\n        while (stdout_buffer.start == stdout_buffer.end) {\n            pthread_cond_wait(&stdout_buffer.cond, &stdout_buffer.mutex);\n        }\n        size_t len = 0;\n        while (stdout_buffer.start != stdout_buffer.end && len < BUFFER_SIZE) {\n            buffer[len++] = stdout_buffer.data[stdout_buffer.start];\n            stdout_buffer.start = (stdout_buffer.start + 1) % BUFFER_SIZE;\n        }\n        pthread_mutex_unlock(&stdout_buffer.mutex);\n        if (len > 0) {\n            write(STDOUT_FILENO, buffer, len);\n        }\n    }\n    return NULL;\n}\n\nvoid setup_stdout_buffer() {\n    init_buffer(&stdout_buffer);\n    pipe(stdout_pipe);\n    dup2(stdout_pipe[1], STDOUT_FILENO);\n    close(stdout_pipe[1]);\n    pthread_t thread;\n    pthread_create(&thread, NULL, writer_thread, NULL);\n}\n\nssize_t custom_write(int fd, const void *buf, size_t count) {\n    if (fd == STDOUT_FILENO) {\n        write_buffer(&stdout_buffer, buf, count);\n        return count;\n    }\n    return write(fd, buf, count);\n}\n\nint main() {\n    setup_stdout_buffer();\n\n    // Redirect printf to use custom write\n    printf("Hello, world!\n");\n    fprintf(stdout, "This goes to stdout\n");\n\n    // Simulate work\n    sleep(1);\n\n    return 0;\n}