#include <openssl/dh.h>\n#include <openssl/engine.h>\n#include <openssl/err.h>\n\nvoid generate_dh_key_pair(DH **dh, unsigned char **pub_key, int *pub_key_len) {\n    *dh = DH_new();\n    DH_generate_parameters_ex(*dh, 2048, DH_GENERATOR_2, NULL);\n    DH_generate_key(*dh);\n\n    const BIGNUM *pub_key_bn = DH_get0_pub_key(*dh);\n    *pub_key_len = BN_num_bytes(pub_key_bn);\n    *pub_key = (unsigned char *)malloc(*pub_key_len);\n    BN_bn2bin(pub_key_bn, *pub_key);\n}\n\nvoid compute_shared_secret(DH *dh, const unsigned char *peer_pub_key, int peer_pub_key_len, unsigned char **secret, int *secret_len) {\n    BIGNUM *peer_pub_key_bn = BN_bin2bn(peer_pub_key, peer_pub_key_len, NULL);\n    *secret_len = DH_size(dh);\n    *secret = (unsigned char *)malloc(*secret_len);\n    *secret_len = DH_compute_key(*secret, peer_pub_key_bn, dh);\n    BN_free(peer_pub_key_bn);\n}\n\nint main() {\n    // Generate DH key pairs for both client and server\n    DH *dh_client, *dh_server;\n    unsigned char *client_pub_key, *server_pub_key;\n    int client_pub_key_len, server_pub_key_len;\n\n    generate_dh_key_pair(&dh_client, &client_pub_key, &client_pub_key_len);\n    generate_dh_key_pair(&dh_server, &server_pub_key, &server_pub_key_len);\n\n    // Compute shared secrets\n    unsigned char *client_secret, *server_secret;\n    int client_secret_len, server_secret_len;\n\n    compute_shared_secret(dh_client, server_pub_key, server_pub_key_len, &client_secret, &client_secret_len);\n    compute_shared_secret(dh_server, client_pub_key, client_pub_key_len, &server_secret, &server_secret_len);\n\n    // Ensure both secrets are identical\n    if (client_secret_len == server_secret_len && memcmp(client_secret, server_secret, client_secret_len) == 0) {\n        printf("DHKE successful and secrets match\n");\n    } else {\n        printf("DHKE failed or secrets do not match\n");\n    }\n\n    // Free resources\n    DH_free(dh_client);\n    DH_free(dh_server);\n    free(client_pub_key);\n    free(server_pub_key);\n    free(client_secret);\n    free(server_secret);\n\n    return 0;\n}