from django.db.models import Subquery, OuterRef, Max\nfrom django.db.models.functions import Coalesce\n\n# Assuming your models look like this:\nclass Role(models.Model):\n    name = models.CharField(max_length=255)\n    weight = models.IntegerField()\n\nclass Person(models.Model):\n    name = models.CharField(max_length=255)\n    roles = models.ManyToManyField(Role)\n\n# Subquery to find the heaviest role's weight for each person\nheaviest_role_weight = Role.objects.filter(\n    person__id=OuterRef('id')\n).order_by(\n    '-weight'\n).values('weight')[:1]\n\n# Coalesce is used to ensure that if there are no roles, the weight defaults to 0\npeople = Person.objects.annotate(\n    max_role_weight=Coalesce(Subquery(heaviest_role_weight), 0)\n).order_by('-max_role_weight')