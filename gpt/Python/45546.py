from genshi.builder import tag\n\nfrom trac.core import implements, Component\nfrom trac.ticket.api import ITicketManipulator\nfrom trac.ticket.default_workflow import ConfigurableTicketWorkflow\nfrom trac.perm import IPermissionRequestor\nfrom trac.config import Option, ListOption\nimport re\n\nrevision = "$Rev$"\nurl = "$URL$"\n\nclass CloseActionController(Component):\n    """Support for close checking.\n\n    If a ticket is closed, it is NOT allowed if ALL the following conditions apply: \n     a) ticket is 'bug' ticket\n     b) resolution status is 'fixed'\n     c) none of the ticket's changes include a comment containing a changeset, i.e. regex "\[\d+\]"\n     d) the ticket does not have the keyword 'web'\n    """\n\n    implements(ITicketManipulator)\n\n    # ITicketManipulator methods\n\n    def prepare_ticket(self, req, ticket, fields, actions):\n        """Not currently called, but should be provided for future\n        compatibility."""\n        return\n\n\n    def has_no_changeset(self, ticket):\n        db = self.env.get_db_cnx()\n        cursor = db.cursor()\n\n        cursor.execute("SELECT newvalue FROM ticket_change WHERE ticket=%s AND field='comment'", (str(ticket.id).encode('ascii', 'replace'),))\n\n        for newvalue, in cursor:\n            if re.search("\[\d{5,}\]", newvalue):\n                return False\n\n        return True\n\n    def validate_ticket(self, req, ticket):\n        """Validate a ticket after it's been populated from user input.\n\n        Must return a list of `(field, message)` tuples, one for each problem\n        detected. `field` can be `None` to indicate an overall problem with the\n\n        ticket. Therefore, a return value of `[]` means everything is OK."""\n\n        if ticket['type'] == 'bug' and ticket['resolution'] == 'fixed':\n            if ticket['keywords'] == None or ticket['keywords'].find('web') == -1:\n                if self.has_no_changeset(ticket):\n                    return [(None, 'You can only close a bug ticket as "fixed" if you refer to a changeset somewhere within the ticket, e.g. with [12345]!')]\n\n        return []