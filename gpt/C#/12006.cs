public class NHibernateSessionModule : IHttpModule\n   {\n       private static readonly string NHibernateSessionKey = "NHibernateSession";\n\n       public void Init(HttpApplication context)\n       {\n           context.BeginRequest += (sender, e) => \n           {\n               var session = NHibernateSession.OpenSession();\n               HttpContext.Current.Items[NHibernateSessionKey] = session;\n               session.BeginTransaction();\n           };\n\n           context.EndRequest += (sender, e) =>\n           {\n               var session = HttpContext.Current.Items[NHibernateSessionKey] as ISession;\n               if (session != null)\n               {\n                   try\n                   {\n                       session.Transaction.Commit();\n                   }\n                   catch\n                   {\n                       session.Transaction.Rollback();\n                       throw;\n                   }\n                   finally\n                   {\n                       session.Dispose();\n                   }\n               }\n           };\n       }\n\n       public void Dispose() { }\n   }