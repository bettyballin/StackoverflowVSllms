using System;\nusing System.IdentityModel.Selectors;\nusing System.ServiceModel;\nusing System.ServiceModel.Channels;\nusing System.ServiceModel.Dispatcher;\nusing System.ServiceModel.Web;\nusing System.Web.Security;\n\npublic class BasicAuthenticationAttribute : Attribute, IDispatchMessageInspector, IServiceBehavior\n{\n    private bool ValidateUser(string username, string password)\n    {\n        return Membership.ValidateUser(username, password);\n    }\n\n    public object AfterReceiveRequest(ref Message request, IClientChannel channel, InstanceContext instanceContext)\n    {\n        var httpRequest = (HttpRequestMessageProperty)request.Properties[HttpRequestMessageProperty.Name];\n        var authHeader = httpRequest.Headers["Authorization"];\n\n        if (authHeader != null && authHeader.StartsWith("Basic"))\n        {\n            var encodedCredentials = authHeader.Substring(6);\n            var credentialBytes = Convert.FromBase64String(encodedCredentials);\n            var credentials = System.Text.Encoding.ASCII.GetString(credentialBytes).Split(':');\n            var username = credentials[0];\n            var password = credentials[1];\n\n            if (ValidateUser(username, password))\n            {\n                return null;\n            }\n        }\n\n        ThrowUnauthorizedException();\n        return null;\n    }\n\n    private void ThrowUnauthorizedException()\n    {\n        var fault = new FaultReason("Invalid credentials");\n        throw new WebFaultException<FaultReason>(fault, System.Net.HttpStatusCode.Unauthorized);\n    }\n\n    public void BeforeSendReply(ref Message reply, object correlationState) { }\n\n    public void AddBindingParameters(ServiceDescription serviceDescription, ServiceHostBase serviceHostBase, Collection<ServiceEndpoint> endpoints, BindingParameterCollection bindingParameters) { }\n\n    public void ApplyDispatchBehavior(ServiceDescription serviceDescription, ServiceHostBase serviceHostBase)\n    {\n        foreach (ChannelDispatcher channelDispatcher in serviceHostBase.ChannelDispatchers)\n        {\n            foreach (EndpointDispatcher endpointDispatcher in channelDispatcher.Endpoints)\n            {\n                endpointDispatcher.DispatchRuntime.MessageInspectors.Add(this);\n            }\n        }\n    }\n\n    public void Validate(ServiceDescription serviceDescription, ServiceHostBase serviceHostBase) { }\n}