using (var session = sessionFactory.OpenSession())\n{\n    using (var transaction = session.BeginTransaction())\n    {\n        try\n        {\n            // Lock the table or row for the duration of the transaction\n            var booking = session.QueryOver<Booking>()\n                                 .Where(b => b.BookingStart < desiredEndDate && b.BookingEnd > desiredStartDate)\n                                 .Take(1)\n                                 .ForUpdate() // Pessimistic lock\n                                 .SingleOrDefault();\n\n            if (booking == null)\n            {\n                // No conflicting booking found, proceed with creating a new booking\n                var newBooking = new Booking\n                {\n                    BookingStart = desiredStartDate,\n                    BookingEnd = desiredEndDate\n                };\n                session.Save(newBooking);\n            }\n            else\n            {\n                // Handle conflicting booking\n                throw new InvalidOperationException("Booking conflict detected.");\n            }\n\n            transaction.Commit();\n        }\n        catch (Exception ex)\n        {\n            transaction.Rollback();\n            // Handle exception\n            throw;\n        }\n    }\n}