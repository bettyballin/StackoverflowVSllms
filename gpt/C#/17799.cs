public class ImageUploadHandler\n{\n    public void UploadImage(HttpPostedFile file, int userId)\n    {\n        // Validate file type and size\n        if (!IsValidImage(file))\n        {\n            throw new InvalidOperationException("Invalid image file.");\n        }\n\n        // Generate a unique filename\n        string uniqueFileName = GenerateUniqueFileName(file.FileName);\n\n        // Determine user-specific directory\n        string userDirectory = Path.Combine("Images", userId.ToString());\n        if (!Directory.Exists(userDirectory))\n        {\n            Directory.CreateDirectory(userDirectory);\n        }\n\n        // Save the file to the filesystem\n        string filePath = Path.Combine(userDirectory, uniqueFileName);\n        file.SaveAs(filePath);\n\n        // Save metadata to the database\n        SaveImageMetadataToDatabase(userId, uniqueFileName, filePath);\n    }\n\n    private bool IsValidImage(HttpPostedFile file)\n    {\n        // Implement file type and size validation\n        string[] allowedExtensions = { ".jpg", ".jpeg", ".png", ".gif" };\n        string fileExtension = Path.GetExtension(file.FileName).ToLower();\n        return allowedExtensions.Contains(fileExtension) && file.ContentLength <= 10485760; // 10 MB limit\n    }\n\n    private string GenerateUniqueFileName(string originalFileName)\n    {\n        string extension = Path.GetExtension(originalFileName);\n        return Guid.NewGuid().ToString() + extension;\n    }\n\n    private void SaveImageMetadataToDatabase(int userId, string fileName, string filePath)\n    {\n        // Implement database logic to save metadata\n        using (var connection = new SqlConnection("YourConnectionString"))\n        {\n            string query = "INSERT INTO Images (UserId, FileName, FilePath, UploadDate) VALUES (@UserId, @FileName, @FilePath, @UploadDate)";\n            using (var command = new SqlCommand(query, connection))\n            {\n                command.Parameters.AddWithValue("@UserId", userId);\n                command.Parameters.AddWithValue("@FileName", fileName);\n                command.Parameters.AddWithValue("@FilePath", filePath);\n                command.Parameters.AddWithValue("@UploadDate", DateTime.Now);\n\n                connection.Open();\n                command.ExecuteNonQuery();\n            }\n        }\n    }\n}