using System;\nusing System.IO;\nusing System.Security.AccessControl;\n\npublic static void SetPermissions(string dir)\n{\n    DirectoryInfo info = new DirectoryInfo(dir);\n    DirectorySecurity ds = info.GetAccessControl();\n    \n    ds.AddAccessRule(new FileSystemAccessRule(@"BUILTIN\Users",\n                         FileSystemRights.FullControl,\n                         InheritanceFlags.ContainerInherit | InheritanceFlags.ObjectInherit,\n                         PropagationFlags.InheritOnly,\n                         AccessControlType.Allow));\n    \n    info.SetAccessControl(ds);\n\n    // Apply the permissions recursively to all subdirectories and files\n    foreach (var subDir in info.GetDirectories("*", SearchOption.AllDirectories))\n    {\n        DirectorySecurity subDirSecurity = subDir.GetAccessControl();\n        subDirSecurity.AddAccessRule(new FileSystemAccessRule(@"BUILTIN\Users",\n                             FileSystemRights.FullControl,\n                             InheritanceFlags.ContainerInherit | InheritanceFlags.ObjectInherit,\n                             PropagationFlags.InheritOnly,\n                             AccessControlType.Allow));\n        subDir.SetAccessControl(subDirSecurity);\n    }\n\n    foreach (var file in info.GetFiles("*", SearchOption.AllDirectories))\n    {\n        FileSecurity fileSecurity = file.GetAccessControl();\n        fileSecurity.AddAccessRule(new FileSystemAccessRule(@"BUILTIN\Users",\n                             FileSystemRights.FullControl,\n                             InheritanceFlags.None,\n                             PropagationFlags.None,\n                             AccessControlType.Allow));\n        file.SetAccessControl(fileSecurity);\n    }\n}