public class XslStylesheetMessageInspector : IDispatchMessageInspector\n{\n    private readonly string _stylesheetHref;\n\n    public XslStylesheetMessageInspector(string stylesheetHref)\n    {\n        _stylesheetHref = stylesheetHref;\n    }\n\n    public object AfterReceiveRequest(ref Message request, IClientChannel channel, InstanceContext instanceContext)\n    {\n        return null;\n    }\n\n    public void BeforeSendReply(ref Message reply, object correlationState)\n    {\n        if (reply.IsFault)\n        {\n            return;\n        }\n\n        var buffer = reply.CreateBufferedCopy(int.MaxValue);\n        var document = new XmlDocument();\n        using (var stream = buffer.CreateMessage().GetReaderAtBodyContents().ReadSubtree())\n        {\n            document.Load(stream);\n        }\n\n        var pi = document.CreateProcessingInstruction("xml-stylesheet", $"type=\"text/xsl\" href=\"{_stylesheetHref}\"");\n        document.InsertBefore(pi, document.DocumentElement);\n\n        var ms = new MemoryStream();\n        using (var writer = XmlWriter.Create(ms))\n        {\n            document.WriteTo(writer);\n            writer.Flush();\n            ms.Position = 0;\n            var reader = XmlReader.Create(ms);\n            var newMessage = Message.CreateMessage(reader, int.MaxValue, reply.Version);\n            newMessage.Properties.CopyProperties(reply.Properties);\n            reply = newMessage;\n        }\n    }\n}