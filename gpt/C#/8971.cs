using System.Web.Hosting;\n\npublic void Persist(Message message)\n{\n    foreach (var recipient in message.Recipients) // recipient is a string\n    {\n        XElement xml_messages;\n        string path;\n        try\n        {\n            path = HostingEnvironment.MapPath("~/"+recipient+FileExtension);\n            // FileExtension=".xml"\n        }\n        catch (Exception e)\n        {\n            throw new Exception("Trying to get path " + e.Message);\n        }\n        try\n        {\n            xml_messages = XElement.Load(path);\n        }\n        catch\n        {\n            xml_messages = XElement.Parse("<nothing/>");\n        }\n        var element = (XElement) message;\n        if (xml_messages.IsEmpty)\n        {\n            xml_messages =\n                new XElement("messages",\n                             new XAttribute("recipient", recipient),\n                             element\n                    );  \n        }\n        else\n        {\n            xml_messages.Add(element);\n        }\n        xml_messages.Save(path);\n    }\n}