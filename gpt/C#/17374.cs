public string GetClientIpAddress(HttpRequest request)\n{\n    string ipAddress = request.Headers["X-Forwarded-For"];\n    if (!string.IsNullOrEmpty(ipAddress))\n    {\n        // The X-Forwarded-For header can contain a comma-separated list of IP addresses,\n        // the first one is the client's IP address.\n        string[] addresses = ipAddress.Split(',');\n        if (addresses.Length != 0)\n        {\n            return addresses[0];\n        }\n    }\n\n    ipAddress = request.Headers["X-Real-IP"];\n    if (!string.IsNullOrEmpty(ipAddress))\n    {\n        return ipAddress;\n    }\n\n    return request.UserHostAddress;\n}