using System;\nusing System.Web;\nusing System.Web.UI;\nusing System.Web.UI.WebControls;\n\nnamespace TestControls\n{\n    public class TestControl : WebControl\n    {\n        int _clickCount;\n        bool _mustUpdate;\n\n        protected override void LoadViewState(object savedState)\n        {\n            base.LoadViewState(savedState);\n\n            // Use session storage to persist the state\n            if (HttpContext.Current.Session["clickCount"] != null)\n            {\n                _clickCount = (int)HttpContext.Current.Session["clickCount"];\n            }\n\n            if (HttpContext.Current.Session["mustUpdate"] != null)\n            {\n                _mustUpdate = (bool)HttpContext.Current.Session["mustUpdate"];\n            }\n        }\n\n        protected override void OnLoad(EventArgs e)\n        {\n            base.OnLoad(e);\n\n            Controls.Clear();\n            ControlCreator();\n        }\n\n        private void ControlCreator()\n        {\n            Label tempLabel = new Label();\n            LiteralControl tempLiteral = new LiteralControl("<br/><br/>");\n            LinkButton tempLink = new LinkButton();\n\n            tempLink.ID = "testLink";\n            tempLink.Text = "Click me!";\n            tempLink.Click += new EventHandler(tempLink_Click);\n\n            tempLabel.ID = "testLabel";\n            tempLabel.Text = _clickCount.ToString();\n\n            Controls.Add(tempLabel);\n            Controls.Add(tempLiteral);\n            Controls.Add(tempLink);\n        }\n\n        void tempLink_Click(object sender, EventArgs e)\n        {\n            _clickCount++;\n            _mustUpdate = true;\n        }\n\n        protected override void OnPreRender(EventArgs e)\n        {\n            base.OnPreRender(e);\n\n            if (_mustUpdate)\n            {\n                Controls.Clear();\n                ControlCreator();\n\n                _mustUpdate = false;\n            }\n        }\n\n        protected override object SaveViewState()\n        {\n            // Store state in session storage\n            HttpContext.Current.Session["clickCount"] = _clickCount;\n            HttpContext.Current.Session["mustUpdate"] = _mustUpdate;\n\n            return base.SaveViewState();\n        }\n    }\n}