<%@ WebHandler Language="C#" Class="FileHandler" %>\n\n   using System;\n   using System.Data.SqlClient;\n   using System.Web;\n\n   public class FileHandler : IHttpHandler\n   {\n       public void ProcessRequest(HttpContext context)\n       {\n           if (context.Session["LoggedIn"] == null || !(bool)context.Session["LoggedIn"])\n           {\n               context.Response.StatusCode = 401; // Unauthorized\n               return;\n           }\n\n           string fileId = context.Request.QueryString["fileId"];\n           if (string.IsNullOrEmpty(fileId))\n           {\n               context.Response.StatusCode = 400; // Bad Request\n               return;\n           }\n\n           byte[] fileData;\n           string fileName;\n           string contentType;\n\n           using (SqlConnection conn = new SqlConnection("YourConnectionStringHere"))\n           {\n               conn.Open();\n               using (SqlCommand cmd = new SqlCommand("SELECT FileName, ContentType, FileData FROM Files WHERE FileId = @FileId", conn))\n               {\n                   cmd.Parameters.AddWithValue("@FileId", fileId);\n                   using (SqlDataReader reader = cmd.ExecuteReader())\n                   {\n                       if (reader.Read())\n                       {\n                           fileName = reader["FileName"].ToString();\n                           contentType = reader["ContentType"].ToString();\n                           fileData = (byte[])reader["FileData"];\n                       }\n                       else\n                       {\n                           context.Response.StatusCode = 404; // Not Found\n                           return;\n                       }\n                   }\n               }\n           }\n\n           context.Response.ContentType = contentType;\n           context.Response.AddHeader("Content-Disposition", "attachment; filename=" + fileName);\n           context.Response.BinaryWrite(fileData);\n           context.Response.End();\n       }\n\n       public bool IsReusable\n       {\n           get { return false; }\n       }\n   }