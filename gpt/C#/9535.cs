using System;\nusing System.IO;\nusing System.ServiceProcess;\nusing System.Threading;\n\npublic class ServiceManager\n{\n    private const int RetryCount = 10;\n    private const int DelayBetweenRetriesMilliseconds = 500;\n\n    public void StopServiceAndPerformAction(string serviceName, Action action)\n    {\n        ServiceController serviceController = new ServiceController(serviceName);\n\n        try\n        {\n            serviceController.Stop();\n            serviceController.WaitForStatus(ServiceControllerStatus.Stopped);\n\n            if (WaitForFileRelease("path/to/your/sqlfile"))\n            {\n                action();\n            }\n            else\n            {\n                throw new Exception("The service did not release the file within the expected time.");\n            }\n        }\n        catch (Exception ex)\n        {\n            // Handle the exception as needed\n            throw new ApplicationException("An error occurred while stopping the service and performing the action.", ex);\n        }\n    }\n\n    private bool WaitForFileRelease(string filePath)\n    {\n        for (int i = 0; i < RetryCount; i++)\n        {\n            try\n            {\n                using (FileStream fs = File.Open(filePath, FileMode.Open, FileAccess.Read, FileShare.None))\n                {\n                    return true;\n                }\n            }\n            catch (IOException)\n            {\n                Thread.Sleep(DelayBetweenRetriesMilliseconds);\n            }\n        }\n\n        return false;\n    }\n}