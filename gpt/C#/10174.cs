internal static DependencyObject GetVisualRoot(DependencyObject d)\n{ \n    DependencyObject root = d; \n    for (;;)\n    { \n        FrameworkElement element = root as FrameworkElement;\n        if (element == null)\n        { \n            break;\n        }\n\n        DependencyObject parent = element.Parent as DependencyObject; \n        if (parent == null)\n        { \n            break;\n        }\n\n        root = parent;\n    }\n    return root; \n}