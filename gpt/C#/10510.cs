using System;\nusing System.Data;\nusing System.Data.SqlClient;\nusing System.Text.RegularExpressions;\n\npublic void ExecuteScriptWithTransaction(string connectionString, string script)\n{\n    using (SqlConnection connection = new SqlConnection(connectionString))\n    {\n        connection.Open();\n        using (SqlTransaction transaction = connection.BeginTransaction())\n        {\n            try\n            {\n                // Split the script into batches using the GO separator\n                string[] batches = Regex.Split(script, @"^\s*GO\s*$", RegexOptions.Multiline | RegexOptions.IgnoreCase);\n\n                foreach (string batch in batches)\n                {\n                    if (string.IsNullOrWhiteSpace(batch))\n                        continue;\n\n                    using (SqlCommand command = new SqlCommand(batch, connection, transaction))\n                    {\n                        command.ExecuteNonQuery();\n                    }\n                }\n\n                // Commit the transaction if all batches succeed\n                transaction.Commit();\n            }\n            catch (Exception ex)\n            {\n                // Rollback the transaction if any batch fails\n                transaction.Rollback();\n                throw new ApplicationException("An error occurred while executing the script within a transaction.", ex);\n            }\n        }\n    }\n}