using System.ServiceModel;\nusing System.ServiceModel.Channels;\nusing System.ServiceModel.Dispatcher;\nusing System.ServiceModel.Web;\n\npublic class ResponseFormatMessageInspector : IDispatchMessageInspector\n{\n    public object AfterReceiveRequest(ref Message request, IClientChannel channel, InstanceContext instanceContext)\n    {\n        var queryParameters = WebOperationContext.Current.IncomingRequest.UriTemplateMatch.QueryParameters;\n        if (queryParameters["format"] == "json")\n        {\n            WebOperationContext.Current.OutgoingResponse.Format = WebMessageFormat.Json;\n        }\n        else\n        {\n            WebOperationContext.Current.OutgoingResponse.Format = WebMessageFormat.Xml;\n        }\n\n        return null;\n    }\n\n    public void BeforeSendReply(ref Message reply, object correlationState) { }\n}