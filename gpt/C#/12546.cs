using (SqlConnection conn = new SqlConnection("your_connection_string"))\n{\n    conn.Open();\n    \n    using (SqlTransaction transaction = conn.BeginTransaction(IsolationLevel.Serializable))\n    {\n        try\n        {\n            // Step 1: Find newest N widgets from the external source\n            var widgets = FindNewestWidgets();\n\n            foreach (var widget in widgets)\n            {\n                // Step 2: Check if widget is already in the database\n                SqlCommand checkCmd = new SqlCommand("SELECT COUNT(*) FROM Widgets WHERE WidgetId = @WidgetId", conn, transaction);\n                checkCmd.Parameters.AddWithValue("@WidgetId", widget.Id);\n                int count = (int)checkCmd.ExecuteScalar();\n\n                if (count == 0)\n                {\n                    // Step 3: Add rows for widget\n                    SqlCommand insertCmd = new SqlCommand("INSERT INTO Widgets (WidgetId, WidgetData) VALUES (@WidgetId, @WidgetData)", conn, transaction);\n                    insertCmd.Parameters.AddWithValue("@WidgetId", widget.Id);\n                    insertCmd.Parameters.AddWithValue("@WidgetData", widget.Data);\n                    insertCmd.ExecuteNonQuery();\n                }\n            }\n\n            // Commit the transaction\n            transaction.Commit();\n        }\n        catch (Exception ex)\n        {\n            // Rollback the transaction in case of an error\n            transaction.Rollback();\n            // Handle the exception (log it, rethrow it, etc.)\n            throw;\n        }\n    }\n}