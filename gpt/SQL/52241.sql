CREATE PROCEDURE CalculateMonthlyVariance\nAS\nBEGIN\n    WITH CurrentMonth AS (\n        SELECT OfficeID, ActivityCount AS CurrentActivityCount\n        FROM MonthlySnapshots\n        WHERE SnapshotDate = (SELECT MAX(SnapshotDate) FROM MonthlySnapshots)\n    ),\n    PreviousMonth AS (\n        SELECT OfficeID, ActivityCount AS PreviousActivityCount\n        FROM MonthlySnapshots\n        WHERE SnapshotDate = (\n            SELECT MAX(SnapshotDate) \n            FROM MonthlySnapshots \n            WHERE SnapshotDate < (SELECT MAX(SnapshotDate) FROM MonthlySnapshots)\n        )\n    )\n    SELECT c.OfficeID, \n           c.CurrentActivityCount, \n           p.PreviousActivityCount,\n           c.CurrentActivityCount - p.PreviousActivityCount AS Variance\n    FROM CurrentMonth c\n    JOIN PreviousMonth p ON c.OfficeID = p.OfficeID;\nEND;