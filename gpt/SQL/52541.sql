WITH WaypointsData AS (\n    SELECT \n        WP_VTDID,\n        MAX(WP_ODOMETER) AS MaxOdometer,\n        MIN(WP_ODOMETER) AS MinOdometer,\n        MIN(WP_DATETIME) AS MinDateTime,\n        MAX(WP_DATETIME) AS MaxDateTime\n    FROM WAYPOINTS\n    WHERE WP_DATETIME BETWEEN DATEADD(DAY, -14, GETDATE()) AND GETDATE()\n    GROUP BY WP_VTDID\n)\nSELECT \n    L.L_VTDID,\n    (W.MaxOdometer - W.MinOdometer) / DATEDIFF(DAY, W.MinDateTime, W.MaxDateTime) AS MAXD,\n    W.MaxOdometer AS MD\nFROM \n    LOCOMOTIVES L\nJOIN \n    WaypointsData W ON L.L_VTDID = W.WP_VTDID;