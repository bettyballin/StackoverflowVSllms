CREATE FUNCTION dbo.CalculateDistance (\n    @Lat1 FLOAT, @Lon1 FLOAT, @Lat2 FLOAT, @Lon2 FLOAT\n) RETURNS FLOAT AS\nBEGIN\n    DECLARE @R FLOAT = 3959; -- Earth radius in miles\n    DECLARE @dLat FLOAT = RADIANS(@Lat2 - @Lat1);\n    DECLARE @dLon FLOAT = RADIANS(@Lon2 - @Lon1);\n    DECLARE @a FLOAT = \n        SIN(@dLat / 2) * SIN(@dLat / 2) +\n        COS(RADIANS(@Lat1)) * COS(RADIANS(@Lat2)) *\n        SIN(@dLon / 2) * SIN(@dLon / 2);\n    DECLARE @c FLOAT = 2 * ATAN2(SQRT(@a), SQRT(1 - @a));\n    RETURN @R * @c;\nEND;