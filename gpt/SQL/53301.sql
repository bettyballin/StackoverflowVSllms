-- Step 1: Build the hierarchy using a recursive CTE\nWITH Hierarchy AS\n(\n    SELECT\n        Key,\n        ParentKey,\n        CAST(Key AS VARCHAR(128)) AS Path\n    FROM\n        Table2\n    WHERE \n        ParentKey IS NULL\n\n    UNION ALL\n\n    SELECT\n        t2.Key,\n        t2.ParentKey,\n        CAST(h.Path + ',' + CAST(t2.Key AS VARCHAR(128)) AS VARCHAR(128)) AS Path\n    FROM\n        Table2 t2\n    INNER JOIN\n        Hierarchy h ON h.Key = t2.ParentKey\n)\n-- Step 2: Filter out groups where ParentKey is 2 or its descendants\n, ExcludedGroups AS\n(\n    SELECT Key\n    FROM Hierarchy\n    WHERE Path LIKE '2%' OR Path LIKE '%,2,%'\n)\n-- Step 3: Select items from Table1 where the group is not in the excluded groups\nSELECT DISTINCT t1.*\nFROM Table1 t1\nINNER JOIN Table3 t3 ON t1.ID = t3.ItemID\nINNER JOIN Table2 t2 ON t3.GroupID = t2.Key\nLEFT JOIN ExcludedGroups eg ON t2.Key = eg.Key\nWHERE eg.Key IS NULL;