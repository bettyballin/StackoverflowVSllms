WITH TableHierarchy AS (\n    SELECT \n        OBJECT_SCHEMA_NAME(f.parent_object_id) + '.' + OBJECT_NAME(f.parent_object_id) AS TableName,\n        OBJECT_SCHEMA_NAME(f.referenced_object_id) + '.' + OBJECT_NAME(f.referenced_object_id) AS ReferenceTableName\n    FROM \n        sys.foreign_keys AS f\n    UNION ALL\n    SELECT \n        th.TableName,\n        th.ReferenceTableName\n    FROM \n        TableHierarchy th\n    JOIN \n        sys.foreign_keys f ON th.TableName = OBJECT_SCHEMA_NAME(f.referenced_object_id) + '.' + OBJECT_NAME(f.referenced_object_id)\n), \nSortedTables AS (\n    SELECT \n        TableName,\n        0 AS Level\n    FROM \n        sys.tables\n    WHERE \n        OBJECT_SCHEMA_NAME(object_id) + '.' + OBJECT_NAME(object_id) NOT IN (SELECT TableName FROM TableHierarchy)\n    UNION ALL\n    SELECT \n        th.TableName,\n        st.Level + 1\n    FROM \n        TableHierarchy th\n    JOIN \n        SortedTables st ON th.ReferenceTableName = st.TableName\n)\nSELECT \n    DISTINCT TableName\nFROM \n    SortedTables\nORDER BY \n    MAX(Level) OVER (PARTITION BY TableName), TableName;