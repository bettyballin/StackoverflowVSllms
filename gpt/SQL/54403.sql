declare @date1 nvarchar(100) , @date2 nvarchar(100) , @countgap int,@count int \nset @date1='2009-05-12'\nset @date2 = '2009-05-13'\nset @countgap = 30\nset @count=48\n\nCREATE TABLE #Temp (VisitingCount int, [Time] int, [Date] datetime)\nDECLARE @DateNow DATETIME,@i int,@Time int, @Date datetime\nset @DateNow='00:00'  \nset @i=1;  \nwhile(@i<@count)  \n    begin  \n        set @DateNow = DATEADD(minute, @countgap, @DateNow)\n        set @Time = (datepart(hour,@DateNow)*60+datepart(minute,@DateNow))/@countgap \n        set @Date = CONVERT(VARCHAR(5),@DateNow, 108)\n        insert into #Temp(VisitingCount,[Time],[Date]) values(0,@Time,@Date )\n        set @i=@i+1\n    end\n\nselect \nSum(VisitingCount) as VisitingCount, [Time], \nRIGHT('0' + CAST(([Time]*@countgap/60) AS nvarchar(50)), 2) + ':' + \nRIGHT('0' + CAST(([Time]*@countgap%60) AS nvarchar(50)), 2) as VisitingGap\nfrom (\n  select 0 as VisitingCount, [Time] from #Temp\n  Union All\n    select count(page) as VisitingCount, \n    (datepart(hour,Date)*60+datepart(minute,Date))/@countgap as [Time] \n    from scr_SecuristLog\n    where Date between @date1 and @date2\n    GROUP BY (datepart(hour,Date)*60+datepart(minute,Date))/@countgap\n  ) X\ngroup by [Time]\norder by  2 asc