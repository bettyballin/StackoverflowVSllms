WITH LoginActivities AS (\n    SELECT \n        AuditRecordID, \n        DateTimeStamp, \n        UserID, \n        ActivityCode,\n        ROW_NUMBER() OVER (PARTITION BY UserID, CAST(DateTimeStamp AS DATE) ORDER BY DateTimeStamp) AS RowNum\n    FROM \n        AuditData\n    WHERE \n        ActivityCode = 1\n),\nDataReturnActivities AS (\n    SELECT \n        AuditRecordID, \n        DateTimeStamp, \n        UserID, \n        ActivityCode,\n        ROW_NUMBER() OVER (PARTITION BY UserID, CAST(DateTimeStamp AS DATE) ORDER BY DateTimeStamp) AS RowNum\n    FROM \n        AuditData\n    WHERE \n        ActivityCode = 2\n)\nSELECT \n    L.UserID,\n    CAST(L.DateTimeStamp AS DATE) AS DateOnly,\n    AVG(DATEDIFF(SECOND, L.DateTimeStamp, D.DateTimeStamp)) AS AvgTimeInSeconds\nFROM \n    LoginActivities L\nJOIN \n    DataReturnActivities D\nON \n    L.UserID = D.UserID AND \n    CAST(L.DateTimeStamp AS DATE) = CAST(D.DateTimeStamp AS DATE) AND \n    D.RowNum = L.RowNum + 1\nGROUP BY \n    L.UserID,\n    CAST(L.DateTimeStamp AS DATE)\nORDER BY \n    L.UserID, \n    CAST(L.DateTimeStamp AS DATE);