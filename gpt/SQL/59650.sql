SELECT\n      DECODE(wid_location, 28.3, 'CL', 29.6, 'DA') AS site,\n      (n*sum_xy - sum_x*sum_y) / (n*sum_x_sq - sum_x*sum_x) AS m,\n      (sum_y - ((n*sum_xy - sum_x*sum_y) / (n*sum_x_sq - sum_x*sum_x)) * sum_x) / n AS b \nFROM (\n        SELECT \n               wid_location,\n               SUM(wids) AS sum_x,\n               SUM(mine) AS sum_y,\n               SUM(wids*mine) AS sum_xy,\n               SUM(wids*wids) AS sum_x_sq,\n               COUNT(*) AS n\n        FROM (                                                                        \n                SELECT \n                       trn.wid_location,\n                       con.empty_weight_total AS wids,                                                                    \n                       CASE \n                              WHEN trn.wid_location = 28.3 THEN con.empty_weight_total * 0.900 - 1.0\n                              WHEN trn.wid_location = 29.6 THEN con.empty_weight_total * 0.950 - 1.5\n                       END AS mine   \n                FROM widsys.train trn\n                     INNER JOIN widsys.consist con\n                     USING (train_record_id)\n                WHERE mine_code = 'YA'\n                      AND TO_CHAR(trn.wid_date, 'IYYY') = 2009\n                      AND TO_CHAR(trn.wid_date, 'IW') = 29\n             )\n        GROUP BY wid_location\n     )