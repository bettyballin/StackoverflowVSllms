WITH job_status AS (\n    SELECT \n        job_id,\n        MIN(status) AS min_status,\n        MAX(CASE WHEN status = 3 THEN completed_date ELSE NULL END) AS max_completed_date\n    FROM \n        tasks\n    GROUP BY \n        job_id\n),\nfiltered_jobs AS (\n    SELECT \n        job_id\n    FROM \n        job_status\n    WHERE \n        min_status <> 3 \n        OR (min_status = 3 AND max_completed_date = TRUNC(SYSDATE))\n)\nSELECT \n    t.task_id, \n    t.job_id, \n    t.to_do_by_date, \n    t.task_name, \n    t.status, \n    t.completed_date\nFROM \n    tasks t\nWHERE \n    t.job_id IN (SELECT job_id FROM filtered_jobs)\nORDER BY \n    t.to_do_by_date, \n    t.job_id;