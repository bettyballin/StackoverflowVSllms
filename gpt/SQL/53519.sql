WITH LatestPurchase AS (\n    SELECT ProductCode, SerialNumber, MAX(DatePurchased) AS MaxDatePurchased\n    FROM YourTable\n    WHERE CustomerID = 'xxx'\n    GROUP BY ProductCode, SerialNumber\n)\nSELECT t.ProductCode, t.SerialNumber, t.Quantity\nFROM YourTable t\nJOIN LatestPurchase lp\nON t.ProductCode = lp.ProductCode\nAND t.SerialNumber = lp.SerialNumber\nAND t.DatePurchased = lp.MaxDatePurchased\nWHERE t.CustomerID = 'xxx';