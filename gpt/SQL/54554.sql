WITH RankedBalances AS (\n    SELECT\n        balance,\n        date,\n        aid,\n        ROW_NUMBER() OVER (PARTITION BY aid ORDER BY date DESC) AS rn,\n        (DATEDIFF(date, '1970-01-01') - (ROW_NUMBER() OVER (PARTITION BY aid ORDER BY date) - 1)) DIV 5 AS grp\n    FROM\n        AccountBalances\n),\nLatestEach5Days AS (\n    SELECT\n        balance,\n        date,\n        aid,\n        rn,\n        grp,\n        ROW_NUMBER() OVER (PARTITION BY aid, grp ORDER BY date DESC) AS grp_rn\n    FROM\n        RankedBalances\n)\nSELECT\n    balance,\n    date,\n    aid\nFROM\n    LatestEach5Days\nWHERE\n    grp_rn = 1\nORDER BY\n    aid,\n    date;