WITH parsed_data AS (\n    SELECT\n        id,\n        TRIM(SPLIT_PART(SPLIT_PART(availability_string, 'available ', 2), ' to ', 1)) AS startdate,\n        NULLIF(TRIM(SPLIT_PART(SPLIT_PART(availability_string, ' to ', 2), ',', 1)), '') AS enddate,\n        CASE \n            WHEN POSITION('exclude' IN availability_string) > 0 \n            THEN TRIM(SPLIT_PART(availability_string, 'exclude ', 2))\n            ELSE NULL\n        END AS exclusions\n    FROM availability\n),\ninsert_dates AS (\n    UPDATE availability\n    SET\n        startdate = TO_DATE(startdate, 'DD/MON/YYYY'),\n        enddate = CASE WHEN enddate IS NOT NULL THEN TO_DATE(enddate, 'DD/MON/YYYY') ELSE NULL END\n    FROM parsed_data\n    WHERE availability.id = parsed_data.id\n    RETURNING availability.id, parsed_data.exclusions\n),\nsplit_exclusions AS (\n    SELECT\n        id,\n        UNNEST(REGEXP_SPLIT_TO_ARRAY(exclusions, ', ')) AS exclusion\n    FROM insert_dates\n)\nINSERT INTO exclusions (availability_id, exclusion)\nSELECT id, exclusion FROM split_exclusions;