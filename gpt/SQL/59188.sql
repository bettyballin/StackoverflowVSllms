-- Setup stuff...\nCREATE DATABASE DBA_AUDIT\nGO \nUSE DBA_AUDIT\nGO\nCREATE TABLE AuditLog\n(\n    ID INT PRIMARY KEY IDENTITY(1,1),\n    Command NVARCHAR(1000),\n    PostTime DATETIME,\n    HostName NVARCHAR(100),\n    LoginName NVARCHAR(100)\n)\nGO\n\nCREATE ROLE AUDITROLE\nGO\n\nsp_adduser 'guest','guest','AUDITROLE'\nGO\n\nGRANT INSERT ON SCHEMA::[dbo]\nTO AUDITROLE\nGO\n\n-- CREATE TRIGGER IN ALL NON SYSTEM DATABASES\n\nDECLARE @dataname VARCHAR(255),\n        @command  NVARCHAR(MAX)\n\n-- Get the list of database names\nDECLARE datanames_cursor CURSOR FOR \nSELECT name \nFROM sys.databases \nWHERE name NOT IN ('master', 'pubs', 'tempdb', 'model', 'msdb')\n\nOPEN datanames_cursor\n\nFETCH NEXT FROM datanames_cursor INTO @dataname\nWHILE (@@FETCH_STATUS = 0)\nBEGIN\n    PRINT '----------BEGIN---------'\n    PRINT 'DATANAME variable: ' + @dataname\n\n    SET @command = 'USE [' + @dataname + ']; ' +\n                   'CREATE TRIGGER DBA_Audit ON DATABASE ' +\n                   'FOR DDL_DATABASE_LEVEL_EVENTS ' +\n                   'AS ' +\n                   'DECLARE @data XML; ' +\n                   'DECLARE @cmd NVARCHAR(1000); ' +\n                   'DECLARE @posttime NVARCHAR(24); ' +\n                   'DECLARE @spid NVARCHAR(6); ' +\n                   'DECLARE @loginname NVARCHAR(100); ' +\n                   'DECLARE @hostname NVARCHAR(100); ' +\n                   'SET @data = EVENTDATA(); ' +\n                   'SET @cmd = @data.value(''(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]'', ''NVARCHAR(1000)''); ' +\n                   'SET @posttime = CONVERT(NVARCHAR(24), GETDATE(), 121); ' +\n                   'SET @spid = CONVERT(NVARCHAR(6), @@SPID); ' +\n                   'SET @loginname = CONVERT(NVARCHAR(100), CURRENT_USER); ' +\n                   'SET @hostname = HOST_NAME(); ' +\n                   'INSERT INTO DBA_AUDIT.dbo.AuditLog (Command, PostTime, HostName, LoginName) ' +\n                   'VALUES (@cmd, @posttime, @hostname, @loginname);'\n\n    EXEC sp_executesql @command\n\n    FETCH NEXT FROM datanames_cursor INTO @dataname\nEND\n\nCLOSE datanames_cursor\nDEALLOCATE datanames_cursor\nGO