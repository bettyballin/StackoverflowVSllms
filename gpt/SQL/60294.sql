SELECT COUNT(perm.PermissionID)\nFROM Users u\nJOIN UserRoles ur ON u.UserID = ur.UserID\nJOIN RolePermissions rp ON ur.RoleID = rp.RoleID\nJOIN Permissions perm ON rp.PermissionID = perm.PermissionID\nLEFT JOIN UserAttributes ua ON u.UserID = ua.UserID\nLEFT JOIN Attributes attr ON ua.AttributeID = attr.AttributeID\nWHERE u.UserID = @UserID\n  AND (perm.PermissionName = @PermissionName)\n  AND (attr.AttributeName = @AttributeName OR @AttributeName IS NULL);