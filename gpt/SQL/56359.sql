DECLARE @currentDate DATETIME = GETDATE()\n\nSELECT \n    A.StaffID,\n    MONTH(D.AbsenceDate) AS AbsenceMonth,\n    YEAR(D.AbsenceDate) AS AbsenceYear,\n    COUNT(*) AS DaysAbsent\nFROM \n    AbsenceTable A\nCROSS APPLY \n    dbo.GenerateDates(A.StartDate, ISNULL(A.EndDate, @currentDate)) D\nGROUP BY \n    A.StaffID,\n    MONTH(D.AbsenceDate),\n    YEAR(D.AbsenceDate)\nORDER BY \n    A.StaffID,\n    YEAR(D.AbsenceDate),\n    MONTH(D.AbsenceDate)