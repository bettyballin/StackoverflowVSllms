WITH adminrooms_cte AS (\n    SELECT\n        a.username,\n        CONCAT(a.firstname, ' ', a.lastname) AS name,\n        a.email,\n        a.phone,\n        a.code,\n        ar.roomcode,\n        (SELECT name FROM rooms WHERE code = ar.roomcode) AS res,\n        COUNT(*) OVER (PARTITION BY a.code) AS cnt,\n        ROW_NUMBER() OVER (PARTITION BY a.code ORDER BY ar.ofield) AS rnum\n    FROM\n        admins a\n    JOIN\n        adminrooms ar ON a.code = ar.roomcode\n    WHERE\n        a.frozen = 0 AND (a.type <> 'root' OR a.type IS NULL)\n)\nSELECT \n    username,\n    name,\n    email,\n    phone,\n    (\n        SELECT \n            LTRIM(SYS_CONNECT_BY_PATH(res, ', '), ', ')\n        FROM \n            adminrooms_cte\n        WHERE\n            adminrooms_cte.code = main_query.code\n        START WITH \n            rnum = 1\n        CONNECT BY \n            PRIOR rnum = rnum - 1\n    ) AS groups\nFROM \n    (SELECT DISTINCT code, username, name, email, phone FROM adminrooms_cte) main_query;