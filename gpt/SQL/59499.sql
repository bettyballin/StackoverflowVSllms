DECLARE @ResultTable table \n(\n  StaffName nvarchar(100),\n  Stage1Count int DEFAULT 0,\n  Stage2Count int DEFAULT 0\n)\n\n-- Insert initial data for Stage1\nINSERT INTO @ResultTable (StaffName, Stage1Count)\nSELECT StaffName, COUNT(*) \nFROM ViewJob\nWHERE DateStarted IS NOT NULL AND DateFinished IS NULL AND InStage1 = 1\nGROUP BY StaffName\n\n-- Update Stage2Count for existing StaffName, and insert new records for those not in Stage1\nMERGE @ResultTable AS target\nUSING \n(\n  SELECT StaffName, COUNT(*) AS Stage2Count \n  FROM ViewJob\n  WHERE DateStarted IS NOT NULL AND DateFinished IS NULL AND InStage2 = 1\n  GROUP BY StaffName\n) AS source\nON (target.StaffName = source.StaffName)\nWHEN MATCHED THEN \n    UPDATE SET Stage2Count = source.Stage2Count\nWHEN NOT MATCHED THEN \n    INSERT (StaffName, Stage2Count) VALUES (source.StaffName, source.Stage2Count);\n\n-- Select the final result\nSELECT * FROM @ResultTable;