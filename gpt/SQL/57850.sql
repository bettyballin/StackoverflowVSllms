ALTER TRIGGER [dbo].[tr_CustomerSatisfactionAlertRepair] \nON [dbo].[tbl_repair_visit] \nAFTER UPDATE\nAS \nBEGIN\n    SET NOCOUNT ON;\n\n    -- Check if TENANTSATISFACTION was updated to 'Poor'\n    IF EXISTS (\n        SELECT 1\n        FROM INSERTED I\n        JOIN DELETED D ON I.VISITID = D.VISITID\n        WHERE I.TENANTSATISFACTION = 'Poor' AND D.TENANTSATISFACTION <> 'Poor'\n    )\n    BEGIN\n        INSERT INTO alertmessagedata (TypeID, Contract, Address, ORDERID, ENGINEERS, Sent, DateAdded)\n        SELECT '5', tbl_property.contract, tbl_property.fulladdress, \n               tbl_repair_visit.orderid, tbl_repair_visit.engineer, \n               0, GETDATE()\n        FROM TBL_REPAIR_VISIT \n        INNER JOIN INSERTED X ON TBL_REPAIR_VISIT.VISITID = X.VISITID \n        INNER JOIN TBL_PROPERTY ON TBL_REPAIR_VISIT.PROPREF = TBL_PROPERTY.PROPREF\n        WHERE tbl_repair_visit.TENANTSATISFACTION = 'Poor';\n    END\nEND