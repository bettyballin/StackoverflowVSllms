BEGIN\n    BEGIN\n        EXECUTE IMMEDIATE 'CREATE TABLE A (PKey int NOT NULL, NewFieldKey int NULL, CONSTRAINT PK_A PRIMARY KEY (PKey))';\n    EXCEPTION\n        WHEN OTHERS THEN\n            RAISE_APPLICATION_ERROR(-20001, 'Error creating table A: ' || SQLERRM);\n    END;\n\n    BEGIN\n        EXECUTE IMMEDIATE 'CREATE INDEX A_2 ON A (NewFieldKey)';\n    EXCEPTION\n        WHEN OTHERS THEN\n            EXECUTE IMMEDIATE 'DROP TABLE A';\n            RAISE_APPLICATION_ERROR(-20002, 'Error creating index A_2: ' || SQLERRM);\n    END;\n\n    BEGIN\n        EXECUTE IMMEDIATE 'CREATE TABLE B (PKey int NOT NULL, CONSTRAINT PK_B PRIMARY KEY (PKey))';\n    EXCEPTION\n        WHEN OTHERS THEN\n            EXECUTE IMMEDIATE 'DROP INDEX A_2';\n            EXECUTE IMMEDIATE 'DROP TABLE A';\n            RAISE_APPLICATION_ERROR(-20003, 'Error creating table B: ' || SQLERRM);\n    END;\n\n    BEGIN\n        EXECUTE IMMEDIATE 'ALTER TABLE A ADD CONSTRAINT FK_B_A FOREIGN KEY (NewFieldKey) REFERENCES B (PKey)';\n    EXCEPTION\n        WHEN OTHERS THEN\n            EXECUTE IMMEDIATE 'DROP TABLE B';\n            EXECUTE IMMEDIATE 'DROP INDEX A_2';\n            EXECUTE IMMEDIATE 'DROP TABLE A';\n            RAISE_APPLICATION_ERROR(-20004, 'Error adding foreign key constraint FK_B_A: ' || SQLERRM);\n    END;\n\n    -- If all DDL statements succeed, commit the transaction\n    COMMIT;\nEXCEPTION\n    WHEN OTHERS THEN\n        -- Rollback any DML changes if any (not DDL as they are already committed)\n        ROLLBACK;\n        RAISE;\nEND;