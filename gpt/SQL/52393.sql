-- Create an index on relevant columns\nCREATE INDEX idx_date_updated ON bigbigtable (date_updated);\nCREATE INDEX idx_category_element ON bigbigtable (category, element_id);\nCREATE INDEX idx_source ON bigbigtable (source_prefix, source_name);\n\n-- Step 1: Find maximum date for each subgroup\nCREATE TEMPORARY TABLE temp2 AS\nSELECT\n    category,\n    element_id,\n    source_prefix,\n    source_name,\n    MAX(date_updated) AS maxdate\nFROM\n    bigbigtable\nWHERE\n    date_updated <= '2009-04-28'\nGROUP BY\n    category, element_id, source_prefix, source_name;\n\n-- Step 2: Join temp2 with bigbigtable to find weighted average values\nCREATE TEMPORARY TABLE valuebycats AS\nSELECT\n    bbt.element_id,\n    bbt.category,\n    bbt.source_prefix,\n    bbt.source_name,\n    bbt.date_updated,\n    AVG(bbt.value) AS avg_value,\n    SUM(bbt.value * bbt.weight) / SUM(bbt.weight) AS rating\nFROM\n    bigbigtable bbt\nINNER JOIN\n    temp2 t2\nON\n    bbt.category = t2.category\n    AND bbt.element_id = t2.element_id\n    AND bbt.source_prefix = t2.source_prefix\n    AND bbt.source_name = t2.source_name\n    AND bbt.date_updated = t2.maxdate\nGROUP BY\n    bbt.category, bbt.element_id, bbt.source_prefix, bbt.source_name;