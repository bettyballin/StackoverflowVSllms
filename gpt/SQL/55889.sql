WITH GroupHierarchy AS (\n    SELECT \n        g.GruppeID,\n        g.ParentGruppeID,\n        0 AS Level\n    FROM \n        Gruppen AS g\n    WHERE \n        g.ParentGruppeID IS NULL\n\n    UNION ALL\n\n    SELECT \n        g.GruppeID,\n        g.ParentGruppeID,\n        gh.Level + 1\n    FROM \n        Gruppen AS g\n    INNER JOIN \n        GroupHierarchy AS gh ON g.ParentGruppeID = gh.GruppeID\n)\nSELECT \n    k.KundeID,\n    g.GruppeID AS MostParentGruppeID\nFROM \n    Kunden AS k\nINNER JOIN \n    KundenGruppen AS kg ON k.KundeID = kg.KundeID\nINNER JOIN \n    GroupHierarchy AS g ON kg.GruppeID = g.GruppeID\nWHERE \n    g.Level = 0