WITH OpeningBalanceCTE AS (\n    SELECT BalanceId, SUM(TokenAmount) AS TotalOpeningTokenAmount\n    FROM BalanceToken\n    GROUP BY BalanceId\n),\nClosingBalanceCTE AS (\n    SELECT BalanceId, SUM(TokenAmount) AS TotalClosingTokenAmount\n    FROM BalanceToken\n    GROUP BY BalanceId\n)\nSELECT A.AccountId,\n       A.AccountBalanceDate,\n       COALESCE(OB.TotalOpeningTokenAmount, 0) AS OpeningBalance,\n       COALESCE(CB.TotalClosingTokenAmount, 0) AS ClosingBalance\nFROM Account A\nLEFT JOIN BALANCE OpeningBal\n  ON A.OpeningBalanceId = OpeningBal.BalanceId\nLEFT JOIN BALANCE ClosingBal\n  ON A.ClosingBalanceId = ClosingBal.BalanceId\nLEFT JOIN OpeningBalanceCTE OB\n  ON OpeningBal.BalanceId = OB.BalanceId\nLEFT JOIN ClosingBalanceCTE CB\n  ON ClosingBal.BalanceId = CB.BalanceId;