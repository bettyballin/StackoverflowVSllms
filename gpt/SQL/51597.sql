WITH AreaProducts AS (\n    SELECT \n        Area.Id AS AreaId,\n        Area.Name AS AreaName,\n        STRING_AGG(CAST(AreaToProduct.ProductId AS NVARCHAR(MAX)), ',') WITHIN GROUP (ORDER BY AreaToProduct.ProductId) AS ProductSet\n    FROM \n        Area\n    INNER JOIN \n        AreaToProduct ON AreaToProduct.AreaId = Area.Id\n    GROUP BY \n        Area.Id, Area.Name\n)\nSELECT \n    ap1.AreaName AS Area1,\n    ap2.AreaName AS Area2,\n    ap1.ProductSet\nFROM \n    AreaProducts ap1\nINNER JOIN \n    AreaProducts ap2 ON ap1.ProductSet = ap2.ProductSet AND ap1.AreaId < ap2.AreaId\nORDER BY \n    ap1.AreaName, ap2.AreaName;