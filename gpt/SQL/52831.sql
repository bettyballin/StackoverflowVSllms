CREATE PROCEDURE CopyEstimateJobHeaders\n    @OldEstimateID INT,\n    @NewEstimateID INT,\n    @RETURN_VALUE INT OUTPUT\nAS\nBEGIN\n    DECLARE @OldJobHeaderID INT;\n    DECLARE @NewJobHeaderID INT;\n    DECLARE @err INT;\n\n    DECLARE JobHeaderCursor CURSOR FOR\n    SELECT JobHeaderID\n    FROM dbo.EstimateJobHeader\n    WHERE EstimateID = @OldEstimateID;\n\n    OPEN JobHeaderCursor;\n    FETCH NEXT FROM JobHeaderCursor INTO @OldJobHeaderID;\n\n    BEGIN TRANSACTION;\n\n    WHILE @@FETCH_STATUS = 0\n    BEGIN\n        INSERT INTO EstimateJobHeader (ServiceID, EstimateID)\n        SELECT ServiceID, @NewEstimateID\n        FROM EstimateJobHeader\n        WHERE EstimateID = @OldEstimateID AND JobHeaderID = @OldJobHeaderID;\n\n        SELECT @err = @@ERROR;\n        IF @err <> 0\n        BEGIN\n            ROLLBACK TRANSACTION;\n            SET @RETURN_VALUE = 4;\n            RETURN;\n        END\n\n        SET @NewJobHeaderID = SCOPE_IDENTITY();\n\n        SELECT @err = @@ERROR;\n        IF @err <> 0\n        BEGIN\n            ROLLBACK TRANSACTION;\n            SET @RETURN_VALUE = 3;\n            RETURN;\n        END\n\n        INSERT INTO EstimateDetail (JobHeaderID, OtherCols)\n        SELECT @NewJobHeaderID, OtherCols\n        FROM EstimateDetail\n        WHERE JobHeaderID = @OldJobHeaderID;\n\n        SELECT @err = @@ERROR;\n        IF @err <> 0\n        BEGIN\n            ROLLBACK TRANSACTION;\n            SET @RETURN_VALUE = 3;\n            RETURN;\n        END\n\n        INSERT INTO EstimateJobDetail (JobHeaderID, OtherCols)\n        SELECT @NewJobHeaderID, OtherCols\n        FROM EstimateJobDetail\n        WHERE JobHeaderID = @OldJobHeaderID;\n\n        SELECT @err = @@ERROR;\n        IF @err <> 0\n        BEGIN\n            ROLLBACK TRANSACTION;\n            SET @RETURN_VALUE = 3;\n            RETURN;\n        END\n\n        FETCH NEXT FROM JobHeaderCursor INTO @OldJobHeaderID;\n    END\n\n    CLOSE JobHeaderCursor;\n    DEALLOCATE JobHeaderCursor;\n\n    COMMIT TRANSACTION;\n\n    SET @RETURN_VALUE = 0;\nEND