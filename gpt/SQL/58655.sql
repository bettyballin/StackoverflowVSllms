INSERT INTO ExpensiveQueriesLog (SqlHandle, ExecutionCount, CPU_Time, Physical_Reads, Logical_Writes, Total_Elapsed_Time, Query_Text, Query_Plan)\nSELECT TOP 10\n    qs.sql_handle,\n    qs.execution_count,\n    qs.total_worker_time AS CPU_Time,\n    qs.total_physical_reads AS Physical_Reads,\n    qs.total_logical_writes AS Logical_Writes,\n    qs.total_elapsed_time AS Total_Elapsed_Time,\n    SUBSTRING(st.text, (qs.statement_start_offset / 2) + 1,\n    ((CASE WHEN qs.statement_end_offset = -1\n        THEN DATALENGTH(st.text)\n        ELSE qs.statement_end_offset\n    END - qs.statement_start_offset) / 2) + 1) AS Query_Text,\n    qp.query_plan\nFROM\n    sys.dm_exec_query_stats AS qs\nCROSS APPLY\n    sys.dm_exec_sql_text(qs.sql_handle) AS st\nCROSS APPLY\n    sys.dm_exec_query_plan(qs.plan_handle) AS qp\nORDER BY\n    qs.total_worker_time DESC;