DELIMITER |\n\nDROP FUNCTION IF EXISTS get_idiscussion_ask|\n\nCREATE FUNCTION get_idiscussion_ask(iask_id INT UNSIGNED) RETURNS TEXT DETERMINISTIC\nBEGIN\n  DECLARE done INT DEFAULT 0;\n  DECLARE body varchar(600);\n  DECLARE created DATETIME;\n  DECLARE anonymous TINYINT(1);\n  DECLARE screen_name varchar(64);\n  DECLARE result TEXT;\n  DECLARE cur1 CURSOR FOR SELECT body, created, anonymous, screen_name \n                         FROM idiscussion \n                         LEFT JOIN users ON idiscussion.uid=users.id \n                         WHERE idiscussion.iask_id=iask_id;\n  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;\n\n  SET result = '';\n  OPEN cur1;\n  \n  read_loop: LOOP\n    FETCH cur1 INTO body, created, anonymous, screen_name;\n    IF done THEN\n      LEAVE read_loop;\n    END IF;\n    SET result = CONCAT(result,'<comment><body><![CDATA[',body,']]></body>',\n                        '<replier>',IF(screen_name IS NOT NULL AND anonymous = 0, screen_name, ''),'</replier>',\n                        '<created>',created,'</created></comment>');\n  END LOOP;\n  \n  CLOSE cur1;\n  RETURN result;\nEND |\n\nDELIMITER ;