WITH visit_intervals AS (\n    SELECT\n        id,\n        visitor_id,\n        visit_time,\n        LAG(visit_time) OVER (PARTITION BY visitor_id ORDER BY visit_time) AS previous_visit_time\n    FROM\n        visiting\n),\nsessions AS (\n    SELECT\n        id,\n        visitor_id,\n        visit_time,\n        CASE\n            WHEN previous_visit_time IS NULL OR EXTRACT(EPOCH FROM (visit_time - previous_visit_time)) > 3600\n            THEN 1\n            ELSE 0\n        END AS new_session\n    FROM\n        visit_intervals\n),\nsession_groups AS (\n    SELECT\n        id,\n        visitor_id,\n        visit_time,\n        SUM(new_session) OVER (PARTITION BY visitor_id ORDER BY visit_time) AS session_id\n    FROM\n        sessions\n)\nSELECT\n    visitor_id,\n    session_id,\n    COUNT(*) AS count\nFROM\n    session_groups\nGROUP BY\n    visitor_id,\n    session_id\nORDER BY\n    visitor_id,\n    session_id;