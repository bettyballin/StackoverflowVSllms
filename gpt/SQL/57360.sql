WITH ranked_distances AS (\n    SELECT\n        id,\n        a_id,\n        b_id,\n        distance,\n        ROW_NUMBER() OVER (PARTITION BY a_id ORDER BY distance) AS rn\n    FROM\n        mytable\n    WHERE\n        delete = 0\n)\nUPDATE mytable\nSET delete = 1\nFROM ranked_distances\nWHERE mytable.id = ranked_distances.id\nAND ranked_distances.rn > 10;\n\nDELETE FROM mytable\nWHERE delete = 1;