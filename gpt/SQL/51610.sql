;WITH UnownedProducts AS (\n    SELECT\n        c.CustomerID,\n        p.ProductID,\n        ROW_NUMBER() OVER (PARTITION BY p.ProductID ORDER BY c.CustomerID) AS rn\n    FROM\n        Customers c\n    CROSS JOIN\n        Products p\n    WHERE\n        NOT EXISTS (\n            SELECT 1\n            FROM CustomerProducts cp\n            WHERE cp.CustomerID = c.CustomerID\n              AND cp.ProductID = p.ProductID\n        )\n)\n, FirstUnowned AS (\n    SELECT\n        CustomerID,\n        ProductID\n    FROM\n        UnownedProducts\n    WHERE\n        rn = 1\n)\nUPDATE c\nSET c.UnownedProduct = p.ProductName\nFROM\n    Customers c\nINNER JOIN\n    FirstUnowned fu ON c.CustomerID = fu.CustomerID\nINNER JOIN\n    Products p ON fu.ProductID = p.ProductID;