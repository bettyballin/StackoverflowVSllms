WITH IdealCustomer AS (\n  SELECT\n    food_type,\n    100 * food_type_value / SUM(food_type_value) OVER () AS ideal_perc\n  FROM\n    mytable\n  WHERE\n    customer = 3\n)\nSELECT\n  c1.customer,\n  c1.food_type,\n  100 * c1.food_type_value / SUM(c2.food_type_value) OVER (PARTITION BY c1.customer) AS food_type_perc,\n  ic.ideal_perc\nFROM\n  mytable c1\nINNER JOIN\n  mytable c2 ON c1.customer = c2.customer\nINNER JOIN\n  IdealCustomer ic ON c1.food_type = ic.food_type\nGROUP BY\n  c1.customer, c1.food_type, c1.food_type_value, ic.ideal_perc\nORDER BY\n  c1.customer, c1.food_type;