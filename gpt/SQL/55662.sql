WITH RankedPrices AS (\n    SELECT \n        Product_ID, \n        Price, \n        Sale_Date,\n        ROW_NUMBER() OVER (PARTITION BY Product_ID ORDER BY Sale_Date) AS rn\n    FROM Prices\n),\nSalesWithPrices AS (\n    SELECT \n        s.Sale_ID, \n        s.ProductID, \n        s.Sale_Date, \n        p.Price\n    FROM \n        Sales s\n    JOIN \n        RankedPrices p\n    ON \n        s.ProductID = p.Product_ID\n    WHERE \n        s.Sale_Date >= p.Sale_Date \n        AND p.rn = (\n            SELECT MAX(rn)\n            FROM RankedPrices\n            WHERE Product_ID = s.ProductID AND Sale_Date <= s.Sale_Date\n        )\n)\nSELECT \n    Sale_ID,\n    ProductID,\n    Sale_Date,\n    Price\nFROM \n    SalesWithPrices\nORDER BY \n    Sale_ID;