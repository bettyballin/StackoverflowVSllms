MERGE INTO Table1 t1\nUSING (\n    WITH RunningTotals AS (\n        SELECT\n            ID,\n            DATE,\n            SUM(AMOUNT1) OVER (PARTITION BY ID ORDER BY DATE DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS RunningTotal,\n            ROW_NUMBER() OVER (PARTITION BY ID ORDER BY DATE DESC) AS rn\n        FROM\n            Table2\n    ),\n    Filtered AS (\n        SELECT\n            ID,\n            DATE\n        FROM\n            RunningTotals\n        WHERE\n            RunningTotal >= (SELECT AMOUNT FROM Table1 t1 WHERE t1.ID = RunningTotals.ID)\n    )\n    SELECT\n        ID,\n        MIN(DATE) AS DATE\n    FROM\n        Filtered\n    GROUP BY\n        ID\n) t2\nON (t1.ID = t2.ID)\nWHEN MATCHED THEN\n    UPDATE SET t1.DATE = t2.DATE;