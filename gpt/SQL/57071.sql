DECLARE\n    sql_query VARCHAR2(4000);\nBEGIN\n    SELECT 'SELECT * FROM (\n               SELECT c.CustomerID, cat.CategoryName, SUM(od.Quantity) AS TotalQuantity\n               FROM Orders o\n               JOIN OrderDetails od ON o.OrderID = od.OrderID\n               JOIN Products p ON od.ProductID = p.ProductID\n               JOIN Categories cat ON p.CategoryID = cat.CategoryID\n               JOIN Customers c ON o.CustomerID = c.CustomerID\n               GROUP BY c.CustomerID, cat.CategoryName\n           ) PIVOT (SUM(TotalQuantity) FOR CategoryName IN ('\n           || LISTAGG('''' || cat.CategoryName || ''' AS ' || REPLACE(cat.CategoryName, ' ', '_'), ',') WITHIN GROUP (ORDER BY cat.CategoryName)\n           || ')) ORDER BY CustomerID;'\n    INTO sql_query\n    FROM Categories cat;\n\n    EXECUTE IMMEDIATE sql_query;\nEND;