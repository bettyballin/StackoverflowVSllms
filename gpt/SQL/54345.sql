;WITH FilteredBars AS (\n    SELECT\n        BarId,\n        FooId,\n        BarName\n    FROM\n        Bar\n    WHERE\n        BarName = 'SomeBar'\n),\nFilteredFoos AS (\n    SELECT\n        FooId,\n        FooName\n    FROM\n        Foo\n    WHERE\n        FooName = 'SomeFoo'\n        AND FooId IN (SELECT FooId FROM FilteredBars)\n)\nSELECT\n    FooId,\n    FooName,\n    (\n        SELECT\n            BarId,\n            FooId,\n            BarName\n        FROM\n            FilteredBars\n        WHERE\n            FilteredBars.FooId = FilteredFoos.FooId\n        FOR XML PATH('Bar'), TYPE\n    )\nFROM\n    FilteredFoos\nFOR XML PATH('Foo'), TYPE;