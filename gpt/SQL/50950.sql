WITH RankedMessages AS (\n    SELECT \n        MessageID, \n        SendingUserID, \n        ReceivingUserID,\n        ROW_NUMBER() OVER (PARTITION BY \n            LEAST(SendingUserID, ReceivingUserID), \n            GREATEST(SendingUserID, ReceivingUserID) \n            ORDER BY MessageID DESC) AS rn\n    FROM Messages\n)\nSELECT \n    MessageID, \n    SendingUserID, \n    ReceivingUserID\nFROM \n    RankedMessages\nWHERE \n    rn = 1;