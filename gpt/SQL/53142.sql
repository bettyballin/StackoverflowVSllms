CREATE PROC [dbo].[UpdateProductDetails]\nAS\nBEGIN\n    -- Set all E_CIKAN to 0 initially\n    UPDATE PRODUCTDETAILS SET E_CIKAN = 0;\n\n    -- Temporary table to store intermediate results\n    CREATE TABLE #TempProductDetails (\n        ID INT,\n        PRODUCTID VARCHAR(50),\n        QTY FLOAT,\n        EXITDEPOT VARCHAR(50),\n        ENTRYDEPOT VARCHAR(50),\n        E_CIKAN FLOAT\n    );\n\n    -- Insert necessary data into the temporary table\n    INSERT INTO #TempProductDetails (ID, PRODUCTID, QTY, EXITDEPOT, ENTRYDEPOT, E_CIKAN)\n    SELECT ID, PRODUCTID, QTY, EXITDEPOT, ENTRYDEPOT, 0\n    FROM PRODUCTDETAILS\n    WHERE EXITDEPOT IS NOT NULL;\n\n    DECLARE @DEMAND FLOAT, @REMAINS FLOAT;\n\n    -- Cursor to iterate through the temporary table\n    DECLARE SH CURSOR FAST_FORWARD FOR\n    SELECT ID, PRODUCTID, QTY, EXITDEPOT\n    FROM #TempProductDetails\n    ORDER BY [DATE] ASC;\n    \n    OPEN SH;\n    FETCH NEXT FROM SH INTO @ID, @SK, @DEMAND, @DP;\n\n    WHILE (@@FETCH_STATUS = 0)\n    BEGIN\n        -- Nested cursor to process entries for the current demand\n        DECLARE SA CURSOR FAST_FORWARD FOR\n        SELECT ID, QTY, E_CIKAN\n        FROM PRODUCTDETAILS\n        WHERE QTY > E_CIKAN AND PRODUCTID = @SK AND ENTRYDEPOT = @DP\n        ORDER BY [DATE] ASC;\n\n        OPEN SA;\n        FETCH NEXT FROM SA INTO @SUBID, @SUBQTY, @SUBCK;\n\n        WHILE (@@FETCH_STATUS = 0 AND @DEMAND > 0)\n        BEGIN\n            SET @REMAINS = @SUBQTY - @SUBCK;\n\n            IF @DEMAND > @REMAINS\n            BEGIN\n                UPDATE PRODUCTDETAILS SET E_CIKAN = QTY WHERE ID = @SUBID;\n                SET @DEMAND = @DEMAND - @REMAINS;\n            END\n            ELSE\n            BEGIN\n                UPDATE PRODUCTDETAILS SET E_CIKAN = E_CIKAN + @DEMAND WHERE ID = @SUBID;\n                SET @DEMAND = 0;\n            END\n\n            FETCH NEXT FROM SA INTO @SUBID, @SUBQTY, @SUBCK;\n        END\n\n        CLOSE SA;\n        DEALLOCATE SA;\n\n        FETCH NEXT FROM SH INTO @ID, @SK, @DEMAND, @DP;\n    END\n\n    CLOSE SH;\n    DEALLOCATE SH;\n\n    -- Clean up temporary table\n    DROP TABLE #TempProductDetails;\nEND