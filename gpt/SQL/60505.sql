DELIMITER //\n\nCREATE PROCEDURE process_queue()\nBEGIN\n    DECLARE done INT DEFAULT 0;\n    DECLARE current_num INT;\n    DECLARE cur CURSOR FOR SELECT num FROM update_queue;\n    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;\n\n    OPEN cur;\n\n    read_loop: LOOP\n        FETCH cur INTO current_num;\n        IF done THEN\n            LEAVE read_loop;\n        END IF;\n\n        -- Update the parent's tot value\n        UPDATE items SET tot = (\n            SELECT SUM(b.tot) FROM tree JOIN items AS b ON tree.term = b.num WHERE tree.orig = current_num\n        ) WHERE num = current_num;\n\n        -- Add the parent of the current node to the queue\n        INSERT IGNORE INTO update_queue (num) VALUES ((SELECT orig FROM tree WHERE term = current_num));\n        \n        -- Remove the processed node from the queue\n        DELETE FROM update_queue WHERE num = current_num;\n    END LOOP;\n\n    CLOSE cur;\nEND //\n\nDELIMITER ;