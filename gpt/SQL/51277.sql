CREATE PROCEDURE ProcessAuditMessages\nAS\nBEGIN\n    DECLARE @messageBody XML,\n            @messageType NVARCHAR(256),\n            @conversationHandle UNIQUEIDENTIFIER;\n\n    WHILE (1=1)\n    BEGIN\n        BEGIN TRANSACTION;\n\n        -- Receive the message\n        WAITFOR (\n            RECEIVE TOP(1)\n                @messageBody = CAST(message_body AS XML),\n                @messageType = message_type_name,\n                @conversationHandle = conversation_handle\n            FROM AuditQueue\n        ), TIMEOUT 5000;\n\n        IF (@@ROWCOUNT = 0)\n        BEGIN\n            ROLLBACK TRANSACTION;\n            BREAK;\n        END\n\n        -- Process the message\n        IF (@messageType = 'AuditMessage')\n        BEGIN\n            -- Insert the audit data into the Change tracking table\n            INSERT INTO ChangeTrackingTable (OldValue, NewValue)\n            SELECT\n                @messageBody.value('(//OldValue)[1]', 'NVARCHAR(MAX)'),\n                @messageBody.value('(//NewValue)[1]', 'NVARCHAR(MAX)');\n        END\n\n        -- End the conversation\n        END CONVERSATION @conversationHandle;\n\n        COMMIT TRANSACTION;\n    END\nEND;