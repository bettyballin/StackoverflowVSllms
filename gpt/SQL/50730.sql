DECLARE @cols AS NVARCHAR(MAX),\n        @query AS NVARCHAR(MAX)\n\n-- Get the list of positions dynamically\nSELECT @cols = STUFF((SELECT ',' + QUOTENAME(PositionName) \n                      FROM Position\n                      FOR XML PATH(''), TYPE\n                     ).value('.', 'NVARCHAR(MAX)') \n                ,1,1,'')\n\n-- Construct the dynamic pivot query\nSET @query = 'SELECT CID, CategoryName as CName, ' + @cols + ' \n              FROM \n              (\n                  SELECT c.CategoryID as CID, c.CategoryName, p.PositionName, \n                         ISNULL(cp.COrder, 0) as COrder\n                  FROM Category c\n                  LEFT JOIN CategoryPosition cp ON c.CategoryID = cp.CID\n                  LEFT JOIN Position p ON cp.PID = p.PositionID\n              ) x\n              PIVOT \n              (\n                  MAX(COrder)\n                  FOR PositionName IN (' + @cols + ')\n              ) p \n              ORDER BY CID'\n\n-- Execute the dynamic pivot query\nEXEC sp_executesql @query