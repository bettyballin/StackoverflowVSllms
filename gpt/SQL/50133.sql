WITH RankedSlots AS (\n    SELECT \n        ps.SlotNumber,\n        ps.FileId,\n        s.Rank,\n        ROW_NUMBER() OVER (PARTITION BY ps.SlotNumber ORDER BY s.Rank DESC, ps.FileId DESC) AS rn\n    FROM \n        dbo.PlaylistSlots ps\n    JOIN \n        dbo.Schedules s ON ps.PlaylistId = s.PlaylistId\n)\nSELECT \n    SlotNumber,\n    FileId,\n    Rank\nFROM \n    RankedSlots\nWHERE \n    rn = 1;