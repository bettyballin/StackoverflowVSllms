WITH DateDays AS (\n    SELECT \n        r.rangeId,\n        d.aDate,\n        d.doUse,\n        CASE WHEN d.doUse = 1 THEN SUM(d.doUse) OVER (PARTITION BY r.rangeId ORDER BY d.aDate) ELSE 0 END AS day\n    FROM \n        Dates d\n    JOIN \n        Range r ON d.aDate >= r.startDate\n),\nFilteredDateDays AS (\n    SELECT \n        rangeId, \n        aDate, \n        day\n    FROM \n        DateDays\n    WHERE \n        day > 0\n)\nSELECT \n    f.rangeId, \n    f.aDate, \n    CASE WHEN d.doUse = 1 THEN dy.qty ELSE 0 END AS qty\nFROM \n    FilteredDateDays f\nLEFT JOIN \n    (SELECT rangeId, day, qty FROM Days) dy\nON \n    f.rangeId = dy.rangeId AND f.day = dy.day\nORDER BY \n    f.rangeId, f.aDate;