BEGIN TRAN\n\nDECLARE @CONTACT_ID VARCHAR(15)\nDECLARE @TYPE VARCHAR(15)\nDECLARE @INDEX_NO  SMALLINT\nDECLARE @COUNTER SMALLINT\n\nDECLARE OUTER_CURSOR CURSOR \nFOR \nSELECT CONTACT_ID, TYPE, INDEX_NO FROM CONTACTS\nWHERE CONTACT_ID IN (SELECT CONTACT_ID FROM dbo.CONTACTS\n                     WHERE CONTACT_ID IN(...)\n                     GROUP BY CONTACT_ID, TYPE, INDEX_NO\n                     HAVING COUNT(*) > 1)\n\nOPEN OUTER_CURSOR \n\nFETCH NEXT FROM OUTER_CURSOR INTO @CONTACT_ID, @TYPE, @INDEX_NO\nWHILE @@FETCH_STATUS = 0\nBEGIN\n    SET @COUNTER = 1\n\n    DECLARE INNER_CURSOR CURSOR \n    FOR \n    SELECT * FROM CONTACTS\n    WHERE CONTACT_ID = @CONTACT_ID\n    AND TYPE = @TYPE \n    FOR UPDATE \n\n    OPEN INNER_CURSOR \n\n    FETCH NEXT FROM INNER_CURSOR \n    WHILE @@FETCH_STATUS = 0\n    BEGIN\n        UPDATE CONTACTS\n        SET INDEX_NO = @COUNTER\n        WHERE CURRENT OF INNER_CURSOR\n\n        SET @COUNTER = @COUNTER + 1\n\n        FETCH NEXT FROM INNER_CURSOR \n    END\n    CLOSE INNER_CURSOR\n    DEALLOCATE INNER_CURSOR\n\n    FETCH NEXT FROM OUTER_CURSOR INTO @CONTACT_ID, @TYPE, @INDEX_NO\nEND\nCLOSE OUTER_CURSOR\nDEALLOCATE OUTER_CURSOR\n\nCOMMIT TRAN