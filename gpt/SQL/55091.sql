INSERT INTO DocLink (IssueKey, DocKey)\nSELECT \n    i.IssueKey,\n    d.DocKey\nFROM \n    Issue i\nJOIN \n    (\n        SELECT \n            IssueID, \n            Mid(References, StartPos, Len) AS DocID\n        FROM \n            TempIssue,\n            (\n                SELECT \n                    Number AS StartPos,\n                    Number + CHARINDEX('DocID', Substring(References, Number + 1, LEN(References))) - 1 AS EndPos\n                FROM \n                    TempIssue, \n                    master..spt_values\n                WHERE \n                    Type = 'P' \n                    AND Number BETWEEN 1 AND LEN(References)\n                    AND Substring(References, Number, 5) = 'DocID'\n            ) AS SplitPos\n        WHERE \n            LEN(References) >= StartPos\n    ) AS SplitReferences\nJOIN \n    Docs d\nON \n    SplitReferences.DocID = d.DocID\nWHERE \n    i.IssueID = SplitReferences.IssueID\nAND NOT EXISTS (\n    SELECT 1\n    FROM DocLink dl\n    WHERE dl.IssueKey = i.IssueKey\n      AND dl.DocKey = d.DocKey\n);