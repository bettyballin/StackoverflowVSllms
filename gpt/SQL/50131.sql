SET @batch_size = 10000;\n   SET @offset = 0;\n   SET @total_records = (SELECT COUNT(*) FROM old_table);\n\n   WHILE @offset < @total_records DO\n       INSERT INTO new_table (record_id, data_field)\n       SELECT DISTINCT record_id, data_field\n       FROM old_table\n       LIMIT @offset, @batch_size\n       ON DUPLICATE KEY UPDATE record_id = record_id;\n\n       INSERT INTO new_table_index (date, index_id)\n       SELECT old_table.date, new_table.index_id\n       FROM old_table\n       JOIN new_table ON old_table.record_id = new_table.record_id \n                      AND old_table.data_field = new_table.data_field\n       LIMIT @offset, @batch_size;\n\n       SET @offset = @offset + @batch_size;\n   END WHILE;