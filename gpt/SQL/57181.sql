CREATE PROCEDURE SearchCustomers\n    @LastName NVARCHAR(50),\n    @FirstName NVARCHAR(50),\n    @StateProvince NVARCHAR(50),\n    @City NVARCHAR(50),\n    @Zip NVARCHAR(50)\nAS\nBEGIN\n    -- Use a temporary table instead of a table variable\n    CREATE TABLE #tempCustTable (\n        CustomerID INT,\n        FirstName NVARCHAR(50),\n        LastName NVARCHAR(50),\n        City NVARCHAR(50),\n        StateProvince NVARCHAR(50),\n        Zip NVARCHAR(10),\n        PhoneNumber NVARCHAR(20)\n    );\n\n    DECLARE @sql NVARCHAR(MAX);\n    SET @sql = '\n        INSERT INTO #tempCustTable (CustomerID, FirstName, LastName, City, StateProvince, Zip, PhoneNumber)\n        SELECT DISTINCT cu.CustomerID, cu.FirstName, cu.LastName, a.City, a.StateProvince, a.Zip, p.PhoneNumber\n        FROM Customer cu WITH(NOLOCK)\n        LEFT OUTER JOIN Address a WITH(NOLOCK) ON cu.CustomerID = a.CustomerID\n        LEFT OUTER JOIN Phone p WITH(NOLOCK) ON cu.CustomerID = p.CustomerID\n        WHERE 1=1';\n\n    IF @LastName IS NOT NULL\n        SET @sql = @sql + ' AND (cu.LastName = @LastName OR cu.LastName LIKE @LastName + ''%'')';\n    IF @FirstName IS NOT NULL\n        SET @sql = @sql + ' AND (cu.FirstName = @FirstName OR cu.FirstName LIKE @FirstName + ''%'')';\n    IF @StateProvince <> ''\n        SET @sql = @sql + ' AND a.StateProvince LIKE @StateProvince';\n    IF @City <> ''\n        SET @sql = @sql + ' AND a.City LIKE @City + ''%''';\n    IF @Zip <> ''\n        SET @sql = @sql + ' AND (a.Zip = @Zip OR a.Zip LIKE @Zip + ''%'')';\n\n    SET @sql = @sql + ' ORDER BY cu.LastName, cu.FirstName';\n\n    EXEC sp_executesql @sql, N'@LastName NVARCHAR(50), @FirstName NVARCHAR(50), @StateProvince NVARCHAR(50), @City NVARCHAR(50), @Zip NVARCHAR(50)',\n        @LastName, @FirstName, @StateProvince, @City, @Zip;\n\n    -- Output the results\n    SELECT * FROM #tempCustTable;\n\n    -- Cleanup\n    DROP TABLE #tempCustTable;\nEND;