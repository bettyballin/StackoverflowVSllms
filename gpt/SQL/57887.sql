WITH CurrentInsurance AS (\n    SELECT\n        tr1.*,\n        ROW_NUMBER() OVER (PARTITION BY tr1.person_id ORDER BY tr1.effdate DESC) AS rn\n    FROM \n        [transaction] tr1\n    LEFT OUTER JOIN \n        [d_vendor] ins1 ON ins1.d_vendor_id = tr1.d_vendor_id\n    LEFT OUTER JOIN \n        [d_product_type] prodtype1 ON prodtype1.d_product_type_id = tr1.d_product_type_id\n    LEFT OUTER JOIN \n        [d_commission_type] ctype1 ON ctype1.d_commission_type_id = tr1.d_commission_type_id\n    WHERE\n        prodtype1.name <> 'Medicare Part D'\n        AND tr1.termdate IS NULL\n),\nPreviousInsurance AS (\n    SELECT\n        tr2.*,\n        ROW_NUMBER() OVER (PARTITION BY tr2.person_id ORDER BY tr2.termdate DESC) AS rn\n    FROM \n        [transaction] tr2\n    LEFT OUTER JOIN \n        [d_vendor] ins2 ON ins2.d_vendor_id = tr2.d_vendor_id\n    LEFT OUTER JOIN \n        [d_product_type] prodtype2 ON prodtype2.d_product_type_id = tr2.d_product_type_id\n    LEFT OUTER JOIN \n        [d_commission_type] ctype2 ON ctype2.d_commission_type_id = tr2.d_commission_type_id\n    WHERE\n        prodtype2.name <> 'Medicare Part D'\n        AND tr2.termdate IS NOT NULL\n)\n\nSELECT \n    p.person_id AS 'MIRID',\n    p.firstname AS 'FIRST',\n    p.lastname AS 'LAST',\n    pg.name AS 'GROUP',\n    e.name AS 'AOR',\n    p.leaddate AS 'CONTACT DATE',\n    [dbo].[GetPICampaignDisp](p.person_id, '2009') AS 'PI - 2009',\n    [dbo].[GetPICampaignDisp](p.person_id, '2008') AS 'PI - 2008',\n    [dbo].[GetPICampaignDisp](p.person_id, '2007') AS 'PI - 2007',\n    a_disp.name AS 'CURR DISP',\n    a_ins.name AS 'CURR INS',\n    a_prodtype.name AS 'CURR INS TYPE',\n    a_t.date AS 'CURR INS APP DATE',\n    a_t.effdate AS 'CURR INS EFF DATE',\n    b_disp.name AS 'PREV DISP',\n    b_ins.name AS 'PREV INS',\n    b_prodtype.name AS 'PREV INS TYPE',\n    b_t.date AS 'PREV INS APP DATE',\n    b_t.effdate AS 'PREV INS EFF DATE',\n    b_t.termdate AS 'PREV INS TERM DATE'\nFROM \n    [person] p\nLEFT OUTER JOIN \n    [employee] e ON e.employee_id = p.agentofrecord_id\nINNER JOIN \n    [dbo].[person_physician] pp ON p.person_id = pp.person_id\nINNER JOIN \n    [dbo].[physician] ph ON ph.physician_id = pp.physician_id\nINNER JOIN \n    [dbo].[clinic] c ON c.clinic_id = ph.clinic_id\nINNER JOIN \n    [dbo].[d_Physgroup] pg ON pg.d_physgroup_id = c.physgroup_id\nLEFT OUTER JOIN \n    CurrentInsurance a_t ON a_t.person_id = p.person_id AND a_t.rn = 1\nLEFT OUTER JOIN \n    PreviousInsurance b_t ON b_t.person_id = p.person_id AND b_t.rn = 1\nLEFT OUTER JOIN \n    [d_vendor] a_ins ON a_ins.d_vendor_id = a_t.d_vendor_id\nLEFT OUTER JOIN \n    [d_product_type] a_prodtype ON a_prodtype.d_product_type_id = a_t.d_product_type_id\nLEFT OUTER JOIN \n    [d_disp] a_disp ON a_disp.d_disp_id = a_t.d_disp_id\nLEFT OUTER JOIN \n    [d_vendor] b_ins ON b_ins.d_vendor_id = b_t.d_vendor_id\nLEFT OUTER JOIN \n    [d_product_type] b_prodtype ON b_prodtype.d_product_type_id = b_t.d_product_type_id\nLEFT OUTER JOIN \n    [d_disp] b_disp ON b_disp.d_disp_id = b_t.d_disp_id