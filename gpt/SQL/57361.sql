WITH RankedActions AS (\n    SELECT \n        ua.userid,\n        ua.action_date,\n        ROW_NUMBER() OVER (PARTITION BY ua.userid ORDER BY ua.action_date) AS rn\n    FROM \n        user_actions ua\n    INNER JOIN \n        users u ON ua.userid = u.userid\n    WHERE \n        ua.action_date >= u.pay_date\n)\nSELECT \n    u.userid,\n    u.pay_date,\n    ra.action_date\nFROM \n    users u\nLEFT JOIN \n    RankedActions ra ON u.userid = ra.userid AND ra.rn = 1\nORDER BY \n    u.userid;