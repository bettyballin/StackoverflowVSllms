WITH RankedPrices AS (\n    SELECT\n        Product,\n        Region,\n        Store,\n        Price,\n        ROW_NUMBER() OVER (\n            PARTITION BY Product, COALESCE(Region, -1), COALESCE(Store, -1)\n            ORDER BY \n                CASE WHEN Region IS NOT NULL AND Store IS NOT NULL THEN 3\n                     WHEN Region IS NOT NULL THEN 2\n                     WHEN Store IS NOT NULL THEN 1\n                     ELSE 0\n                END DESC\n        ) AS PriceRank\n    FROM \n        Prices\n)\nSELECT \n    Product,\n    Region,\n    Store,\n    Price\nFROM \n    RankedPrices\nWHERE \n    PriceRank = 1\nORDER BY \n    Product, Region, Store;