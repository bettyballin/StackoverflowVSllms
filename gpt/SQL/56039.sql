WITH MostRecentActions AS (\n    SELECT \n        track.historyID,\n        track.action,\n        track.trackDateTime,\n        ROW_NUMBER() OVER (PARTITION BY track.historyID ORDER BY track.trackDateTime DESC) AS RowNum\n    FROM \n        RS_HistoryTracker track\n    WHERE \n        (track.action = 'STATUS:INITIAL:DRAFT'\n         OR track.action = 'STATUS:DELETED:DRAFT'\n         OR track.action = 'STATUS:DRAFT:DRAFT')\n        AND track.trackDateTime <= @endOfWeek\n)\nSELECT \n    COUNT(DISTINCT his.historyID) AS theCount\nFROM \n    RS_History his\nWHERE \n    his.historyID IN (\n        SELECT \n            historyID\n        FROM \n            MostRecentActions\n        WHERE \n            RowNum = 1\n    );