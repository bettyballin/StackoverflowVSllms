BEGIN TRANSACTION;\n\n-- Step 1: Insert new contacts\nWITH NewContacts AS (\n    INSERT INTO Contacts (UserID, FirstName, LastName, EmailAddress)\n    OUTPUT INSERTED.ID, INSERTED.UserID, INSERTED.EmailAddress\n    SELECT DISTINCT \n        t1.UserID, t1.FirstName, t1.LastName, t1.EmailAddress\n    FROM \n        ContactImportStaging AS t1\n    WHERE \n        NOT EXISTS (\n            SELECT 1 \n            FROM Contacts AS c\n            WHERE \n                c.UserID = t1.UserID \n                AND c.EmailAddress = t1.EmailAddress \n                AND c.FirstName = t1.FirstName \n                AND c.LastName = t1.LastName\n        )\n)\n\n-- Step 2 & 3: Insert into ContactGroupMapping\nINSERT INTO ContactGroupMapping (ContactID, GroupID)\nSELECT \n    nc.ID, \n    s.GroupID\nFROM \n    NewContacts AS nc\nJOIN \n    ContactImportStaging AS s\nON \n    nc.UserID = s.UserID\n    AND nc.EmailAddress = s.EmailAddress;\n\nCOMMIT TRANSACTION;