WITH LatestListed AS (\n    SELECT\n        S.ProductCode,\n        L.SKU,\n        ROW_NUMBER() OVER (PARTITION BY S.ProductCode ORDER BY L.ListDate DESC) AS rn\n    FROM\n        Stock S\n    INNER JOIN\n        Listed L ON S.SKU = L.SKU\n    WHERE\n        S.StatusCode = 2\n        AND NOT EXISTS (\n            SELECT 1\n            FROM Stock S2\n            WHERE S2.ProductCode = S.ProductCode\n            AND S2.StatusCode = 1\n        )\n)\nUPDATE Stock\nSET StatusCode = 1\nFROM Stock S\nINNER JOIN LatestListed LL ON S.SKU = LL.SKU\nWHERE LL.rn = 1;