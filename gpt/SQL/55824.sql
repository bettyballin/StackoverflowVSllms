CREATE PROCEDURE CheckLicenseOveruse\n    @LicenseLimit INT\nAS\nBEGIN\n    SELECT \n        LoginDateTime,\n        COUNT(UserId) AS SimultaneousUsers\n    INTO #LoginCounts\n    FROM UserLogins\n    WHERE LogoutDateTime IS NULL\n    GROUP BY LoginDateTime;\n\n    SELECT \n        LogoutDateTime,\n        COUNT(UserId) AS SimultaneousUsers\n    INTO #LogoutCounts\n    FROM UserLogins\n    WHERE LogoutDateTime IS NOT NULL\n    GROUP BY LogoutDateTime;\n\n    SELECT \n        DateTime,\n        SUM(SimultaneousUsers) OVER (ORDER BY DateTime ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS CurrentUsers\n    INTO #UserCounts\n    FROM (\n        SELECT LoginDateTime AS DateTime, SimultaneousUsers FROM #LoginCounts\n        UNION ALL\n        SELECT LogoutDateTime AS DateTime, -SimultaneousUsers FROM #LogoutCounts\n    ) AS UserEvents\n    ORDER BY DateTime;\n\n    SELECT * \n    FROM #UserCounts\n    WHERE CurrentUsers > @LicenseLimit;\n\n    DROP TABLE #LoginCounts;\n    DROP TABLE #LogoutCounts;\n    DROP TABLE #UserCounts;\nEND