WITH distance_ranked AS (\n    SELECT \n        zr.zip AS zip_required,\n        za.zip AS zip_available,\n        zipdistance(zr.zip, za.zip) AS distance,\n        za.locations,\n        SUM(za.locations) OVER (PARTITION BY zr.zip ORDER BY zipdistance(zr.zip, za.zip)) AS running_total\n    FROM \n        zips_required zr\n    JOIN \n        zips_available za ON 1=1\n)\nSELECT \n    zip_required,\n    MIN(distance) AS min_distance\nFROM \n    distance_ranked\nWHERE \n    running_total >= :n\nGROUP BY \n    zip_required;