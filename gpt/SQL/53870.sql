WITH PeakLoad AS (\n       SELECT TOP 5\n           DATEPART(YEAR, CreateDate) AS Year,\n           DATEPART(MONTH, CreateDate) AS Month,\n           DATEPART(DAY, CreateDate) AS Day,\n           DATEPART(HOUR, CreateDate) AS Hour,\n           DATEPART(MINUTE, CreateDate) AS Minute,\n           DATEPART(SECOND, CreateDate) AS Second,\n           COUNT(*) AS MessagesPerSecond\n       FROM\n           Message\n       GROUP BY\n           DATEPART(YEAR, CreateDate),\n           DATEPART(MONTH, CreateDate),\n           DATEPART(DAY, CreateDate),\n           DATEPART(HOUR, CreateDate),\n           DATEPART(MINUTE, CreateDate),\n           DATEPART(SECOND, CreateDate)\n       ORDER BY\n           MessagesPerSecond DESC\n   )\n   SELECT\n       AVG(MessagesPerSecond) AS AvgMessagesPerSecond\n   FROM\n       PeakLoad;