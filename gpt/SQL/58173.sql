WITH FirstLastActivity AS (\n    SELECT\n        sessionid,\n        MIN(created) AS first_created,\n        MAX(created) AS last_created\n    FROM\n        activity_details\n    GROUP BY\n        sessionid\n),\nFirstActivity AS (\n    SELECT\n        ad.sessionid,\n        ad.activity_description AS first_activity_desc\n    FROM\n        activity_details ad\n    JOIN\n        FirstLastActivity fla ON ad.sessionid = fla.sessionid AND ad.created = fla.first_created\n),\nLastActivity AS (\n    SELECT\n        ad.sessionid,\n        ad.activity_description AS last_activity_desc\n    FROM\n        activity_details ad\n    JOIN\n        FirstLastActivity fla ON ad.sessionid = fla.sessionid AND ad.created = fla.last_created\n)\nINSERT INTO activity_summary (sessionid, first_activity_desc, last_activity_desc)\nSELECT\n    a.sessionid,\n    fa.first_activity_desc,\n    la.last_activity_desc\nFROM\n    activity a\nJOIN\n    FirstActivity fa ON a.sessionid = fa.sessionid\nJOIN\n    LastActivity la ON a.sessionid = la.sessionid;