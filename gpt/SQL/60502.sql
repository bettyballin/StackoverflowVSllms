WITH DB_CPU_Stats\nAS\n(\n    SELECT\n        DatabaseID,\n        DB_Name(DatabaseID) AS [DatabaseName],\n        SUM(total_worker_time) AS [CPU_Time]\n    FROM\n        sys.dm_exec_query_stats AS qs\n    CROSS APPLY\n        (SELECT\n             CONVERT(int, value) AS [DatabaseID]\n         FROM\n             sys.dm_exec_plan_attributes(qs.plan_handle)\n         WHERE\n             attribute = N'dbid') AS F_DB\n    GROUP BY\n        DatabaseID\n)\nSELECT\n    ROW_NUMBER() OVER(ORDER BY [CPU_Time] DESC) AS [Rank],\n    [DatabaseName],\n    [CPU_Time] AS [CPU Time (ms)],\n    [CPU_Time] * 1.0 / SUM([CPU_Time]) OVER() * 100 AS [CPU Percentage]\nFROM\n    DB_CPU_Stats\nWHERE\n    DatabaseID > 4 -- system databases\nORDER BY\n    [CPU Time (ms)] DESC;