WITH ObsMax AS (\n    SELECT ObsMax2.pId, ObsMax2.hdId, MAX(ObsMax2.obsDate) AS maxDate\n    FROM ml.Obs ObsMax2\n    WHERE ObsMax2.obsDate < :EndDate\n    GROUP BY ObsMax2.pId, ObsMax2.hdId\n)\nSELECT Person.*, Obs.*\nFROM ml.Person Person\nJOIN ml.Obs Obs ON Person.pID = Obs.pId\nJOIN ObsMax ON Obs.pId = ObsMax.pId\n    AND Obs.hdId = ObsMax.hdId\n    AND Obs.obsDate = ObsMax.maxDate;