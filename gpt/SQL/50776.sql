WITH CategoryHierarchy AS (\n    -- Anchor member: start with each category\n    SELECT CategoryId, ParentCategoryId\n    FROM Category\n    UNION ALL\n    -- Recursive member: join with parent categories\n    SELECT c.CategoryId, ch.ParentCategoryId\n    FROM Category c\n    INNER JOIN CategoryHierarchy ch ON c.ParentCategoryId = ch.CategoryId\n)\n-- Select distinct combinations of ProductId and CategoryId\nSELECT DISTINCT pc.ProductId, ch.ParentCategoryId AS CategoryId\nFROM ProductCategory pc\nINNER JOIN CategoryHierarchy ch ON pc.CategoryId = ch.CategoryId\nUNION\n-- Add root level categories (CategoryId = 0)\nSELECT DISTINCT pc.ProductId, 0 AS CategoryId\nFROM ProductCategory pc\nORDER BY 1, 2;