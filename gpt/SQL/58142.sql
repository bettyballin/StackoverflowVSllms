WITH LastUpdates AS (\n    SELECT\n        UpdateID,\n        ProductID,\n        UpdateDateTime,\n        QuantityOnHand,\n        ROW_NUMBER() OVER (\n            PARTITION BY CAST(UpdateDateTime AS DATE)\n            ORDER BY UpdateDateTime DESC\n        ) AS rn\n    FROM\n        InventoryHistory\n    WHERE\n        ProductID = 1\n        AND UpdateDateTime < DATEADD(HOUR, 17, CAST(UpdateDateTime AS DATE))\n        AND UpdateDateTime >= DATEADD(DAY, -30, GETDATE())\n)\nSELECT\n    UpdateID,\n    ProductID,\n    UpdateDateTime,\n    QuantityOnHand\nFROM\n    LastUpdates\nWHERE\n    rn = 1\nORDER BY\n    UpdateDateTime;