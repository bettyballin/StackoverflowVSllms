WITH transaction_sums AS (\n    SELECT  td.transaction_id,\n        SUM(IF(\n                COALESCE(ti.na, -1) = 0\n                AND COALESCE(ti.special_info_type, -1) = 0\n                AND COALESCE(ti.item_type, '') = 'P'\n                AND COALESCE(ti.comp_id, 0) <= 0,\n                COALESCE(disc_amt, 0),\n                0\n            )) AS disc_sum,\n        SUM(IF(\n                COALESCE(ti.na, -1) = 0\n                AND COALESCE(ti.special_info_type, -1) = 0\n                AND COALESCE(ti.item_type, '') = 'P'\n                AND COALESCE(ti.comp_id, 0) > 0,\n                COALESCE(comp_amt, 0),\n                0\n            )) AS cSM,\n        SUM(IF(\n                COALESCE(ti.na, -1) = 0\n                AND COALESCE(ti.special_info_type, -1) = 0\n                AND COALESCE(ti.item_type, '') = 'P'\n                AND COALESCE(ti.comp_id, 0) > 0,\n                COALESCE(comp_tax, 0),\n                0\n            )) AS cTX\n    FROM transaction_details td\n    LEFT OUTER JOIN transaction_items ti\n        ON ti.transaction_id = td.transaction_id\n    WHERE td.na = 0\n        AND td.entry_TS >= ?\n        AND td.entry_TS < ?\n    GROUP BY td.transaction_id\n),\nrefund_sums AS (\n    SELECT  tiP.transaction_id,\n            COUNT(x.id) AS refCnt,\n            COALESCE(SUM(x.item_price + x.sub_price), 0) AS refAmt,\n            COALESCE(SUM(x.efftax), 0) AS refTax\n    FROM (\n        SELECT  tiP.transaction_id,\n                (tiP.item_price - tiP.comp_amt) AS item_price,\n                COALESCE(SUM(tiA.item_price), 0) AS sub_price,\n                (tiP.efftax - tiP.comp_tax) AS efftax,\n                tiP.id\n        FROM transaction_items tiP\n        LEFT OUTER JOIN transaction_items tiA\n            ON tiP.id = tiA.ref_id\n            AND tiA.item_type = 'A'\n            AND tiA.na = 0\n        WHERE tiP.item_type = 'P'\n            AND tiP.na = 0\n            AND tiP.refund = 1\n        GROUP BY tiP.id\n    ) AS x\n    GROUP BY tiP.transaction_id\n)\nSELECT ts.transaction_id, ts.disc_sum, ts.cSM, ts.cTX, rs.refCnt, rs.refAmt, rs.refTax\nFROM transaction_sums ts\nLEFT JOIN refund_sums rs\n    ON ts.transaction_id = rs.transaction_id;