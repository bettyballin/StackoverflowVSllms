WITH CoalesceValues AS (\n    SELECT \n        tbl1.gid,\n        COALESCE(t1_end_dt, t6_actl_end_dt, t6_calc_end_dt) AS perd_end_dt,\n        t1_end_dt,\n        tbl2.t2_strt_dt,\n        tbl2.t2_end_dt,\n        tbl3.t3_strt_dt,\n        tbl3.t3_end_dt,\n        tbl4_a.t4_pk AS t4_a_pk,\n        tbl4_b.t4_or_id AS t4_b_or_id,\n        tbl4_a.t4_or_id AS t4_a_or_id,\n        t7_or_id\n    FROM tbl1\n    JOIN tbl2 ON (t2_pk = wpck_wrkr_id AND t2_ind_1 = 'Y')\n    JOIN tbl3 ON t3_pk = t2_fk_t3_pk\n    LEFT JOIN tbl4 tbl4_a ON tbl4_a.t4_pk = chkw_wkt_id\n    -- other joins and conditions\n)\nSELECT \n    gid,\n    perd_end_dt,\n    t1_end_dt\n    -- other columns\nFROM CoalesceValues\nWHERE \n    perd_end_dt BETWEEN t2_strt_dt AND t2_end_dt\n    AND perd_end_dt BETWEEN t3_strt_dt AND t3_end_dt\nGROUP BY gid, perd_end_dt, t1_end_dt, COALESCE(t4_b_or_id, t4_a_or_id, t7_or_id)\nORDER BY perd_end_dt;