SELECT lo4.*\nFROM\n(\n    SELECT CASE WHEN ln.log_id IS NULL THEN lo2.log_id ELSE ln.log_id END AS log_id, \n           ROW_NUMBER() OVER (PARTITION BY lo2.fb_id ORDER BY lo2.cdate) AS rn\n    FROM\n    (\n        SELECT lo.*,\n               (SELECT TOP 1 log_id\n                FROM t_log li \n                WHERE li.fb_id = lo.fb_id \n                  AND li.cdate >= lo.cdate\n                  AND li.log_id > lo.log_id \n                  AND li.log_name <> lo.log_name\n                ORDER BY cdate, log_id) AS next_id\n        FROM t_log lo\n    ) lo2 \n    LEFT OUTER JOIN t_log ln ON ln.log_id = lo2.next_id\n) lo3, t_log lo4\nWHERE lo3.rn = 1 \n  AND lo4.log_id = lo3.log_id