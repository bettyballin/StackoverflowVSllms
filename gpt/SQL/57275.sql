WITH PurchasesWithMonthEnd AS (\n    SELECT \n        CustomerID, \n        Date,\n        EOMONTH(Date) AS MonthEnd,\n        ROW_NUMBER() OVER (PARTITION BY CustomerID, EOMONTH(Date) ORDER BY ABS(DATEDIFF(day, Date, EOMONTH(Date)))) AS rn\n    FROM \n        Purchase\n)\nSELECT \n    CustomerID, \n    Date\nFROM \n    PurchasesWithMonthEnd\nWHERE \n    rn = 1\nORDER BY \n    CustomerID, Date;