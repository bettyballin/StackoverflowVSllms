-- Step 1: Filter PageViews table and store results in a temporary table\nSELECT pv.SessionID, pv.Created, pv.PageUrl\nINTO #FilteredPageViews\nFROM PageViews pv\nWHERE charindex(@MatchValue, pv.PageUrl) > 0\n    AND pv.Created > (SELECT MIN(c.LastDate) FROM @Conversions c WHERE c.GoalName = @GoalName);\n\n-- Step 2: Update the @Conversions table using the filtered results\nUPDATE c\nSET\n    LastStep = @StepNumber,\n    LastDate = pv.Created\nFROM\n    @Conversions c\n    INNER JOIN #FilteredPageViews pv ON c.SessionID = pv.SessionID\nWHERE\n    c.GoalName = @GoalName\n    AND pv.Created > c.LastDate;\n\n-- Step 3: Drop the temporary table\nDROP TABLE #FilteredPageViews;