CREATE FUNCTION dbo.YearFrac(\n    @startDate DATETIME,\n    @endDate DATETIME\n)\nRETURNS FLOAT\nAS\nBEGIN\n    DECLARE @years INT,\n            @daysInStartYear INT,\n            @daysFromStartYear FLOAT,\n            @daysInEndYear INT,\n            @daysInBetweenYears INT,\n            @result FLOAT\n\n    -- Calculate the number of whole years between the dates\n    SET @years = DATEDIFF(YEAR, @startDate, @endDate)\n\n    -- Adjust if the end date is earlier in the year than the start date\n    IF DATEADD(YEAR, @years, @startDate) > @endDate\n        SET @years = @years - 1\n\n    -- Calculate the fractional part of the first year\n    SET @daysInStartYear = DATEDIFF(DAY, @startDate, DATEADD(YEAR, 1, @startDate))\n    SET @daysFromStartYear = DATEDIFF(DAY, @startDate, DATEADD(YEAR, 1, @startDate)) - DATEDIFF(DAY, DATEADD(YEAR, @years, @startDate), @endDate)\n\n    -- Calculate the fractional part of the last year\n    SET @daysInEndYear = DATEDIFF(DAY, DATEADD(YEAR, -1, @endDate), @endDate)\n\n    -- Calculate the total result\n    SET @result = @years + (@daysFromStartYear / @daysInStartYear) + (DATEDIFF(DAY, DATEADD(YEAR, -1, @endDate), @endDate) / @daysInEndYear)\n\n    RETURN @result\nEND