CREATE TABLE #tmp\n(\n    Atype VARCHAR(10),\n    Btype VARCHAR(10)\n);\n\nINSERT INTO #tmp VALUES ('a', 'x');\nINSERT INTO #tmp VALUES ('b', 'x');\nINSERT INTO #tmp VALUES ('a', 'y');\nINSERT INTO #tmp VALUES ('a', 'y');\nINSERT INTO #tmp VALUES ('b', 'z');\nINSERT INTO #tmp VALUES ('b', 'y');\n\nDECLARE @cols AS NVARCHAR(MAX),\n        @query AS NVARCHAR(MAX);\n\n-- Get distinct values of Btype to create the columns dynamically\nSELECT @cols = STRING_AGG(QUOTENAME(Btype), ',')\nFROM (SELECT DISTINCT Btype FROM #tmp) AS B;\n\n-- Construct the dynamic SQL query\nSET @query = '\nSELECT Atype, ' + @cols + '\nFROM\n(\n    SELECT Atype, Btype, COUNT(*) AS count\n    FROM #tmp\n    GROUP BY Atype, Btype\n) AS SourceTable\nPIVOT\n(\n    MAX(count)\n    FOR Btype IN (' + @cols + ')\n) AS PivotTable\nORDER BY Atype;';\n\n-- Execute the dynamic SQL query\nEXEC sp_executesql @query;\n\nDROP TABLE #tmp;