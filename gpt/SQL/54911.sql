WITH RankedTemperatures AS (\n    SELECT\n        locId,\n        dtg,\n        temp,\n        ROW_NUMBER() OVER (PARTITION BY locId ORDER BY dtg DESC) AS rn\n    FROM\n        temperature_table\n),\nFilteredTemperatures AS (\n    SELECT\n        locId,\n        temp AS current_temp,\n        LAG(temp) OVER (PARTITION BY locId ORDER BY dtg DESC) AS previous_temp\n    FROM\n        RankedTemperatures\n    WHERE\n        rn <= 2\n)\nSELECT\n    locId,\n    (current_temp - previous_temp) AS change\nFROM\n    FilteredTemperatures\nWHERE\n    previous_temp IS NOT NULL\nORDER BY\n    locId;