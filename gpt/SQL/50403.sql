SELECT \n    i.invoice_id,\n    i.user_id,\n    i.invoice_type,\n    rp.price\nFROM \n    invoices i\nJOIN \n    users u ON i.user_id = u.user_id\nJOIN \n    rate_prices rp ON \n    (i.invoice_type = 'package' AND rp.rate_id = u.rate_package_id)\n    OR \n    (i.invoice_type = 'document' AND rp.rate_id = u.rate_document_id)\nWHERE\n    rp.weight = (SELECT MAX(rp2.weight) \n                 FROM rate_prices rp2 \n                 WHERE rp2.rate_id = rp.rate_id \n                 AND rp2.weight <= i.weight);