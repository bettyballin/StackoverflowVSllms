WITH user_locations AS (\n  SELECT `users`.`first_name`, `users`.`last_name`, `users`.`email`,\n  SUBSTRING(`locations`.`raw`, -6, 4) AS `guaranteed_postcode`\n  FROM `users`\n  LEFT OUTER JOIN `locations` ON `users`.`id` = `locations`.`user_id`\n)\nSELECT `first_name`, `last_name`, `email`, `guaranteed_postcode`\nFROM user_locations\nWHERE `guaranteed_postcode` NOT IN (\n  SELECT `postcode` FROM `postcodes` WHERE `region` IN ('australia')\n);