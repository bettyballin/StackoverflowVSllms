WITH EarningCTE AS (\n    SELECT\n        CustomerId,\n        DATEPART(YEAR, Date) AS Year,\n        DATEPART(MONTH, Date) AS Month,\n        SUM(Earning) AS TotalEarning\n    FROM Stats\n    GROUP BY CustomerId, DATEPART(YEAR, Date), DATEPART(MONTH, Date)\n),\nBonusCTE AS (\n    SELECT\n        CustomerId,\n        DATEPART(YEAR, Date) AS Year,\n        DATEPART(MONTH, Date) AS Month,\n        SUM(Amount) AS TotalBonus\n    FROM Bonus\n    GROUP BY CustomerId, DATEPART(YEAR, Date), DATEPART(MONTH, Date)\n),\nPaymentCTE AS (\n    SELECT\n        p.CustomerId,\n        p.Id AS PaymentId,\n        DATEPART(YEAR, p.DateFrom) AS Year,\n        DATEPART(MONTH, p.DateFrom) AS Month,\n        SUM(cp.Quantity * cp.UnitPrice) AS TotalCampaignAmount,\n        SUM(bp.Amount) AS TotalBonusAmount,\n        p.DateFrom,\n        p.DateTo\n    FROM Payments p\n    LEFT JOIN CampaignPayment cp ON p.Id = cp.PaymentId\n    LEFT JOIN BonusPayment bp ON p.Id = bp.PaymentId\n    GROUP BY p.CustomerId, p.Id, DATEPART(YEAR, p.DateFrom), DATEPART(MONTH, p.DateFrom), p.DateFrom, p.DateTo\n),\nMonthlyCTE AS (\n    SELECT\n        c.Id AS CustomerId,\n        c.Name AS CustomerName,\n        ISNULL(pc.PaymentId, NULL) AS PaymentId,\n        ISNULL(pc.TotalCampaignAmount, 0) AS Amount,\n        ISNULL(pc.TotalBonusAmount, 0) AS BonusAmount,\n        pc.DateFrom,\n        pc.DateTo,\n        ec.TotalEarning,\n        bc.TotalBonus,\n        DATEFROMPARTS(ec.Year, ec.Month, 1) AS FirstDayOfMonth,\n        EOMONTH(DATEFROMPARTS(ec.Year, ec.Month, 1)) AS LastDayOfMonth\n    FROM Customers c\n    LEFT JOIN EarningCTE ec ON c.Id = ec.CustomerId\n    LEFT JOIN BonusCTE bc ON c.Id = bc.CustomerId AND ec.Year = bc.Year AND ec.Month = bc.Month\n    LEFT JOIN PaymentCTE pc ON c.Id = pc.CustomerId AND ec.Year = pc.Year AND ec.Month = pc.Month\n)\nSELECT\n    CustomerId,\n    CustomerName,\n    PaymentId,\n    CASE \n        WHEN PaymentId IS NULL THEN (TotalEarning - Amount)\n        ELSE Amount\n    END AS Amount,\n    CASE \n        WHEN PaymentId IS NULL THEN (TotalBonus - BonusAmount)\n        ELSE BonusAmount\n    END AS BonusAmount,\n    COALESCE(DateFrom, FirstDayOfMonth) AS DateFrom,\n    COALESCE(DateTo, LastDayOfMonth) AS DateTo\nFROM MonthlyCTE