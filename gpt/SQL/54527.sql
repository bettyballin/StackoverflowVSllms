WITH RankedStudents AS (\n    SELECT\n        ProfessorID,\n        StudentID,\n        Mark,\n        ROW_NUMBER() OVER (PARTITION BY ProfessorID ORDER BY Mark DESC) AS Rank\n    FROM\n        your_table\n),\nFilteredProfessors AS (\n    SELECT\n        ProfessorID\n    FROM\n        your_table\n    GROUP BY\n        ProfessorID\n    HAVING\n        COUNT(StudentID) >= 2\n)\nSELECT\n    rs.ProfessorID,\n    rs.StudentID,\n    rs.Mark\nFROM\n    RankedStudents rs\nJOIN\n    FilteredProfessors fp ON rs.ProfessorID = fp.ProfessorID\nWHERE\n    rs.Rank <= 2\nORDER BY\n    rs.ProfessorID,\n    rs.Rank;