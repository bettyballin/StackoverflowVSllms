WITH Transaction_Diffs AS (\n    SELECT\n        ID,\n        REF,\n        Date,\n        LAG(Date) OVER (PARTITION BY ID, REF ORDER BY Date) AS Prev_Date\n    FROM\n        transactions\n),\nDate_Diffs AS (\n    SELECT\n        ID,\n        REF,\n        Date,\n        Prev_Date,\n        JULIANDAY(Date) - JULIANDAY(Prev_Date) AS Day_Diff\n    FROM\n        Transaction_Diffs\n    WHERE\n        Prev_Date IS NOT NULL\n)\nSELECT\n    ID,\n    REF,\n    AVG(Day_Diff) AS Avg_Days\nFROM\n    Date_Diffs\nGROUP BY\n    ID,\n    REF\nORDER BY\n    ID,\n    REF;