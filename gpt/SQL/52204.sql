DECLARE @Site TABLE\n(\n    SiteID int,\n    SiteNm varchar(10)\n)\n\nDECLARE @Person TABLE\n(\n    PersonID int,\n    PersonName char(1),\n    SiteID int\n)\n\nINSERT @Site\nSELECT 1, 'Site1' UNION ALL\nSELECT 2, 'Site2' UNION ALL\nSELECT 3, 'Site3' UNION ALL\nSELECT 4, 'Site4'\n\nINSERT @Person\nSELECT 1, 'A', 1 UNION ALL\nSELECT 2, 'B', 1 UNION ALL\nSELECT 3, 'C', 1 UNION ALL\nSELECT 4, 'D', 1 UNION ALL\nSELECT 5, 'E', 1 UNION ALL\nSELECT 6, 'F', 1 UNION ALL\nSELECT 7, 'G', 2 UNION ALL\nSELECT 8, 'H', 2 UNION ALL\nSELECT 9, 'I', 2 UNION ALL\nSELECT 10, 'J', 2 UNION ALL\nSELECT 11, 'K', 2 UNION ALL\nSELECT 12, 'L', 2 UNION ALL\nSELECT 13, 'M', 3 UNION ALL\nSELECT 14, 'N', 3 UNION ALL\nSELECT 15, 'O', 3 UNION ALL\nSELECT 16, 'P', 3 UNION ALL\nSELECT 17, 'Q', 3 UNION ALL\nSELECT 18, 'R', 3 UNION ALL\nSELECT 19, 'S', 4 UNION ALL\nSELECT 20, 'T', 4 UNION ALL\nSELECT 21, 'U', 4 UNION ALL\nSELECT 22, 'V', 4 UNION ALL\nSELECT 23, 'W', 4 UNION ALL\nSELECT 24, 'X', 4\n\n-- Create a calendar table or use an existing one\n;WITH Calendar AS\n(\n    SELECT CONVERT(DATE, '2023-06-22') AS TestDate\n    UNION ALL\n    SELECT DATEADD(DAY, 1, TestDate) FROM Calendar WHERE TestDate < '2023-06-30'\n)\n-- Exclude Sundays\nSELECT TestDate INTO #Calendar FROM Calendar WHERE DATEPART(WEEKDAY, TestDate) <> 1\n\n-- Assign pairs to dates\n;WITH Pairing AS\n(\n    SELECT \n        SiteID,\n        PersonName,\n        ROW_NUMBER() OVER (PARTITION BY SiteID ORDER BY PersonID) AS RowNum\n    FROM @Person\n),\nTestSchedule AS\n(\n    SELECT \n        c.TestDate,\n        s.SiteNm,\n        STRING_AGG(p.PersonName, ', ') AS Testers\n    FROM #Calendar c\n    JOIN @Site s ON 1=1\n    JOIN Pairing p ON s.SiteID = p.SiteID\n    WHERE (DATEDIFF(DAY, '2023-06-22', c.TestDate) % 3) = ((p.RowNum - 1) / 2)\n    GROUP BY c.TestDate, s.SiteNm\n)\nSELECT \n    ts.TestDate,\n    MAX(CASE WHEN ts.SiteNm = 'Site1' THEN ts.Testers END) AS Site1,\n    MAX(CASE WHEN ts.SiteNm = 'Site2' THEN ts.Testers END) AS Site2,\n    MAX(CASE WHEN ts.SiteNm = 'Site3' THEN ts.Testers END) AS Site3,\n    MAX(CASE WHEN ts.SiteNm = 'Site4' THEN ts.Testers END) AS Site4\nFROM TestSchedule ts\nGROUP BY ts.TestDate\nORDER BY ts.TestDate\n\nDROP TABLE #Calendar