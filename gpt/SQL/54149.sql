WITH MaxCounterCTE AS (\n    SELECT serial_number, MAX(counter) AS max_counter\n    FROM incoming_data\n    WHERE CAST(received_date AS DATE) = CAST(GETDATE() AS DATE)  -- Adjust this condition based on your date column\n    GROUP BY serial_number\n)\nSELECT id.primary_key_id, id.serial_number, id.counter, id.selected_color\nFROM incoming_data id\nJOIN MaxCounterCTE mc ON id.serial_number = mc.serial_number AND id.counter = mc.max_counter;