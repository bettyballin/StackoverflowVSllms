WITH CommonPrefix AS (\n    SELECT\n        id,\n        LEFT(ref, LEN(ref) - CHARINDEX(REVERSE('/' + REVERSE(STUFF((SELECT '/' + ref\n                                                                       FROM tableA t1\n                                                                       WHERE t1.id = t2.id\n                                                                       FOR XML PATH('')), 1, 1, ''))), '/')) AS common_prefix\n    FROM tableA t2\n    GROUP BY id\n),\nModifiedRefs AS (\n    SELECT\n        a.id,\n        SUBSTRING(a.ref, LEN(cp.common_prefix) + 1, LEN(a.ref) - LEN(cp.common_prefix)) AS modified_ref\n    FROM tableA a\n    JOIN CommonPrefix cp ON a.id = cp.id\n)\nSELECT\n    id,\n    STUFF((SELECT '/' + modified_ref\n           FROM ModifiedRefs m\n           WHERE m.id = t.id\n           FOR XML PATH('')), 1, 1, '') AS concatenated_refs\nFROM ModifiedRefs t\nGROUP BY id;