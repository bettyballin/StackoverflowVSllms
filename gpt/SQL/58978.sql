WITH RECURSIVE cte AS (\n    SELECT\n        asid1 AS asid,\n        asid1 AS root\n    FROM\n        #matches\n    UNION\n    SELECT\n        asid2,\n        asid1\n    FROM\n        #matches\n    UNION\n    SELECT\n        asid1 AS asid,\n        asid2 AS root\n    FROM\n        #matches\n    UNION\n    SELECT\n        asid2,\n        asid2\n    FROM\n        #matches\n),\ngrouped AS (\n    SELECT\n        asid,\n        MIN(root) OVER (PARTITION BY asid) AS group_root\n    FROM\n        cte\n)\nSELECT\n    DENSE_RANK() OVER (ORDER BY group_root) AS [group],\n    asid\nFROM\n    grouped\nGROUP BY\n    asid, group_root\nORDER BY\n    [group], asid;