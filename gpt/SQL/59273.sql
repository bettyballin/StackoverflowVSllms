SELECT \n    RAWDATA.date,\n    RAWDATA.expiration,\n    RAWDATA.days,\n    RAWDATA.callput,\n    RAWDATA.iv,\n    RAWDATA.delta\nFROM (\n    SELECT \n        ID,\n        date,\n        expiration,\n        [expiration]-[date] AS days,\n        callput,\n        iv,\n        delta,\n        RANK() OVER (PARTITION BY date ORDER BY delta, days) AS rank\n    FROM RAWDATA\n    WHERE \n        delta > 0.5 AND \n        callput = 'C' AND \n        [expiration]-[date] BETWEEN 15 AND 50\n) AS ranked_data\nWHERE rank = 1\nORDER BY date;