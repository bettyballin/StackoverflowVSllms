CREATE OR REPLACE VIEW v_test AS\n    WITH trimmed_roles AS (\n        SELECT role_name, trim(region) AS region, trim(prod_id) AS prod_id, trim(div_id) AS div_id,\n               trim(clus_id) AS clus_id, trim(prod_ln_id) AS prod_ln_id, trim(dept_id) AS dept_id\n        FROM cust_bo_roles\n    ),\n    trimmed_dept AS (\n        SELECT dept_id, trim(chrgback_reg) AS chrgback_reg, trim(prod_id) AS prod_id,\n               trim(div_id) AS div_id, trim(clus_id) AS clus_id, trim(prod_ln_id) AS prod_ln_id\n        FROM cust_dept_roll_up_tbl\n    )\n    SELECT DISTINCT u.bo_id AS bo_id, upper(trimmed_dept.dept_id) AS dept_id\n    FROM cust_bo_users u\n    JOIN trimmed_roles r ON u.role_name = r.role_name\n    JOIN trimmed_dept d ON (r.region IS NULL OR r.region = d.chrgback_reg)\n                          AND (r.prod_id IS NULL OR r.prod_id = d.prod_id)\n                          AND (r.div_id IS NULL OR r.div_id = d.div_id)\n                          AND (r.clus_id IS NULL OR r.clus_id = d.clus_id)\n                          AND (r.prod_ln_id IS NULL OR r.prod_ln_id = d.prod_ln_id)\n                          AND (r.dept_id IS NULL OR r.dept_id = d.dept_id);