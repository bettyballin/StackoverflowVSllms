class MyControllerTest < ActionController::TestCase\n  context "on POST to :my_action" do\n    setup do\n      @site = sites(:some_site) # Assuming you have a fixture named sites\n      @owner = @site.owner\n      @controller.instance_variable_set(:@site, @site)\n    end\n\n    context "with valid credentials" do\n      setup do\n        @owner.stubs(:authenticated?).returns(true)\n        post :my_action, params: { email: 'foo@bar.com', password: 'test' }\n      end\n\n      should "assign owner" do\n        assert_equal @owner, assigns(:owner)\n      end\n\n      should "authenticate owner" do\n        assert_equal true, assigns(:owner).authenticated?('test')\n      end\n\n      should "update owner's login" do\n        assert_equal 'foo@bar.com', assigns(:owner).login\n      end\n\n      should "call do_some_method" do\n        assert_received(@owner, :do_some_method)\n      end\n\n      should "set success flash message" do\n        assert_equal "Success.", flash[:success]\n      end\n\n      should "render my_action template" do\n        assert_template :my_action\n      end\n\n      should_respond_with :success\n    end\n\n    context "with invalid password" do\n      setup do\n        @owner.stubs(:authenticated?).returns(false)\n        post :my_action, params: { email: 'foo@bar.com', password: 'wrong' }\n      end\n\n      should "set error flash message" do\n        assert_equal "Incorrect password", flash[:error]\n      end\n\n      should "render my_action template" do\n        assert_template :my_action\n      end\n\n      should_respond_with :success\n    end\n\n    context "with blank email or password" do\n      setup do\n        post :my_action, params: { email: '', password: '' }\n      end\n\n      should "set error flash message" do\n        assert_equal "You must fill in both the e-mail and password fields", flash[:error]\n      end\n\n      should "render my_action template" do\n        assert_template :my_action\n      end\n\n      should_respond_with :success\n    end\n\n    context "when @site is nil" do\n      setup do\n        @controller.instance_variable_set(:@site, nil)\n        post :my_action\n      end\n\n      should "redirect to root_url" do\n        assert_redirected_to root_url\n      end\n    end\n  end\nend