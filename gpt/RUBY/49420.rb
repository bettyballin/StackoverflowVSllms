# payment_controller.rb\n\nclass PaymentController < ApplicationController\n  # Ensure the controller actions are accessible only over HTTPS\n  force_ssl\n\n  def payment\n    session[:billing_address] = params[:billing_address]\n  end\n\n  def summary\n    @billing_address = session[:billing_address]\n    @cart = get_cart\n    @purchases = @cart.purchases\n    @total = @cart.total\n  end\n\n  def finish\n    @cart = get_cart\n    @total = @cart.total\n\n    credit_card = ActiveMerchant::Billing::CreditCard.new(credit_card_params)\n    \n    billing_address = session[:billing_address]\n\n    if credit_card.valid?\n      gateway = ActiveMerchant::Billing::PaypalGateway.new(\n        login: ENV['PAYPAL_LOGIN'],\n        password: ENV['PAYPAL_PASSWORD']\n      )\n\n      res = gateway.authorize(@total, credit_card, ip: request.remote_ip, billing_address: billing_address)\n\n      if res.success?\n        gateway.capture(@total, res.authorization)\n        flash[:notice] = "Authorized"\n      else\n        flash[:notice] = "Failure: " + res.message.to_s\n      end\n    else\n      flash[:notice] = credit_card.errors.full_messages.join(", ")\n    end\n\n    redirect_to some_path # Redirect to an appropriate path\n  end\n\n  private\n\n  def credit_card_params\n    params.require(:credit_card).permit(:number, :month, :year, :verification_value, :first_name, :last_name)\n  end\nend