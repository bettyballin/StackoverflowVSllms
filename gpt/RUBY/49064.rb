require 'uri'\nrequire 'rack/utils'\n\ndef test_uses_referrer_for_return_to\n  expected_return_to = 'http://test.com/foo'\n  @request.env['HTTP_REFERER'] = expected_return_to\n  get :fazbot\n  # Extract the query parameters from the redirected URL\n  query_params = URI.parse(@response.redirected_to).query\n  # Parse the query parameters\n  params = Rack::Utils.parse_query(query_params)\n  encoded_return_to = params['return_to']\n  assert_equal expected_return_to, URI.decode_www_form_component(encoded_return_to)\nend